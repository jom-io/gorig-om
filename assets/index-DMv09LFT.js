import{u as B,F as U,j as i,E as j}from"./index-C7FItI_P.js";import{a as q}from"./vendor-utils-DG9TG-F2.js";import{r as n}from"./vendor-core-Cler3e7Q.js";import{s as G,T as x,af as Y,i as T,C as K,ag as P,G as Q,M as V,I as W,H as X}from"./vendor-ui-Bdifwvp0.js";const ee="https://ssl-checker.zoel-du.workers.dev/?host=";async function te(r){const f=`${ee}${r}`,{data:l}=await q.get(f,{timeout:1e4});return l.result}const h="certificateCache",{Text:_}=G;function re(r){try{return new URL(r).hostname}catch{return null}}function ie(){const{t:r}=B(),f=U(),[l,y]=n.useState([]),[H,m]=n.useState([]),[D,I]=n.useState(!1),[A,S]=n.useState(null),R=n.useRef(r("sys.certificate.fetchFailed")),s=n.useRef(null),[O,$]=n.useState(!1),z=n.useRef(!1),[F,k]=n.useState(!1),[L,w]=n.useState(""),M=n.useRef(null);n.useEffect(()=>{R.current=r("sys.certificate.fetchFailed")},[r]),n.useEffect(()=>{try{const t=localStorage.getItem(h);if(t){const e=JSON.parse(t);s.current=e,e.domains&&y(e.domains),e.results&&m(e.results),e.lastFetched&&S(new Date(e.lastFetched))}}catch{}finally{$(!0)}},[]),n.useEffect(()=>{if(z.current||!O||s.current?.domains?.length||s.current?.seededFromServers||l.length>0)return;const t=f.map(a=>re(a.addr)).filter(Boolean);if(t.length===0)return;const d=Array.from(new Set(t)).map(a=>({host:a,source:"server",createdAt:Date.now()}));y(d),s.current={domains:d,seededFromServers:!0},localStorage.setItem(h,JSON.stringify({domains:d,lastFetched:s.current?.lastFetched,results:s.current?.results,seededFromServers:!0})),z.current=!0},[f,l.length,O]);const p=n.useCallback(t=>t.map(e=>({key:`${e.host}-${e.source}`,name:e.host,addr:e.host,host:e.host})),[]),v=n.useMemo(()=>p(l),[l,p]),E=n.useCallback(t=>{const e={domains:l,lastFetched:t.lastFetched??s.current?.lastFetched,results:t.results??s.current?.results,seededFromServers:t.seededFromServers??s.current?.seededFromServers??!1};s.current=e,localStorage.setItem(h,JSON.stringify(e))},[l]),g=n.useCallback(async t=>{const d=p(t??l);if(d.length===0){m([]),E({results:[],lastFetched:void 0});return}m([]),I(!0);try{const a=[];for(const o of d)try{const c=await te(o.host),C=typeof c.cert_valid=="boolean"?c.cert_valid:c.cert_exp===!1?!0:void 0;a.push({key:o.key,name:o.name,addr:o.addr,host:o.host,ip:c.resolved_ip,valid:C,validFrom:c.valid_from,validTill:c.valid_till,vendor:c.issuer_o||c.issuer_cn})}catch(c){const C=typeof c=="string"?c:c?.message||R.current;a.push({key:o.key,name:o.name,addr:o.addr,host:o.host,error:C})}m(a);const u=new Date;S(u),E({results:a,lastFetched:u.toISOString()})}finally{I(!1)}},[l,p,E]);n.useEffect(()=>{if(v.length===0)return;const t=s.current,e=o=>{if(!o)return!1;const c=new Date;return o.getFullYear()===c.getFullYear()&&o.getMonth()===c.getMonth()&&o.getDate()===c.getDate()},d=(t?.domains||[]).map(o=>o.host).sort().join(","),a=l.map(o=>o.host).sort().join(","),u=d===a;if(t?.results&&t.lastFetched&&e(new Date(t.lastFetched))&&u){m(t.results),S(new Date(t.lastFetched));return}g()},[v.length,l,g]);const b=()=>{k(!0),w("")};n.useEffect(()=>{F&&setTimeout(()=>M.current?.focus(),50)},[F]);const N=()=>{const t=L.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!t){j.error(r("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(t)){j.error(r("sys.certificate.domainInvalid"));return}if(l.some(u=>u.host.toLowerCase()===t.toLowerCase())){j.warning(r("sys.certificate.domainExists"));return}const a=[...l,{host:t,source:"custom",createdAt:Date.now()}];y(a),s.current={...s.current,domains:a,seededFromServers:s.current?.seededFromServers??!0},localStorage.setItem(h,JSON.stringify({domains:a,lastFetched:s.current?.lastFetched,results:s.current?.results,seededFromServers:s.current?.seededFromServers??!0})),k(!1),w(""),g(a)},Z=t=>{const e=l.filter(a=>a.host!==t);y(e);const d={domains:e,lastFetched:s.current?.lastFetched,results:(s.current?.results||[]).filter(a=>a.host!==t),seededFromServers:s.current?.seededFromServers??!0};s.current=d,localStorage.setItem(h,JSON.stringify(d)),m(a=>a.filter(u=>u.host!==t))},J=[{title:r("sys.certificate.api"),dataIndex:"addr",key:"addr",render:(t,e)=>i.jsx(_,{className:"font-medium",children:e.addr})},{title:r("sys.certificate.ip"),dataIndex:"ip",key:"ip",render:(t,e)=>e.error?"-":e.ip||"-"},{title:r("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",render:(t,e)=>e.error?"-":e.vendor||"-"},{title:r("sys.certificate.valid"),dataIndex:"valid",key:"valid",render:(t,e)=>e.error?i.jsx(x,{color:"default",children:r("sys.certificate.unknown")}):e.valid===void 0?i.jsx(x,{color:"default",children:r("sys.certificate.unknown")}):e.valid?i.jsx(x,{color:"success",children:r("sys.certificate.validTag")}):i.jsx(x,{color:"error",children:r("sys.certificate.invalidTag")})},{title:r("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",render:(t,e)=>e.error?"-":e.validFrom||"-"},{title:r("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",render:(t,e)=>e.error?"-":e.validTill||"-"},{title:r("sys.certificate.remark"),dataIndex:"error",key:"error",render:(t,e)=>e.error?i.jsx(_,{type:"danger",children:e.error}):"-"},{title:r("sys.certificate.operation"),key:"operation",render:(t,e)=>i.jsx(Y,{title:r("sys.certificate.deleteConfirm"),onConfirm:()=>Z(e.host),children:i.jsx(T,{type:"link",danger:!0,children:r("sys.certificate.delete")})})}];return i.jsxs(K,{title:r("sys.certificate.title"),extra:i.jsxs(X,{size:"middle",children:[A&&i.jsx(_,{type:"secondary",className:"text-xs",children:r("sys.certificate.updatedAt",{time:A.toLocaleString()})}),i.jsx(T,{onClick:b,children:r("sys.certificate.addDomain")}),i.jsx(T,{onClick:g,loading:D,disabled:v.length===0,children:r("sys.certificate.refresh")})]}),children:[v.length===0?i.jsx(P,{image:P.PRESENTED_IMAGE_SIMPLE,description:r("sys.certificate.noServer")}):i.jsx(Q,{rowKey:"key",loading:D,columns:J,dataSource:H,pagination:!1,scroll:{x:!0},size:"middle"}),i.jsx(V,{title:r("sys.certificate.addDomain"),open:F,onOk:N,onCancel:()=>k(!1),okText:r("sys.certificate.confirm"),cancelText:r("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},children:i.jsx(W,{addonBefore:"https://",placeholder:r("sys.certificate.domainPlaceholder"),value:L,onChange:t=>w(t.target.value),onPressEnter:N,allowClear:!0,ref:M})})]})}export{ie as default};

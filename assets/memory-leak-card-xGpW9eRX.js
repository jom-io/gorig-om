import{u as A,a as U,j as e,t}from"./index-AHjT66P3.js";import{s as D}from"./statService-CxUvAms7.js";import{C as G}from"./index-Bc1co6Wu.js";import{z as m,S as $,M as W,ak as L,G as V,t as q}from"./vendor-ui-B8JNe9Dz.js";import{r}from"./vendor-core-D3G3Pc5t.js";import J from"./RefreshIcon-DSzYLikf.js";import{useTimeRange as Q}from"./api-latency-chart-BEhE8p-9.js";import"./vendor-utils-9ATX-dPw.js";import"./chart-DWnyXj9S.js";import"./vendor-charts-C0vSEv4L.js";import"./useChart-CgyA-rHf.js";import"./api-sample-modal-DLs4z4SQ.js";const{Panel:X}=L,f=l=>{if(l===0)return"0 B";const o=1024,k=["B","KB","MB","GB"],p=Math.floor(Math.log(Math.abs(l))/Math.log(o));return`${(l/o**p).toFixed(2)} ${k[p]}`};function de(){const{t:l}=A(),o=U(),[k,p]=r.useState(!1),[j,B]=r.useState(0),[w,O]=r.useState(""),[i,S]=r.useState(!1),[u,H]=r.useState([]),[a,x]=r.useState({current:1,pageSize:10,total:0}),[I,v]=r.useState(!1),[R,y]=r.useState([]),C=r.useRef(!1),{timeUnit:h,timeRange:N,setTimeRange:M,getRange:z,renderTimePicker:Y}=Q("today",[m().startOf("day"),m()]),g=r.useCallback(async()=>{if(o)try{p(!0);const s=m(),n=s.startOf("day").unix(),c=s.unix(),d=await D.memLeakCount(n,c);B(d),O(s.format("HH:mm"))}catch{}finally{p(!1)}},[o]),b=r.useCallback(async()=>{if(o)try{v(!0);const{start:s,end:n}=z(h),c=await D.memLeakPage({start:s,end:n,page:a.current,size:a.pageSize}),d=c.items||[];H(d),d.length>0?y([`${d[0].at}-0`]):y([]),x(K=>({...K,total:c.total||0,current:c.page||1,pageSize:c.size||10}))}catch{}finally{v(!1)}},[o,h,z,a.current,a.pageSize]);r.useEffect(()=>{o&&g()},[o,g]),r.useEffect(()=>{const s=C.current;C.current=i,i&&!s&&h==="today"&&N?.[0]&&M([N[0],m()]),i&&o&&(!s||h)&&b()},[i,o,h,N,M,b]);const E=()=>{S(!0),y([]),x(s=>({...s,current:1}))},P=r.useCallback(s=>{s.stopPropagation(),g(),i&&o&&b()},[g,i,o,b]),T=[{title:l("sys.workbench.leakFunc"),dataIndex:"func",key:"func",render:(s,n)=>e.jsxs("div",{className:"flex flex-col py-0.5",style:{wordBreak:"break-all",whiteSpace:"normal"},children:[e.jsx("span",{style:{fontSize:"13px",fontFamily:"monospace",fontWeight:600,color:t.colors.text.primary,wordBreak:"break-all",whiteSpace:"normal",lineHeight:"1.4"},children:s}),e.jsxs("span",{className:"mt-0.5",style:{fontSize:"11px",color:t.colors.text.secondary,wordBreak:"break-all",whiteSpace:"normal",lineHeight:"1.4"},children:[n.file,":",n.line]})]})},{title:l("sys.workbench.leakDeltaSpace"),dataIndex:"deltaSpace",key:"deltaSpace",width:110,align:"right",render:s=>e.jsxs("span",{style:{fontSize:"13px",fontWeight:700,color:t.colors.palette.error.dark},children:["+",f(s)]})},{title:l("sys.workbench.leakDeltaObjects"),dataIndex:"deltaObjects",key:"deltaObjects",width:90,align:"right",render:s=>e.jsxs("span",{style:{fontSize:"13px",color:t.colors.text.primary},children:["+",s.toLocaleString()]})}],F=`linear-gradient(135deg, rgba(${t.colors.palette.error.lightChannel}, 0.14), rgba(${t.colors.palette.warning.lightChannel}, 0.12)) ${t.colors.background.paper}`;return e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"!p-0 overflow-hidden cursor-pointer hover:shadow-lg transition-shadow",onClick:E,style:{background:F,padding:0,boxShadow:t.shadows.card,height:133,width:"100%",display:"flex",flexDirection:"column",flexShrink:0},children:e.jsx($,{spinning:k,style:{height:"100%"},wrapperClassName:"flex-1 flex flex-col",children:e.jsx("div",{className:"flex h-full flex-col justify-center p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"text-lg font-medium",style:{color:t.colors.text.primary},children:l("sys.workbench.memoryLeak")}),e.jsx("div",{className:"text-xs",style:{color:t.colors.text.secondary},children:j>0?l("sys.workbench.leakSummary"):l("sys.workbench.leakNoEvent")}),e.jsxs("div",{className:"flex items-baseline gap-2 mt-6",children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:j>0?t.colors.palette.error.dark:t.colors.text.primary},children:j}),e.jsx("div",{className:"text-xs",style:{color:t.colors.text.secondary},children:l("sys.workbench.leakUnit")})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 justify-center",children:[e.jsx(J,{background:`rgba(${t.colors.palette.error.defaultChannel}, 0.16)`,color:t.colors.palette.error.dark,icon:"mdi:leak",onClick:P}),w&&e.jsx("span",{className:"mt-4 text-xs whitespace-nowrap",style:{color:t.colors.text.secondary},children:l("sys.workbench.leakUpdatedAt",{time:w})})]})]})})})}),e.jsxs(W,{title:e.jsx("span",{className:"text-lg font-bold",children:l("sys.workbench.memoryLeak")}),open:i,onCancel:()=>S(!1),footer:null,width:900,centered:!0,styles:{body:{paddingTop:"12px",maxHeight:"calc(100vh - 200px)",overflowY:"auto"}},children:[e.jsx("div",{className:"mb-4 flex items-center justify-end gap-2",children:Y(()=>{x(s=>({...s,current:1}))})}),e.jsxs($,{spinning:I,children:[u&&u.length>0?e.jsx(L,{activeKey:R,onChange:y,style:{background:"transparent"},children:u.map((s,n)=>e.jsx(X,{header:e.jsx("div",{className:"flex items-center justify-between w-full pr-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-semibold",style:{color:t.colors.text.primary},children:m.unix(s.at).format("YYYY-MM-DD HH:mm:ss")}),e.jsxs("span",{className:"text-sm font-bold text-red-500",style:{color:t.colors.palette.error.dark},children:["+",f(s.allocDelta)]}),e.jsxs("span",{className:"text-sm font-bold text-red-500",style:{color:t.colors.palette.error.dark},children:["+",s.objectDelta.toLocaleString()]})]})}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl",style:{background:t.colors.background.neutral},children:[e.jsxs("div",{className:"flex flex-col gap-1.5",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakTime",{time:""})}),e.jsx("div",{className:"text-sm font-bold",style:{color:t.colors.text.primary},children:m.unix(s.at).format("YYYY-MM-DD HH:mm:ss")})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakBaseInuseSpace")}),e.jsx("div",{className:"text-base font-bold",style:{color:t.colors.text.primary},children:f(s.baseInuseSpace)})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakLeakInuseSpace")}),e.jsx("div",{className:"text-base font-bold",style:{color:t.colors.text.primary},children:f(s.leakInuseSpace)})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakAllocDelta")}),e.jsxs("div",{className:"text-lg font-black text-red-500",children:["+",f(s.allocDelta)]})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakObjectDelta")}),e.jsxs("div",{className:"text-lg font-black text-red-500",children:["+",s.objectDelta.toLocaleString()]})]})]})]}),s.points&&s.points.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"mb-3 text-sm font-bold tracking-tight",style:{color:t.colors.text.primary},children:l("sys.workbench.leakPoints")}),e.jsx(V,{dataSource:s.points,columns:T,pagination:!1,size:"small",rowKey:(c,d)=>`${c.func}-${c.file}-${c.line}-${d}`})]})]})},`${s.at}-${n}`))}):e.jsx("div",{className:"py-20 text-center",children:e.jsx("div",{className:"mb-2 text-lg font-medium",style:{color:t.colors.text.disabled},children:l("sys.workbench.leakNoEvent")})}),u.length>0&&e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",style:{color:t.colors.text.secondary},children:["共 ",a.total," 条"]}),e.jsx(q,{value:a.pageSize,onChange:s=>{x(n=>({...n,pageSize:s,current:1}))},style:{width:100},options:[{value:10,label:"10 条/页"},{value:20,label:"20 条/页"},{value:50,label:"50 条/页"}]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>{a.current>1&&x(s=>({...s,current:s.current-1}))},disabled:a.current===1,className:"px-2 py-1 text-sm rounded border",style:{background:a.current===1?t.colors.background.neutral:"transparent",cursor:a.current===1?"not-allowed":"pointer"},children:"上一页"}),e.jsxs("span",{className:"px-2 text-sm",style:{color:t.colors.text.primary},children:[a.current," / ",Math.ceil(a.total/a.pageSize)]}),e.jsx("button",{type:"button",onClick:()=>{const s=Math.ceil(a.total/a.pageSize);a.current<s&&x(n=>({...n,current:n.current+1}))},disabled:a.current>=Math.ceil(a.total/a.pageSize),className:"px-2 py-1 text-sm rounded border",style:{background:a.current>=Math.ceil(a.total/a.pageSize)?t.colors.background.neutral:"transparent",cursor:a.current>=Math.ceil(a.total/a.pageSize)?"not-allowed":"pointer"},children:"下一页"})]})]})})]})]})]})}export{de as default};

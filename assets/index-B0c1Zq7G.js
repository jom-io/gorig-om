import{u as cs,a as ls,j as a,I as K,b as U}from"./index-DeoBYzhN.js";import{d as E}from"./deployService-CQgysdIf.js";import{z as k,c as Z,T as q,E as R,M as B,C as ds,G as us,H as fs,i as _}from"./vendor-ui-BgnAtmuh.js";import{d as hs,g as ms,r as l}from"./vendor-core-Cler3e7Q.js";import{DeploySteps as ys}from"./DeploySteps-CyZYRdgr.js";import gs from"./EnvConfigModal-BY5FWpDo.js";import ps from"./LogModal-CO8sFWha.js";import"./vendor-utils-Dg5_7-NF.js";var Q={exports:{}};(function(i,u){(function(b,h){i.exports=h()})(hs,function(){var b,h,z=1e3,C=6e4,x=36e5,O=864e5,A=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,H=31536e6,w=2628e6,P=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/,S={years:H,months:w,days:O,hours:x,minutes:C,seconds:z,milliseconds:1,weeks:6048e5},T=function(c){return c instanceof V},M=function(c,n,s){return new V(c,s,n.$l)},N=function(c){return h.p(c)+"s"},v=function(c){return c<0},m=function(c){return v(c)?Math.ceil(c):Math.floor(c)},j=function(c){return Math.abs(c)},$=function(c,n){return c?v(c)?{negative:!0,format:""+j(c)+n}:{negative:!1,format:""+c+n}:{negative:!1,format:""}},V=function(){function c(s,r,o){var d=this;if(this.$d={},this.$l=o,s===void 0&&(this.$ms=0,this.parseFromMilliseconds()),r)return M(s*S[N(r)],this);if(typeof s=="number")return this.$ms=s,this.parseFromMilliseconds(),this;if(typeof s=="object")return Object.keys(s).forEach(function(p){d.$d[N(p)]=s[p]}),this.calMilliseconds(),this;if(typeof s=="string"){var y=s.match(P);if(y){var g=y.slice(2).map(function(p){return p!=null?Number(p):0});return this.$d.years=g[0],this.$d.months=g[1],this.$d.weeks=g[2],this.$d.days=g[3],this.$d.hours=g[4],this.$d.minutes=g[5],this.$d.seconds=g[6],this.calMilliseconds(),this}}return this}var n=c.prototype;return n.calMilliseconds=function(){var s=this;this.$ms=Object.keys(this.$d).reduce(function(r,o){return r+(s.$d[o]||0)*S[o]},0)},n.parseFromMilliseconds=function(){var s=this.$ms;this.$d.years=m(s/H),s%=H,this.$d.months=m(s/w),s%=w,this.$d.days=m(s/O),s%=O,this.$d.hours=m(s/x),s%=x,this.$d.minutes=m(s/C),s%=C,this.$d.seconds=m(s/z),s%=z,this.$d.milliseconds=s},n.toISOString=function(){var s=$(this.$d.years,"Y"),r=$(this.$d.months,"M"),o=+this.$d.days||0;this.$d.weeks&&(o+=7*this.$d.weeks);var d=$(o,"D"),y=$(this.$d.hours,"H"),g=$(this.$d.minutes,"M"),p=this.$d.seconds||0;this.$d.milliseconds&&(p+=this.$d.milliseconds/1e3,p=Math.round(1e3*p)/1e3);var D=$(p,"S"),F=s.negative||r.negative||d.negative||y.negative||g.negative||D.negative,L=y.format||g.format||D.format?"T":"",Y=(F?"-":"")+"P"+s.format+r.format+d.format+L+y.format+g.format+D.format;return Y==="P"||Y==="-P"?"P0D":Y},n.toJSON=function(){return this.toISOString()},n.format=function(s){var r=s||"YYYY-MM-DDTHH:mm:ss",o={Y:this.$d.years,YY:h.s(this.$d.years,2,"0"),YYYY:h.s(this.$d.years,4,"0"),M:this.$d.months,MM:h.s(this.$d.months,2,"0"),D:this.$d.days,DD:h.s(this.$d.days,2,"0"),H:this.$d.hours,HH:h.s(this.$d.hours,2,"0"),m:this.$d.minutes,mm:h.s(this.$d.minutes,2,"0"),s:this.$d.seconds,ss:h.s(this.$d.seconds,2,"0"),SSS:h.s(this.$d.milliseconds,3,"0")};return r.replace(A,function(d,y){return y||String(o[d])})},n.as=function(s){return this.$ms/S[N(s)]},n.get=function(s){var r=this.$ms,o=N(s);return o==="milliseconds"?r%=1e3:r=o==="weeks"?m(r/S[o]):this.$d[o],r||0},n.add=function(s,r,o){var d;return d=r?s*S[N(r)]:T(s)?s.$ms:M(s,this).$ms,M(this.$ms+d*(o?-1:1),this)},n.subtract=function(s,r){return this.add(s,r,!0)},n.locale=function(s){var r=this.clone();return r.$l=s,r},n.clone=function(){return M(this.$ms,this)},n.humanize=function(s){return b().add(this.$ms,"ms").locale(this.$l).fromNow(!s)},n.valueOf=function(){return this.asMilliseconds()},n.milliseconds=function(){return this.get("milliseconds")},n.asMilliseconds=function(){return this.as("milliseconds")},n.seconds=function(){return this.get("seconds")},n.asSeconds=function(){return this.as("seconds")},n.minutes=function(){return this.get("minutes")},n.asMinutes=function(){return this.as("minutes")},n.hours=function(){return this.get("hours")},n.asHours=function(){return this.as("hours")},n.days=function(){return this.get("days")},n.asDays=function(){return this.as("days")},n.weeks=function(){return this.get("weeks")},n.asWeeks=function(){return this.as("weeks")},n.months=function(){return this.get("months")},n.asMonths=function(){return this.as("months")},n.years=function(){return this.get("years")},n.asYears=function(){return this.as("years")},c}(),I=function(c,n,s){return c.add(n.years()*s,"y").add(n.months()*s,"M").add(n.days()*s,"d").add(n.hours()*s,"h").add(n.minutes()*s,"m").add(n.seconds()*s,"s").add(n.milliseconds()*s,"ms")};return function(c,n,s){b=s,h=s().$utils(),s.duration=function(d,y){var g=s.locale();return M(d,{$l:g},y)},s.isDuration=T;var r=n.prototype.add,o=n.prototype.subtract;n.prototype.add=function(d,y){return T(d)?I(this,d,1):r.bind(this)(d,y)},n.prototype.subtract=function(d,y){return T(d)?I(this,d,-1):o.bind(this)(d,y)}}})})(Q);var xs=Q.exports;const bs=ms(xs);k.extend(bs);const Rs=()=>{const{t:i}=cs(),u=ls(),[b,h]=l.useState([]),[z,C]=l.useState(!1),[,x]=l.useState(!1),[O,A]=l.useState(!1),[H,w]=l.useState(null),[P,S]=l.useState(!1),[T,M]=l.useState(!1),[N,v]=l.useState(0),[m,j]=l.useState({current:1,pageSize:10,total:0}),[$,V]=l.useState(!1),[I,c]=l.useState(null),[n,s]=l.useState(null),r=l.useRef(null),[o,d]=l.useState(null),[y,g]=l.useState(!1);l.useEffect(()=>{u&&(C(!1),x(!1),w(null),d(null),v(0))},[u]);const p=l.useCallback(async(t,e)=>{if(u)try{M(!0);const f=await E.pageTask(t,e);h(f.items),j(W=>({...W,total:f.total}))}catch{}finally{M(!1)}},[u]),D=l.useCallback(async()=>{if(u){if(r.current?.addr===u.addr){v(r.current.step);return}try{const t=await E.getTaskCfg();if(d(t),!t.gitInit){v(0),x(!1),r.current={addr:u.addr,step:0};return}if(!t.sshKeyCopy){v(1),x(!1),r.current={addr:u.addr,step:1};return}if(!t.repo||!t.branch){v(2),x(!1),r.current={addr:u.addr,step:2};return}v(3),x(!0),r.current={addr:u.addr,step:3},w({repoUrl:t.repo,selectedBranch:t.branch})}catch{x(!1),w(null),d(null)}}},[u]),F=l.useCallback(()=>o?o.gitInit&&o.sshKeyCopy&&o.repo&&o.branch:!1,[o]),L=l.useCallback(()=>o?o.goInit:!1,[o]);l.useEffect(()=>{u&&(D(),j(t=>({...t,current:1})))},[u,D]),l.useEffect(()=>{u&&p(m.current,m.pageSize)},[m.current,m.pageSize,p,u]);const Y=l.useCallback(async t=>{try{return await E.getTask(t)}catch{return null}},[]),G=l.useCallback(()=>{if(!b)return null;const t=b.filter(e=>e.status==="running"||e.status==="waiting");return t.length>0?t.sort((e,f)=>k(e.createAt).valueOf()-k(f.createAt).valueOf())[0]:null},[b]);l.useEffect(()=>{const t=G();s(t)},[G]),l.useEffect(()=>{if(!n)return;const e=setInterval(async()=>{const f=await Y(n.id);f&&(h(W=>W.map(J=>J.id===f.id?f:J)),$&&I?.id===f.id&&c(f))},3e3);return()=>clearInterval(e)},[n,$,I,Y]),l.useEffect(()=>{if(b?.some(e=>e.status==="running")??!1){const e=setInterval(()=>{h(f=>[...f])},1e3);return()=>clearInterval(e)}},[b]);const X=[{title:a.jsx("div",{className:"pl-4",children:i("sys.cicd.deployInfo")}),dataIndex:"gitHash",width:120,align:"left",render:(t,e)=>a.jsxs("div",{className:"flex flex-col pl-4",children:[a.jsx(Z,{title:e.gitHash,children:a.jsx("span",{className:"text-sm block w-[120px] text-left",children:e.rb?i("sys.cicd.rollback.to",{hash:e.gitHash?`${e.gitHash.slice(0,7)}...`:"-"}):e.gitHash?`${e.gitHash.slice(0,7)}...`:"-"})}),a.jsx(Z,{title:e.commit,children:a.jsx("span",{className:"text-xs text-text-secondary block w-[120px] text-left truncate",children:e.commit||"-"})})]})},{title:i("sys.cicd.deployBranch"),dataIndex:"branch",align:"center",width:100},{title:i("sys.cicd.autoTrigger"),dataIndex:"autoTrigger",align:"center",width:80,render:t=>a.jsx(q,{color:t?"blue":"orange",children:i(t?"sys.cicd.triggerAuto":"sys.cicd.triggerManual")})},{title:i("sys.cicd.status"),dataIndex:"status",align:"center",width:80,render:(t,e)=>{const f={success:{color:"success",text:e.rb?i("deploy.sys.cicd.statusRollbackSuccess"):i("deploy.sys.cicd.statusSuccess"),className:void 0},failed:{color:"error",text:e.rb?i("deploy.sys.cicd.statusRollbackFailed"):i("deploy.sys.cicd.statusFailed"),className:void 0},running:{color:"processing",text:i("deploy.sys.cicd.statusRunning"),className:void 0},waiting:{color:"warning",text:e.rb?i("deploy.sys.cicd.statusRollbackWaiting"):i("deploy.sys.cicd.statusWaiting"),className:void 0},timeout:{color:"error",text:i("deploy.sys.cicd.statusTimeout"),className:void 0},canceled:{color:"default",text:i("deploy.sys.cicd.statusCanceled"),className:"!bg-[#f5f5f5] !text-[#999] !border-[#f5f5f5] [&>a]:!text-[#999]"}};return a.jsx(q,{color:f[t]?.color||"default",className:f[t]?.className,children:f[t]?.text||t})}},{title:i("sys.cicd.createTime"),dataIndex:"createAt",align:"center",width:150,render:t=>k(t).format("YYYY-MM-DD HH:mm:ss")},{title:i("sys.cicd.duration"),key:"duration",align:"center",width:80,render:(t,e)=>e.status==="waiting"?"-":e.status==="running"?k.duration(k().diff(k(e.startAt))).format("HH:mm:ss"):e.status==="success"||e.status==="failed"||e.status==="timeout"?k.duration(k(e.finishAt).diff(k(e.startAt))).format("HH:mm:ss"):"-"},{title:i("sys.cicd.operation"),key:"operation",align:"center",width:100,render:(t,e)=>a.jsxs("div",{className:"flex w-full justify-center text-gray-500",children:[a.jsx(K,{onClick:()=>ts(e),disabled:e.status==="waiting",className:e.status==="waiting"?"opacity-50 cursor-not-allowed":"",children:a.jsx(U,{icon:"mdi:file-document-outline",size:18,className:e.status==="waiting"?"text-gray-300":""})}),a.jsx(K,{onClick:()=>os(e),disabled:e.status!=="running"&&e.status!=="waiting",className:e.status!=="running"&&e.status!=="waiting"?"opacity-50 cursor-not-allowed":"",children:a.jsx(U,{icon:"mdi:stop-circle-outline",size:18,className:e.status==="running"||e.status==="waiting"?"text-error":"text-gray-300"})}),a.jsx(K,{onClick:()=>es(e),disabled:e.rbStatus!=="ready",className:e.rbStatus!=="ready"?"opacity-50 cursor-not-allowed":"",children:a.jsx(U,{icon:"mdi:backup-restore",size:18,className:e.rbStatus==="ready"?"text-warning":"text-gray-300"})})]})}],ss=()=>{C(!0)},ts=t=>{if(!t.log||t.log.length===0){R.warning("暂无日志");return}c(t),V(!0)},es=t=>{if(t.rbStatus!=="ready"){R.warning(t.rbStatus==="cleaned"?i("sys.cicd.rollback.cleaned"):i("sys.cicd.rollback.notReady"));return}B.confirm({title:i("sys.cicd.rollback.confirmTitle"),content:i("sys.cicd.rollback.confirmContent",{hash:t.gitHash||i("sys.cicd.rollback.unknownVersion")}),onOk:async()=>{try{await E.rollbackTask(t.id),R.success(i("sys.cicd.rollback.success")),j(e=>({...e,current:1})),p(1,m.pageSize)}catch{R.error(i("sys.cicd.rollback.failed"))}}})},ns=t=>{d(t),w({repoUrl:t.repo,selectedBranch:t.branch}),x(!0),r.current={addr:u?.addr||"",step:3},C(!1)},is=()=>{A(!0)},as=async()=>{try{S(!0),await E.startTask(),R.success(i("sys.cicd.runSuccess")),A(!1),j(t=>({...t,current:1})),p(1,m.pageSize)}catch{}finally{S(!1)}},rs=t=>{j(t)},os=t=>{if(t.status!=="running"&&t.status!=="waiting"){R.warning(i("deploy.sys.cicd.stop.notRunning"));return}B.confirm({title:i("deploy.sys.cicd.stop.confirmTitle"),content:i("deploy.sys.cicd.stop.confirmContent"),onOk:async()=>{try{await E.stopTask(t.id),R.success(i("deploy.sys.cicd.stop.success")),j(e=>({...e,current:1})),p(1,m.pageSize)}catch{R.error(i("deploy.sys.cicd.stop.failed"))}}})};return a.jsxs(a.Fragment,{children:[a.jsxs(ds,{title:i("sys.cicd.deployList"),styles:{body:{padding:"0 0px"}},extra:a.jsxs(fs,{children:[a.jsx(_,{type:"primary",onClick:ss,children:i("sys.cicd.deployConfig")}),a.jsx(_,{type:"primary",onClick:()=>g(!0),disabled:!L(),className:L()?"":"opacity-50 cursor-not-allowed",children:i("deploy.sys.cicd.env.title")}),a.jsx(_,{type:"primary",onClick:is,disabled:!F(),className:F()?"":"opacity-50 cursor-not-allowed",children:i("sys.cicd.run")})]}),children:[a.jsx(us,{rowKey:t=>`${t.gitHash}-${t.createAt}`,size:"small",scroll:{x:"max-content"},columns:X,dataSource:b,loading:T,pagination:{...m,style:{marginRight:"16px"}},onChange:rs,className:"w-full max-w-[1000px] mx-auto"}),a.jsx(B,{title:i("sys.cicd.deployConfig"),open:z,onCancel:()=>C(!1),footer:null,width:800,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"},body:{paddingTop:"4px"}},children:a.jsx(ys,{onComplete:ns,initialStep:N},u?.addr)}),a.jsx(B,{title:i("sys.cicd.runModal.title"),open:O,onCancel:()=>A(!1),onOk:as,confirmLoading:P,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"}},children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"font-medium",children:[i("sys.cicd.runModal.repoAddress"),"："]}),a.jsx("div",{className:"text-gray-600",children:H?.repoUrl})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"font-medium",children:[i("sys.cicd.runModal.currentBranch"),"："]}),a.jsx("div",{className:"text-gray-600",children:H?.selectedBranch})]}),a.jsx("div",{className:"text-gray-500",children:i("sys.cicd.runModal.confirmTip")})]})})]}),I&&a.jsx(ps,{record:I,visible:$,onClose:()=>V(!1)}),a.jsx(gs,{visible:y,onClose:()=>g(!1)})]})};export{Rs as default};

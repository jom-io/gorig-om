import{c as i,d as A,u as ue,a as ge,j as s}from"./index-CSQWneH1.js";import{r as c}from"./vendor-core-Cler3e7Q.js";import{J as L,s as fe,K as j,N as E,i as y,O as xe,I as me,t as je,P as be,h as ke,Q as Se,E as p}from"./vendor-ui-BgnAtmuh.js";const Ce=()=>i.get({url:"/om/deploy/git/check"}),ve=()=>i.post({url:"/om/deploy/git/install"}),Ie=()=>i.get({url:"/om/deploy/go/check"}),Ne=()=>i.post({url:"/om/deploy/go/install"}),Te=()=>i.post({url:"/om/deploy/ssh/key"}),we=()=>i.get({url:"/om/deploy/ssh/key"}),Ke=h=>i.get({url:"/om/deploy/branches",params:{repoUrl:h}}),Ge=h=>i.post({url:"/om/deploy/task/config",data:h}),Be=()=>i.get({url:"/om/deploy/task/config"}),Re=()=>i.post({url:"/om/deploy/task/start"}),Le=(h,F)=>i.get({url:"/om/deploy/task/page",params:{page:h,size:F}}),Ee=h=>i.get({url:"/om/deploy/task/get",params:{id:h}}),Ae=h=>i.post({url:"/om/deploy/task/rollback",params:{id:h}}),Fe=A(Ce,200),Oe=A(Ie,200),Pe=A(we,200),_e=A(Be,200),d={checkInstallStatus:Fe,installGit:ve,checkGo:Oe,installGo:Ne,generateSshKey:Te,getSshKey:Pe,getBranches:Ke,saveTaskCfg:Ge,getTaskCfg:_e,startTask:Re,pageTask:Le,getTask:Ee,rollbackTask:Ae},{Text:o,Paragraph:$e}=fe,W=({onComplete:h,initialStep:F})=>{const{t}=ue(),b=ge(),[l,T]=c.useState(F),[u,f]=c.useState(!1),[q,D]=c.useState(!1),[k,w]=c.useState(!1),[U,H]=c.useState(!1),[x,M]=c.useState(null),[g,z]=c.useState(null),[C,V]=c.useState(null),[O,S]=c.useState([]),[a,r]=c.useState({gitInit:!1,goInit:!1,sshKeyCopy:!1,repo:"",branch:"",autoTrigger:!1}),[X,J]=c.useState(!1),[Y,De]=c.useState(!1),[m,P]=c.useState(!1),_=c.useRef(null),K=c.useRef(!1),v=c.useCallback(async()=>{try{const e=await d.checkInstallStatus();return M(e),e?.installed?r(n=>({...n,gitInit:!0})):r(n=>({...n,gitInit:!1})),e}catch{return r(n=>({...n,gitInit:!1})),null}},[]),I=c.useCallback(async()=>{try{const e=await d.checkGo();return z(e),e?.installed?r(n=>({...n,goInit:!0})):r(n=>({...n,goInit:!1})),e}catch{return r(n=>({...n,goInit:!1})),null}},[]),Q=c.useCallback(async()=>{try{const e=await d.getSshKey();return V(e),r(n=>({...n,sshKeyCopy:!!e?.publicKey})),e}catch{return null}},[]);c.useCallback(async()=>{try{return await d.getTaskCfg()}catch{return null}},[]),c.useEffect(()=>{l===0?(!x&&!u&&!K.current&&v().then(e=>{e?.installed&&r(n=>({...n,gitInit:!0}))}),!g&&!u&&!K.current&&I().then(e=>{e?.installed&&r(n=>({...n,goInit:!0}))})):l===1?Q().then(e=>{e?.publicKey&&r(n=>({...n,sshKeyCopy:!0}))}):l===3&&a.repo&&Z()},[l,a.repo,v,I,Q,u,x,g]);const G=c.useCallback(async()=>{if(b)try{K.current=!0,f(!0);const e=await d.getTaskCfg(),n=await v(),$=await I();r({gitInit:e.gitInit||!!n?.installed,goInit:e.goInit||!!$?.installed,sshKeyCopy:e.sshKeyCopy,repo:e.repo,branch:e.branch,autoTrigger:e.autoTrigger});let N=0;e.gitInit&&e.goInit&&(N=1,e.sshKeyCopy&&(N=2,e.repo&&(N=3,e.branch&&(N=4)))),T(N),_.current=b.addr}catch{}finally{K.current=!1,f(!1)}},[b,v,I]);c.useEffect(()=>{G()},[G]),c.useEffect(()=>{b&&_.current!==b.addr&&(_.current=null,G())},[b,G]);const Z=async()=>{if(a.repo)try{w(!0);const e=await d.getBranches(a.repo);S(e),!a.branch&&e.length>0&&r(n=>({...n,branch:e[0]}))}catch{S([])}finally{w(!1)}},ee=async()=>{if(a.repo)try{w(!0);const e=await d.getBranches(a.repo);S(e),!a.branch&&e.length>0&&r(n=>({...n,branch:e[0]}))}catch{S([])}finally{w(!1)}},se=async e=>{r(n=>({...n,branch:e}))},te=async()=>{try{f(!0);const e=await d.installGit();if(e.error){p.error(e.error),r(n=>({...n,gitInit:!1}));return}M(e),r(n=>({...n,gitInit:!0})),p.success("Git 安装成功")}catch{r(n=>({...n,gitInit:!1}))}finally{f(!1)}},ne=async()=>{try{f(!0);const e=await d.installGo();if(e.error){p.error(e.error),r(n=>({...n,goInit:!1}));return}z(e),r(n=>({...n,goInit:!0})),p.success("Go 安装成功")}catch{r(n=>({...n,goInit:!1}))}finally{f(!1)}},ae=async()=>{try{f(!0);const e=await d.generateSshKey();V(e),r(n=>({...n,sshKeyCopy:!!e?.publicKey})),p.success("SSH Key 生成成功")}catch{}finally{f(!1)}},re=async()=>{if(!a.repo.startsWith("git@")){p.error(t("deploy.repo.invalidFormat"));return}try{H(!0);const e=await d.getBranches(a.repo);S(e),!a.branch&&e.length>0&&r(n=>({...n,branch:e[0]})),P(!0),p.success(t("deploy.repo.checkSuccess"))}catch{S([]),r(n=>({...n,branch:""})),P(!1)}finally{H(!1)}},ce=async()=>{if(!C?.publicKey){p.error(t("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(C.publicKey),p.success(t("deploy.ssh.copySuccess"))}catch{p.error(t("deploy.ssh.copyFailed"))}},le=e=>{if(B(e))T(e);else{const n=[];a.gitInit||n.push(t("deploy.steps.gitCheck")),a.sshKeyCopy||n.push(t("deploy.steps.sshConfig")),a.repo||n.push(t("deploy.steps.repoConfig")),a.branch||n.push(t("deploy.steps.branchSelect")),p.warning(t("deploy.navigation.missingSteps",{steps:n.join("、")}))}},oe=O.map(e=>({label:e,value:e})),ie=async e=>{try{J(!0),r(n=>({...n,autoTrigger:e}))}catch{r($=>({...$,autoTrigger:!e}))}finally{J(!1)}},B=e=>{switch(e){case 0:return!0;case 1:return a.gitInit&&a.goInit;case 2:return a.gitInit&&a.goInit&&a.sshKeyCopy;case 3:return a.gitInit&&a.goInit&&a.sshKeyCopy&&a.repo&&m;case 4:return a.gitInit&&a.goInit&&a.sshKeyCopy&&a.repo&&a.branch;default:return!1}},R=[{title:t("deploy.steps.envCheck"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:t("deploy.git.title")}),u&&!x&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{}),s.jsx(o,{children:t("deploy.git.checking")})]}),x?.error&&s.jsx(j,{message:t("deploy.git.installFailed"),description:x.error,type:"error",showIcon:!0,className:"mb-4"}),x?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(E,{className:"text-success"}),s.jsx(o,{children:t("deploy.git.installed")}),s.jsxs(o,{type:"secondary",children:["(",x.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(y,{type:"primary",onClick:te,loading:u,children:t("deploy.git.install")}),s.jsx(y,{onClick:v,children:t("deploy.git.recheck")})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:t("deploy.go.title")}),u&&!g&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{}),s.jsx(o,{children:t("deploy.go.checking")})]}),g?.error&&s.jsx(j,{message:g.version?t("deploy.go.versionMismatch"):t("deploy.go.installFailed"),description:g.error,type:"error",showIcon:!0,className:"mb-4"}),g?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(E,{className:"text-success"}),s.jsx(o,{children:t("deploy.go.installed")}),s.jsxs(o,{type:"secondary",children:["(",g.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(y,{type:"primary",onClick:ne,loading:u,children:g?.version?t("deploy.go.reinstall"):t("deploy.go.install")}),s.jsx(y,{onClick:I,children:t("deploy.go.recheck")})]})]})]})},{title:t("deploy.steps.sshConfig"),content:s.jsxs("div",{className:"py-4",children:[u&&!C&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{}),s.jsx(o,{children:t("deploy.ssh.checking")})]}),C?.publicKey?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(E,{className:"text-success"}),s.jsx(o,{children:t("deploy.ssh.configured")})]}),s.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(o,{strong:!0,children:t("deploy.ssh.publicKey")}),s.jsx(y,{type:"link",icon:s.jsx(xe,{}),onClick:ce,children:t("deploy.ssh.copy")})]}),s.jsx($e,{className:"mb-0 break-all",children:s.jsx(o,{code:!0,children:C.publicKey})})]}),s.jsx(j,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(y,{type:"primary",onClick:ae,loading:u,children:t("deploy.ssh.generate")}),s.jsx(j,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:t("deploy.steps.repoConfig"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(me,{placeholder:t("deploy.repo.inputPlaceholder"),value:a.repo,onChange:e=>{r(n=>({...n,repo:e.target.value})),P(!1)},style:{width:400}}),s.jsx(y,{onClick:re,loading:U,type:m?"default":"primary",icon:m?s.jsx(E,{}):null,children:t(m?"deploy.repo.recheck":"deploy.repo.check")})]}),s.jsx(j,{message:t(m?"deploy.repo.success":"deploy.repo.nextStep"),description:t(m?"deploy.repo.successTip":"deploy.repo.tip"),type:m?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.branchSelect"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(je,{showSearch:!0,style:{width:400},placeholder:t(k?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:oe,value:a.branch,onChange:se,loading:k,disabled:k,filterOption:(e,n)=>(n?.label??"").toLowerCase().includes(e.toLowerCase())}),s.jsx(y,{icon:s.jsx(be,{spin:k}),onClick:ee,disabled:!a.repo,loading:k,children:t("deploy.branch.refresh")})]}),!O.length&&!k&&!a.branch&&s.jsx(j,{message:t("deploy.branch.noBranches"),description:t("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),(O.length>0||a.branch)&&s.jsx(j,{message:t("deploy.branch.nextStep"),description:a.branch?t("deploy.branch.currentBranch",{branch:a.branch}):t("deploy.branch.selectTip"),type:a.branch?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.autoTrigger"),content:s.jsx("div",{className:"py-4 space-y-4",children:Y?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{}),s.jsx(o,{children:t("deploy.autoTrigger.loading")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(ke,{checked:a.autoTrigger,onChange:ie,loading:X}),s.jsx(o,{children:t("deploy.autoTrigger.enable")})]}),s.jsx(o,{type:"secondary",children:t("deploy.autoTrigger.tip")})]})})}],pe=()=>{B(l+1)&&T(l+1)},de=()=>{l>0&&T(l-1)},he=R.map((e,n)=>({key:e.title,title:e.title,disabled:!B(n)})),ye=async()=>{try{D(!0),await d.saveTaskCfg(a),h(a),p.success(t("sys.cicd.saveSuccess"))}catch{}finally{D(!1)}};return s.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[s.jsx(Se,{current:l,items:he,className:"px-6",onChange:le}),s.jsx("div",{className:"flex-1 mt-4 px-6",children:R[l].content}),s.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[l>0&&s.jsx(y,{style:{margin:"0 8px"},onClick:de,children:t("deploy.navigation.prev")}),l<R.length-1&&s.jsx(y,{type:"primary",onClick:pe,disabled:!B(l+1),children:t("deploy.navigation.next")}),l===R.length-1&&s.jsx(y,{type:"primary",onClick:ye,loading:q,children:t("sys.cicd.save")})]})]})},Ve=Object.freeze(Object.defineProperty({__proto__:null,DeploySteps:W,default:W},Symbol.toStringTag,{value:"Module"}));export{W as D,Ve as a,d};

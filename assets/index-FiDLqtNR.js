import{u as ls,a as us,j as a,I as K,b as U}from"./index-CB2BM8Kc.js";import{d as E}from"./deployService-Dva0ibAb.js";import{z as C,c as q,T as Q,E as M,M as B,C as ds,G as fs,H as hs,i as _}from"./vendor-ui-BgnAtmuh.js";import{d as ms,g as gs,r as l}from"./vendor-core-Cler3e7Q.js";import{DeploySteps as ys}from"./DeploySteps-BLw9LOMO.js";import ps from"./EnvConfigModal-3G862JiY.js";import xs from"./LogModal-DtTgJdI0.js";import"./vendor-utils-Dg5_7-NF.js";var X={exports:{}};(function(i,d){(function($,h){i.exports=h()})(ms,function(){var $,h,z=1e3,w=6e4,A=36e5,b=864e5,P=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,j=31536e6,T=2628e6,N=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/,R={years:j,months:T,days:b,hours:A,minutes:w,seconds:z,milliseconds:1,weeks:6048e5},I=function(r){return r instanceof D},H=function(r,n,s){return new D(r,s,n.$l)},S=function(r){return h.p(r)+"s"},V=function(r){return r<0},g=function(r){return V(r)?Math.ceil(r):Math.floor(r)},k=function(r){return Math.abs(r)},p=function(r,n){return r?V(r)?{negative:!0,format:""+k(r)+n}:{negative:!1,format:""+r+n}:{negative:!1,format:""}},D=function(){function r(s,u,c){var o=this;if(this.$d={},this.$l=c,s===void 0&&(this.$ms=0,this.parseFromMilliseconds()),u)return H(s*R[S(u)],this);if(typeof s=="number")return this.$ms=s,this.parseFromMilliseconds(),this;if(typeof s=="object")return Object.keys(s).forEach(function(x){o.$d[S(x)]=s[x]}),this.calMilliseconds(),this;if(typeof s=="string"){var f=s.match(N);if(f){var y=f.slice(2).map(function(x){return x!=null?Number(x):0});return this.$d.years=y[0],this.$d.months=y[1],this.$d.weeks=y[2],this.$d.days=y[3],this.$d.hours=y[4],this.$d.minutes=y[5],this.$d.seconds=y[6],this.calMilliseconds(),this}}return this}var n=r.prototype;return n.calMilliseconds=function(){var s=this;this.$ms=Object.keys(this.$d).reduce(function(u,c){return u+(s.$d[c]||0)*R[c]},0)},n.parseFromMilliseconds=function(){var s=this.$ms;this.$d.years=g(s/j),s%=j,this.$d.months=g(s/T),s%=T,this.$d.days=g(s/b),s%=b,this.$d.hours=g(s/A),s%=A,this.$d.minutes=g(s/w),s%=w,this.$d.seconds=g(s/z),s%=z,this.$d.milliseconds=s},n.toISOString=function(){var s=p(this.$d.years,"Y"),u=p(this.$d.months,"M"),c=+this.$d.days||0;this.$d.weeks&&(c+=7*this.$d.weeks);var o=p(c,"D"),f=p(this.$d.hours,"H"),y=p(this.$d.minutes,"M"),x=this.$d.seconds||0;this.$d.milliseconds&&(x+=this.$d.milliseconds/1e3,x=Math.round(1e3*x)/1e3);var v=p(x,"S"),F=s.negative||u.negative||o.negative||f.negative||y.negative||v.negative,L=f.format||y.format||v.format?"T":"",Y=(F?"-":"")+"P"+s.format+u.format+o.format+L+f.format+y.format+v.format;return Y==="P"||Y==="-P"?"P0D":Y},n.toJSON=function(){return this.toISOString()},n.format=function(s){var u=s||"YYYY-MM-DDTHH:mm:ss",c={Y:this.$d.years,YY:h.s(this.$d.years,2,"0"),YYYY:h.s(this.$d.years,4,"0"),M:this.$d.months,MM:h.s(this.$d.months,2,"0"),D:this.$d.days,DD:h.s(this.$d.days,2,"0"),H:this.$d.hours,HH:h.s(this.$d.hours,2,"0"),m:this.$d.minutes,mm:h.s(this.$d.minutes,2,"0"),s:this.$d.seconds,ss:h.s(this.$d.seconds,2,"0"),SSS:h.s(this.$d.milliseconds,3,"0")};return u.replace(P,function(o,f){return f||String(c[o])})},n.as=function(s){return this.$ms/R[S(s)]},n.get=function(s){var u=this.$ms,c=S(s);return c==="milliseconds"?u%=1e3:u=c==="weeks"?g(u/R[c]):this.$d[c],u||0},n.add=function(s,u,c){var o;return o=u?s*R[S(u)]:I(s)?s.$ms:H(s,this).$ms,H(this.$ms+o*(c?-1:1),this)},n.subtract=function(s,u){return this.add(s,u,!0)},n.locale=function(s){var u=this.clone();return u.$l=s,u},n.clone=function(){return H(this.$ms,this)},n.humanize=function(s){return $().add(this.$ms,"ms").locale(this.$l).fromNow(!s)},n.valueOf=function(){return this.asMilliseconds()},n.milliseconds=function(){return this.get("milliseconds")},n.asMilliseconds=function(){return this.as("milliseconds")},n.seconds=function(){return this.get("seconds")},n.asSeconds=function(){return this.as("seconds")},n.minutes=function(){return this.get("minutes")},n.asMinutes=function(){return this.as("minutes")},n.hours=function(){return this.get("hours")},n.asHours=function(){return this.as("hours")},n.days=function(){return this.get("days")},n.asDays=function(){return this.as("days")},n.weeks=function(){return this.get("weeks")},n.asWeeks=function(){return this.as("weeks")},n.months=function(){return this.get("months")},n.asMonths=function(){return this.as("months")},n.years=function(){return this.get("years")},n.asYears=function(){return this.as("years")},r}(),O=function(r,n,s){return r.add(n.years()*s,"y").add(n.months()*s,"M").add(n.days()*s,"d").add(n.hours()*s,"h").add(n.minutes()*s,"m").add(n.seconds()*s,"s").add(n.milliseconds()*s,"ms")};return function(r,n,s){$=s,h=s().$utils(),s.duration=function(o,f){var y=s.locale();return H(o,{$l:y},f)},s.isDuration=I;var u=n.prototype.add,c=n.prototype.subtract;n.prototype.add=function(o,f){return I(o)?O(this,o,1):u.bind(this)(o,f)},n.prototype.subtract=function(o,f){return I(o)?O(this,o,-1):c.bind(this)(o,f)}}})})(X);var bs=X.exports;const $s=gs(bs);C.extend($s);const Is=()=>{const{t:i}=ls(),d=us(),[$,h]=l.useState([]),[z,w]=l.useState(!1),[A,b]=l.useState(!1),[P,j]=l.useState(!1),[T,N]=l.useState(null),[R,I]=l.useState(!1),[H,S]=l.useState(!1),[V,g]=l.useState(0),[k,p]=l.useState({current:1,pageSize:10,total:0}),[D,O]=l.useState(!1),[r,n]=l.useState(null),[s,u]=l.useState(null),c=l.useRef(null),[o,f]=l.useState(null),[y,x]=l.useState(!1);l.useEffect(()=>{d&&(w(!1),b(!1),N(null),f(null),g(0))},[d]);const v=l.useCallback(async(t,e)=>{if(d)try{S(!0);const m=await E.pageTask(t,e);h(m.items),p(W=>({...W,total:m.total}))}catch{}finally{S(!1)}},[d]),F=l.useCallback(async()=>{if(d){if(c.current?.addr===d.addr){g(c.current.step);return}try{const t=await E.getTaskCfg();if(f(t),!t.gitInit){g(0),b(!1),c.current={addr:d.addr,step:0};return}if(!t.sshKeyCopy){g(1),b(!1),c.current={addr:d.addr,step:1};return}if(!t.repo){g(2),b(!1),c.current={addr:d.addr,step:2};return}if(!t.branch){g(3),b(!1),c.current={addr:d.addr,step:3};return}g(4),b(!0),c.current={addr:d.addr,step:4},N({repoUrl:t.repo,selectedBranch:t.branch})}catch{b(!1),N(null),f(null)}}},[d]),L=l.useCallback(()=>o?o.gitInit&&o.sshKeyCopy&&o.repo&&o.branch:!1,[o]),Y=l.useCallback(()=>o?o.goInit:!1,[o]);l.useEffect(()=>{d&&(F(),p(t=>({...t,current:1})))},[d,F]),l.useEffect(()=>{d&&v(k.current,k.pageSize)},[k.current,k.pageSize,v,d]);const G=l.useCallback(async t=>{try{return await E.getTask(t)}catch{return null}},[]),J=l.useCallback(()=>{if(!$)return null;const t=$.filter(e=>e.status==="running"||e.status==="waiting");return t.length>0?t.sort((e,m)=>C(e.createAt).valueOf()-C(m.createAt).valueOf())[0]:null},[$]);l.useEffect(()=>{const t=J();u(t)},[J]),l.useEffect(()=>{if(!s)return;const e=setInterval(async()=>{const m=await G(s.id);m&&(h(W=>W.map(Z=>Z.id===m.id?m:Z)),D&&r?.id===m.id&&n(m))},3e3);return()=>clearInterval(e)},[s,D,r,G]),l.useEffect(()=>{if($?.some(e=>e.status==="running")??!1){const e=setInterval(()=>{h(m=>[...m])},1e3);return()=>clearInterval(e)}},[$]);const ss=[{title:a.jsx("div",{className:"pl-4",children:i("sys.cicd.deployInfo")}),dataIndex:"gitHash",width:120,align:"left",render:(t,e)=>a.jsxs("div",{className:"flex flex-col pl-4",children:[a.jsx(q,{title:e.gitHash,children:a.jsx("span",{className:"text-sm block w-[120px] text-left",children:e.rb?i("sys.cicd.rollback.to",{hash:e.gitHash?`${e.gitHash.slice(0,7)}...`:"-"}):e.gitHash?`${e.gitHash.slice(0,7)}...`:"-"})}),a.jsx(q,{title:e.commit,children:a.jsx("span",{className:"text-xs text-text-secondary block w-[120px] text-left truncate",children:e.commit||"-"})})]})},{title:i("sys.cicd.deployBranch"),dataIndex:"branch",align:"center",width:100},{title:i("sys.cicd.autoTrigger"),dataIndex:"autoTrigger",align:"center",width:80,render:t=>a.jsx(Q,{color:t?"blue":"orange",children:i(t?"sys.cicd.triggerAuto":"sys.cicd.triggerManual")})},{title:i("sys.cicd.status"),dataIndex:"status",align:"center",width:80,render:(t,e)=>{const m={success:{color:"success",text:e.rb?i("sys.cicd.statusRollbackSuccess"):i("sys.cicd.statusSuccess")},failed:{color:"error",text:e.rb?i("sys.cicd.statusRollbackFailed"):i("sys.cicd.statusFailed")},running:{color:"processing",text:i("sys.cicd.statusRunning")},waiting:{color:"warning",text:e.rb?i("sys.cicd.statusRollbackWaiting"):i("sys.cicd.statusWaiting")},timeout:{color:"error",text:i("sys.cicd.statusTimeout")}};return a.jsx(Q,{color:m[t]?.color||"default",children:m[t]?.text||t})}},{title:i("sys.cicd.createTime"),dataIndex:"createAt",align:"center",width:150,render:t=>C(t).format("YYYY-MM-DD HH:mm:ss")},{title:i("sys.cicd.duration"),key:"duration",align:"center",width:80,render:(t,e)=>e.status==="waiting"?"-":e.status==="running"?C.duration(C().diff(C(e.startAt))).format("HH:mm:ss"):e.status==="success"||e.status==="failed"||e.status==="timeout"?C.duration(C(e.finishAt).diff(C(e.startAt))).format("HH:mm:ss"):"-"},{title:i("sys.cicd.operation"),key:"operation",align:"center",width:100,render:(t,e)=>a.jsxs("div",{className:"flex w-full justify-center text-gray-500",children:[a.jsx(K,{onClick:()=>es(e),disabled:e.status==="waiting",className:e.status==="waiting"?"opacity-50 cursor-not-allowed":"",children:a.jsx(U,{icon:"mdi:file-document-outline",size:18,className:e.status==="waiting"?"text-gray-300":""})}),a.jsx(K,{onClick:()=>cs(e),disabled:e.status!=="running"&&e.status!=="waiting",className:e.status!=="running"&&e.status!=="waiting"?"opacity-50 cursor-not-allowed":"",children:a.jsx(U,{icon:"mdi:stop-circle-outline",size:18,className:e.status==="running"||e.status==="waiting"?"text-error":"text-gray-300"})}),a.jsx(K,{onClick:()=>ns(e),disabled:e.rbStatus!=="ready",className:e.rbStatus!=="ready"?"opacity-50 cursor-not-allowed":"",children:a.jsx(U,{icon:"mdi:backup-restore",size:18,className:e.rbStatus==="ready"?"text-warning":"text-gray-300"})})]})}],ts=()=>{w(!0)},es=t=>{if(!t.log||t.log.length===0){M.warning("暂无日志");return}n(t),O(!0)},ns=t=>{if(t.rbStatus!=="ready"){M.warning(t.rbStatus==="cleaned"?i("sys.cicd.rollback.cleaned"):i("sys.cicd.rollback.notReady"));return}B.confirm({title:i("sys.cicd.rollback.confirmTitle"),content:i("sys.cicd.rollback.confirmContent",{hash:t.gitHash||i("sys.cicd.rollback.unknownVersion")}),onOk:async()=>{try{await E.rollbackTask(t.id),M.success(i("sys.cicd.rollback.success")),p(e=>({...e,current:1})),v(1,k.pageSize)}catch{M.error(i("sys.cicd.rollback.failed"))}}})},is=t=>{f(t),N({repoUrl:t.repo,selectedBranch:t.branch}),b(!0),c.current={addr:d?.addr||"",step:4},w(!1)},as=()=>{j(!0)},rs=async()=>{try{I(!0),await E.startTask(),M.success(i("sys.cicd.runSuccess")),j(!1),p(t=>({...t,current:1})),v(1,k.pageSize)}catch{}finally{I(!1)}},os=t=>{p(t)},cs=t=>{if(t.status!=="running"&&t.status!=="waiting"){M.warning(i("deploy.sys.cicd.stop.notRunning"));return}B.confirm({title:i("deploy.sys.cicd.stop.confirmTitle"),content:i("deploy.sys.cicd.stop.confirmContent"),onOk:async()=>{try{await E.stopTask(t.id),M.success(i("deploy.sys.cicd.stop.success")),p(e=>({...e,current:1})),v(1,k.pageSize)}catch{M.error(i("deploy.sys.cicd.stop.failed"))}}})};return a.jsxs(a.Fragment,{children:[a.jsxs(ds,{title:i("sys.cicd.deployList"),styles:{body:{padding:"0 0px"}},extra:a.jsxs(hs,{children:[a.jsx(_,{type:"primary",onClick:ts,children:i("sys.cicd.deployConfig")}),a.jsx(_,{type:"primary",onClick:()=>x(!0),disabled:!Y(),className:Y()?"":"opacity-50 cursor-not-allowed",children:i("deploy.sys.cicd.env.title")}),a.jsx(_,{type:"primary",onClick:as,disabled:!L(),className:L()?"":"opacity-50 cursor-not-allowed",children:i("sys.cicd.run")})]}),children:[a.jsx(fs,{rowKey:t=>`${t.gitHash}-${t.createAt}`,size:"small",scroll:{x:"max-content"},columns:ss,dataSource:$,loading:H,pagination:{...k,style:{marginRight:"16px"}},onChange:os,className:"w-full max-w-[1000px] mx-auto"}),a.jsx(B,{title:i("sys.cicd.deployConfig"),open:z,onCancel:()=>w(!1),footer:null,width:800,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"},body:{paddingTop:"4px"}},children:a.jsx(ys,{onComplete:is,initialStep:V},d?.addr)}),a.jsx(B,{title:i("sys.cicd.runModal.title"),open:P,onCancel:()=>j(!1),onOk:rs,confirmLoading:R,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"}},children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"font-medium",children:[i("sys.cicd.runModal.repoAddress"),"："]}),a.jsx("div",{className:"text-gray-600",children:T?.repoUrl})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"font-medium",children:[i("sys.cicd.runModal.currentBranch"),"："]}),a.jsx("div",{className:"text-gray-600",children:T?.selectedBranch})]}),a.jsx("div",{className:"text-gray-500",children:i("sys.cicd.runModal.confirmTip")})]})})]}),r&&a.jsx(xs,{record:r,visible:D,onClose:()=>O(!1)}),a.jsx(ps,{visible:y,onClose:()=>x(!1)})]})};export{Is as default};

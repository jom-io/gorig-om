import{u as G,t as m,j as a}from"./index-DBJ8dyql.js";import{s as b}from"./api-sample-modal-CfylE9qr.js";import{C as H}from"./index-DTLun4oy.js";import{u as K,C as V}from"./useChart-D1qVDBM-.js";import{z as T,M as W,G as q,s as j,T as B}from"./vendor-ui-Dp3kvFmo.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import J from"./anomaly-sample-modal-Diugzq5B.js";import{useTimeRange as Q}from"./api-latency-chart-PlJuUv74.js";import"./vendor-utils-DKy5dUqm.js";import"./vendor-charts-C0vSEv4L.js";const h=["error","panic"];function ce({open:l,onClose:C,enabled:y=!0}){const{t:r}=G(),{timeUnit:d,getRange:u,dateLabelFormat:v,renderTimePicker:S}=Q("hour",[T().startOf("day"),T()]),[L,N]=o.useState([]),[M,f]=o.useState([]),[D,x]=o.useState(!1),[E,R]=o.useState(h),[F,w]=o.useState({open:!1,data:null}),I=o.useMemo(()=>[m.colors.palette.error.dark,m.colors.palette.error.default],[]),n=E,A=e=>{w({open:!0,data:e})},U=o.useCallback(e=>{const t=h[e];R(s=>s.includes(t)?s.filter(i=>i!==t):[...s,t])},[]),g=o.useCallback(async e=>{try{const t=u(e),s=await b.errorTimeRange(t.start,t.end,t.apiUnit,h);N(s)}catch{}},[u]),k=o.useCallback(async e=>{if(n.length===0){f([]);return}try{x(!0);const t=u(e),s=await b.errorTop(t.start,t.end,10,n);f(s)}catch{}finally{x(!1)}},[u,n]);o.useEffect(()=>{l&&y&&(g(d),k(d))},[l,y,d,g,k]);const c=L,O=M,z=o.useMemo(()=>{if(!c.length)return[];const e=t=>{switch(t){case"error":return r("sys.workbench.anomalyError");case"panic":return r("sys.workbench.anomalyPanic");default:return t}};return h.map(t=>{const s=c.map(i=>{const $=i.value[t]||0;return{x:Number(i.at)*1e3,y:$}}),p=n.includes(t);return{name:e(t),data:p?s:s.map(i=>({...i,y:null}))}})},[c,n,r]),P=o.useMemo(()=>{if(c.length)return c.reduce((e,t)=>{const s=t.value,p=(s.error||0)+(s.panic||0);return Math.max(e,p)},0)+1},[c]),_=K({colors:I,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:v}},tooltip:{x:{formatter:e=>{switch(d){case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e}`}},yaxis:{labels:{formatter:e=>`${e}`},min:0,max:P},chart:{toolbar:{show:!1},events:{legendClick:(e,t)=>(U(t??0),!1)}},stroke:{curve:"smooth",width:2}});return a.jsxs(W,{title:r("sys.workbench.anomalyTrend"),open:l&&y,onCancel:C,width:850,footer:null,style:{top:"10%"},styles:{body:{padding:"0px"}},maskClosable:!0,destroyOnClose:!0,children:[a.jsxs(H,{className:"flex-col !shadow-none",children:[a.jsxs("header",{className:"flex w-full justify-between items-center mb-4",children:[a.jsx("div",{}),S()]}),a.jsxs("main",{className:"w-full flex flex-col gap-4",children:[a.jsx("div",{className:"w-full",children:a.jsx(V,{type:"area",series:z,options:_,height:360})}),a.jsxs("div",{className:"w-full",children:[a.jsx("div",{className:"flex items-center justify-between mb-2 px-1",children:a.jsxs("div",{className:"flex flex-col",children:[a.jsx("span",{className:"text-base font-medium",style:{color:m.colors.text.primary},children:r("sys.workbench.anomalyTopTitle")}),a.jsx("span",{className:"text-xs",style:{color:m.colors.text.secondary},children:r("sys.workbench.anomalyTopDesc")})]})}),a.jsx(q,{rowKey:e=>e.sigHash,dataSource:O,loading:D,size:"small",pagination:!1,locale:{emptyText:r("sys.workbench.anomalyTopEmpty")},onRow:e=>({onClick:()=>A(e),className:"cursor-pointer"}),columns:[{title:r("sys.workbench.anomalySignature"),dataIndex:"signature",key:"signature",render:(e,t)=>a.jsx(j.Text,{ellipsis:{tooltip:t.signature||t.sampleMsg||t.sampleError},style:{maxWidth:320},children:t.signature||t.sampleMsg||r("sys.workbench.anomalySampleEmpty")})},{title:r("sys.workbench.anomalyCount"),dataIndex:"count",key:"count",align:"right",width:80,render:e=>a.jsx(j.Text,{strong:!0,style:{color:m.colors.palette.error.dark},children:e})},{title:r("sys.workbench.anomalyLevel"),dataIndex:"level",key:"level",width:90,render:e=>{const t=e||(n.length===1?n[0]:"-");return a.jsx(B,{color:m.colors.palette.error.light,children:t?.toUpperCase()})}},{title:r("sys.workbench.anomalyLastSeen"),dataIndex:"lastAt",key:"lastAt",width:180,className:"whitespace-nowrap",render:e=>X(e)}]})]})]})]}),a.jsx(J,{...F,onClose:()=>w(e=>({...e,open:!1}))})]})}const X=l=>l?new Date(Number(l)*1e3).toLocaleString():"--";export{ce as default};

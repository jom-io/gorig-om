import{b as i,u as ne,g as oe,S as A,j as e,s as ie}from"./index-DcyBWYzV.js";import{r as n}from"./vendor-core-Cler3e7Q.js";import{J as K,s as pe,K as k,N as U,i as g,O as de,I as he,t as ye,P as ge,h as ue,Q as fe,z as p}from"./vendor-ui-CJOmdTmk.js";const xe=()=>i.get({url:"/om/deploy/git/check"}),me=()=>i.post({url:"/om/deploy/git/install"}),je=()=>i.post({url:"/om/deploy/ssh/key"}),Se=()=>i.get({url:"/om/deploy/ssh/key"}),ve=l=>i.get({url:"/om/deploy/repository",data:l}),be=l=>i.post({url:"/om/deploy/repository",data:l}),ke=l=>i.get({url:"/om/deploy/branches",params:{repoUrl:l}}),Ce=l=>i.post({url:"/om/deploy/branch",data:{branch:l}}),Te=()=>i.get({url:"/om/deploy/branch"}),Be=l=>i.post({url:"/om/deploy/task/config",data:{autoTrigger:l}}),we=()=>i.get({url:"/om/deploy/task/config"}),Ke=()=>i.post({url:"/om/deploy/task/start"}),Ne=(l,t)=>i.get({url:"/om/deploy/task/page",params:{page:l,size:t}}),Ie=l=>i.get({url:"/om/deploy/task/get",params:{id:l}}),d={checkGitStatus:xe,installGit:me,generateSshKey:je,getSshKey:Se,checkRepository:be,getBranches:ke,getRepository:ve,setBranch:Ce,getBranch:Te,saveTaskCfg:Be,getTaskCfg:we,startTask:Ke,pageTask:Ne,getTask:Ie},{Text:y,Paragraph:Ee}=pe,_=({onComplete:l})=>{const{t}=ne(),[h,x]=n.useState(0),[m,o]=n.useState(!1),[j,B]=n.useState(!1),[C,R]=n.useState(null),[T,L]=n.useState(null),[u,v]=n.useState(!1),[N,b]=n.useState([]),[a,c]=n.useState(()=>oe(A.DEPLOY_STEPS)||{gitInstalled:!1,sshKeyExists:!1,repoUrl:"",selectedBranch:"",autoTrigger:!1}),[S,f]=n.useState(!1),[D,G]=n.useState(!1),[F,P]=n.useState(!1),$=s=>{ie(A.DEPLOY_STEPS,s)};n.useEffect(()=>{$(a)},[a]),n.useEffect(()=>{a.gitInstalled&&a.sshKeyExists&&a.repoUrl&&a.selectedBranch?(x(4),v(!0),f(!0)):a.gitInstalled&&a.sshKeyExists&&a.repoUrl?(x(3),v(!0)):a.gitInstalled&&a.sshKeyExists?x(2):a.gitInstalled&&x(1)},[]);const O=async()=>{try{o(!0);const s=await d.checkGitStatus();R(s),c(r=>({...r,gitInstalled:s.installed}))}catch{}finally{o(!1)}},H=async()=>{try{o(!0);const s=await d.getSshKey();L(s),c(r=>({...r,sshKeyExists:!!s?.publicKey}))}catch{}finally{o(!1)}},z=async()=>{try{const s=await d.getRepository({url:""});s&&(c(r=>({...r,repoUrl:s})),v(!0))}catch{}};n.useEffect(()=>{h===3?M():h===4&&W()},[h]);const M=async()=>{try{B(!0);const s=await d.getBranch();if(s)c(r=>({...r,selectedBranch:s})),f(!0);else{const r=await d.getBranches(a.repoUrl);b(r),r.length>0&&(c(E=>({...E,selectedBranch:r[0]})),f(!1))}}catch{b([]),f(!1),c(r=>({...r,selectedBranch:""}))}finally{B(!1)}},Y=async()=>{if(a.repoUrl)try{B(!0);const s=await d.getBranches(a.repoUrl);b(s),!a.selectedBranch&&s.length>0&&(c(r=>({...r,selectedBranch:s[0]})),f(!1))}catch{b([])}finally{B(!1)}},J=async s=>{c(r=>({...r,selectedBranch:s})),f(!1)},Q=async()=>{if(!a.selectedBranch)return p.warning(t("deploy.branch.selectTip")),!1;try{return o(!0),await d.setBranch(a.selectedBranch),f(!0),p.success(t("deploy.branch.saveSuccess")),!0}catch{return!1}finally{o(!1)}},W=async()=>{try{P(!0);const s=await d.getTaskCfg();c(r=>({...r,autoTrigger:s.autoTrigger}))}catch{}finally{P(!1)}};n.useEffect(()=>{O(),H(),z()},[]);const I=s=>{switch(s){case 0:return!0;case 1:return a.gitInstalled;case 2:return a.gitInstalled&&a.sshKeyExists;case 3:return a.gitInstalled&&a.sshKeyExists&&a.repoUrl&&u;case 4:return a.gitInstalled&&a.sshKeyExists&&a.repoUrl&&u&&S;default:return!1}},q=async()=>{try{o(!0);const s=await d.installGit();if(s.error){p.error(s.error);return}R(s),c(r=>({...r,gitInstalled:!0})),p.success("Git 安装成功")}catch{}finally{o(!1)}},V=async()=>{try{o(!0);const s=await d.generateSshKey();L(s),c(r=>({...r,sshKeyExists:!!s?.publicKey})),p.success("SSH Key 生成成功")}catch{}finally{o(!1)}},X=async()=>{if(!a.repoUrl.startsWith("git@")){p.error(t("deploy.repo.invalidFormat"));return}try{o(!0),await d.checkRepository({url:a.repoUrl}),v(!0),b([]),f(!1),c(s=>({...s,selectedBranch:""})),p.success(t("deploy.repo.saveSuccess"))}catch{v(!1),b([]),f(!1),c(r=>({...r,selectedBranch:""}))}finally{o(!1)}},Z=async()=>{if(!T?.publicKey){p.error(t("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(T.publicKey),p.success(t("deploy.ssh.copySuccess"))}catch{p.error(t("deploy.ssh.copyFailed"))}},ee=s=>{if(I(s))x(s);else{const r=[];a.gitInstalled||r.push(t("deploy.steps.gitCheck")),a.sshKeyExists||r.push(t("deploy.steps.sshConfig")),a.repoUrl||r.push(t("deploy.steps.repoConfig")),a.selectedBranch||r.push(t("deploy.steps.branchSelect")),p.warning(t("deploy.navigation.missingSteps",{steps:r.join("、")}))}},se=N.map(s=>({label:s,value:s})),te=async s=>{try{G(!0),await d.saveTaskCfg(s),c(r=>({...r,autoTrigger:s})),p.success(t("deploy.autoTrigger.saveSuccess"))}catch{c(E=>({...E,autoTrigger:!s}))}finally{G(!1)}},w=[{title:t("deploy.steps.gitCheck"),content:e.jsxs("div",{className:"py-4",children:[m&&!C&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{}),e.jsx(y,{children:t("deploy.git.checking")})]}),C?.error&&e.jsx(k,{message:t("deploy.git.installFailed"),description:C.error,type:"error",showIcon:!0,className:"mb-4"}),C?.installed?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:"text-success"}),e.jsx(y,{children:t("deploy.git.installed")}),e.jsxs(y,{type:"secondary",children:["(",C.version,")"]})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{type:"primary",onClick:q,loading:m,children:t("deploy.git.install")}),e.jsx(g,{onClick:O,children:t("deploy.git.recheck")})]})]})},{title:t("deploy.steps.sshConfig"),content:e.jsxs("div",{className:"py-4",children:[m&&!T&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{}),e.jsx(y,{children:t("deploy.ssh.checking")})]}),T?.publicKey?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:"text-success"}),e.jsx(y,{children:t("deploy.ssh.configured")})]}),e.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(y,{strong:!0,children:t("deploy.ssh.publicKey")}),e.jsx(g,{type:"link",icon:e.jsx(de,{}),onClick:Z,children:t("deploy.ssh.copy")})]}),e.jsx(Ee,{className:"mb-0 break-all",children:e.jsx(y,{code:!0,children:T.publicKey})})]}),e.jsx(k,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(g,{type:"primary",onClick:V,loading:m,children:t("deploy.ssh.generate")}),e.jsx(k,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:t("deploy.steps.repoConfig"),content:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(he,{placeholder:t("deploy.repo.inputPlaceholder"),value:a.repoUrl,onChange:s=>{c(r=>({...r,repoUrl:s.target.value})),v(!1)},style:{width:400}}),e.jsx(g,{onClick:X,loading:m,type:u?"default":"primary",icon:u?e.jsx(U,{}):null,children:t(u?"deploy.repo.recheck":"deploy.repo.check")})]}),e.jsx(k,{message:t(u?"deploy.repo.success":"deploy.repo.nextStep"),description:t(u?"deploy.repo.successTip":"deploy.repo.tip"),type:u?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.branchSelect"),content:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ye,{showSearch:!0,style:{width:400},placeholder:t(j?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:se,value:a.selectedBranch,onChange:J,loading:j,disabled:j,filterOption:(s,r)=>(r?.label??"").toLowerCase().includes(s.toLowerCase())}),e.jsx(g,{icon:e.jsx(ge,{spin:j}),onClick:Y,disabled:!u,loading:j,children:t("deploy.branch.refresh")}),e.jsx(g,{type:"primary",onClick:Q,loading:m,disabled:!a.selectedBranch||S,children:t(S?"deploy.branch.saved":"deploy.branch.save")})]}),!N.length&&!j&&!S&&e.jsx(k,{message:t("deploy.branch.noBranches"),description:t("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),(N.length>0||S)&&e.jsx(k,{message:t("deploy.branch.nextStep"),description:S?t("deploy.branch.currentBranch",{branch:a.selectedBranch}):t("deploy.branch.selectTip"),type:S?"success":"info",showIcon:!0}),j&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{}),e.jsx(y,{children:t("deploy.branch.loadingBranches")})]})]})},{title:t("deploy.steps.autoTrigger"),content:e.jsx("div",{className:"py-4 space-y-4",children:F?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{}),e.jsx(y,{children:t("deploy.autoTrigger.loading")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{checked:a.autoTrigger,onChange:te,loading:D}),e.jsx(y,{children:t("deploy.autoTrigger.enable")})]}),e.jsx(y,{type:"secondary",children:t("deploy.autoTrigger.tip")})]})})}],ae=()=>{x(h+1)},re=()=>{x(h-1)},ce=w.map((s,r)=>({key:s.title,title:s.title,disabled:!I(r)})),le=async()=>{try{o(!0),await d.saveTaskCfg(a.autoTrigger),l(a)}catch{p.error(t("deploy.navigation.saveFailed"))}finally{o(!1)}};return e.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[e.jsx(fe,{current:h,items:ce,className:"px-6",onChange:ee}),e.jsx("div",{className:"flex-1 mt-4 px-6",children:w[h].content}),e.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[h>0&&e.jsx(g,{style:{margin:"0 8px"},onClick:re,children:t("deploy.navigation.prev")}),h<w.length-1&&e.jsx(g,{type:"primary",onClick:ae,disabled:!I(h+1),children:t("deploy.navigation.next")}),h===w.length-1&&e.jsx(g,{type:"primary",onClick:le,loading:m,children:t("deploy.navigation.complete")})]})]})},Ge=Object.freeze(Object.defineProperty({__proto__:null,DeploySteps:_,default:_},Symbol.toStringTag,{value:"Module"}));export{_ as D,Ge as a,d};

import{u as q,g as Q,S as X,j as i,I as _,a as W}from"./index-DcyBWYzV.js";import{d as F,D as tt}from"./DeploySteps-DUekpAVJ.js";import{z as Y,E as $,c as G,T as K,M as V,C as st,G as et,H as nt,i as J}from"./vendor-ui-CJOmdTmk.js";import{d as it,g as at,r as u}from"./vendor-core-Cler3e7Q.js";import rt from"./LogModal-BcPFpqe4.js";import"./vendor-utils-MXilNKRg.js";var Z={exports:{}};(function(l,b){(function(w,f){l.exports=f()})(it,function(){var w,f,C=1e3,j=6e4,M=36e5,N=864e5,T=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,k=31536e6,R=2628e6,z=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/,v={years:k,months:R,days:N,hours:M,minutes:j,seconds:C,milliseconds:1,weeks:6048e5},H=function(r){return r instanceof E},S=function(r,e,t){return new E(r,t,e.$l)},g=function(r){return f.p(r)+"s"},I=function(r){return r<0},p=function(r){return I(r)?Math.ceil(r):Math.floor(r)},B=function(r){return Math.abs(r)},x=function(r,e){return r?I(r)?{negative:!0,format:""+B(r)+e}:{negative:!1,format:""+r+e}:{negative:!1,format:""}},E=function(){function r(t,a,c){var o=this;if(this.$d={},this.$l=c,t===void 0&&(this.$ms=0,this.parseFromMilliseconds()),a)return S(t*v[g(a)],this);if(typeof t=="number")return this.$ms=t,this.parseFromMilliseconds(),this;if(typeof t=="object")return Object.keys(t).forEach(function(y){o.$d[g(y)]=t[y]}),this.calMilliseconds(),this;if(typeof t=="string"){var d=t.match(z);if(d){var h=d.slice(2).map(function(y){return y!=null?Number(y):0});return this.$d.years=h[0],this.$d.months=h[1],this.$d.weeks=h[2],this.$d.days=h[3],this.$d.hours=h[4],this.$d.minutes=h[5],this.$d.seconds=h[6],this.calMilliseconds(),this}}return this}var e=r.prototype;return e.calMilliseconds=function(){var t=this;this.$ms=Object.keys(this.$d).reduce(function(a,c){return a+(t.$d[c]||0)*v[c]},0)},e.parseFromMilliseconds=function(){var t=this.$ms;this.$d.years=p(t/k),t%=k,this.$d.months=p(t/R),t%=R,this.$d.days=p(t/N),t%=N,this.$d.hours=p(t/M),t%=M,this.$d.minutes=p(t/j),t%=j,this.$d.seconds=p(t/C),t%=C,this.$d.milliseconds=t},e.toISOString=function(){var t=x(this.$d.years,"Y"),a=x(this.$d.months,"M"),c=+this.$d.days||0;this.$d.weeks&&(c+=7*this.$d.weeks);var o=x(c,"D"),d=x(this.$d.hours,"H"),h=x(this.$d.minutes,"M"),y=this.$d.seconds||0;this.$d.milliseconds&&(y+=this.$d.milliseconds/1e3,y=Math.round(1e3*y)/1e3);var O=x(y,"S"),L=t.negative||a.negative||o.negative||d.negative||h.negative||O.negative,P=d.format||h.format||O.format?"T":"",s=(L?"-":"")+"P"+t.format+a.format+o.format+P+d.format+h.format+O.format;return s==="P"||s==="-P"?"P0D":s},e.toJSON=function(){return this.toISOString()},e.format=function(t){var a=t||"YYYY-MM-DDTHH:mm:ss",c={Y:this.$d.years,YY:f.s(this.$d.years,2,"0"),YYYY:f.s(this.$d.years,4,"0"),M:this.$d.months,MM:f.s(this.$d.months,2,"0"),D:this.$d.days,DD:f.s(this.$d.days,2,"0"),H:this.$d.hours,HH:f.s(this.$d.hours,2,"0"),m:this.$d.minutes,mm:f.s(this.$d.minutes,2,"0"),s:this.$d.seconds,ss:f.s(this.$d.seconds,2,"0"),SSS:f.s(this.$d.milliseconds,3,"0")};return a.replace(T,function(o,d){return d||String(c[o])})},e.as=function(t){return this.$ms/v[g(t)]},e.get=function(t){var a=this.$ms,c=g(t);return c==="milliseconds"?a%=1e3:a=c==="weeks"?p(a/v[c]):this.$d[c],a||0},e.add=function(t,a,c){var o;return o=a?t*v[g(a)]:H(t)?t.$ms:S(t,this).$ms,S(this.$ms+o*(c?-1:1),this)},e.subtract=function(t,a){return this.add(t,a,!0)},e.locale=function(t){var a=this.clone();return a.$l=t,a},e.clone=function(){return S(this.$ms,this)},e.humanize=function(t){return w().add(this.$ms,"ms").locale(this.$l).fromNow(!t)},e.valueOf=function(){return this.asMilliseconds()},e.milliseconds=function(){return this.get("milliseconds")},e.asMilliseconds=function(){return this.as("milliseconds")},e.seconds=function(){return this.get("seconds")},e.asSeconds=function(){return this.as("seconds")},e.minutes=function(){return this.get("minutes")},e.asMinutes=function(){return this.as("minutes")},e.hours=function(){return this.get("hours")},e.asHours=function(){return this.as("hours")},e.days=function(){return this.get("days")},e.asDays=function(){return this.as("days")},e.weeks=function(){return this.get("weeks")},e.asWeeks=function(){return this.as("weeks")},e.months=function(){return this.get("months")},e.asMonths=function(){return this.as("months")},e.years=function(){return this.get("years")},e.asYears=function(){return this.as("years")},r}(),D=function(r,e,t){return r.add(e.years()*t,"y").add(e.months()*t,"M").add(e.days()*t,"d").add(e.hours()*t,"h").add(e.minutes()*t,"m").add(e.seconds()*t,"s").add(e.milliseconds()*t,"ms")};return function(r,e,t){w=t,f=t().$utils(),t.duration=function(o,d){var h=t.locale();return S(o,{$l:h},d)},t.isDuration=H;var a=e.prototype.add,c=e.prototype.subtract;e.prototype.add=function(o,d){return H(o)?D(this,o,1):a.bind(this)(o,d)},e.prototype.subtract=function(o,d){return H(o)?D(this,o,-1):c.bind(this)(o,d)}}})})(Z);var ot=Z.exports;const ct=at(ot);$.extend(ct);const gt=()=>{const{t:l}=q(),[b,w]=u.useState([]),[f,C]=u.useState(!1),[j,M]=u.useState(!1),[N,T]=u.useState(!1),[k,R]=u.useState(null),[z,v]=u.useState(!1),[H,S]=u.useState(!1),[g,I]=u.useState({current:1,pageSize:10,total:0}),[p,B]=u.useState(!1),[x,E]=u.useState(null),[D,r]=u.useState(null);u.useEffect(()=>{const s=Q(X.DEPLOY_STEPS);if(s){const n=!!(s.gitInstalled&&s.sshKeyExists&&s.repoUrl&&s.selectedBranch);M(n),R({repoUrl:s.repoUrl,selectedBranch:s.selectedBranch})}},[]);const e=u.useCallback(async(s,n)=>{try{S(!0);const m=await F.pageTask(s,n);w(m.items),I(A=>({...A,total:m.total}))}catch{Y.error("获取部署记录失败")}finally{S(!1)}},[]),t=u.useCallback(async s=>{try{return await F.getTask(s)}catch{return null}},[]);u.useEffect(()=>{e(g.current,g.pageSize)},[g.current,g.pageSize,e]);const a=u.useCallback(()=>{const s=b.filter(n=>n.status==="running"||n.status==="waiting");return s.length>0?s.sort((n,m)=>$(n.createAt).valueOf()-$(m.createAt).valueOf())[0]:null},[b]);u.useEffect(()=>{const s=a();r(s)},[a]),u.useEffect(()=>{if(!D)return;const n=setInterval(async()=>{const m=await t(D.id);m&&(w(A=>A.map(U=>U.id===m.id?m:U)),p&&x?.id===m.id&&E(m))},3e3);return()=>clearInterval(n)},[D,p,x,t]),u.useEffect(()=>{if(b?.some(n=>n.status==="running")??!1){const n=setInterval(()=>{w(m=>[...m])},1e3);return()=>clearInterval(n)}},[b]);const c=[{title:l("sys.cicd.deployInfo"),dataIndex:"gitHash",width:120,render:(s,n)=>i.jsxs("div",{className:"flex flex-col",children:[i.jsx(G,{title:n.gitHash,children:i.jsx("span",{className:"text-sm",children:n.gitHash?`${n.gitHash.slice(0,7)}...`:"-"})}),i.jsx(G,{title:n.commit,children:i.jsx("span",{className:"text-xs text-text-secondary truncate max-w-[120px]",children:n.commit||"-"})})]})},{title:l("sys.cicd.deployBranch"),dataIndex:"branch",align:"center",width:100},{title:l("sys.cicd.autoTrigger"),dataIndex:"autoTrigger",align:"center",width:80,render:s=>i.jsx(K,{color:s?"success":"default",children:l(s?"sys.common.yes":"sys.common.no")})},{title:l("sys.cicd.status"),dataIndex:"status",align:"center",width:80,render:s=>{const n={success:{color:"success",text:l("sys.cicd.statusSuccess")},failed:{color:"error",text:l("sys.cicd.statusFailed")},running:{color:"processing",text:l("sys.cicd.statusRunning")},waiting:{color:"warning",text:l("sys.cicd.statusWaiting")},timeout:{color:"error",text:l("sys.cicd.statusTimeout")}};return i.jsx(K,{color:n[s]?.color||"default",children:n[s]?.text||s})}},{title:l("sys.cicd.createTime"),dataIndex:"createAt",align:"center",width:150,render:s=>$(s).format("YYYY-MM-DD HH:mm:ss")},{title:l("sys.cicd.duration"),key:"duration",align:"center",width:80,render:(s,n)=>n.status==="waiting"?"-":n.status==="running"?$.duration($().diff($(n.startAt))).format("HH:mm:ss"):n.status==="success"||n.status==="failed"||n.status==="timeout"?$.duration($(n.finishAt).diff($(n.startAt))).format("HH:mm:ss"):"-"},{title:l("sys.cicd.operation"),key:"operation",align:"center",width:100,render:(s,n)=>i.jsxs("div",{className:"flex w-full justify-center text-gray-500",children:[i.jsx(_,{onClick:()=>d(n),disabled:n.status==="waiting",className:n.status==="waiting"?"opacity-50 cursor-not-allowed":"",children:i.jsx(W,{icon:"mdi:file-document-outline",size:18,className:n.status==="waiting"?"text-gray-300":""})}),i.jsx(_,{onClick:()=>h(n),disabled:n.rbStatus!=="ready",className:n.rbStatus!=="ready"?"opacity-50 cursor-not-allowed":"",children:i.jsx(W,{icon:"mdi:backup-restore",size:18,className:n.rbStatus==="ready"?"text-warning":"text-gray-300"})})]})}],o=()=>{C(!0)},d=s=>{if(!s.log||s.log.length===0){Y.warning("暂无日志");return}E(s),B(!0)},h=s=>{if(s.rbStatus!=="ready"){Y.warning(s.rbStatus==="cleaned"?"该版本文件已被清理，无法回滚":"当前状态无法回滚");return}V.confirm({title:"确认回滚",content:`确定要回滚到版本 ${s.gitHash||"未知版本"} 吗？`,onOk:()=>{Y.success("回滚操作已提交")}})},y=s=>{R({repoUrl:s.repoUrl,selectedBranch:s.selectedBranch}),M(!0),Y.success("配置已保存"),C(!1)},O=()=>{T(!0)},L=async()=>{try{v(!0),await F.startTask(),Y.success("部署任务已启动"),T(!1),I(s=>({...s,current:1})),e(1,g.pageSize)}catch{}finally{v(!1)}},P=s=>{I(s)};return i.jsxs(i.Fragment,{children:[i.jsxs(st,{title:l("sys.cicd.deployList"),extra:i.jsxs(nt,{children:[i.jsx(J,{type:"primary",onClick:o,children:l("sys.cicd.deployConfig")}),i.jsx(J,{type:"primary",onClick:O,disabled:!j,className:j?"":"opacity-50 cursor-not-allowed",children:l("sys.cicd.run")})]}),children:[i.jsx(et,{rowKey:s=>`${s.gitHash}-${s.createAt}`,size:"small",scroll:{x:"max-content"},columns:c,dataSource:b,loading:H,pagination:g,onChange:P,className:"w-full max-w-[1000px] mx-auto"}),i.jsx(V,{title:"配置部署流程",open:f,onCancel:()=>C(!1),footer:null,width:800,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"}},children:i.jsx(tt,{onComplete:y})}),i.jsx(V,{title:"确认运行部署",open:N,onCancel:()=>T(!1),onOk:L,confirmLoading:z,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"}},children:i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{children:[i.jsx("div",{className:"font-medium",children:"远程仓库地址："}),i.jsx("div",{className:"text-gray-600",children:k?.repoUrl})]}),i.jsxs("div",{children:[i.jsx("div",{className:"font-medium",children:"当前分支："}),i.jsx("div",{className:"text-gray-600",children:k?.selectedBranch})]}),i.jsx("div",{className:"text-gray-500",children:"确认要开始部署吗？部署过程可能需要一些时间。"})]})})]}),x&&i.jsx(rt,{record:x,visible:p,onClose:()=>B(!1)})]})};export{gt as default};

import{J as _,K as ne,N as le,b as C,O as ce,P as de,u as ge,j as s}from"./index-DcyBWYzV.js";import{Q as ue,u as me}from"./useBaseQuery-B0exdZvM.js";import{A as G,F as y,E as c,H,C as W,U as he,V as w,t as S,T as fe,I,ac as ye,i as v,M as X,ad as pe,n as xe}from"./vendor-ui-CJOmdTmk.js";import{r as g}from"./vendor-core-Cler3e7Q.js";import{LogList as Z}from"./log-list-kMJ8lTNp.js";import"./vendor-utils-MXilNKRg.js";var Pe=class extends ue{constructor(r,m){super(r,m)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(r,m){super.setOptions({...r,behavior:_()},m)}getOptimisticResult(r){return r.behavior=_(),super.getOptimisticResult(r)}fetchNextPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"backward"}}})}createResult(r,m){const{state:b}=r,k=super.createResult(r,m),{isFetching:F,isRefetching:a,isError:h,isRefetchError:T}=k,p=b.fetchMeta?.fetchMore?.direction,x=h&&p==="forward",f=F&&p==="forward",P=h&&p==="backward",L=F&&p==="backward";return{...k,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:le(m,b.data),hasPreviousPage:ne(m,b.data),isFetchNextPageError:x,isFetchingNextPage:f,isFetchPreviousPageError:P,isFetchingPreviousPage:L,isRefetchError:T&&!x&&!P,isRefetching:a&&!f&&!L}}};function we(r,m){return me(r,Pe)}const be=r=>C.post({url:"/om/log/search",data:r}),je=()=>C.get({url:"/om/log/categories"}),ve=()=>C.get({url:"/om/log/levels"}),Ce=r=>C.get({url:"/om/log/near",params:r}),ke=r=>C.get({url:"/om/log/download",params:{path:r},responseType:"blob"}),D={getLogList:be,getCategories:je,getLevels:ve,getNearLogs:Ce,downloadLog:ke};function De(){const{message:r}=G.useApp(),[m,b]=g.useState([]),[k,F]=g.useState([]),[a]=y.useForm(),[h,T]=g.useState(null),[p,x]=g.useState(!1),[f,P]=g.useState(!1),[L,Q]=g.useState(null),M=g.useRef(null),V=ce(),[j,O]=g.useState(!1),[ee,q]=g.useState(!1),[d,se]=g.useState([]),R=de(),{t:o}=ge(),A=(e,t)=>{t.stopPropagation(),X.confirm({title:o("sys.log.downloadConfirm"),content:o("sys.log.downloadConfirmContent"),onOk:async()=>{try{const i=await fetch(`${R?.addr}/om/log/download?path=${e}`,{headers:{Authorization:`Bearer ${R?.token}`}});if(!i.ok)throw new Error("下载失败");const n=await i.blob(),l=window.URL.createObjectURL(n),u=document.createElement("a");u.href=l,u.download=e.split("/").pop()||"logfile",document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(l)}catch{r.error(o("sys.log.downloadFailed"))}}})},N=async(e,t,i)=>{if(i.stopPropagation(),!(t<=0))try{const n=await D.getNearLogs({path:e,line:t,range:10});n.forEach(l=>{l.line===t&&(l.highlight=!0)}),se(n),q(!0)}catch{r.error(o("sys.log.contextLogFailed"))}};g.useEffect(()=>{a.setFieldsValue({startTime:c().startOf("day"),timeRange:[c().startOf("day"),c()]}),(async()=>{const t=await D.getCategories(),i=await D.getLevels();b(t),F(i)})()},[a]);const{data:te,fetchNextPage:K,hasNextPage:U,isFetchingNextPage:$}=we({queryKey:["logs",h],queryFn:async({pageParam:e={lastPath:void 0,lastLine:void 0}})=>{try{if(p)return[];x(!0);const t=h,i={...t,startTime:t?.startTime?c(t.startTime).format("YYYY-MM-DD HH:mm:ss"):void 0,endTime:t?.endTime?c(t.endTime).format("YYYY-MM-DD HH:mm:ss"):void 0},n=await D.getLogList({...i,lastPath:e.lastPath,lastLine:e.lastLine,size:50});return await new Promise(l=>setTimeout(l,200)),!n||n.length===0?[]:n}catch{return[]}finally{x(!1)}},getNextPageParam:e=>{if(!e||e.length===0)return;const t=e[e.length-1];return{lastPath:t.path,lastLine:t.line}},initialPageParam:void 0,enabled:h!==null&&!f,retry:1,retryDelay:1e3,onError:()=>{x(!1)}}),re=te?.pages.flat()??[];g.useEffect(()=>{const e=new IntersectionObserver(t=>{if(t[0]?.isIntersecting&&U&&!$){if(f)return;K()}},{threshold:.5});return M.current&&e.observe(M.current),()=>{e.disconnect()}},[U,$,K]);const ae=async()=>{if(f)L?.close(),P(!1),O(!1),r.success(o("sys.log.monitorStopped"));else{V.setQueryData(["logs",h],{pages:[],pageParams:[]});const{timeRange:e,...t}={categories:a.getFieldValue("categories"),level:a.getFieldValue("level"),keyword:a.getFieldValue("keyword"),traceID:a.getFieldValue("traceID"),startTime:a.getFieldValue("startTime"),endTime:a.getFieldValue("endTime"),token:R?.token},i=Object.entries(t).filter(([l,u])=>u!==void 0).reduce((l,[u,E])=>(l[u]=E,l),{}),n=new EventSource(`${R?.addr}/om/log/monitor?${new URLSearchParams(i).toString()}`);n.onmessage=l=>{if(l.data==="monitoring started")r.success(o("sys.log.monitorStarted"));else if(l.data==="monitoring stopped")r.success(o("sys.log.monitorStopped")),n.close();else{const u=JSON.parse(l.data);V.setQueryData(["logs",h],E=>{const ie=E?.pages||[];return{pages:[[u,...ie.flat()]],pageParams:[]}})}},n.onerror=()=>{n.close(),P(!1),r.error(o("sys.log.monitorFailed")),O(!1)},Q(n),P(!0),x(!1),O(!0)}},z=(e,t)=>{t.stopPropagation(),a.setFieldsValue({traceID:e}),T(i=>({...i,traceID:e})),Y()},oe=()=>{a.resetFields(),a.setFieldsValue({startTime:c().startOf("day"),timeRange:[c().startOf("day"),c()]})},Y=async()=>{if(!f&&!p)try{const{timeRange:e,...t}=a.getFieldsValue();await V.resetQueries({queryKey:["logs",t]}),T(t)}catch{x(!1)}},B=e=>{e.key==="Enter"&&Y()},J=(e,t)=>{t.stopPropagation();const i=c(e).format("YYYY-MM-DD HH:mm:ss"),n=a.getFieldValue("startTime"),l=a.getFieldValue("endTime");n?l?a.setFieldsValue({timeRange:[c(n),c(i)],endTime:i}):a.setFieldsValue({timeRange:[c(n),c(i)],endTime:i}):a.setFieldsValue({timeRange:[c(i),l?c(l):null],startTime:i})};return s.jsxs(G,{children:[s.jsxs(H,{direction:"vertical",size:"small",className:"w-full",children:[s.jsx(W,{children:s.jsxs(y,{form:a,onFinish:Y,children:[s.jsxs(he,{gutter:[16,16],style:{fontSize:"12px",lineHeight:"16px"},children:[s.jsx(w,{span:24,lg:6,children:s.jsx(y.Item,{label:o("sys.log.category"),name:"categories",className:"!mb-0",children:s.jsx(S,{mode:"multiple",allowClear:!0,disabled:j,children:m.map(e=>s.jsx(S.Option,{value:e,children:e},e))})})}),s.jsx(w,{span:24,lg:6,children:s.jsx(y.Item,{label:o("sys.log.level"),name:"level",className:"!mb-0",children:s.jsx(S,{allowClear:!0,disabled:j,children:k.map(e=>s.jsx(S.Option,{value:e,children:s.jsx(fe,{color:e==="error"||e==="fatal"?"error":e==="warn"?"warning":"success",children:e})},e))})})}),s.jsx(w,{span:24,lg:6,children:s.jsx(y.Item,{label:o("sys.log.keyword"),name:"keyword",className:"!mb-0",children:s.jsx(I,{placeholder:o("sys.log.keywordPlaceholder"),allowClear:!0,onKeyPress:B,disabled:j})})}),s.jsx(w,{span:24,lg:6,children:s.jsx(y.Item,{label:o("sys.log.traceID"),name:"traceID",className:"!mb-0",children:s.jsx(I,{placeholder:o("sys.log.traceIDPlaceholder"),allowClear:!0,onKeyPress:B,disabled:j})})}),s.jsx(w,{span:24,lg:12,children:s.jsx(y.Item,{label:o("sys.log.timeRange"),name:"timeRange",className:"!mb-0",children:s.jsx(ye.RangePicker,{showTime:!0,style:{width:"100%"},disabled:j,disabledDate:e=>e&&e>c().endOf("day"),onChange:e=>{e?a.setFieldsValue({startTime:e[0]?.format("YYYY-MM-DD HH:mm:ss"),endTime:e[1]?.format("YYYY-MM-DD HH:mm:ss")}):a.setFieldsValue({startTime:void 0,endTime:void 0})}})})}),s.jsx(w,{span:24,children:s.jsxs("div",{className:"flex justify-end",children:[s.jsx(v,{onClick:oe,children:o("sys.log.reset")}),s.jsx(v,{type:"primary",className:"ml-4",htmlType:"submit",loading:p,disabled:f,children:o("sys.log.search")}),s.jsx(v,{type:"primary",className:"ml-4",onClick:ae,children:o(f?"sys.log.stopMonitor":"sys.log.startMonitor")})]})})]}),s.jsx(y.Item,{name:"startTime",hidden:!0,children:s.jsx(I,{})}),s.jsx(y.Item,{name:"endTime",hidden:!0,children:s.jsx(I,{})})]})}),s.jsxs(W,{children:[s.jsx(Z,{dataSource:re,keyword:h?.keyword,onTraceIDClick:z,onLineNumberClick:N,onFileClick:A,onTimeClick:J}),s.jsx("div",{ref:M,style:{height:20}})]})]}),s.jsx(X,{title:o("sys.log.contextLog"),open:ee,onCancel:()=>q(!1),footer:s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"8px"},children:[s.jsx(v,{onClick:e=>{d&&d.length>0&&N(d[0].path,d[0].line,e)},disabled:!d||d.length===0,children:s.jsxs(H,{children:[s.jsx(pe,{}),o("sys.log.prevPage")]})}),s.jsx(v,{onClick:e=>{if(d&&d.length>0){const t=d[d.length-1];N(t.path,t.line,e)}},disabled:!d||d.length===0,children:s.jsxs(H,{children:[o("sys.log.nextPage"),s.jsx(xe,{})]})})]}),width:1e3,styles:{body:{height:"75vh",padding:"24px",overflow:"hidden"},content:{height:"100%"}},children:s.jsx("div",{style:{height:"100%",overflow:"auto"},children:s.jsx(Z,{dataSource:d,keyword:h?.keyword,onTraceIDClick:z,onLineNumberClick:N,onFileClick:A,onTimeClick:J})})})]})}export{De as default};

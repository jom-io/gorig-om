import{u as U,F as q,j as i,E as A}from"./index-HWvyI2US.js";import{a as G}from"./vendor-utils-DG9TG-F2.js";import{r as n}from"./vendor-core-Cler3e7Q.js";import{s as Y,T as S,af as K,i as T,C as Q,ag as H,G as V,M as W,I as X,H as ee}from"./vendor-ui-Bdifwvp0.js";const te="https://ssl-checker.zoel-du.workers.dev/?host=";async function re(r){const m=`${te}${r}`,{data:l}=await G.get(m,{timeout:1e4});return l.result}const y="certificateCache",{Text:_}=Y;function se(r){try{return new URL(r).hostname}catch{return null}}function u(r){return Array.isArray(r)?r:[]}function ce(){const{t:r}=U(),m=q(),[l,p]=n.useState([]),[$,h]=n.useState([]),[D,I]=n.useState(!1),[R,F]=n.useState(null),O=n.useRef(r("sys.certificate.fetchFailed")),s=n.useRef(null),[z,b]=n.useState(!1),L=n.useRef(!1),[k,w]=n.useState(!1),[M,E]=n.useState(""),N=n.useRef(null);n.useEffect(()=>{O.current=r("sys.certificate.fetchFailed")},[r]),n.useEffect(()=>{try{const t=localStorage.getItem(y);if(t){const e=JSON.parse(t);s.current=e,e.domains&&p(u(e.domains)),e.results&&h(u(e.results)),e.lastFetched&&F(new Date(e.lastFetched))}}catch{}finally{b(!0)}},[]),n.useEffect(()=>{if(L.current||!z||u(s.current?.domains).length>0||s.current?.seededFromServers||l.length>0)return;const t=m.map(a=>se(a.addr)).filter(Boolean);if(t.length===0)return;const d=Array.from(new Set(t)).map(a=>({host:a,source:"server",createdAt:Date.now()}));p(d),s.current={domains:d,seededFromServers:!0},localStorage.setItem(y,JSON.stringify({domains:d,lastFetched:s.current?.lastFetched,results:s.current?.results,seededFromServers:!0})),L.current=!0},[m,l.length,z]);const v=n.useCallback(t=>u(t).map(e=>({key:`${e.host}-${e.source}`,name:e.host,addr:e.host,host:e.host})),[]),g=n.useMemo(()=>v(l),[l,v]),C=n.useCallback(t=>{const e={domains:u(l),lastFetched:t.lastFetched??s.current?.lastFetched,results:t.results??u(s.current?.results),seededFromServers:t.seededFromServers??s.current?.seededFromServers??!1};s.current=e,localStorage.setItem(y,JSON.stringify(e))},[l]),x=n.useCallback(async t=>{const e=u(t??l),d=v(e);if(d.length===0){h([]),C({results:[],lastFetched:void 0});return}h([]),I(!0);try{const a=[];for(const o of d)try{const c=await re(o.host),j=typeof c.cert_valid=="boolean"?c.cert_valid:c.cert_exp===!1?!0:void 0;a.push({key:o.key,name:o.name,addr:o.addr,host:o.host,ip:c.resolved_ip,valid:j,validFrom:c.valid_from,validTill:c.valid_till,vendor:c.issuer_o||c.issuer_cn})}catch(c){const j=typeof c=="string"?c:c?.message||O.current;a.push({key:o.key,name:o.name,addr:o.addr,host:o.host,error:j})}h(a);const f=new Date;F(f),C({results:a,lastFetched:f.toISOString()})}finally{I(!1)}},[l,v,C]);n.useEffect(()=>{if(g.length===0)return;const t=s.current,e=o=>{if(!o)return!1;const c=new Date;return o.getFullYear()===c.getFullYear()&&o.getMonth()===c.getMonth()&&o.getDate()===c.getDate()},d=(t?.domains||[]).map(o=>o.host).sort().join(","),a=l.map(o=>o.host).sort().join(","),f=d===a;if(t?.results&&t.lastFetched&&e(new Date(t.lastFetched))&&f){h(t.results),F(new Date(t.lastFetched));return}x()},[g.length,l,x]);const Z=()=>{w(!0),E("")};n.useEffect(()=>{k&&setTimeout(()=>N.current?.focus(),50)},[k]);const P=()=>{const t=M.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!t){A.error(r("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(t)){A.error(r("sys.certificate.domainInvalid"));return}if(l.some(f=>f.host.toLowerCase()===t.toLowerCase())){A.warning(r("sys.certificate.domainExists"));return}const a=[...l,{host:t,source:"custom",createdAt:Date.now()}];p(a),s.current={...s.current,domains:a,seededFromServers:s.current?.seededFromServers??!0},localStorage.setItem(y,JSON.stringify({domains:a,lastFetched:s.current?.lastFetched,results:s.current?.results,seededFromServers:s.current?.seededFromServers??!0})),w(!1),E(""),x(a)},J=t=>{const e=l.filter(a=>a.host!==t);p(e);const d={domains:u(e),lastFetched:s.current?.lastFetched,results:u(s.current?.results).filter(a=>a.host!==t),seededFromServers:s.current?.seededFromServers??!0};s.current=d,localStorage.setItem(y,JSON.stringify(d)),h(a=>a.filter(f=>f.host!==t))},B=[{title:r("sys.certificate.api"),dataIndex:"addr",key:"addr",render:(t,e)=>i.jsx(_,{className:"font-medium",children:e.addr})},{title:r("sys.certificate.ip"),dataIndex:"ip",key:"ip",render:(t,e)=>e.error?"-":e.ip||"-"},{title:r("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",render:(t,e)=>e.error?"-":e.vendor||"-"},{title:r("sys.certificate.valid"),dataIndex:"valid",key:"valid",render:(t,e)=>e.error?i.jsx(S,{color:"default",children:r("sys.certificate.unknown")}):e.valid===void 0?i.jsx(S,{color:"default",children:r("sys.certificate.unknown")}):e.valid?i.jsx(S,{color:"success",children:r("sys.certificate.validTag")}):i.jsx(S,{color:"error",children:r("sys.certificate.invalidTag")})},{title:r("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",render:(t,e)=>e.error?"-":e.validFrom||"-"},{title:r("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",render:(t,e)=>e.error?"-":e.validTill||"-"},{title:r("sys.certificate.remark"),dataIndex:"error",key:"error",render:(t,e)=>e.error?i.jsx(_,{type:"danger",children:e.error}):"-"},{title:r("sys.certificate.operation"),key:"operation",render:(t,e)=>i.jsx(K,{title:r("sys.certificate.deleteConfirm"),onConfirm:()=>J(e.host),children:i.jsx(T,{type:"link",danger:!0,children:r("sys.certificate.delete")})})}];return i.jsxs(Q,{title:r("sys.certificate.title"),extra:i.jsxs(ee,{size:"middle",children:[R&&i.jsx(_,{type:"secondary",className:"text-xs",children:r("sys.certificate.updatedAt",{time:R.toLocaleString()})}),i.jsx(T,{onClick:Z,children:r("sys.certificate.addDomain")}),i.jsx(T,{onClick:x,loading:D,disabled:g.length===0,children:r("sys.certificate.refresh")})]}),children:[g.length===0?i.jsx(H,{image:H.PRESENTED_IMAGE_SIMPLE,description:r("sys.certificate.noServer")}):i.jsx(V,{rowKey:"key",loading:D,columns:B,dataSource:$,pagination:!1,scroll:{x:!0},size:"middle"}),i.jsx(W,{title:r("sys.certificate.addDomain"),open:k,onOk:P,onCancel:()=>w(!1),okText:r("sys.certificate.confirm"),cancelText:r("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},children:i.jsx(X,{addonBefore:"https://",placeholder:r("sys.certificate.domainPlaceholder"),value:M,onChange:t=>E(t.target.value),onPressEnter:P,allowClear:!0,ref:N})})]})}export{ce as default};

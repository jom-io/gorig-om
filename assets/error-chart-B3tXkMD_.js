import{u as z,t as m,j as s}from"./index-BERtlmQb.js";import{s as b}from"./api-sample-modal-DF60HdJW.js";import{C as G}from"./index-DCpAUovq.js";import{u as H,C as K}from"./useChart-BUFOfR3x.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import V from"./anomaly-sample-modal-BHpqpA8t.js";import{useTimeRange as W}from"./api-latency-chart-CP2UWLJS.js";import{M as q,G as B,s as T,T as J}from"./vendor-ui-DHYkxuVK.js";import"./vendor-utils-CsjJZ8C9.js";import"./vendor-charts-C0vSEv4L.js";const h=["error","panic"];function le({open:l,onClose:j,enabled:y=!0}){const{t:r}=z(),{timeUnit:u,getRange:d,dateLabelFormat:C,renderTimePicker:v}=W("hour"),[S,L]=o.useState([]),[N,x]=o.useState([]),[M,f]=o.useState(!1),[D,E]=o.useState(h),[R,w]=o.useState({open:!1,data:null}),F=o.useMemo(()=>[m.colors.palette.error.dark,m.colors.palette.error.default],[]),n=D,I=e=>{w({open:!0,data:e})},A=o.useCallback(e=>{const t=h[e];E(a=>a.includes(t)?a.filter(i=>i!==t):[...a,t])},[]),g=o.useCallback(async e=>{try{const t=d(e),a=await b.errorTimeRange(t.start,t.end,t.apiUnit,h);L(a)}catch{}},[d]),k=o.useCallback(async e=>{if(n.length===0){x([]);return}try{f(!0);const t=d(e),a=await b.errorTop(t.start,t.end,10,n);x(a)}catch{}finally{f(!1)}},[d,n]);o.useEffect(()=>{l&&y&&(g(u),k(u))},[l,y,u,g,k]);const c=S,U=N,O=o.useMemo(()=>{if(!c.length)return[];const e=t=>{switch(t){case"error":return r("sys.workbench.anomalyError");case"panic":return r("sys.workbench.anomalyPanic");default:return t}};return h.map(t=>{const a=c.map(i=>{const $=i.value[t]||0;return{x:Number(i.at)*1e3,y:$}}),p=n.includes(t);return{name:e(t),data:p?a:a.map(i=>({...i,y:null}))}})},[c,n,r]),P=o.useMemo(()=>{if(c.length)return c.reduce((e,t)=>{const a=t.value,p=(a.error||0)+(a.panic||0);return Math.max(e,p)},0)+1},[c]),_=H({colors:F,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:C}},tooltip:{x:{formatter:e=>{switch(u){case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e}`}},yaxis:{labels:{formatter:e=>`${e}`},min:0,max:P},chart:{toolbar:{show:!1},events:{legendClick:(e,t)=>(A(t??0),!1)}},stroke:{curve:"smooth",width:2}});return s.jsxs(q,{title:r("sys.workbench.anomalyTrend"),open:l&&y,onCancel:j,width:850,footer:null,style:{top:"10%"},styles:{body:{padding:"0px"}},maskClosable:!0,destroyOnClose:!0,children:[s.jsxs(G,{className:"flex-col !shadow-none",children:[s.jsxs("header",{className:"flex w-full justify-between items-center mb-4",children:[s.jsx("div",{}),v()]}),s.jsxs("main",{className:"w-full flex flex-col gap-4",children:[s.jsx("div",{className:"w-full",children:s.jsx(K,{type:"area",series:O,options:_,height:360})}),s.jsxs("div",{className:"w-full",children:[s.jsx("div",{className:"flex items-center justify-between mb-2 px-1",children:s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-base font-medium",style:{color:m.colors.text.primary},children:r("sys.workbench.anomalyTopTitle")}),s.jsx("span",{className:"text-xs",style:{color:m.colors.text.secondary},children:r("sys.workbench.anomalyTopDesc")})]})}),s.jsx(B,{rowKey:e=>e.sigHash,dataSource:U,loading:M,size:"small",pagination:!1,locale:{emptyText:r("sys.workbench.anomalyTopEmpty")},onRow:e=>({onClick:()=>I(e),className:"cursor-pointer"}),columns:[{title:r("sys.workbench.anomalySignature"),dataIndex:"signature",key:"signature",render:(e,t)=>s.jsx(T.Text,{ellipsis:{tooltip:t.signature||t.sampleMsg||t.sampleError},style:{maxWidth:320},children:t.signature||t.sampleMsg||r("sys.workbench.anomalySampleEmpty")})},{title:r("sys.workbench.anomalyCount"),dataIndex:"count",key:"count",align:"right",width:80,render:e=>s.jsx(T.Text,{strong:!0,style:{color:m.colors.palette.error.dark},children:e})},{title:r("sys.workbench.anomalyLevel"),dataIndex:"level",key:"level",width:90,render:e=>{const t=e||(n.length===1?n[0]:"-");return s.jsx(J,{color:m.colors.palette.error.light,children:t?.toUpperCase()})}},{title:r("sys.workbench.anomalyLastSeen"),dataIndex:"lastAt",key:"lastAt",width:180,className:"whitespace-nowrap",render:e=>Q(e)}]})]})]})]}),s.jsx(V,{...R,onClose:()=>w(e=>({...e,open:!1}))})]})}const Q=l=>l?new Date(Number(l)*1e3).toLocaleString():"--";export{le as default};

import{G as _,H as ne,J as le,c as k,K as ce,a as de,u as ge,j as s}from"./index-DGlVSG5J.js";import{Q as ue,u as he}from"./useBaseQuery-BoGBcKgb.js";import{A as G,F as p,z as c,H as E,C as J,U as me,V as w,t as S,T as fe,I,ac as pe,i as v,M as X,ad as ye,n as xe}from"./vendor-ui-BgnAtmuh.js";import{r as g}from"./vendor-core-Cler3e7Q.js";import{LogList as W}from"./log-list-Cs4AANNr.js";import"./vendor-utils-Dg5_7-NF.js";var Pe=class extends ue{constructor(r,u){super(r,u)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(r,u){super.setOptions({...r,behavior:_()},u)}getOptimisticResult(r){return r.behavior=_(),super.getOptimisticResult(r)}fetchNextPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"backward"}}})}createResult(r,u){const{state:j}=r,C=super.createResult(r,u),{isFetching:F,isRefetching:n,isError:h,isRefetchError:L}=C,y=j.fetchMeta?.fetchMore?.direction,x=h&&y==="forward",m=F&&y==="forward",P=h&&y==="backward",T=F&&y==="backward";return{...C,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:le(u,j.data),hasPreviousPage:ne(u,j.data),isFetchNextPageError:x,isFetchingNextPage:m,isFetchPreviousPageError:P,isFetchingPreviousPage:T,isRefetchError:L&&!x&&!P,isRefetching:n&&!m&&!T}}};function we(r,u){return he(r,Pe)}const je=r=>k.post({url:"/om/log/search",data:r}),be=()=>k.get({url:"/om/log/categories"}),ve=()=>k.get({url:"/om/log/levels"}),ke=r=>k.get({url:"/om/log/near",params:r}),Ce=r=>k.get({url:"/om/log/download",params:{path:r},responseType:"blob"}),M={getLogList:je,getCategories:be,getLevels:ve,getNearLogs:ke,downloadLog:Ce},Z=1e3;function Ie(){const{message:r}=G.useApp(),[u,j]=g.useState([]),[C,F]=g.useState([]),[n]=p.useForm(),[h,L]=g.useState(null),[y,x]=g.useState(!1),[m,P]=g.useState(!1),[T,H]=g.useState(null),D=g.useRef(null),O=ce(),[b,V]=g.useState(!1),[ee,Q]=g.useState(!1),[d,se]=g.useState([]),R=de(),{t:a}=ge();g.useEffect(()=>{n.setFieldsValue({startTime:c().startOf("day"),timeRange:[c().startOf("day"),c()]})},[n]),g.useEffect(()=>{(async()=>{try{const[t,o]=await Promise.all([M.getCategories(),M.getLevels()]);F(t),j(o),t&&t.length>0&&n.setFieldsValue({categories:[t[0]]})}catch{r.error(a("sys.log.fetchDataFailed"))}})()},[n,r,a]);const q=(e,t)=>{t.stopPropagation(),X.confirm({title:a("sys.log.downloadConfirm"),content:a("sys.log.downloadConfirmContent"),onOk:async()=>{try{const o=await fetch(`${R?.addr}/om/log/download?path=${e}`,{headers:{Authorization:`Bearer ${R?.token}`}});if(!o.ok)throw new Error("下载失败");const i=await o.blob(),l=window.URL.createObjectURL(i),f=document.createElement("a");f.href=l,f.download=e.split("/").pop()||"logfile",document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(l)}catch{r.error(a("sys.log.downloadFailed"))}}})},N=async(e,t,o)=>{if(o.stopPropagation(),!(t<=0))try{const i=await M.getNearLogs({path:e,line:t,range:10});i.forEach(l=>{l.line===t&&(l.highlight=!0)}),se(i),Q(!0)}catch{r.error(a("sys.log.contextLogFailed"))}},{data:te,fetchNextPage:U,hasNextPage:$,isFetchingNextPage:z}=we({queryKey:["logs",h],queryFn:async({pageParam:e={lastPath:void 0,lastLine:void 0}})=>{try{if(y)return[];x(!0);const t=h,o={...t,startTime:t?.startTime?c(t.startTime).format("YYYY-MM-DD HH:mm:ss"):void 0,endTime:t?.endTime?c(t.endTime).format("YYYY-MM-DD HH:mm:ss"):void 0},i=await M.getLogList({...o,lastPath:e.lastPath,lastLine:e.lastLine,size:50});return await new Promise(l=>setTimeout(l,200)),!i||i.length===0?[]:i}catch{return[]}finally{x(!1)}},getNextPageParam:e=>{if(!e||e.length===0)return;const t=e[e.length-1];return{lastPath:t.path,lastLine:t.line}},initialPageParam:void 0,enabled:h!==null&&!m,retry:1,retryDelay:1e3}),re=te?.pages.flat()??[];g.useEffect(()=>{const e=new IntersectionObserver(t=>{if(t[0]?.isIntersecting&&$&&!z){if(m)return;U()}},{threshold:.5});return D.current&&e.observe(D.current),()=>{e.disconnect()}},[$,z,U,m]);const ae=async()=>{if(m)T?.close(),P(!1),V(!1),r.success(a("sys.log.monitorStopped"));else{O.setQueryData(["logs",h],{pages:[],pageParams:[]});const e={categories:n.getFieldValue("categories"),level:n.getFieldValue("level"),keyword:n.getFieldValue("keyword"),traceID:n.getFieldValue("traceID"),token:R?.token},t=Object.entries(e).filter(([i,l])=>l!==void 0).reduce((i,[l,f])=>(i[l]=f,i),{}),o=new EventSource(`${R?.addr}/om/log/monitor?${new URLSearchParams(t).toString()}`);o.onmessage=i=>{if(i.data==="monitoring started")r.success(a("sys.log.monitorStarted"));else if(i.data==="monitoring stopped")r.success(a("sys.log.monitorStopped")),o.close();else{const l=JSON.parse(i.data);O.setQueryData(["logs",h],f=>{const ie=f?.pages||[],Y=[l,...ie.flat()];return Y.length>Z&&Y.splice(Z),{pages:[Y],pageParams:[]}})}},o.onerror=()=>{o.close(),P(!1),r.error(a("sys.log.monitorFailed")),V(!1)},H(o),P(!0),x(!1),V(!0)}},A=(e,t)=>{t.stopPropagation();const o=n.getFieldValue("timeRange");n.setFieldsValue({categories:[],level:"",keyword:"",traceID:e,timeRange:o}),L(i=>i?{...i,categories:[],level:"",keyword:"",traceID:e}:null),B()},oe=()=>{n.resetFields(),n.setFieldsValue({startTime:c().startOf("day"),timeRange:[c().startOf("day"),c()]})},B=async()=>{if(!m&&!y)try{const{timeRange:e,...t}=n.getFieldsValue();await O.resetQueries({queryKey:["logs",t]}),L(t)}catch{x(!1)}},K=(e,t)=>{t.stopPropagation();const o=c(e).format("YYYY-MM-DD HH:mm:ss"),i=n.getFieldValue("startTime"),l=n.getFieldValue("endTime");i?l?n.setFieldsValue({timeRange:[c(i),c(o)],endTime:o}):n.setFieldsValue({timeRange:[c(i),c(o)],endTime:o}):n.setFieldsValue({timeRange:[c(o),l?c(l):null],startTime:o})};return s.jsxs(G,{children:[s.jsxs(E,{direction:"vertical",size:"small",className:"w-full",children:[s.jsx(J,{children:s.jsxs(p,{form:n,onFinish:B,children:[s.jsxs(me,{gutter:[16,16],style:{fontSize:"12px",lineHeight:"16px"},children:[s.jsx(w,{span:24,lg:6,children:s.jsx(p.Item,{label:a("sys.log.category"),name:"categories",className:"!mb-0",children:s.jsx(S,{mode:"multiple",allowClear:!0,disabled:b,children:C.map(e=>s.jsx(S.Option,{value:e,children:e},e))})})}),s.jsx(w,{span:24,lg:6,children:s.jsx(p.Item,{label:a("sys.log.level"),name:"level",className:"!mb-0",children:s.jsx(S,{allowClear:!0,disabled:b,children:u.map(e=>s.jsx(S.Option,{value:e,children:s.jsx(fe,{color:e==="error"||e==="fatal"||e==="dpanic"?"error":e==="warn"?"warning":"success",children:e})},e))})})}),s.jsx(w,{span:24,lg:6,children:s.jsx(p.Item,{label:a("sys.log.keyword"),name:"keyword",className:"!mb-0",children:s.jsx(I,{placeholder:a("sys.log.keywordPlaceholder"),allowClear:!0,disabled:b})})}),s.jsx(w,{span:24,lg:6,children:s.jsx(p.Item,{label:a("sys.log.traceID"),name:"traceID",className:"!mb-0",children:s.jsx(I,{placeholder:a("sys.log.traceIDPlaceholder"),allowClear:!0,disabled:b})})}),s.jsx(w,{span:24,lg:12,children:s.jsx(p.Item,{label:a("sys.log.timeRange"),name:"timeRange",className:"!mb-0",children:s.jsx(pe.RangePicker,{showTime:!0,style:{width:"100%"},disabled:b,disabledDate:e=>e&&e>c().endOf("day"),onChange:e=>{e?n.setFieldsValue({startTime:e[0]?.format("YYYY-MM-DD HH:mm:ss"),endTime:e[1]?.format("YYYY-MM-DD HH:mm:ss")}):n.setFieldsValue({startTime:void 0,endTime:void 0})}})})}),s.jsx(w,{span:24,children:s.jsxs("div",{className:"flex justify-end",children:[s.jsx(v,{onClick:oe,children:a("sys.log.reset")}),s.jsx(v,{type:"primary",className:"ml-4",htmlType:"submit",loading:y,disabled:m,children:a("sys.log.search")}),s.jsx(v,{type:"primary",className:"ml-4",onClick:ae,children:a(m?"sys.log.stopMonitor":"sys.log.startMonitor")})]})})]}),s.jsx(p.Item,{name:"startTime",hidden:!0,children:s.jsx(I,{})}),s.jsx(p.Item,{name:"endTime",hidden:!0,children:s.jsx(I,{})})]})}),s.jsxs(J,{children:[s.jsx(W,{dataSource:re,keyword:h?.keyword,onTraceIDClick:A,onLineNumberClick:N,onFileClick:q,onTimeClick:K}),s.jsx("div",{ref:D,style:{height:20}})]})]}),s.jsx(X,{title:a("sys.log.contextLog"),open:ee,onCancel:()=>Q(!1),footer:s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"8px"},children:[s.jsx(v,{onClick:e=>{d&&d.length>0&&N(d[0].path,d[0].line,e)},disabled:!d||d.length===0,children:s.jsxs(E,{children:[s.jsx(ye,{}),a("sys.log.prevPage")]})}),s.jsx(v,{onClick:e=>{if(d&&d.length>0){const t=d[d.length-1];N(t.path,t.line,e)}},disabled:!d||d.length===0,children:s.jsxs(E,{children:[a("sys.log.nextPage"),s.jsx(xe,{})]})})]}),width:1e3,styles:{body:{height:"70vh",padding:"24px",overflow:"hidden"},content:{height:"100%"}},children:s.jsx("div",{style:{height:"100%",overflow:"auto"},children:s.jsx(W,{dataSource:d,keyword:h?.keyword,onTraceIDClick:A,onLineNumberClick:N,onFileClick:q,onTimeClick:K})})})]})}export{Ie as default};

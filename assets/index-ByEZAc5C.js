import{u as os,a as cs,j as r,I as G,b as J}from"./index-Dyy-_55f.js";import{d as z}from"./deployService-BtWGbLGx.js";import{z as k,c as Z,T as q,E as A,M as W,C as ls,G as us,H as ds,i as K}from"./vendor-ui-BgnAtmuh.js";import{d as hs,g as fs,r as u}from"./vendor-core-Cler3e7Q.js";import{DeploySteps as ms}from"./DeploySteps-BKBRkUFt.js";import gs from"./EnvConfigModal-B-057iPY.js";import ys from"./LogModal-C43FUPmp.js";import"./vendor-utils-Dg5_7-NF.js";var Q={exports:{}};(function(i,d){(function($,f){i.exports=f()})(hs,function(){var $,f,Y=1e3,C=6e4,O=36e5,x=864e5,B=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,M=31536e6,I=2628e6,T=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/,j={years:M,months:I,days:x,hours:O,minutes:C,seconds:Y,milliseconds:1,weeks:6048e5},R=function(a){return a instanceof D},H=function(a,e,s){return new D(a,s,e.$l)},S=function(a){return f.p(a)+"s"},V=function(a){return a<0},g=function(a){return V(a)?Math.ceil(a):Math.floor(a)},v=function(a){return Math.abs(a)},b=function(a,e){return a?V(a)?{negative:!0,format:""+v(a)+e}:{negative:!1,format:""+a+e}:{negative:!1,format:""}},D=function(){function a(s,c,o){var l=this;if(this.$d={},this.$l=o,s===void 0&&(this.$ms=0,this.parseFromMilliseconds()),c)return H(s*j[S(c)],this);if(typeof s=="number")return this.$ms=s,this.parseFromMilliseconds(),this;if(typeof s=="object")return Object.keys(s).forEach(function(p){l.$d[S(p)]=s[p]}),this.calMilliseconds(),this;if(typeof s=="string"){var h=s.match(T);if(h){var y=h.slice(2).map(function(p){return p!=null?Number(p):0});return this.$d.years=y[0],this.$d.months=y[1],this.$d.weeks=y[2],this.$d.days=y[3],this.$d.hours=y[4],this.$d.minutes=y[5],this.$d.seconds=y[6],this.calMilliseconds(),this}}return this}var e=a.prototype;return e.calMilliseconds=function(){var s=this;this.$ms=Object.keys(this.$d).reduce(function(c,o){return c+(s.$d[o]||0)*j[o]},0)},e.parseFromMilliseconds=function(){var s=this.$ms;this.$d.years=g(s/M),s%=M,this.$d.months=g(s/I),s%=I,this.$d.days=g(s/x),s%=x,this.$d.hours=g(s/O),s%=O,this.$d.minutes=g(s/C),s%=C,this.$d.seconds=g(s/Y),s%=Y,this.$d.milliseconds=s},e.toISOString=function(){var s=b(this.$d.years,"Y"),c=b(this.$d.months,"M"),o=+this.$d.days||0;this.$d.weeks&&(o+=7*this.$d.weeks);var l=b(o,"D"),h=b(this.$d.hours,"H"),y=b(this.$d.minutes,"M"),p=this.$d.seconds||0;this.$d.milliseconds&&(p+=this.$d.milliseconds/1e3,p=Math.round(1e3*p)/1e3);var w=b(p,"S"),F=s.negative||c.negative||l.negative||h.negative||y.negative||w.negative,L=h.format||y.format||w.format?"T":"",N=(F?"-":"")+"P"+s.format+c.format+l.format+L+h.format+y.format+w.format;return N==="P"||N==="-P"?"P0D":N},e.toJSON=function(){return this.toISOString()},e.format=function(s){var c=s||"YYYY-MM-DDTHH:mm:ss",o={Y:this.$d.years,YY:f.s(this.$d.years,2,"0"),YYYY:f.s(this.$d.years,4,"0"),M:this.$d.months,MM:f.s(this.$d.months,2,"0"),D:this.$d.days,DD:f.s(this.$d.days,2,"0"),H:this.$d.hours,HH:f.s(this.$d.hours,2,"0"),m:this.$d.minutes,mm:f.s(this.$d.minutes,2,"0"),s:this.$d.seconds,ss:f.s(this.$d.seconds,2,"0"),SSS:f.s(this.$d.milliseconds,3,"0")};return c.replace(B,function(l,h){return h||String(o[l])})},e.as=function(s){return this.$ms/j[S(s)]},e.get=function(s){var c=this.$ms,o=S(s);return o==="milliseconds"?c%=1e3:c=o==="weeks"?g(c/j[o]):this.$d[o],c||0},e.add=function(s,c,o){var l;return l=c?s*j[S(c)]:R(s)?s.$ms:H(s,this).$ms,H(this.$ms+l*(o?-1:1),this)},e.subtract=function(s,c){return this.add(s,c,!0)},e.locale=function(s){var c=this.clone();return c.$l=s,c},e.clone=function(){return H(this.$ms,this)},e.humanize=function(s){return $().add(this.$ms,"ms").locale(this.$l).fromNow(!s)},e.valueOf=function(){return this.asMilliseconds()},e.milliseconds=function(){return this.get("milliseconds")},e.asMilliseconds=function(){return this.as("milliseconds")},e.seconds=function(){return this.get("seconds")},e.asSeconds=function(){return this.as("seconds")},e.minutes=function(){return this.get("minutes")},e.asMinutes=function(){return this.as("minutes")},e.hours=function(){return this.get("hours")},e.asHours=function(){return this.as("hours")},e.days=function(){return this.get("days")},e.asDays=function(){return this.as("days")},e.weeks=function(){return this.get("weeks")},e.asWeeks=function(){return this.as("weeks")},e.months=function(){return this.get("months")},e.asMonths=function(){return this.as("months")},e.years=function(){return this.get("years")},e.asYears=function(){return this.as("years")},a}(),E=function(a,e,s){return a.add(e.years()*s,"y").add(e.months()*s,"M").add(e.days()*s,"d").add(e.hours()*s,"h").add(e.minutes()*s,"m").add(e.seconds()*s,"s").add(e.milliseconds()*s,"ms")};return function(a,e,s){$=s,f=s().$utils(),s.duration=function(l,h){var y=s.locale();return H(l,{$l:y},h)},s.isDuration=R;var c=e.prototype.add,o=e.prototype.subtract;e.prototype.add=function(l,h){return R(l)?E(this,l,1):c.bind(this)(l,h)},e.prototype.subtract=function(l,h){return R(l)?E(this,l,-1):o.bind(this)(l,h)}}})})(Q);var ps=Q.exports;const xs=fs(ps);k.extend(xs);const js=()=>{const{t:i}=os(),d=cs(),[$,f]=u.useState([]),[Y,C]=u.useState(!1),[O,x]=u.useState(!1),[B,M]=u.useState(!1),[I,T]=u.useState(null),[j,R]=u.useState(!1),[H,S]=u.useState(!1),[V,g]=u.useState(0),[v,b]=u.useState({current:1,pageSize:10,total:0}),[D,E]=u.useState(!1),[a,e]=u.useState(null),[s,c]=u.useState(null),o=u.useRef(null),[l,h]=u.useState(null),[y,p]=u.useState(!1);u.useEffect(()=>{d&&(C(!1),x(!1),T(null),h(null),g(0))},[d]);const w=u.useCallback(async(t,n)=>{if(d)try{S(!0);const m=await z.pageTask(t,n);f(m.items),b(P=>({...P,total:m.total}))}catch{}finally{S(!1)}},[d]),F=u.useCallback(async()=>{if(d){if(o.current?.addr===d.addr){g(o.current.step);return}try{const t=await z.getTaskCfg();if(h(t),!t.gitInit){g(0),x(!1),o.current={addr:d.addr,step:0};return}if(!t.sshKeyCopy){g(1),x(!1),o.current={addr:d.addr,step:1};return}if(!t.repo){g(2),x(!1),o.current={addr:d.addr,step:2};return}if(!t.branch){g(3),x(!1),o.current={addr:d.addr,step:3};return}g(4),x(!0),o.current={addr:d.addr,step:4},T({repoUrl:t.repo,selectedBranch:t.branch})}catch{x(!1),T(null),h(null)}}},[d]),L=u.useCallback(()=>l?l.gitInit&&l.sshKeyCopy&&l.repo&&l.branch:!1,[l]);u.useEffect(()=>{d&&(F(),b(t=>({...t,current:1})))},[d,F]),u.useEffect(()=>{d&&w(v.current,v.pageSize)},[v.current,v.pageSize,w,d]);const N=u.useCallback(async t=>{try{return await z.getTask(t)}catch{return null}},[]),U=u.useCallback(()=>{if(!$)return null;const t=$.filter(n=>n.status==="running"||n.status==="waiting");return t.length>0?t.sort((n,m)=>k(n.createAt).valueOf()-k(m.createAt).valueOf())[0]:null},[$]);u.useEffect(()=>{const t=U();c(t)},[U]),u.useEffect(()=>{if(!s)return;const n=setInterval(async()=>{const m=await N(s.id);m&&(f(P=>P.map(_=>_.id===m.id?m:_)),D&&a?.id===m.id&&e(m))},3e3);return()=>clearInterval(n)},[s,D,a,N]),u.useEffect(()=>{if($?.some(n=>n.status==="running")??!1){const n=setInterval(()=>{f(m=>[...m])},1e3);return()=>clearInterval(n)}},[$]);const X=[{title:r.jsx("div",{className:"pl-4",children:i("sys.cicd.deployInfo")}),dataIndex:"gitHash",width:120,align:"left",render:(t,n)=>r.jsxs("div",{className:"flex flex-col pl-4",children:[r.jsx(Z,{title:n.gitHash,children:r.jsx("span",{className:"text-sm block w-[120px] text-left",children:n.rb?i("sys.cicd.rollback.to",{hash:n.gitHash?`${n.gitHash.slice(0,7)}...`:"-"}):n.gitHash?`${n.gitHash.slice(0,7)}...`:"-"})}),r.jsx(Z,{title:n.commit,children:r.jsx("span",{className:"text-xs text-text-secondary block w-[120px] text-left truncate",children:n.commit||"-"})})]})},{title:i("sys.cicd.deployBranch"),dataIndex:"branch",align:"center",width:100},{title:i("sys.cicd.autoTrigger"),dataIndex:"autoTrigger",align:"center",width:80,render:t=>r.jsx(q,{color:t?"blue":"orange",children:i(t?"sys.cicd.triggerAuto":"sys.cicd.triggerManual")})},{title:i("sys.cicd.status"),dataIndex:"status",align:"center",width:80,render:(t,n)=>{const m={success:{color:"success",text:n.rb?i("sys.cicd.statusRollbackSuccess"):i("sys.cicd.statusSuccess")},failed:{color:"error",text:n.rb?i("sys.cicd.statusRollbackFailed"):i("sys.cicd.statusFailed")},running:{color:"processing",text:i("sys.cicd.statusRunning")},waiting:{color:"warning",text:n.rb?i("sys.cicd.statusRollbackWaiting"):i("sys.cicd.statusWaiting")},timeout:{color:"error",text:i("sys.cicd.statusTimeout")}};return r.jsx(q,{color:m[t]?.color||"default",children:m[t]?.text||t})}},{title:i("sys.cicd.createTime"),dataIndex:"createAt",align:"center",width:150,render:t=>k(t).format("YYYY-MM-DD HH:mm:ss")},{title:i("sys.cicd.duration"),key:"duration",align:"center",width:80,render:(t,n)=>n.status==="waiting"?"-":n.status==="running"?k.duration(k().diff(k(n.startAt))).format("HH:mm:ss"):n.status==="success"||n.status==="failed"||n.status==="timeout"?k.duration(k(n.finishAt).diff(k(n.startAt))).format("HH:mm:ss"):"-"},{title:i("sys.cicd.operation"),key:"operation",align:"center",width:100,render:(t,n)=>r.jsxs("div",{className:"flex w-full justify-center text-gray-500",children:[r.jsx(G,{onClick:()=>ts(n),disabled:n.status==="waiting",className:n.status==="waiting"?"opacity-50 cursor-not-allowed":"",children:r.jsx(J,{icon:"mdi:file-document-outline",size:18,className:n.status==="waiting"?"text-gray-300":""})}),r.jsx(G,{onClick:()=>es(n),disabled:n.rbStatus!=="ready",className:n.rbStatus!=="ready"?"opacity-50 cursor-not-allowed":"",children:r.jsx(J,{icon:"mdi:backup-restore",size:18,className:n.rbStatus==="ready"?"text-warning":"text-gray-300"})})]})}],ss=()=>{C(!0)},ts=t=>{if(!t.log||t.log.length===0){A.warning("暂无日志");return}e(t),E(!0)},es=t=>{if(t.rbStatus!=="ready"){A.warning(t.rbStatus==="cleaned"?i("sys.cicd.rollback.cleaned"):i("sys.cicd.rollback.notReady"));return}W.confirm({title:i("sys.cicd.rollback.confirmTitle"),content:i("sys.cicd.rollback.confirmContent",{hash:t.gitHash||i("sys.cicd.rollback.unknownVersion")}),onOk:async()=>{try{await z.rollbackTask(t.id),A.success(i("sys.cicd.rollback.success")),b(n=>({...n,current:1})),w(1,v.pageSize)}catch{A.error(i("sys.cicd.rollback.failed"))}}})},ns=t=>{h(t),T({repoUrl:t.repo,selectedBranch:t.branch}),x(!0),o.current={addr:d?.addr||"",step:4},C(!1)},is=()=>{M(!0)},rs=async()=>{try{R(!0),await z.startTask(),A.success(i("sys.cicd.runSuccess")),M(!1),b(t=>({...t,current:1})),w(1,v.pageSize)}catch{}finally{R(!1)}},as=t=>{b(t)};return r.jsxs(r.Fragment,{children:[r.jsxs(ls,{title:i("sys.cicd.deployList"),styles:{body:{padding:"0 0px"}},extra:r.jsxs(ds,{children:[r.jsx(K,{type:"primary",onClick:ss,children:i("sys.cicd.deployConfig")}),r.jsx(K,{type:"primary",onClick:()=>p(!0),children:i("deploy.sys.cicd.env.title")}),r.jsx(K,{type:"primary",onClick:is,disabled:!L(),className:L()?"":"opacity-50 cursor-not-allowed",children:i("sys.cicd.run")})]}),children:[r.jsx(us,{rowKey:t=>`${t.gitHash}-${t.createAt}`,size:"small",scroll:{x:"max-content"},columns:X,dataSource:$,loading:H,pagination:{...v,style:{marginRight:"16px"}},onChange:as,className:"w-full max-w-[1000px] mx-auto"}),r.jsx(W,{title:i("sys.cicd.deployConfig"),open:Y,onCancel:()=>C(!1),footer:null,width:800,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"},body:{paddingTop:"4px"}},children:r.jsx(ms,{onComplete:ns,initialStep:V},d?.addr)}),r.jsx(W,{title:i("sys.cicd.runModal.title"),open:B,onCancel:()=>M(!1),onOk:rs,confirmLoading:j,styles:{mask:{backgroundColor:"rgba(0, 0, 0, 0.75)"}},children:r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"font-medium",children:[i("sys.cicd.runModal.repoAddress"),"："]}),r.jsx("div",{className:"text-gray-600",children:I?.repoUrl})]}),r.jsxs("div",{children:[r.jsxs("div",{className:"font-medium",children:[i("sys.cicd.runModal.currentBranch"),"："]}),r.jsx("div",{className:"text-gray-600",children:I?.selectedBranch})]}),r.jsx("div",{className:"text-gray-500",children:i("sys.cicd.runModal.confirmTip")})]})})]}),a&&r.jsx(ys,{record:a,visible:D,onClose:()=>E(!1)}),r.jsx(gs,{visible:y,onClose:()=>p(!1)})]})};export{js as default};

import{u as de,a as he,j as s}from"./index-Dyy-_55f.js";import{d as o}from"./deployService-BtWGbLGx.js";import{r as c}from"./vendor-core-Cler3e7Q.js";import{J as R,s as ye,K as x,N as G,i as d,O as ue,I as ge,t as fe,P as xe,h as me,Q as je,E as p}from"./vendor-ui-BgnAtmuh.js";import"./vendor-utils-Dg5_7-NF.js";const{Text:l,Paragraph:be}=ye,we=({onComplete:D,initialStep:J})=>{const{t}=de(),m=he(),[i,k]=c.useState(J),[h,u]=c.useState(!1),[Q,P]=c.useState(!1),[j,N]=c.useState(!1),[W,H]=c.useState(!1),[g,O]=c.useState(null),[y,$]=c.useState(null),[S,M]=c.useState(null),[L,b]=c.useState([]),[r,a]=c.useState({gitInit:!1,goInit:!1,sshKeyCopy:!1,repo:"",branch:"",autoTrigger:!1}),[q,V]=c.useState(!1),[U,Se]=c.useState(!1),[f,E]=c.useState(!1),A=c.useRef(null),w=c.useRef(!1),v=c.useCallback(async()=>{try{const e=await o.checkInstallStatus();return O(e),e?.installed?a(n=>({...n,gitInit:!0})):a(n=>({...n,gitInit:!1})),e}catch{return a(n=>({...n,gitInit:!1})),null}},[]),C=c.useCallback(async()=>{try{const e=await o.checkGo();return $(e),e?.installed?a(n=>({...n,goInit:!0})):a(n=>({...n,goInit:!1})),e}catch{return a(n=>({...n,goInit:!1})),null}},[]),z=c.useCallback(async()=>{try{const e=await o.getSshKey();return M(e),a(n=>({...n,sshKeyCopy:!!e?.publicKey})),e}catch{return null}},[]);c.useCallback(async()=>{try{return await o.getTaskCfg()}catch{return null}},[]),c.useEffect(()=>{i===0?(!g&&!h&&!w.current&&v().then(e=>{e?.installed&&a(n=>({...n,gitInit:!0}))}),!y&&!h&&!w.current&&C().then(e=>{e?.installed&&a(n=>({...n,goInit:!0}))})):i===1?z().then(e=>{e?.publicKey&&a(n=>({...n,sshKeyCopy:!0}))}):i===3&&r.repo&&X()},[i,r.repo,v,C,z,h,g,y]);const K=c.useCallback(async()=>{if(m)try{w.current=!0,u(!0);const e=await o.getTaskCfg(),n=await v(),F=await C();a({gitInit:e.gitInit||!!n?.installed,goInit:e.goInit||!!F?.installed,sshKeyCopy:e.sshKeyCopy,repo:e.repo,branch:e.branch,autoTrigger:e.autoTrigger});let I=0;e.gitInit&&e.goInit&&(I=1,e.sshKeyCopy&&(I=2,e.repo&&(I=3,e.branch&&(I=4)))),k(I),A.current=m.addr}catch{}finally{w.current=!1,u(!1)}},[m,v,C]);c.useEffect(()=>{K()},[K]),c.useEffect(()=>{m&&A.current!==m.addr&&(A.current=null,K())},[m,K]);const X=async()=>{if(r.repo)try{N(!0);const e=await o.getBranches(r.repo);b(e),!r.branch&&e.length>0&&a(n=>({...n,branch:e[0]}))}catch{b([])}finally{N(!1)}},Y=async()=>{if(r.repo)try{N(!0);const e=await o.getBranches(r.repo);b(e),!r.branch&&e.length>0&&a(n=>({...n,branch:e[0]}))}catch{b([])}finally{N(!1)}},Z=async e=>{a(n=>({...n,branch:e}))},_=async()=>{try{u(!0);const e=await o.installGit();if(e.error){p.error(e.error),a(n=>({...n,gitInit:!1}));return}O(e),a(n=>({...n,gitInit:!0})),p.success("Git 安装成功")}catch{a(n=>({...n,gitInit:!1}))}finally{u(!1)}},ee=async()=>{try{u(!0);const e=await o.installGo();if(e.error){p.error(e.error),a(n=>({...n,goInit:!1}));return}$(e),a(n=>({...n,goInit:!0})),p.success("Go 安装成功")}catch{a(n=>({...n,goInit:!1}))}finally{u(!1)}},se=async()=>{try{u(!0);const e=await o.generateSshKey();M(e),a(n=>({...n,sshKeyCopy:!!e?.publicKey})),p.success("SSH Key 生成成功")}catch{}finally{u(!1)}},te=async()=>{if(!r.repo.startsWith("git@")){p.error(t("deploy.repo.invalidFormat"));return}try{H(!0);const e=await o.getBranches(r.repo);b(e),!r.branch&&e.length>0&&a(n=>({...n,branch:e[0]})),E(!0),p.success(t("deploy.repo.checkSuccess"))}catch{b([]),a(n=>({...n,branch:""})),E(!1)}finally{H(!1)}},ne=async()=>{if(!S?.publicKey){p.error(t("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(S.publicKey),p.success(t("deploy.ssh.copySuccess"))}catch{p.error(t("deploy.ssh.copyFailed"))}},re=e=>{if(T(e))k(e);else{const n=[];r.gitInit||n.push(t("deploy.steps.gitCheck")),r.sshKeyCopy||n.push(t("deploy.steps.sshConfig")),r.repo||n.push(t("deploy.steps.repoConfig")),r.branch||n.push(t("deploy.steps.branchSelect")),p.warning(t("deploy.navigation.missingSteps",{steps:n.join("、")}))}},ae=L.map(e=>({label:e,value:e})),ce=async e=>{try{V(!0),a(n=>({...n,autoTrigger:e}))}catch{a(F=>({...F,autoTrigger:!e}))}finally{V(!1)}},T=e=>{switch(e){case 0:return!0;case 1:return r.gitInit&&r.goInit;case 2:return r.gitInit&&r.goInit&&r.sshKeyCopy;case 3:return r.gitInit&&r.goInit&&r.sshKeyCopy&&r.repo&&f;case 4:return r.gitInit&&r.goInit&&r.sshKeyCopy&&r.repo&&r.branch;default:return!1}},B=[{title:t("deploy.steps.envCheck"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:t("deploy.git.title")}),h&&!g&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(R,{}),s.jsx(l,{children:t("deploy.git.checking")})]}),g?.error&&s.jsx(x,{message:t("deploy.git.installFailed"),description:g.error,type:"error",showIcon:!0,className:"mb-4"}),g?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(G,{className:"text-success"}),s.jsx(l,{children:t("deploy.git.installed")}),s.jsxs(l,{type:"secondary",children:["(",g.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(d,{type:"primary",onClick:_,loading:h,children:t("deploy.git.install")}),s.jsx(d,{onClick:v,children:t("deploy.git.recheck")})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:t("deploy.go.title")}),h&&!y&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(R,{}),s.jsx(l,{children:t("deploy.go.checking")})]}),y?.error&&s.jsx(x,{message:y.version?t("deploy.go.versionMismatch"):t("deploy.go.installFailed"),description:y.error,type:"error",showIcon:!0,className:"mb-4"}),y?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(G,{className:"text-success"}),s.jsx(l,{children:t("deploy.go.installed")}),s.jsxs(l,{type:"secondary",children:["(",y.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(d,{type:"primary",onClick:ee,loading:h,children:y?.version?t("deploy.go.reinstall"):t("deploy.go.install")}),s.jsx(d,{onClick:C,children:t("deploy.go.recheck")})]})]})]})},{title:t("deploy.steps.sshConfig"),content:s.jsxs("div",{className:"py-4",children:[h&&!S&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(R,{}),s.jsx(l,{children:t("deploy.ssh.checking")})]}),S?.publicKey?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(G,{className:"text-success"}),s.jsx(l,{children:t("deploy.ssh.configured")})]}),s.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(l,{strong:!0,children:t("deploy.ssh.publicKey")}),s.jsx(d,{type:"link",icon:s.jsx(ue,{}),onClick:ne,children:t("deploy.ssh.copy")})]}),s.jsx(be,{className:"mb-0 break-all",children:s.jsx(l,{code:!0,children:S.publicKey})})]}),s.jsx(x,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(d,{type:"primary",onClick:se,loading:h,children:t("deploy.ssh.generate")}),s.jsx(x,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:t("deploy.steps.repoConfig"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(ge,{placeholder:t("deploy.repo.inputPlaceholder"),value:r.repo,onChange:e=>{a(n=>({...n,repo:e.target.value})),E(!1)},style:{width:400}}),s.jsx(d,{onClick:te,loading:W,type:f?"default":"primary",icon:f?s.jsx(G,{}):null,children:t(f?"deploy.repo.recheck":"deploy.repo.check")})]}),s.jsx(x,{message:t(f?"deploy.repo.success":"deploy.repo.nextStep"),description:t(f?"deploy.repo.successTip":"deploy.repo.tip"),type:f?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.branchSelect"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(fe,{showSearch:!0,style:{width:400},placeholder:t(j?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:ae,value:r.branch,onChange:Z,loading:j,disabled:j,filterOption:(e,n)=>(n?.label??"").toLowerCase().includes(e.toLowerCase())}),s.jsx(d,{icon:s.jsx(xe,{spin:j}),onClick:Y,disabled:!r.repo,loading:j,children:t("deploy.branch.refresh")})]}),!L.length&&!j&&!r.branch&&s.jsx(x,{message:t("deploy.branch.noBranches"),description:t("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),(L.length>0||r.branch)&&s.jsx(x,{message:t("deploy.branch.nextStep"),description:r.branch?t("deploy.branch.currentBranch",{branch:r.branch}):t("deploy.branch.selectTip"),type:r.branch?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.autoTrigger"),content:s.jsx("div",{className:"py-4 space-y-4",children:U?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(R,{}),s.jsx(l,{children:t("deploy.autoTrigger.loading")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(me,{checked:r.autoTrigger,onChange:ce,loading:q}),s.jsx(l,{children:t("deploy.autoTrigger.enable")})]}),s.jsx(l,{type:"secondary",children:t("deploy.autoTrigger.tip")})]})})}],ie=()=>{T(i+1)&&k(i+1)},le=()=>{i>0&&k(i-1)},oe=B.map((e,n)=>({key:e.title,title:e.title,disabled:!T(n)})),pe=async()=>{try{P(!0),await o.saveTaskCfg(r),D(r),p.success(t("sys.cicd.saveSuccess"))}catch{}finally{P(!1)}};return s.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[s.jsx(je,{current:i,items:oe,className:"px-6",onChange:re}),s.jsx("div",{className:"flex-1 mt-4 px-6",children:B[i].content}),s.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[i>0&&s.jsx(d,{style:{margin:"0 8px"},onClick:le,children:t("deploy.navigation.prev")}),i<B.length-1&&s.jsx(d,{type:"primary",onClick:ie,disabled:!T(i+1),children:t("deploy.navigation.next")}),i===B.length-1&&s.jsx(d,{type:"primary",onClick:pe,loading:Q,children:t("sys.cicd.save")})]})]})};export{we as DeploySteps,we as default};

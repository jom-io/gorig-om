import{u as ee,a as Ie,j as s}from"./index-DGlVSG5J.js";import{d as m}from"./deployService-BMo8vmkE.js";import{r as o}from"./vendor-core-Cler3e7Q.js";import{A as we,J,s as Ne,K as R,N as W,i as j,O as ke,I as z,t as se,P as Ke,h as Te,Q as Be,l as Le}from"./vendor-ui-BgnAtmuh.js";import"./vendor-utils-Dg5_7-NF.js";const{Text:x,Paragraph:Oe}=Ne,te=o.memo(({repo:y,index:u,onChange:r,onRemove:i})=>{const{t:f}=ee(),[l,I]=o.useState(!1),v=async d=>{if(d.endsWith(".git"))try{I(!0);const p=await m.getBranches(d);r(u,"branches",JSON.stringify(p||[])),p&&p.length>0&&r(u,"branch",p[0])}catch{r(u,"branches","[]")}finally{I(!1)}},S=o.useMemo(()=>{try{return typeof y.branches=="string"?JSON.parse(y.branches):y.branches||[]}catch{return[]}},[y.branches]);return s.jsx("div",{className:"flex items-start mb-4 p-4 border rounded",children:s.jsxs("div",{className:"flex-1 flex items-center space-x-2",children:[s.jsx(z,{placeholder:f("deploy.repo.dirPlaceholder"),value:y.dir,onChange:d=>{const p=d.target.value;r(u,"dir",p)},style:{width:160}}),s.jsx(z,{placeholder:f("deploy.repo.inputPlaceholder"),value:y.repo,onChange:d=>{const p=d.target.value;r(u,"repo",p),p.endsWith(".git")&&v(p)},style:{width:280}}),s.jsx(se,{showSearch:!0,style:{width:160},placeholder:f(l?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),value:y.branch,onChange:d=>r(u,"branch",d),options:S.map(d=>({label:d,value:d})),loading:l,disabled:l,filterOption:(d,p)=>p?String(p.value).toLowerCase().includes(d.toLowerCase()):!1}),s.jsx(j,{type:"text",danger:!0,icon:s.jsx(Le,{}),onClick:()=>i(u)})]})})},(y,u)=>{const r=y.repo.branches||[],i=u.repo.branches||[];return y.repo.dir===u.repo.dir&&y.repo.repo===u.repo.repo&&y.repo.branch===u.repo.branch&&JSON.stringify(r)===JSON.stringify(i)&&y.index===u.index});te.displayName="OtherRepoItem";const Je=({onComplete:y,initialStep:u})=>{const{t:r}=ee(),{message:i}=we.useApp(),f=Ie(),[l,I]=o.useState(u),[v,S]=o.useState(!1),[d,p]=o.useState(!1),[N,q]=o.useState(!1),[re,M]=o.useState(!1),[w,Q]=o.useState(null),[C,Z]=o.useState(null),[k,_]=o.useState(null),[$,L]=o.useState([]),[n,a]=o.useState({gitInit:!1,goInit:!1,sshKeyCopy:!1,repo:"",branch:"",autoTrigger:!1}),[ne,X]=o.useState(!1),[ae]=o.useState(!1),[K,O]=o.useState(!1),H=o.useRef(null),D=o.useRef(!1),oe=o.useRef([]),ce=o.useCallback((e,t,b)=>{a(h=>{const c=[...h.otherRepos||[]];return c[e]||(c[e]={dir:"",repo:"",branch:"",branches:[]}),c[e]={...c[e],[t]:b},{...h,otherRepos:c}})},[]),ie=o.useCallback(()=>{a(e=>({...e,otherRepos:[...e.otherRepos||[],{dir:"",repo:"",branch:"",branches:[]}]}))},[]),le=o.useCallback(e=>{a(t=>{const b=[...t.otherRepos||[]];return b.splice(e,1),{...t,otherRepos:b}})},[]);o.useEffect(()=>{n.otherRepos&&(oe.current=n.otherRepos)},[n.otherRepos]);const T=o.useCallback(async()=>{try{const e=await m.checkInstallStatus();return Q(e),e?.installed?a(t=>({...t,gitInit:!0})):a(t=>({...t,gitInit:!1})),e}catch{return a(t=>({...t,gitInit:!1})),null}},[]),B=o.useCallback(async()=>{try{const e=await m.checkGo();return Z(e),e?.installed?a(t=>({...t,goInit:!0})):a(t=>({...t,goInit:!1})),e}catch{return a(t=>({...t,goInit:!1})),null}},[]),Y=o.useCallback(async()=>{try{const e=await m.getSshKey();return _(e),a(t=>({...t,sshKeyCopy:!!e?.publicKey})),e}catch{return null}},[]),G=o.useCallback(async()=>{if(f&&!D.current)try{D.current=!0,S(!0);const e=await m.getTaskCfg(),t=await T(),b=await B(),h={gitInit:e.gitInit||!!t?.installed,goInit:e.goInit||!!b?.installed,sshKeyCopy:e.sshKeyCopy,repo:e.repo,branch:e.branch,autoTrigger:e.autoTrigger,otherRepos:e.otherRepos||[]};let c=0;if(h.gitInit&&h.goInit&&(c=1,h.sshKeyCopy&&(c=2,h.repo&&h.branch&&(c=3))),a(h),I(c),e.repo){O(!0);try{const g=await m.getBranches(e.repo);L(g)}catch{L([])}}if(e.otherRepos&&e.otherRepos.length>0){for(const g of e.otherRepos)if(g.repo?.endsWith(".git"))try{const P=await m.getBranches(g.repo);a(U=>{const F=[...U.otherRepos||[]],V=F.findIndex(Re=>Re.repo===g.repo);return V!==-1&&(F[V]={...F[V],branches:P}),{...U,otherRepos:F}})}catch{}}H.current=f.addr}catch{}finally{D.current=!1,S(!1)}},[f,T,B]);o.useEffect(()=>{f&&G()},[G,f]),o.useEffect(()=>{f&&H.current!==f.addr&&(H.current=null,G())},[f,G]),o.useEffect(()=>{D.current||v||(l===0?(w||T().then(e=>{e?.installed&&a(t=>({...t,gitInit:!0}))}),C||B().then(e=>{e?.installed&&a(t=>({...t,goInit:!0}))})):l===1&&Y().then(e=>{e?.publicKey&&a(t=>({...t,sshKeyCopy:!0}))}))},[l,T,B,Y,v,w,C]);const pe=async(e,t)=>{if(e.endsWith(".git"))try{q(!0);const b=await m.getBranches(e);a(h=>{const c=[...h.otherRepos||[]];return c[t]&&(c[t]={...c[t],branches:b}),{...h,otherRepos:c}})}catch{a(h=>{const c=[...h.otherRepos||[]];return c[t]&&(c[t]={...c[t],branches:[]}),{...h,otherRepos:c}})}finally{q(!1)}},he=e=>{a(t=>({...t,branch:e}))},de=async()=>{try{S(!0);const e=await m.installGit();if(e.error){i.error(e.error),a(t=>({...t,gitInit:!1}));return}Q(e),a(t=>({...t,gitInit:!0})),i.success("Git 安装成功")}catch{a(t=>({...t,gitInit:!1}))}finally{S(!1)}},ye=async()=>{try{S(!0);const e=await m.installGo();if(e.error){i.error(e.error),a(t=>({...t,goInit:!1}));return}Z(e),a(t=>({...t,goInit:!0})),i.success("Go 安装成功")}catch{a(t=>({...t,goInit:!1}))}finally{S(!1)}},ue=async()=>{try{S(!0);const e=await m.generateSshKey();_(e),a(t=>({...t,sshKeyCopy:!!e?.publicKey})),i.success("SSH Key 生成成功")}catch{}finally{S(!1)}},ge=async()=>{if(!n.repo.startsWith("git@")){i.error(r("deploy.repo.invalidFormat"));return}try{M(!0);const e=await m.getBranches(n.repo);L(e),!n.branch&&e.length>0&&a(t=>({...t,branch:e[0]})),O(!0),i.success(r("deploy.repo.checkSuccess"))}catch{L([]),a(t=>({...t,branch:""})),O(!1)}finally{M(!1)}},fe=async()=>{if(!k?.publicKey){i.error(r("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(k.publicKey),i.success(r("deploy.ssh.copySuccess"))}catch{i.error(r("deploy.ssh.copyFailed"))}},xe=e=>{if(A(e))I(e);else{const t=[];n.gitInit||t.push(r("deploy.steps.gitCheck")),n.sshKeyCopy||t.push(r("deploy.steps.sshConfig")),n.repo||t.push(r("deploy.steps.repoConfig")),n.branch||t.push(r("deploy.steps.branchSelect")),i.warning(r("deploy.navigation.missingSteps",{steps:t.join("、")}))}},me=$.map(e=>({label:e,value:e})),je=async e=>{try{X(!0),a(t=>({...t,autoTrigger:e}))}catch{a(b=>({...b,autoTrigger:!e}))}finally{X(!1)}},A=e=>{switch(e){case 0:return!0;case 1:return n.gitInit&&n.goInit;case 2:return n.gitInit&&n.goInit&&n.sshKeyCopy;case 3:return n.gitInit&&n.goInit&&n.sshKeyCopy&&n.repo&&n.branch;default:return!1}},E=[{title:r("deploy.steps.envCheck"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:r("deploy.git.title")}),v&&!w&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:r("deploy.git.checking")})]}),w?.error&&s.jsx(R,{message:r("deploy.git.installFailed"),description:w.error,type:"error",showIcon:!0,className:"mb-4"}),w?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(x,{children:r("deploy.git.installed")}),s.jsxs(x,{type:"secondary",children:["(",w.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{type:"primary",onClick:de,loading:v,children:r("deploy.git.install")}),s.jsx(j,{onClick:T,children:r("deploy.git.recheck")})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:r("deploy.go.title")}),v&&!C&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:r("deploy.go.checking")})]}),C?.error&&s.jsx(R,{message:C.version?r("deploy.go.versionMismatch"):r("deploy.go.installFailed"),description:C.error,type:"error",showIcon:!0,className:"mb-4"}),C?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(x,{children:r("deploy.go.installed")}),s.jsxs(x,{type:"secondary",children:["(",C.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{type:"primary",onClick:ye,loading:v,children:C?.version?r("deploy.go.reinstall"):r("deploy.go.install")}),s.jsx(j,{onClick:B,children:r("deploy.go.recheck")})]})]})]})},{title:r("deploy.steps.sshConfig"),content:s.jsxs("div",{className:"py-4",children:[v&&!k&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:r("deploy.ssh.checking")})]}),k?.publicKey?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(x,{children:r("deploy.ssh.configured")})]}),s.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(x,{strong:!0,children:r("deploy.ssh.publicKey")}),s.jsx(j,{type:"link",icon:s.jsx(ke,{}),onClick:fe,children:r("deploy.ssh.copy")})]}),s.jsx(Oe,{className:"mb-0 break-all",children:s.jsx(x,{code:!0,children:k.publicKey})})]}),s.jsx(R,{message:r("deploy.ssh.nextStep"),description:r("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(j,{type:"primary",onClick:ue,loading:v,children:r("deploy.ssh.generate")}),s.jsx(R,{message:r("deploy.ssh.nextStep"),description:r("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:r("deploy.steps.repoConfig"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(z,{placeholder:r("deploy.repo.inputPlaceholder"),value:n.repo,onChange:e=>{a(t=>({...t,repo:e.target.value})),O(!1)},style:{width:400}}),s.jsx(j,{onClick:ge,loading:re,type:K?"default":"primary",icon:K?s.jsx(W,{}):null,children:r(K?"deploy.repo.recheck":"deploy.repo.check")})]}),!K&&s.jsx(R,{message:r("deploy.repo.nextStep"),description:r("deploy.repo.tip"),type:"info",showIcon:!0}),K&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(se,{showSearch:!0,style:{width:400},placeholder:r(N?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:me,value:n.branch,onChange:he,loading:N,disabled:N,filterOption:(e,t)=>(t?.label??"").toLowerCase().includes(e.toLowerCase())}),s.jsx(j,{icon:s.jsx(Ke,{spin:N}),onClick:()=>pe(n.repo,0),disabled:!n.repo,loading:N,children:r("deploy.branch.refresh")})]}),!$.length&&!N&&!n.branch&&s.jsx(R,{message:r("deploy.branch.noBranches"),description:r("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),($.length>0||n.branch)&&s.jsx(R,{message:r("deploy.branch.nextStep"),description:n.branch?r("deploy.branch.currentBranch",{branch:n.branch}):r("deploy.branch.selectTip"),type:n.branch?"success":"info",showIcon:!0}),s.jsxs("div",{className:"mt-6 border-t pt-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("div",{className:"font-medium",children:r("deploy.repo.dependencies")}),s.jsx(j,{type:"default",onClick:ie,children:r("deploy.repo.addDependency")})]}),n.otherRepos?.map((e,t)=>s.jsx(te,{repo:e,index:t,onChange:ce,onRemove:le},e.dir)),n.otherRepos&&n.otherRepos.length>0&&s.jsx(R,{message:r("deploy.repo.dependencyTip"),description:s.jsx("div",{style:{lineHeight:1.6},children:r("deploy.repo.dependencyDesc").split(`
`).map((e,t)=>s.jsx("div",{style:{marginBottom:2},children:e},t))}),type:"info",showIcon:!0,className:"mt-4"})]})]})]})},{title:r("deploy.steps.autoTrigger"),content:s.jsx("div",{className:"py-4 space-y-4",children:ae?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:r("deploy.autoTrigger.loading")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(Te,{checked:n.autoTrigger,onChange:je,loading:ne}),s.jsx(x,{children:r("deploy.autoTrigger.enable")})]}),s.jsx(x,{type:"secondary",children:r("deploy.autoTrigger.tip")})]})})}],be=()=>{if(l===2){if(!n.repo||!n.branch){i.warning(r("deploy.navigation.missingSteps",{steps:r("deploy.steps.repoConfig")}));return}if(n.otherRepos&&n.otherRepos.length>0){if(n.otherRepos.filter(g=>!g.dir||!g.repo||!g.branch).length>0){i.warning(r("deploy.repo.incompleteDependency"));return}const t=n.otherRepos.map(g=>g.dir);if(new Set(t).size!==t.length){i.error(r("deploy.repo.duplicateDir"));return}const h=/^[a-zA-Z0-9_-]+$/;if(t.filter(g=>!h.test(g)).length>0){i.error(r("deploy.repo.invalidDir"));return}}}A(l+1)&&I(l+1)},ve=()=>{l>0&&I(l-1)},Se=E.map((e,t)=>({key:e.title,title:e.title,disabled:!A(t)})),Ce=async()=>{try{p(!0),await m.saveTaskCfg(n),y(n),i.success(r("sys.cicd.saveSuccess"))}catch{}finally{p(!1)}};return s.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[s.jsx(Be,{current:l,items:Se,className:"px-6",onChange:xe}),s.jsx("div",{className:"flex-1 mt-4 px-6",children:E[l]?.content}),s.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[l>0&&s.jsx(j,{style:{margin:"0 8px"},onClick:ve,children:r("deploy.navigation.prev")}),l<E.length-1&&s.jsx(j,{type:"primary",onClick:be,disabled:!A(l+1),children:r("deploy.navigation.next")}),l===E.length-1&&s.jsx(j,{type:"primary",onClick:Ce,loading:d,children:r("sys.cicd.save")})]})]})};export{Je as DeploySteps,Je as default};

import{u as ee,F as te,G as se,j as o,I as J,b as G,E as z}from"./index-CVAugEzq.js";import{a as re}from"./vendor-utils-DG9TG-F2.js";import{r as c}from"./vendor-core-Cler3e7Q.js";import{T as F,H as U,af as ae,C as ne,ag as q,G as ie,M as oe,I as ce,s as de,i as Y}from"./vendor-ui-Bdifwvp0.js";const le="https://ssl-checker.zoel-du.workers.dev/?host=";async function K(r){const g=`${le}${r}`,{data:m}=await re.get(g,{timeout:1e4});return m.result}const _="certificateCache",{Text:ue}=de;function fe(r){try{return new URL(r).hostname}catch{return null}}function h(r){return Array.isArray(r)?r:[]}function xe(){const{t:r}=ee(),g=te(),m=se(e=>e.setStats),[l,k]=c.useState([]),[L,v]=c.useState([]),[N,O]=c.useState(!1),[$,T]=c.useState(null),E=c.useRef(r("sys.certificate.fetchFailed")),a=c.useRef(null),[C,Q]=c.useState(!1),M=c.useRef(!1),[A,I]=c.useState(!1),[P,b]=c.useState(""),H=c.useRef(null),y=c.useCallback(e=>{let t=0,n=0;return e.forEach(s=>{if(s.valid===!1){t+=1;return}s.valid===!0&&typeof s.daysLeft=="number"&&(s.daysLeft<0?t+=1:s.daysLeft<=7&&(n+=1))}),{expired:t,expiring:n}},[]);c.useEffect(()=>{E.current=r("sys.certificate.fetchFailed")},[r]),c.useEffect(()=>{try{const e=localStorage.getItem(_);if(e){const t=JSON.parse(e);if(a.current=t,t.domains&&k(h(t.domains)),t.results){const n=h(t.results);v(n);const s=y(n);m({expiring:s.expiring,expired:s.expired,lastChecked:t.lastFetched?new Date(t.lastFetched).getTime():Date.now()})}t.lastFetched&&T(new Date(t.lastFetched))}}catch{}finally{Q(!0)}},[]),c.useEffect(()=>{if(M.current||!C||h(a.current?.domains).length>0||a.current?.seededFromServers||l.length>0)return;const e=g.map(s=>fe(s.addr)).filter(Boolean);if(e.length===0)return;const n=Array.from(new Set(e)).map(s=>({host:s,source:"server",createdAt:Date.now()}));k(n),a.current={domains:n,seededFromServers:!0},localStorage.setItem(_,JSON.stringify({domains:n,lastFetched:a.current?.lastFetched,results:a.current?.results,seededFromServers:!0})),M.current=!0},[g,l.length,C]);const D=c.useCallback(e=>h(e).map(t=>({key:`${t.host}-${t.source}`,name:t.host,addr:t.host,host:t.host})),[]),j=c.useMemo(()=>D(l),[l,D]),S=c.useCallback(e=>{const t={domains:h(l),lastFetched:e.lastFetched??a.current?.lastFetched,results:e.results??h(a.current?.results),seededFromServers:e.seededFromServers??a.current?.seededFromServers??!1};a.current=t,localStorage.setItem(_,JSON.stringify(t))},[l]),w=c.useCallback(async e=>{const t=h(e??(l.length?l:a.current?.domains)),n=D(t);if(n.length===0){S({results:[],lastFetched:void 0});return}O(!0);try{const s=[],f=new Date().toLocaleString();for(const p of n)try{const d=await K(p.host),x=typeof d.cert_valid=="boolean"?d.cert_valid:d.cert_exp===!1?!0:void 0;s.push({key:p.key,name:p.name,addr:p.addr,host:p.host,ip:d.resolved_ip,valid:x,daysLeft:d.days_left??d.valid_days_to_expire??d.validity_days,validFrom:d.valid_from,validTill:d.valid_till,vendor:d.issuer_o||d.issuer_cn,updatedAt:f})}catch(d){const x=typeof d=="string"?d:d?.message||E.current;s.push({key:p.key,name:p.name,addr:p.addr,host:p.host,error:x,daysLeft:void 0,updatedAt:f})}v(s);const i=new Date;T(i);const u=y(s);m({expiring:u.expiring,expired:u.expired,lastChecked:i.getTime()}),S({results:s,lastFetched:i.toISOString()})}finally{O(!1)}},[l,D,S,y,m]);c.useEffect(()=>{if(!C)return;const e=a.current?.lastFetched?new Date(a.current.lastFetched).getTime():0,t=Date.now(),n=24*60*60*1e3;(l.length>0||h(a.current?.domains).length>0)&&(!e||t-e>n)&&w()},[C,l.length,w]),c.useEffect(()=>{if(j.length===0)return;const e=a.current,t=i=>{if(!i)return!1;const u=new Date;return i.getFullYear()===u.getFullYear()&&i.getMonth()===u.getMonth()&&i.getDate()===u.getDate()},n=(e?.domains||[]).map(i=>i.host).sort().join(","),s=l.map(i=>i.host).sort().join(","),f=n===s;if(e?.results&&e.lastFetched&&t(new Date(e.lastFetched))&&f){v(e.results),T(new Date(e.lastFetched));const i=y(e.results);m({expiring:i.expiring,expired:i.expired,lastChecked:new Date(e.lastFetched).getTime()});return}w()},[j.length,l,w]);const Z=async(e,t="server")=>{const n=new Date().toLocaleString();try{const s=await K(e),f=typeof s.cert_valid=="boolean"?s.cert_valid:s.cert_exp===!1?!0:void 0,i={key:`${e}-${t}`,name:e,addr:e,host:e,ip:s.resolved_ip,valid:f,daysLeft:s.days_left??s.valid_days_to_expire??s.validity_days,validFrom:s.valid_from,validTill:s.valid_till,vendor:s.issuer_o||s.issuer_cn,updatedAt:n};v(u=>{const d=[...u.filter(R=>R.host!==e),i],x=y(d);return m({expiring:x.expiring,expired:x.expired,lastChecked:Date.now()}),d}),S({results:[...a.current?.results?h(a.current?.results).filter(u=>u.host!==e):[],i],lastFetched:a.current?.lastFetched})}catch(s){const f=typeof s=="string"?s:s?.message||E.current,i={key:`${e}-${t}`,name:e,addr:e,host:e,error:f,daysLeft:void 0,updatedAt:n};v(u=>{const d=[...u.filter(R=>R.host!==e),i],x=y(d);return m({expiring:x.expiring,expired:x.expired,lastChecked:Date.now()}),d}),S({results:[...a.current?.results?h(a.current?.results).filter(u=>u.host!==e):[],i],lastFetched:a.current?.lastFetched})}};c.useEffect(()=>{const e=y(L);m({expiring:e.expiring,expired:e.expired,lastChecked:Date.now()})},[L,y,m]);const V=()=>{I(!0),b("")};c.useEffect(()=>{A&&setTimeout(()=>H.current?.focus(),50)},[A]);const B=()=>{const e=P.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!e){z.error(r("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(e)){z.error(r("sys.certificate.domainInvalid"));return}if(l.some(f=>f.host.toLowerCase()===e.toLowerCase())){z.warning(r("sys.certificate.domainExists"));return}const s=[...l,{host:e,source:"custom",createdAt:Date.now()}];k(s),a.current={...a.current,domains:s,seededFromServers:a.current?.seededFromServers??!0},localStorage.setItem(_,JSON.stringify({domains:s,lastFetched:a.current?.lastFetched,results:a.current?.results,seededFromServers:a.current?.seededFromServers??!0})),I(!1),b(""),Z(e,"custom")},W=e=>{const t=l.filter(s=>s.host!==e);k(t);const n={domains:h(t),lastFetched:a.current?.lastFetched,results:h(a.current?.results).filter(s=>s.host!==e),seededFromServers:a.current?.seededFromServers??!0};a.current=n,localStorage.setItem(_,JSON.stringify(n)),v(s=>{const f=s.filter(u=>u.host!==e),i=y(f);return m({expiring:i.expiring,expired:i.expired,lastChecked:Date.now()}),f})},X=[{title:r("sys.certificate.api"),dataIndex:"addr",key:"addr",render:(e,t)=>o.jsx("div",{className:"max-w-[220px] truncate md:max-w-none md:whitespace-nowrap",children:t.addr})},{title:r("sys.certificate.ip"),dataIndex:"ip",key:"ip",render:(e,t)=>t.error?"-":t.ip||"-"},{title:r("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",render:(e,t)=>t.error?"-":t.vendor||"-"},{title:r("sys.certificate.daysLeft"),dataIndex:"daysLeft",key:"daysLeft",render:(e,t)=>{if(t.error||typeof t.daysLeft!="number")return"-";const n=t.daysLeft<=7?"error":"default";return o.jsx(F,{color:n,className:"!px-3 !py-1 text-base leading-6",children:o.jsx("span",{className:"text-lg font-medium",children:t.daysLeft})})}},{title:r("sys.certificate.valid"),dataIndex:"valid",key:"valid",render:(e,t)=>t.error?o.jsx(F,{color:"default",children:r("sys.certificate.unknown")}):t.valid===void 0?o.jsx(F,{color:"default",children:r("sys.certificate.unknown")}):t.valid===!1?o.jsx(F,{color:"error",children:r("sys.certificate.invalidTag")}):typeof t.daysLeft=="number"&&t.daysLeft<=7?o.jsx(F,{color:"gold",children:r("sys.certificate.expiring")}):o.jsx(F,{color:"success",children:r("sys.certificate.validTag")})},{title:r("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",render:(e,t)=>t.error?"-":t.validFrom||"-"},{title:r("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",render:(e,t)=>t.error?"-":t.validTill||"-"},{title:r("sys.certificate.remark"),dataIndex:"error",key:"error",render:(e,t)=>t.updatedAt||"-"},{title:r("sys.certificate.operation"),key:"operation",render:(e,t)=>o.jsxs(U,{size:"small",className:"text-gray-500",children:[o.jsx(J,{size:"small",onClick:()=>void Z(t.host),children:o.jsx(G,{icon:"solar:refresh-bold-duotone",size:16})}),o.jsx(ae,{title:r("sys.certificate.deleteConfirm"),onConfirm:()=>W(t.host),children:o.jsx(J,{size:"small",children:o.jsx(G,{icon:"solar:trash-bin-trash-bold-duotone",size:16})})})]})}];return o.jsxs(ne,{title:r("sys.certificate.title"),extra:o.jsxs(U,{size:"middle",children:[$&&o.jsx(ue,{type:"secondary",className:"text-xs",children:r("sys.certificate.updatedAt",{time:$.toLocaleString()})}),o.jsx(Y,{onClick:V,children:r("sys.certificate.addDomain")}),o.jsx(Y,{onClick:()=>{w()},loading:N,disabled:j.length===0,children:r("sys.certificate.refresh")})]}),children:[j.length===0?o.jsx(q,{image:q.PRESENTED_IMAGE_SIMPLE,description:r("sys.certificate.noServer")}):o.jsx(ie,{rowKey:"key",loading:N,columns:X,dataSource:L,pagination:!1,scroll:{x:!0},size:"middle"}),o.jsx(oe,{title:r("sys.certificate.addDomain"),open:A,onOk:B,onCancel:()=>I(!1),okText:r("sys.certificate.confirm"),cancelText:r("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},children:o.jsx(ce,{addonBefore:"https://",placeholder:r("sys.certificate.domainPlaceholder"),value:P,onChange:e=>b(e.target.value),onPressEnter:B,allowClear:!0,ref:H})})]})}export{xe as default};

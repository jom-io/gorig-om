import{c as l,d as A,u as oe,a as ie,j as s}from"./index-DBq9XUmR.js";import{r as a}from"./vendor-core-Cler3e7Q.js";import{J as R,s as le,K as S,N as E,i as y,O as pe,I as de,t as he,P as ye,h as ue,Q as ge,E as p}from"./vendor-ui-BgnAtmuh.js";const fe=()=>l.get({url:"/om/deploy/git/check"}),xe=()=>l.post({url:"/om/deploy/git/install"}),me=()=>l.post({url:"/om/deploy/ssh/key"}),be=()=>l.get({url:"/om/deploy/ssh/key"}),je=i=>l.get({url:"/om/deploy/branches",params:{repoUrl:i}}),Se=i=>l.post({url:"/om/deploy/task/config",data:i}),ke=()=>l.get({url:"/om/deploy/task/config"}),Ce=()=>l.post({url:"/om/deploy/task/start"}),ve=(i,I)=>l.get({url:"/om/deploy/task/page",params:{page:i,size:I}}),Te=i=>l.get({url:"/om/deploy/task/get",params:{id:i}}),Ke=i=>l.post({url:"/om/deploy/task/rollback",params:{id:i}}),we=A(fe,200),Ne=A(be,200),Ie=A(ke,200),d={checkGitStatus:we,installGit:xe,generateSshKey:me,getSshKey:Ne,getBranches:je,saveTaskCfg:Se,getTaskCfg:Ie,startTask:Ce,pageTask:ve,getTask:Te,rollbackTask:Ke},{Text:h,Paragraph:Be}=le,H=({onComplete:i,initialStep:I})=>{const{t}=oe(),g=ie(),[c,v]=a.useState(I),[f,x]=a.useState(!1),[z,O]=a.useState(!1),[m,T]=a.useState(!1),[M,P]=a.useState(!1),[b,F]=a.useState(null),[k,_]=a.useState(null),[B,j]=a.useState([]),[r,o]=a.useState({gitInit:!1,sshKeyCopy:!1,repo:"",branch:"",autoTrigger:!1}),[J,$]=a.useState(!1),[Q,Ge]=a.useState(!1),G=a.useRef(null),L=a.useRef(!1),C=a.useCallback(async()=>{try{const e=await d.checkGitStatus();return F(e),e}catch{return null}},[]),D=a.useCallback(async()=>{try{const e=await d.getSshKey();return _(e),o(n=>({...n,sshKeyCopy:!!e?.publicKey})),e}catch{return null}},[]);a.useCallback(async()=>{try{return await d.getTaskCfg()}catch{return null}},[]),a.useEffect(()=>{c===0?!b&&!f&&!L.current&&C().then(e=>{e?.installed&&o(n=>({...n,gitInit:!0}))}):c===1?D().then(e=>{e?.publicKey&&o(n=>({...n,sshKeyCopy:!0}))}):c===3&&r.repo&&W()},[c,r.repo,C,D,f]);const K=a.useCallback(async()=>{if(g)try{L.current=!0,x(!0);const e=await d.getTaskCfg(),n=await C();o({gitInit:e.gitInit||!!n?.installed,sshKeyCopy:e.sshKeyCopy,repo:e.repo,branch:e.branch,autoTrigger:e.autoTrigger});let u=0;e.gitInit&&(u=1,e.sshKeyCopy&&(u=2,e.repo&&(u=3,e.branch&&(u=4)))),v(u),G.current=g.addr}catch{}finally{L.current=!1,x(!1)}},[g,C]);a.useEffect(()=>{K()},[K]),a.useEffect(()=>{g&&G.current!==g.addr&&(G.current=null,K())},[g,K]);const W=async()=>{if(r.repo)try{T(!0);const e=await d.getBranches(r.repo);j(e),!r.branch&&e.length>0&&o(n=>({...n,branch:e[0]}))}catch{j([])}finally{T(!1)}},q=async()=>{if(r.repo)try{T(!0);const e=await d.getBranches(r.repo);j(e),!r.branch&&e.length>0&&o(n=>({...n,branch:e[0]}))}catch{j([])}finally{T(!1)}},U=async e=>{o(n=>({...n,branch:e}))},V=async()=>{try{x(!0);const e=await d.installGit();if(e.error){p.error(e.error);return}F(e),o(n=>({...n,gitInit:!0})),p.success("Git 安装成功")}catch{}finally{x(!1)}},X=async()=>{try{x(!0);const e=await d.generateSshKey();_(e),o(n=>({...n,sshKeyCopy:!!e?.publicKey})),p.success("SSH Key 生成成功")}catch{}finally{x(!1)}},Y=async()=>{if(!r.repo.startsWith("git@")){p.error(t("deploy.repo.invalidFormat"));return}try{P(!0);const e=await d.getBranches(r.repo);j(e),!r.branch&&e.length>0&&o(n=>({...n,branch:e[0]})),p.success(t("deploy.repo.checkSuccess"))}catch{j([]),o(n=>({...n,branch:""}))}finally{P(!1)}},Z=async()=>{if(!k?.publicKey){p.error(t("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(k.publicKey),p.success(t("deploy.ssh.copySuccess"))}catch{p.error(t("deploy.ssh.copyFailed"))}},ee=e=>{if(w(e))v(e);else{const n=[];r.gitInit||n.push(t("deploy.steps.gitCheck")),r.sshKeyCopy||n.push(t("deploy.steps.sshConfig")),r.repo||n.push(t("deploy.steps.repoConfig")),r.branch||n.push(t("deploy.steps.branchSelect")),p.warning(t("deploy.navigation.missingSteps",{steps:n.join("、")}))}},se=B.map(e=>({label:e,value:e})),te=async e=>{try{$(!0),o(n=>({...n,autoTrigger:e}))}catch{o(u=>({...u,autoTrigger:!e}))}finally{$(!1)}},w=e=>{switch(e){case 0:return!0;case 1:return r.gitInit;case 2:return r.gitInit&&r.sshKeyCopy;case 3:return r.gitInit&&r.sshKeyCopy&&r.repo;case 4:return r.gitInit&&r.sshKeyCopy&&r.repo&&r.branch;default:return!1}},N=[{title:t("deploy.steps.gitCheck"),content:s.jsxs("div",{className:"py-4",children:[f&&!b&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(R,{}),s.jsx(h,{children:t("deploy.git.checking")})]}),b?.error&&s.jsx(S,{message:t("deploy.git.installFailed"),description:b.error,type:"error",showIcon:!0,className:"mb-4"}),b?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(E,{className:"text-success"}),s.jsx(h,{children:t("deploy.git.installed")}),s.jsxs(h,{type:"secondary",children:["(",b.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(y,{type:"primary",onClick:V,loading:f,children:t("deploy.git.install")}),s.jsx(y,{onClick:C,children:t("deploy.git.recheck")})]})]})},{title:t("deploy.steps.sshConfig"),content:s.jsxs("div",{className:"py-4",children:[f&&!k&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(R,{}),s.jsx(h,{children:t("deploy.ssh.checking")})]}),k?.publicKey?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(E,{className:"text-success"}),s.jsx(h,{children:t("deploy.ssh.configured")})]}),s.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(h,{strong:!0,children:t("deploy.ssh.publicKey")}),s.jsx(y,{type:"link",icon:s.jsx(pe,{}),onClick:Z,children:t("deploy.ssh.copy")})]}),s.jsx(Be,{className:"mb-0 break-all",children:s.jsx(h,{code:!0,children:k.publicKey})})]}),s.jsx(S,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(y,{type:"primary",onClick:X,loading:f,children:t("deploy.ssh.generate")}),s.jsx(S,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:t("deploy.steps.repoConfig"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(de,{placeholder:t("deploy.repo.inputPlaceholder"),value:r.repo,onChange:e=>{o(n=>({...n,repo:e.target.value}))},style:{width:400}}),s.jsx(y,{onClick:Y,loading:M,type:r.repo?"default":"primary",icon:r.repo?s.jsx(E,{}):null,children:r.repo?t("deploy.repo.recheck"):t("deploy.repo.check")})]}),s.jsx(S,{message:r.repo?t("deploy.repo.success"):t("deploy.repo.nextStep"),description:r.repo?t("deploy.repo.successTip"):t("deploy.repo.tip"),type:r.repo?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.branchSelect"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(he,{showSearch:!0,style:{width:400},placeholder:t(m?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:se,value:r.branch,onChange:U,loading:m,disabled:m,filterOption:(e,n)=>(n?.label??"").toLowerCase().includes(e.toLowerCase())}),s.jsx(y,{icon:s.jsx(ye,{spin:m}),onClick:q,disabled:!r.repo,loading:m,children:t("deploy.branch.refresh")})]}),!B.length&&!m&&!r.branch&&s.jsx(S,{message:t("deploy.branch.noBranches"),description:t("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),(B.length>0||r.branch)&&s.jsx(S,{message:t("deploy.branch.nextStep"),description:r.branch?t("deploy.branch.currentBranch",{branch:r.branch}):t("deploy.branch.selectTip"),type:r.branch?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.autoTrigger"),content:s.jsx("div",{className:"py-4 space-y-4",children:Q?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(R,{}),s.jsx(h,{children:t("deploy.autoTrigger.loading")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(ue,{checked:r.autoTrigger,onChange:te,loading:J}),s.jsx(h,{children:t("deploy.autoTrigger.enable")})]}),s.jsx(h,{type:"secondary",children:t("deploy.autoTrigger.tip")})]})})}],re=()=>{w(c+1)&&v(c+1)},ne=()=>{c>0&&v(c-1)},ae=N.map((e,n)=>({key:e.title,title:e.title,disabled:!w(n)})),ce=async()=>{try{O(!0),await d.saveTaskCfg(r),i(r),p.success(t("sys.cicd.saveSuccess"))}catch{}finally{O(!1)}};return s.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[s.jsx(ge,{current:c,items:ae,className:"px-6",onChange:ee}),s.jsx("div",{className:"flex-1 mt-4 px-6",children:N[c].content}),s.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[c>0&&s.jsx(y,{style:{margin:"0 8px"},onClick:ne,children:t("deploy.navigation.prev")}),c<N.length-1&&s.jsx(y,{type:"primary",onClick:re,disabled:!w(c+1),children:t("deploy.navigation.next")}),c===N.length-1&&s.jsx(y,{type:"primary",onClick:ce,loading:z,children:t("sys.cicd.save")})]})]})},Ae=Object.freeze(Object.defineProperty({__proto__:null,DeploySteps:H,default:H},Symbol.toStringTag,{value:"Module"}));export{H as D,Ae as a,d};

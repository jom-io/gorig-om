import{d as nt,c as B,u as ot,a as ct,j as e}from"./index-Cm_8XUJi.js";import{z as c,s as it,i as p,C as lt,H as dt,G as ut,M as H,E as z}from"./vendor-ui-Bdifwvp0.js";import{r}from"./vendor-core-Cler3e7Q.js";import"./vendor-utils-DG9TG-F2.js";const ft=()=>B.post({url:"/om/app/restart"}),mt=(t,a)=>B.get({url:"/om/app/restart/logs",params:{page:t,size:a}}),yt=nt(mt,200),g={restart:ft,restartLogs:yt},{Text:i}=it,I=t=>{switch(t){case"manual":return"#52c41a";case"deploy":return"#1890ff";case"crash":return"#ff4d4f";case"overuse":return"#faad14";default:return"#000000"}},V=(t,a)=>{switch(t){case"manual":return a("sys.restart.manual");case"deploy":return a("sys.restart.deploy");case"crash":return a("sys.restart.crash");case"overuse":return a("sys.restart.overuse");default:return a("sys.restart.unknown")}},m=t=>t.toString().padStart(2,"0"),wt=()=>{const{t}=ot(),a=ct(),[d,P]=r.useState(null),[_,w]=r.useState(!1),[u,S]=r.useState(0),[F,j]=r.useState(!1),[l,T]=r.useState(!1),[v,b]=r.useState([]),[G,C]=r.useState(0),[y,M]=r.useState(1),[h]=r.useState(10),[K,L]=r.useState(!1),[O,k]=r.useState(!1),[q,A]=r.useState(""),N=r.useCallback(async()=>{if(a)try{w(!0);const s=await g.restartLogs(0,1);if(s.items&&s.items.length>0){P(s.items[0]);const n=c.unix(s.items[0].startTime),o=c();S(o.diff(n,"second"))}}catch{}finally{w(!1)}},[a]),R=r.useCallback(async(s,n)=>{if(a)try{L(!0);const o=await g.restartLogs(s,n);b(o.items),C(o.total)}catch{}finally{L(!1)}},[a]);r.useEffect(()=>{a&&(N(),T(!1),M(1),b([]),C(0))},[a,N]),r.useEffect(()=>{l&&a&&R(y,h)},[l,y,h,R,a]),r.useEffect(()=>{const s=setInterval(()=>{S(n=>n+1)},1e3);return()=>clearInterval(s)},[]);const J=()=>{H.confirm({title:t("sys.restart.confirmTitle"),content:t("sys.restart.confirmContent"),onOk:async()=>{try{j(!0),await g.restart(),z.success(t("sys.restart.restarting")),setTimeout(()=>{window.location.reload()},3e3)}catch{z.error(t("sys.restart.failed"))}finally{j(!1)}}})},Q=s=>{M(s)},U=s=>{A(s),k(!0)},$=(s,n)=>{const o=c.unix(s),f=(n?c.unix(n):c()).diff(o,"second"),E=Math.floor(f/86400),et=Math.floor(f%86400/3600),rt=Math.floor(f%3600/60),at=f%60;let x="";return E>0&&(x+=`${E}${t("sys.restart.day")}`),x+=`${et}${t("sys.restart.hour")}${m(rt)}${t("sys.restart.minute")}${m(at)}${t("sys.restart.second")}`,x},W=[{title:t("sys.restart.startTime"),dataIndex:"startTime",key:"startTime",width:180,render:s=>c.unix(s).format("YYYY-MM-DD HH:mm:ss")},{title:t("sys.restart.duration"),key:"duration",width:180,render:(s,n,o)=>{if(o===0)return $(n.startTime);const D=v[o-1];return $(n.startTime,D.startTime)}},{title:t("sys.restart.startType"),dataIndex:"startSrc",key:"startSrc",width:100,render:s=>e.jsx(i,{style:{color:I(s)},children:V(s,t)})},{title:t("sys.restart.operation"),key:"operation",width:100,align:"center",render:(s,n)=>e.jsx(p,{type:"link",size:"small",onClick:()=>U(n.log),children:t("sys.restart.viewLog")})}];if(!d)return null;const Y=Math.floor(u/86400),X=Math.floor(u%86400/3600),Z=Math.floor(u%3600/60),tt=u%60,st=c.unix(d.startTime);return e.jsxs(lt,{className:"w-full",loading:_,styles:{body:{padding:"12px 24px"}},children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsxs(i,{className:"text-gray-500",children:[t("sys.restart.runningTime"),"："]}),e.jsxs(i,{strong:!0,className:"text-base",children:[Y>0?`${Y}${t("sys.restart.day")}`:"",X,t("sys.restart.hour"),m(Z),t("sys.restart.minute"),m(tt),t("sys.restart.second")]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsxs(i,{className:"text-gray-500",children:[t("sys.restart.startTime"),"："]}),e.jsx(i,{children:st.format("YYYY-MM-DD HH:mm:ss")})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsxs(i,{className:"text-gray-500",children:[t("sys.restart.startType"),"："]}),e.jsx(i,{style:{color:I(d.startSrc)},children:V(d.startSrc,t)})]})]}),e.jsxs(dt,{children:[e.jsx(p,{onClick:()=>T(!l),children:t(l?"sys.restart.collapse":"sys.restart.moreRecords")}),e.jsx(p,{type:"primary",onClick:J,loading:F,className:"!bg-[#faad14] !border-[#faad14] hover:!bg-[#ffc53d] hover:!border-[#ffc53d]",children:t("sys.restart.restart")})]})]}),e.jsx("div",{className:`overflow-hidden transition-all duration-300 ease-in-out ${l?"max-h-[2000px] opacity-100":"max-h-0 opacity-0"}`,children:e.jsx("div",{className:"mt-4",children:e.jsx(ut,{columns:W,dataSource:v,rowKey:s=>s.startTime.toString(),pagination:{current:y,pageSize:h,total:G,onChange:Q},loading:K,size:"small"})})}),e.jsx(H,{title:t("sys.restart.logDetail"),open:O,onCancel:()=>k(!1),footer:null,width:"50vw",styles:{body:{maxHeight:"60vh",overflowY:"auto",whiteSpace:"pre-wrap",wordBreak:"break-word"}},children:q})]})};export{wt as default};

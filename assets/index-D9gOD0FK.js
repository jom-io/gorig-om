import{J,K as ce,N as de,c as F,O as ge,a as ue,u as he,j as s}from"./index-AHjT66P3.js";import{l as me,r as d}from"./vendor-core-D3G3Pc5t.js";import{Q as fe,u as pe}from"./useBaseQuery-B9Qt2qvj.js";import{A as K,F as y,z as c,H as E,C as G,U as ye,V as b,t as D,T as xe,I as X,ac as W,i as C,M as Z,ae as be,n as Pe}from"./vendor-ui-B8JNe9Dz.js";import{LogList as ee}from"./log-list-C30QXk09.js";import"./vendor-utils-9ATX-dPw.js";var we=class extends fe{constructor(r,h){super(r,h)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(r,h){super.setOptions({...r,behavior:J()},h)}getOptimisticResult(r){return r.behavior=J(),super.getOptimisticResult(r)}fetchNextPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"backward"}}})}createResult(r,h){const{state:T}=r,L=super.createResult(r,h),{isFetching:N,isRefetching:l,isError:m,isRefetchError:k}=L,p=T.fetchMeta?.fetchMore?.direction,x=m&&p==="forward",f=N&&p==="forward",P=m&&p==="backward",I=N&&p==="backward";return{...L,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:de(h,T.data),hasPreviousPage:ce(h,T.data),isFetchNextPageError:x,isFetchingNextPage:f,isFetchPreviousPageError:P,isFetchingPreviousPage:I,isRefetchError:k&&!x&&!P,isRefetching:l&&!f&&!I}}};function je(r,h){return pe(r,we)}function ve(){const[r]=me();return d.useMemo(()=>r,[r])}const Te=r=>F.post({url:"/om/log/search",data:r}),ke=()=>F.get({url:"/om/log/categories"}),Ce=()=>F.get({url:"/om/log/levels"}),Fe=r=>F.get({url:"/om/log/near",params:r}),Le=r=>F.get({url:"/om/log/download",params:{path:r},responseType:"blob"}),M={getLogList:Te,getCategories:ke,getLevels:Ce,getNearLogs:Fe,downloadLog:Le},se=1e3;function Oe(){const{message:r}=K.useApp(),[h,T]=d.useState([]),[L,N]=d.useState([]),[l]=y.useForm(),[m,k]=d.useState(null),[p,x]=d.useState(!1),[f,P]=d.useState(!1),[I,Y]=d.useState(null),R=d.useRef(null),Q=ge(),[w,O]=d.useState(!1),[te,H]=d.useState(!1),[g,re]=d.useState([]),j=ue(),{t:a}=he(),v=ve();d.useEffect(()=>{const e=v.get("traceID"),t=v.get("startTime"),o=v.get("endTime");if(e){const i=t?c(Number(t)):c().subtract(1,"hour"),n=o?c(Number(o)):i.clone().add(1,"hour");l.setFieldsValue({traceID:e,startTime:i,endTime:n,categories:[],level:void 0,keyword:""});const u=l.getFieldsValue();k(u)}else l.setFieldsValue({startTime:c().subtract(1,"hour")})},[l,v]),d.useEffect(()=>{j&&(async()=>{try{const[t,o]=await Promise.all([M.getCategories(),M.getLevels()]);if(N(t),T(o),!v.get("traceID")&&t&&t.length>0){const n=t.includes("commons")?"commons":t[0];l.setFieldsValue({categories:[n]})}}catch{r.error(a("sys.log.fetchDataFailed"))}})()},[j,l,r,a,v]);const $=(e,t)=>{t.stopPropagation(),Z.confirm({title:a("sys.log.downloadConfirm"),content:a("sys.log.downloadConfirmContent"),onOk:async()=>{try{const o=await fetch(`${j?.addr}/om/log/download?path=${e}`,{headers:{Authorization:`Bearer ${j?.token}`}});if(!o.ok)throw new Error("下载失败");const i=await o.blob(),n=window.URL.createObjectURL(i),u=document.createElement("a");u.href=n,u.download=e.split("/").pop()||"logfile",document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(n)}catch{r.error(a("sys.log.downloadFailed"))}}})},S=async(e,t,o)=>{if(o.stopPropagation(),!(t<=0))try{const i=await M.getNearLogs({path:e,line:t,range:10});i.forEach(n=>{n.line===t&&(n.highlight=!0)}),re(i),H(!0)}catch{r.error(a("sys.log.contextLogFailed"))}},{data:ae,fetchNextPage:U,hasNextPage:q,isFetchingNextPage:z}=je({queryKey:["logs",m],queryFn:async({pageParam:e={lastPath:void 0,lastLine:void 0}})=>{try{if(p)return[];x(!0);const t=m,o={...t,startTime:t?.startTime?c(t.startTime).format("YYYY-MM-DD HH:mm:ss"):void 0,endTime:t?.endTime?c(t.endTime).format("YYYY-MM-DD HH:mm:ss"):void 0},i=await M.getLogList({...o,lastPath:e.lastPath,lastLine:e.lastLine,size:50});return await new Promise(n=>setTimeout(n,200)),!i||i.length===0?[]:i}catch{return[]}finally{x(!1)}},getNextPageParam:e=>{if(!e||e.length===0)return;const t=e[e.length-1];return{lastPath:t.path,lastLine:t.line}},initialPageParam:void 0,enabled:m!==null&&!f,retry:1,retryDelay:1e3}),oe=ae?.pages.flat()??[];d.useEffect(()=>{const e=new IntersectionObserver(t=>{if(t[0]?.isIntersecting&&q&&!z){if(f)return;U()}},{threshold:.5});return R.current&&e.observe(R.current),()=>{e.disconnect()}},[q,z,U,f]);const ie=async()=>{if(f)I?.close(),P(!1),O(!1),r.success(a("sys.log.monitorStopped"));else{Q.setQueryData(["logs",m],{pages:[],pageParams:[]});const e={categories:l.getFieldValue("categories"),level:l.getFieldValue("level"),keyword:l.getFieldValue("keyword"),traceID:l.getFieldValue("traceID"),token:j?.token},t=Object.entries(e).filter(([i,n])=>n!==void 0).reduce((i,[n,u])=>(i[n]=u,i),{}),o=new EventSource(`${j?.addr}/om/log/monitor?${new URLSearchParams(t).toString()}`);o.onmessage=i=>{if(i.data==="monitoring started")r.success(a("sys.log.monitorStarted"));else if(i.data==="monitoring stopped")r.success(a("sys.log.monitorStopped")),o.close();else{const n=JSON.parse(i.data);Q.setQueryData(["logs",m],u=>{const ne=u?.pages||[],V=[n,...ne.flat()];return V.length>se&&V.splice(se),{pages:[V],pageParams:[]}})}},o.onerror=()=>{o.close(),P(!1),r.error(a("sys.log.monitorFailed")),O(!1)},Y(o),P(!0),x(!1),O(!0)}},A=(e,t)=>{t.stopPropagation(),l.setFieldsValue({categories:[],level:"",keyword:"",traceID:e}),k(o=>o?{...o,categories:[],level:"",keyword:"",traceID:e}:null),B()},le=()=>{l.resetFields(),l.setFieldsValue({startTime:c().subtract(1,"hour"),endTime:c()})},B=async()=>{if(!f&&!p)try{const e=l.getFieldsValue();k(e)}catch{x(!1)}},_=(e,t)=>{t.stopPropagation();const o=c(e).format("YYYY-MM-DD HH:mm:ss"),i=l.getFieldValue("startTime"),n=l.getFieldValue("endTime");i?n?l.setFieldsValue({endTime:c(o)}):l.setFieldsValue({endTime:c(o)}):l.setFieldsValue({startTime:c(o)})};return s.jsxs(K,{children:[s.jsxs(E,{direction:"vertical",size:"small",className:"w-full",children:[s.jsx(G,{children:s.jsx(y,{form:l,onFinish:B,children:s.jsxs(ye,{gutter:[16,16],style:{fontSize:"12px",lineHeight:"16px"},children:[s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.category"),name:"categories",className:"!mb-0",children:s.jsx(D,{mode:"multiple",allowClear:!0,disabled:w,children:L.map(e=>s.jsx(D.Option,{value:e,children:e},e))})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.level"),name:"level",className:"!mb-0",children:s.jsx(D,{allowClear:!0,disabled:w,children:h.map(e=>s.jsx(D.Option,{value:e,children:s.jsx(xe,{color:e==="error"||e==="fatal"||e==="dpanic"?"error":e==="warn"?"warning":"success",children:e})},e))})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.keyword"),name:"keyword",className:"!mb-0",children:s.jsx(X,{placeholder:a("sys.log.keywordPlaceholder"),allowClear:!0,disabled:w})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.traceID"),name:"traceID",className:"!mb-0",children:s.jsx(X,{placeholder:a("sys.log.traceIDPlaceholder"),allowClear:!0,disabled:w})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.startTime"),name:"startTime",className:"!mb-0",children:s.jsx(W,{showTime:!0,style:{width:"100%"},disabled:w,disabledDate:e=>e&&e>c().endOf("day"),placeholder:a("sys.log.startTimePlaceholder")})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.endTime"),name:"endTime",className:"!mb-0",children:s.jsx(W,{showTime:!0,style:{width:"100%"},disabled:w,disabledDate:e=>e&&e>c().endOf("day"),placeholder:a("sys.log.endTimePlaceholder")})})}),s.jsx(b,{span:24,children:s.jsxs("div",{className:"flex justify-end",children:[s.jsx(C,{onClick:le,children:a("sys.log.reset")}),s.jsx(C,{type:"primary",className:"ml-4",htmlType:"submit",loading:p,disabled:f,children:a("sys.log.search")}),s.jsx(C,{type:"primary",className:"ml-4",onClick:ie,children:a(f?"sys.log.stopMonitor":"sys.log.startMonitor")})]})})]})})}),s.jsxs(G,{children:[s.jsx(ee,{dataSource:oe,keyword:m?.keyword,onTraceIDClick:A,onLineNumberClick:S,onFileClick:$,onTimeClick:_}),s.jsx("div",{ref:R,style:{height:20}})]})]}),s.jsx(Z,{title:a("sys.log.contextLog"),open:te,onCancel:()=>H(!1),footer:s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"8px"},children:[s.jsx(C,{onClick:e=>{g&&g.length>0&&S(g[0].path,g[0].line,e)},disabled:!g||g.length===0,children:s.jsxs(E,{children:[s.jsx(be,{}),a("sys.log.prevPage")]})}),s.jsx(C,{onClick:e=>{if(g&&g.length>0){const t=g[g.length-1];S(t.path,t.line,e)}},disabled:!g||g.length===0,children:s.jsxs(E,{children:[a("sys.log.nextPage"),s.jsx(Pe,{})]})})]}),width:1e3,styles:{body:{height:"70vh",padding:"24px",overflow:"hidden"},content:{height:"100%"}},children:s.jsx("div",{style:{height:"100%",overflow:"auto"},children:s.jsx(ee,{dataSource:g,keyword:m?.keyword,onTraceIDClick:A,onLineNumberClick:S,onFileClick:$,onTimeClick:_})})})]})}export{Oe as default};

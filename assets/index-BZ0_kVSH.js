import{u as oe,F as ce,G as de,j as l,I as K,b as Q,E as V}from"./index-B0Zw6bap.js";import{a as le}from"./vendor-utils-DG9TG-F2.js";import{r as c}from"./vendor-core-Cler3e7Q.js";import{T as _,H as W,af as ue,C as fe,ag as X,G as me,M as ye,I as he,i as ee,s as pe}from"./vendor-ui-Bdifwvp0.js";const ge="https://ssl-checker.zoel-du.workers.dev/?host=";async function te(s){const v=`${ge}${s}`,{data:I}=await le.get(v,{timeout:1e4});return I.result}const b="certificateCache",{Text:Te}=pe,se=s=>{const v=Number(s);return Number.isFinite(v)?v:void 0};function xe(s){try{return new URL(s).hostname}catch{return null}}function x(s){return Array.isArray(s)?s:[]}function _e(){const{t:s}=oe(),v=ce(),I=de(e=>e.setStats),[y,E]=c.useState([]),[N,T]=c.useState([]),[$,H]=c.useState(!1),[Ie,A]=c.useState(null),[Z,k]=c.useState({current:1,pageSize:10}),O=c.useRef(s("sys.certificate.fetchFailed")),a=c.useRef(null),[C,re]=c.useState(!1),B=c.useRef(!1),[z,P]=c.useState(!1),[J,R]=c.useState(""),G=c.useRef(null),S=c.useCallback(e=>{let t=0,o=0;return e.forEach(r=>{if(r.valid===!1){t+=1;return}r.valid===!0&&typeof r.daysLeft=="number"&&(r.daysLeft<0?t+=1:r.daysLeft<=7&&(o+=1))}),{expired:t,expiring:o}},[]);c.useEffect(()=>{O.current=s("sys.certificate.fetchFailed")},[s]),c.useEffect(()=>{try{const e=localStorage.getItem(b);if(e){const t=JSON.parse(e);if(a.current=t,t.domains&&E(x(t.domains)),t.results){const r=[...x(t.results)].sort((u,d)=>{const m=typeof u.daysLeft=="number"?u.daysLeft:Number.POSITIVE_INFINITY,f=typeof d.daysLeft=="number"?d.daysLeft:Number.POSITIVE_INFINITY;return m-f});T(r);const n=S(r);I({expiring:n.expiring,expired:n.expired,lastChecked:t.lastFetched?new Date(t.lastFetched).getTime():Date.now()})}t.lastFetched&&A(new Date(t.lastFetched))}}catch{}finally{re(!0)}},[]),c.useEffect(()=>{if(B.current||!C||x(a.current?.domains).length>0||a.current?.seededFromServers||y.length>0)return;const e=v.map(r=>xe(r.addr)).filter(Boolean);if(e.length===0)return;const o=Array.from(new Set(e)).map(r=>({host:r,source:"server",createdAt:Date.now()}));E(o),a.current={domains:o,seededFromServers:!0},localStorage.setItem(b,JSON.stringify({domains:o,lastFetched:a.current?.lastFetched,results:a.current?.results,seededFromServers:!0})),B.current=!0},[v,y.length,C]);const D=c.useCallback(e=>x(e).map(t=>({key:`${t.host}-${t.source}`,name:t.host,addr:t.host,host:t.host})),[]),j=c.useMemo(()=>D(y),[y,D]),L=c.useCallback(e=>{const t={domains:x(y),lastFetched:e.lastFetched??a.current?.lastFetched,results:e.results??x(a.current?.results),seededFromServers:e.seededFromServers??a.current?.seededFromServers??!1};a.current=t,localStorage.setItem(b,JSON.stringify(t))},[y]),w=c.useCallback(async e=>{const t=x(e??(y.length?y:a.current?.domains)),o=D(t);if(o.length===0){L({results:[],lastFetched:void 0});return}H(!0);try{const r=[],n=new Date().toLocaleString();for(const f of o)try{const i=await te(f.host),g=typeof i.cert_valid=="boolean"?i.cert_valid:i.cert_exp===!1?!0:void 0;r.push({key:f.key,name:f.name,addr:f.addr,host:f.host,ip:i.resolved_ip,valid:g,daysLeft:se(i.days_left??i.valid_days_to_expire??i.validity_days),validFrom:i.valid_from,validTill:i.valid_till,vendor:i.issuer_o||i.issuer_cn,updatedAt:n})}catch(i){const g=typeof i=="string"?i:i?.message||O.current;r.push({key:f.key,name:f.name,addr:f.addr,host:f.host,error:g,daysLeft:void 0,updatedAt:n})}const u=[...r].sort((f,i)=>{const g=typeof f.daysLeft=="number"?f.daysLeft:Number.POSITIVE_INFINITY,F=typeof i.daysLeft=="number"?i.daysLeft:Number.POSITIVE_INFINITY;return g-F});T(u);const d=new Date;A(d);const m=S(r);I({expiring:m.expiring,expired:m.expired,lastChecked:d.getTime()}),L({results:r,lastFetched:d.toISOString()})}finally{H(!1)}},[y,D,L,S,I]);c.useEffect(()=>{if(!C)return;const e=a.current?.lastFetched?new Date(a.current.lastFetched).getTime():0,t=Date.now(),o=24*60*60*1e3;(y.length>0||x(a.current?.domains).length>0)&&(!e||t-e>o)&&w()},[C,y.length,w]),c.useEffect(()=>{if(j.length===0)return;const e=a.current,t=u=>{if(!u)return!1;const d=new Date;return u.getFullYear()===d.getFullYear()&&u.getMonth()===d.getMonth()&&u.getDate()===d.getDate()},o=(e?.domains||[]).map(u=>u.host).sort().join(","),r=y.map(u=>u.host).sort().join(","),n=o===r;if(e?.results&&e.lastFetched&&t(new Date(e.lastFetched))&&n){const u=[...e.results].sort((m,f)=>{const i=typeof m.daysLeft=="number"?m.daysLeft:Number.POSITIVE_INFINITY,g=typeof f.daysLeft=="number"?f.daysLeft:Number.POSITIVE_INFINITY;return i-g});T(u),A(new Date(e.lastFetched));const d=S(e.results);I({expiring:d.expiring,expired:d.expired,lastChecked:new Date(e.lastFetched).getTime()});return}w()},[j.length,y,w]);const U=async(e,t="server",o=!1)=>{const r=new Date().toLocaleString();try{const n=await te(e),u=typeof n.cert_valid=="boolean"?n.cert_valid:n.cert_exp===!1?!0:void 0,d={key:`${e}-${t}`,name:e,addr:e,host:e,ip:n.resolved_ip,valid:u,daysLeft:se(n.days_left??n.valid_days_to_expire??n.validity_days),validFrom:n.valid_from,validTill:n.valid_till,vendor:n.issuer_o||n.issuer_cn,updatedAt:r};T(m=>{const i=[...m.filter(h=>h.host!==e),d],g=S(i);I({expiring:g.expiring,expired:g.expired,lastChecked:Date.now()});const F=[...i].sort((h,p)=>{const M=typeof h.daysLeft=="number"?h.daysLeft:Number.POSITIVE_INFINITY,Y=typeof p.daysLeft=="number"?p.daysLeft:Number.POSITIVE_INFINITY;return M-Y});if(o){const h=F.findIndex(p=>p.host===e);h>=0&&k(p=>({...p,current:Math.floor(h/p.pageSize)+1}))}return F}),L({results:[...a.current?.results?x(a.current?.results).filter(m=>m.host!==e):[],d],lastFetched:a.current?.lastFetched})}catch(n){const u=typeof n=="string"?n:n?.message||O.current,d={key:`${e}-${t}`,name:e,addr:e,host:e,error:u,daysLeft:void 0,updatedAt:r};T(m=>{const i=[...m.filter(h=>h.host!==e),d],g=S(i);I({expiring:g.expiring,expired:g.expired,lastChecked:Date.now()});const F=[...i].sort((h,p)=>{const M=typeof h.daysLeft=="number"?h.daysLeft:Number.POSITIVE_INFINITY,Y=typeof p.daysLeft=="number"?p.daysLeft:Number.POSITIVE_INFINITY;return M-Y});if(o){const h=F.findIndex(p=>p.host===e);h>=0&&k(p=>({...p,current:Math.floor(h/p.pageSize)+1}))}return F}),L({results:[...a.current?.results?x(a.current?.results).filter(m=>m.host!==e):[],d],lastFetched:a.current?.lastFetched})}};c.useEffect(()=>{const e=S(N);I({expiring:e.expiring,expired:e.expired,lastChecked:Date.now()})},[N,S,I]),c.useEffect(()=>{k(e=>{const t=Math.max(1,Math.ceil(N.length/e.pageSize)),o=Math.min(e.current,t);return{...e,current:o}})},[N.length]);const ae=()=>{P(!0),R("")};c.useEffect(()=>{z&&setTimeout(()=>G.current?.focus(),50)},[z]);const q=()=>{const e=J.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!e){V.error(s("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(e)){V.error(s("sys.certificate.domainInvalid"));return}if(y.some(n=>n.host.toLowerCase()===e.toLowerCase())){V.warning(s("sys.certificate.domainExists"));return}const r=[...y,{host:e,source:"custom",createdAt:Date.now()}];E(r),a.current={...a.current,domains:r,seededFromServers:a.current?.seededFromServers??!0},localStorage.setItem(b,JSON.stringify({domains:r,lastFetched:a.current?.lastFetched,results:a.current?.results,seededFromServers:a.current?.seededFromServers??!0})),P(!1),R(""),U(e,"custom",!0)},ne=e=>{const t=y.filter(r=>r.host!==e);E(t);const o={domains:x(t),lastFetched:a.current?.lastFetched,results:x(a.current?.results).filter(r=>r.host!==e),seededFromServers:a.current?.seededFromServers??!0};a.current=o,localStorage.setItem(b,JSON.stringify(o)),T(r=>{const n=r.filter(d=>d.host!==e),u=S(n);return I({expiring:u.expiring,expired:u.expired,lastChecked:Date.now()}),[...n].sort((d,m)=>{const f=typeof d.daysLeft=="number"?d.daysLeft:Number.POSITIVE_INFINITY,i=typeof m.daysLeft=="number"?m.daysLeft:Number.POSITIVE_INFINITY;return f-i})})},ie=[{title:l.jsx("div",{className:"pl-4 text-left",children:s("sys.certificate.api")}),dataIndex:"addr",key:"addr",align:"left",render:(e,t)=>l.jsx("div",{className:"max-w-[220px] truncate pl-4 md:max-w-none md:whitespace-nowrap",children:t.addr})},{title:s("sys.certificate.ip"),dataIndex:"ip",key:"ip",align:"center",render:(e,t)=>t.error?"-":t.ip||"-"},{title:s("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",align:"center",render:(e,t)=>t.error?"-":t.vendor||"-"},{title:s("sys.certificate.daysLeft"),dataIndex:"daysLeft",key:"daysLeft",width:110,align:"center",render:(e,t)=>{if(t.error||typeof t.daysLeft!="number")return"-";const o=t.daysLeft<=7?"error":"default";return l.jsx(_,{color:o,className:"!px-3 !py-1 text-base leading-6",children:l.jsx("span",{className:"text-lg font-medium",children:t.daysLeft})})}},{title:s("sys.certificate.valid"),dataIndex:"valid",key:"valid",width:110,align:"center",className:"!whitespace-nowrap",render:(e,t)=>t.error?l.jsx(_,{color:"default",children:s("sys.certificate.unknown")}):t.valid===void 0?l.jsx(_,{color:"default",children:s("sys.certificate.unknown")}):t.valid===!1?l.jsx(_,{color:"error",children:s("sys.certificate.invalidTag")}):typeof t.daysLeft=="number"&&t.daysLeft<=7?l.jsx(_,{color:"gold",children:s("sys.certificate.expiring")}):l.jsx(_,{color:"success",children:s("sys.certificate.validTag")})},{title:s("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",align:"center",render:(e,t)=>t.error?"-":t.validFrom||"-"},{title:s("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",align:"center",render:(e,t)=>t.error?"-":t.validTill||"-"},{title:s("sys.certificate.remark"),dataIndex:"error",key:"error",align:"center",render:(e,t)=>t.updatedAt||"-"},{title:s("sys.certificate.operation"),key:"operation",align:"center",render:(e,t)=>l.jsxs(W,{size:"small",className:"text-gray-500",children:[l.jsx(K,{size:"small",onClick:()=>void U(t.host),children:l.jsx(Q,{icon:"solar:refresh-bold-duotone",size:16})}),l.jsx(ue,{title:s("sys.certificate.deleteConfirm"),onConfirm:()=>ne(t.host),children:l.jsx(K,{size:"small",children:l.jsx(Q,{icon:"solar:trash-bin-trash-bold-duotone",size:16})})})]})}];return l.jsxs(fe,{title:s("sys.certificate.title"),styles:{body:{padding:0}},extra:l.jsxs(W,{size:"middle",children:[l.jsx(ee,{type:"primary",onClick:ae,children:s("sys.certificate.addDomain")}),l.jsx(ee,{onClick:()=>void w(),loading:$,disabled:j.length===0,children:s("sys.certificate.refreshAll")})]}),children:[j.length===0?l.jsx(X,{image:X.PRESENTED_IMAGE_SIMPLE,description:s("sys.certificate.noServer")}):l.jsx(me,{rowKey:"key",loading:$,columns:ie,dataSource:N,pagination:{current:Z.current,pageSize:Z.pageSize,total:N.length,showSizeChanger:!1,onChange:e=>k(t=>({...t,current:e}))},scroll:{x:"max-content"},size:"small",className:"w-full"}),l.jsx(ye,{title:s("sys.certificate.addDomain"),open:z,onOk:q,onCancel:()=>P(!1),okText:s("sys.certificate.confirm"),cancelText:s("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},children:l.jsx(he,{addonBefore:"https://",placeholder:s("sys.certificate.domainPlaceholder"),value:J,onChange:e=>R(e.target.value),onPressEnter:q,allowClear:!0,ref:G})})]})}export{_e as default};

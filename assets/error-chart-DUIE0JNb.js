import{d as L,c as R,u as I,t as f,j as s}from"./index-CVAugEzq.js";import{C as W}from"./index-BhnXKidm.js";import{u as $,C as B}from"./useChart-DKoN25xi.js";import{r as o}from"./vendor-core-Cler3e7Q.js";import{M as G,t as K,G as V,s as m,T as q}from"./vendor-ui-Bdifwvp0.js";const J=(c,b,d,a)=>R.get({url:"/om/stat/error/time",params:{start:c,end:b,unit:d,filter:a},paramsSerializer:{serialize:l=>{const i=new URLSearchParams;for(const[h,u]of Object.entries(l))if(Array.isArray(u))for(const w of u)i.append(h,w);else i.append(h,String(u));return i.toString()}}}),Q=L(J,200),X=(c,b,d,a)=>R.get({url:"/om/stat/error/top",params:{start:c,end:b,limit:d,filter:a},paramsSerializer:{serialize:l=>{const i=new URLSearchParams;for(const[h,u]of Object.entries(l))if(Array.isArray(u))for(const w of u)i.append(h,w);else i.append(h,String(u));return i.toString()}}}),Y=L(X,200),E={errorTimeRange:Q,errorTop:Y},g=["error","panic"];function Z({open:c,onClose:b,enabled:d=!0}){const{t:a}=I(),[l,i]=o.useState("hour"),[h,u]=o.useState([]),[w,z]=o.useState([]),[N,j]=o.useState(!1),[T,D]=o.useState(g),H=o.useMemo(()=>[f.colors.palette.error.dark,f.colors.palette.error.default],[]),p=o.useMemo(()=>T.length?T:g,[T]),U=o.useCallback(e=>{const r=g[e];D(t=>{const y=t.includes(r)?t.filter(v=>v!==r):[...t,r];return y.length?y:g})},[]),A=o.useMemo(()=>{switch(l){case"5m":case"10m":case"30m":case"hour":return"HH:mm";case"day":return"MM-dd HH:mm";case"week":case"month":return"yyyy-MM-dd";default:return"yyyy-MM-dd HH:mm"}},[l]),k=o.useCallback(e=>{const r=Math.floor(Date.now()/1e3);let t,n;switch(e){case"5m":t=r-300,n="minute";break;case"10m":t=r-600,n="minute";break;case"30m":t=r-1800,n="5m";break;case"hour":t=r-3600,n="5m";break;case"day":t=r-86400,n="hour";break;case"week":t=r-604800,n="day";break;case"month":t=r-2592e3,n="day";break;default:t=r-86400,n="hour"}return{start:t,end:r,apiUnit:n}},[]),S=o.useCallback(async e=>{try{const r=k(e),t=await E.errorTimeRange(r.start,r.end,r.apiUnit,g);u(t)}catch{}},[k]),M=o.useCallback(async e=>{try{j(!0);const r=k(e),t=await E.errorTop(r.start,r.end,10,p);z(t)}catch{}finally{j(!1)}},[k,p]);o.useEffect(()=>{c&&d&&(S(l),M(l))},[c,d,l,S,M]);const x=h,C=w,F=o.useMemo(()=>C.filter(e=>p.includes((e.level||"error").toLowerCase())),[C,p]),O=o.useMemo(()=>{if(!x.length)return[];const e=r=>{switch(r){case"error":return a("sys.workbench.anomalyError");case"panic":return a("sys.workbench.anomalyPanic");default:return r}};return g.map(r=>{const t=x.map(y=>{const v=y.value[r]||0;return{x:Number(y.at)*1e3,y:v}}),n=p.includes(r);return{name:e(r),data:n?t:t.map(y=>({...y,y:null}))}})},[x,p,a]),P=o.useMemo(()=>{if(x.length)return x.reduce((e,r)=>{const t=r.value,n=(t.error||0)+(t.panic||0);return Math.max(e,n)},0)+1},[x]),_=$({colors:H,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:A}},tooltip:{x:{formatter:e=>{switch(l){case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e}`}},yaxis:{labels:{formatter:e=>`${e}`},min:0,max:P},chart:{toolbar:{show:!1},events:{legendClick:(e,r)=>(U(r??0),!1)}},stroke:{curve:"smooth",width:2}});return s.jsx(G,{title:a("sys.workbench.anomalyTrend"),open:c&&d,onCancel:b,width:850,footer:null,style:{top:"10%"},styles:{body:{padding:"0px"}},maskClosable:!0,destroyOnClose:!0,children:s.jsxs(W,{className:"flex-col !shadow-none",children:[s.jsxs("header",{className:"flex w-full justify-between items-start",children:[s.jsx("div",{}),s.jsx(K,{size:"small",value:l,onChange:i,style:{width:140},options:[{value:"5m",label:a("sys.workbench.last5m")},{value:"10m",label:a("sys.workbench.last10m")},{value:"30m",label:a("sys.workbench.last30m")},{value:"hour",label:a("sys.workbench.lastHour")},{value:"day",label:a("sys.workbench.lastDay")},{value:"week",label:a("sys.workbench.lastWeek")},{value:"month",label:a("sys.workbench.lastMonth")}]})]}),s.jsxs("main",{className:"w-full flex flex-col gap-4",children:[s.jsx("div",{className:"w-full",children:s.jsx(B,{type:"area",series:O,options:_,height:360})}),s.jsxs("div",{className:"w-full",children:[s.jsx("div",{className:"flex items-center justify-between mb-2 px-1",children:s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-base font-medium",style:{color:f.colors.text.primary},children:a("sys.workbench.anomalyTopTitle")}),s.jsx("span",{className:"text-xs",style:{color:f.colors.text.secondary},children:a("sys.workbench.anomalyTopDesc")})]})}),s.jsx(V,{rowKey:e=>e.sigHash,dataSource:F,loading:N,size:"small",pagination:!1,locale:{emptyText:a("sys.workbench.anomalyTopEmpty")},columns:[{title:a("sys.workbench.anomalySignature"),dataIndex:"signature",key:"signature",render:(e,r)=>s.jsx(m.Text,{ellipsis:{tooltip:r.signature||r.sampleMsg||r.sampleError},style:{maxWidth:320},children:r.signature||r.sampleMsg||a("sys.workbench.anomalySampleEmpty")})},{title:a("sys.workbench.anomalyCount"),dataIndex:"count",key:"count",align:"right",render:e=>s.jsx(m.Text,{strong:!0,style:{color:f.colors.palette.error.dark},children:e})},{title:a("sys.workbench.anomalyLevel"),dataIndex:"level",key:"level",render:e=>s.jsx(q,{color:f.colors.palette.error.light,children:e?.toUpperCase()||"-"})},{title:a("sys.workbench.anomalyLastSeen"),dataIndex:"lastAt",key:"lastAt",render:e=>ee(e)}],expandable:{expandedRowRender:e=>e.sampleMsg||e.sampleError?s.jsxs("div",{className:"px-1 space-y-1",children:[e.sampleTrace&&s.jsxs("div",{children:[s.jsx(m.Text,{strong:!0,style:{fontSize:12,marginRight:6},children:"Trace:"}),s.jsx(m.Text,{code:!0,copyable:!0,style:{fontSize:12},children:e.sampleTrace})]}),e.sampleMsg&&s.jsxs("div",{children:[s.jsx(m.Text,{strong:!0,style:{fontSize:12,marginRight:6},children:"Msg:"}),s.jsx(m.Text,{type:"secondary",style:{fontSize:12},children:e.sampleMsg})]}),e.sampleError&&s.jsxs("div",{children:[s.jsx(m.Text,{strong:!0,style:{fontSize:12,marginRight:6},children:"Error:"}),s.jsx(m.Text,{type:"secondary",style:{fontSize:12},children:e.sampleError})]})]}):null,rowExpandable:e=>!!(e.sampleMsg||e.sampleError)}})]})]})]})})}const ee=c=>c?new Date(Number(c)*1e3).toLocaleString():"--",ne=Object.freeze(Object.defineProperty({__proto__:null,default:Z},Symbol.toStringTag,{value:"Module"}));export{Z as E,ne as e,E as s};

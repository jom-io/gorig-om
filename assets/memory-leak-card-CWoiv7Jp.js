import{u as F,a as K,j as e,t}from"./index-DWD_6FxE.js";import{s as C}from"./statService-DIGahmug.js";import{C as R}from"./index-k__wfER6.js";import{z as p,S as z,M as A,ak as M,G as U,t as G}from"./vendor-ui-B8JNe9Dz.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import W from"./RefreshIcon-BI2Hh287.js";import{useTimeRange as V}from"./api-latency-chart-DrgXqS-O.js";import"./vendor-utils-9ATX-dPw.js";import"./chart-CO_-K2pT.js";import"./vendor-charts-C0vSEv4L.js";import"./useChart-CGXm_jHt.js";import"./api-sample-modal-CA9JjTBU.js";const{Panel:q}=M,h=l=>{if(l===0)return"0 B";const r=1024,b=["B","KB","MB","GB"],m=Math.floor(Math.log(Math.abs(l))/Math.log(r));return`${(l/r**m).toFixed(2)} ${b[m]}`};function ce(){const{t:l}=F(),r=K(),[b,m]=o.useState(!1),[k,D]=o.useState(0),[j,$]=o.useState(""),[i,N]=o.useState(!1),[f,L]=o.useState([]),[a,x]=o.useState({current:1,pageSize:10,total:0}),[B,w]=o.useState(!1),[E,u]=o.useState([]),{timeUnit:S,getRange:v,renderTimePicker:H}=V("today",[p().startOf("day"),p()]),y=o.useCallback(async()=>{if(r)try{m(!0);const s=p(),c=s.startOf("day").unix(),n=s.unix(),d=await C.memLeakCount(c,n);D(d),$(s.format("HH:mm"))}catch{}finally{m(!1)}},[r]),g=o.useCallback(async()=>{if(r)try{w(!0);const{start:s,end:c}=v(S),n=await C.memLeakPage({start:s,end:c,page:a.current,size:a.pageSize}),d=n.items||[];L(d),d.length>0?u([`${d[0].at}-0`]):u([]),x(T=>({...T,total:n.total||0,current:n.page||1,pageSize:n.size||10}))}catch{}finally{w(!1)}},[r,S,v,a.current,a.pageSize]);o.useEffect(()=>{r&&y()},[r,y]),o.useEffect(()=>{i&&r&&x(s=>({...s,current:1}))},[i,r]),o.useEffect(()=>{i&&r&&g()},[i,r,g]);const I=()=>{N(!0),u([])},Y=o.useCallback(s=>{s.stopPropagation(),y(),i&&r&&g()},[y,i,r,g]),O=[{title:l("sys.workbench.leakFunc"),dataIndex:"func",key:"func",render:(s,c)=>e.jsxs("div",{className:"flex flex-col py-0.5",style:{wordBreak:"break-all",whiteSpace:"normal"},children:[e.jsx("span",{style:{fontSize:"13px",fontFamily:"monospace",fontWeight:600,color:t.colors.text.primary,wordBreak:"break-all",whiteSpace:"normal",lineHeight:"1.4"},children:s}),e.jsxs("span",{className:"mt-0.5",style:{fontSize:"11px",color:t.colors.text.secondary,wordBreak:"break-all",whiteSpace:"normal",lineHeight:"1.4"},children:[c.file,":",c.line]})]})},{title:l("sys.workbench.leakDeltaSpace"),dataIndex:"deltaSpace",key:"deltaSpace",width:110,align:"right",render:s=>e.jsxs("span",{style:{fontSize:"13px",fontWeight:700,color:t.colors.palette.error.dark},children:["+",h(s)]})},{title:l("sys.workbench.leakDeltaObjects"),dataIndex:"deltaObjects",key:"deltaObjects",width:90,align:"right",render:s=>e.jsxs("span",{style:{fontSize:"13px",color:t.colors.text.primary},children:["+",s.toLocaleString()]})}],P=`linear-gradient(135deg, rgba(${t.colors.palette.error.lightChannel}, 0.14), rgba(${t.colors.palette.warning.lightChannel}, 0.12)) ${t.colors.background.paper}`;return e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"!p-0 overflow-hidden cursor-pointer hover:shadow-lg transition-shadow",onClick:I,style:{background:P,padding:0,boxShadow:t.shadows.card,height:133,width:"100%",display:"flex",flexDirection:"column",flexShrink:0},children:e.jsx(z,{spinning:b,style:{height:"100%"},wrapperClassName:"flex-1 flex flex-col",children:e.jsx("div",{className:"flex h-full flex-col justify-center p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"text-lg font-medium",style:{color:t.colors.text.primary},children:l("sys.workbench.memoryLeak")}),e.jsx("div",{className:"text-xs",style:{color:t.colors.text.secondary},children:k>0?l("sys.workbench.leakSummary"):l("sys.workbench.leakNoEvent")}),e.jsxs("div",{className:"flex items-baseline gap-2 mt-6",children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:k>0?t.colors.palette.error.dark:t.colors.text.primary},children:k}),e.jsx("div",{className:"text-xs",style:{color:t.colors.text.secondary},children:l("sys.workbench.leakUnit")})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 justify-center",children:[e.jsx(W,{background:`rgba(${t.colors.palette.error.defaultChannel}, 0.16)`,color:t.colors.palette.error.dark,icon:"mdi:leak",onClick:Y}),j&&e.jsx("span",{className:"mt-4 text-xs whitespace-nowrap",style:{color:t.colors.text.secondary},children:l("sys.workbench.leakUpdatedAt",{time:j})})]})]})})})}),e.jsxs(A,{title:e.jsx("span",{className:"text-lg font-bold",children:l("sys.workbench.memoryLeak")}),open:i,onCancel:()=>N(!1),footer:null,width:900,centered:!0,styles:{body:{paddingTop:"12px",maxHeight:"calc(100vh - 200px)",overflowY:"auto"}},children:[e.jsx("div",{className:"mb-4 flex items-center justify-end gap-2",children:H(()=>{x(s=>({...s,current:1}))})}),e.jsxs(z,{spinning:B,children:[f&&f.length>0?e.jsx(M,{activeKey:E,onChange:u,style:{background:"transparent"},children:f.map((s,c)=>e.jsx(q,{header:e.jsx("div",{className:"flex items-center justify-between w-full pr-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-semibold",style:{color:t.colors.text.primary},children:p.unix(s.at).format("YYYY-MM-DD HH:mm:ss")}),e.jsxs("span",{className:"text-sm font-bold text-red-500",style:{color:t.colors.palette.error.dark},children:["+",h(s.allocDelta)]}),e.jsxs("span",{className:"text-sm font-bold text-red-500",style:{color:t.colors.palette.error.dark},children:["+",s.objectDelta.toLocaleString()]})]})}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl",style:{background:t.colors.background.neutral},children:[e.jsxs("div",{className:"flex flex-col gap-1.5",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakTime",{time:""})}),e.jsx("div",{className:"text-sm font-bold",style:{color:t.colors.text.primary},children:p.unix(s.at).format("YYYY-MM-DD HH:mm:ss")})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakBaseInuseSpace")}),e.jsx("div",{className:"text-base font-bold",style:{color:t.colors.text.primary},children:h(s.baseInuseSpace)})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakLeakInuseSpace")}),e.jsx("div",{className:"text-base font-bold",style:{color:t.colors.text.primary},children:h(s.leakInuseSpace)})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakAllocDelta")}),e.jsxs("div",{className:"text-lg font-black text-red-500",children:["+",h(s.allocDelta)]})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:t.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakObjectDelta")}),e.jsxs("div",{className:"text-lg font-black text-red-500",children:["+",s.objectDelta.toLocaleString()]})]})]})]}),s.points&&s.points.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"mb-3 text-sm font-bold tracking-tight",style:{color:t.colors.text.primary},children:l("sys.workbench.leakPoints")}),e.jsx(U,{dataSource:s.points,columns:O,pagination:!1,size:"small",rowKey:(n,d)=>`${n.func}-${n.file}-${n.line}-${d}`})]})]})},`${s.at}-${c}`))}):e.jsx("div",{className:"py-20 text-center",children:e.jsx("div",{className:"mb-2 text-lg font-medium",style:{color:t.colors.text.disabled},children:l("sys.workbench.leakNoEvent")})}),f.length>0&&e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",style:{color:t.colors.text.secondary},children:["共 ",a.total," 条"]}),e.jsx(G,{value:a.pageSize,onChange:s=>{x(c=>({...c,pageSize:s,current:1}))},style:{width:100},options:[{value:10,label:"10 条/页"},{value:20,label:"20 条/页"},{value:50,label:"50 条/页"}]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>{a.current>1&&x(s=>({...s,current:s.current-1}))},disabled:a.current===1,className:"px-2 py-1 text-sm rounded border",style:{background:a.current===1?t.colors.background.neutral:"transparent",cursor:a.current===1?"not-allowed":"pointer"},children:"上一页"}),e.jsxs("span",{className:"px-2 text-sm",style:{color:t.colors.text.primary},children:[a.current," / ",Math.ceil(a.total/a.pageSize)]}),e.jsx("button",{type:"button",onClick:()=>{const s=Math.ceil(a.total/a.pageSize);a.current<s&&x(c=>({...c,current:c.current+1}))},disabled:a.current>=Math.ceil(a.total/a.pageSize),className:"px-2 py-1 text-sm rounded border",style:{background:a.current>=Math.ceil(a.total/a.pageSize)?t.colors.background.neutral:"transparent",cursor:a.current>=Math.ceil(a.total/a.pageSize)?"not-allowed":"pointer"},children:"下一页"})]})]})})]})]})]})}export{ce as default};

import{u as J,t as r,j as s}from"./index-AHjT66P3.js";import{s as B}from"./statService-CxUvAms7.js";import{C as ne}from"./index-Bc1co6Wu.js";import{C as le}from"./chart-DWnyXj9S.js";import{u as ce}from"./useChart-CgyA-rHf.js";import{z as c,T as ie,s as w,M as ue,t as Q,I as de,ab as me,G as xe,ac as ye}from"./vendor-ui-B8JNe9Dz.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import he from"./api-sample-modal-DLs4z4SQ.js";import"./vendor-utils-9ATX-dPw.js";import"./vendor-charts-C0vSEv4L.js";const pe=[{value:"today",label:"Today"},{value:"5m",label:"Last 5m"},{value:"10m",label:"Last 10m"},{value:"30m",label:"Last 30m"},{value:"hour",label:"Last Hour"},{value:"day",label:"Last Day"},{value:"week",label:"Last Week"},{value:"month",label:"Last Month"}];function fe(h="hour",H=null){const{t:d}=J(),[f,y]=o.useState(h),[n,g]=o.useState(H),L=o.useCallback(u=>{if(n?.[0]&&n?.[1]){const D=Math.floor(n[0].valueOf()/1e3),R=Math.floor(n[1].valueOf()/1e3),j=(R-D)/3600;let k;return n[0]?.startOf("day").valueOf()===n[0]?.valueOf()&&n[1]?.valueOf()<=Date.now()&&Math.abs(n[1].valueOf()-Date.now())<6e4?k="5m":j<=1?k="minute":j<=6?k="5m":j<=48?k="hour":k="day",{start:D,end:R,apiUnit:k}}const x=Math.floor(Date.now()/1e3);let i,p;switch(u){case"today":i=Math.floor(c().startOf("day").valueOf()/1e3),p="5m";break;case"5m":i=x-300,p="minute";break;case"10m":i=x-600,p="minute";break;case"30m":i=x-1800,p="5m";break;case"hour":i=x-3600,p="5m";break;case"day":i=x-86400,p="hour";break;case"week":i=x-604800,p="day";break;case"month":i=x-2592e3,p="day";break;default:i=x-86400,p="hour"}return{start:i,end:x,apiUnit:p}},[n]),v=o.useMemo(()=>[...pe.map(u=>({...u,label:d(`sys.workbench.time.${u.value}`,u.label)})),...n?[{value:"custom",label:d("sys.workbench.time.custom","Custom")}]:[]],[d,n]),N=o.useMemo(()=>{switch(f){case"today":case"5m":case"10m":case"30m":case"hour":return"HH:mm";case"day":return"MM-dd HH:mm";case"week":case"month":return"yyyy-MM-dd";default:return"yyyy-MM-dd HH:mm"}},[f]);return{timeUnit:f,setTimeUnit:y,timeRange:n,setTimeRange:g,getRange:L,dateLabelFormat:N,renderTimePicker:u=>{const x=n?.[0]&&n?.[1]&&n[0].startOf("day").valueOf()===n[0].valueOf()&&n[1].valueOf()<=Date.now()&&Math.abs(n[1].valueOf()-Date.now())<6e4;return s.jsxs("div",{className:"flex items-center gap-1 bg-neutral-100 dark:bg-neutral-800 p-0.5 rounded-lg border border-neutral-200 dark:border-neutral-700",style:{background:r.colors.background.neutral},children:[s.jsx(Q,{size:"small",variant:"borderless",value:x?"today":n?"custom":f,onChange:i=>{i!=="custom"&&(i==="today"?(g([c().startOf("day"),c()]),y("today")):(y(i),g(null)),u?.())},style:{width:110},options:v}),s.jsx("span",{className:"w-[1px] h-4 bg-neutral-300 dark:bg-neutral-600 mx-1"}),s.jsx(ye.RangePicker,{size:"small",variant:"borderless",value:n,onChange:i=>{g(i),u?.()},showTime:{format:"HH:mm"},format:"YYYY-MM-DD HH:mm",allowClear:!0,placeholder:[d("sys.workbench.startTime","Start"),d("sys.workbench.endTime","End")],style:{width:280},presets:[{label:d("sys.workbench.time.5m","Last 5m"),value:[c().subtract(5,"minute"),c()]},{label:d("sys.workbench.time.10m","Last 10m"),value:[c().subtract(10,"minute"),c()]},{label:d("sys.workbench.time.30m","Last 30m"),value:[c().subtract(30,"minute"),c()]},{label:d("sys.workbench.time.hour","Last Hour"),value:[c().subtract(1,"hour"),c()]},{label:d("sys.workbench.time.day","Last Day"),value:[c().subtract(1,"day"),c()]},{label:d("sys.workbench.time.week","Last Week"),value:[c().subtract(1,"week"),c()]},{label:d("sys.workbench.time.month","Last Month"),value:[c().subtract(1,"month"),c()]}]})]})}}}const E=["2xx","4xx","5xx"],V=h=>`${h} ms`;function je({open:h,onClose:H,enabled:d=!0,defaultSort:f="count"}){const{t:y}=J(),{timeUnit:n,timeRange:g,setTimeRange:L,getRange:v,dateLabelFormat:N,renderTimePicker:A}=fe("today",[c().startOf("day"),c()]),[u,x]=o.useState(null),[i,p]=o.useState([]),[D,R]=o.useState([]),[j,k]=o.useState(0),[T,Z]=o.useState(E),U=o.useRef(!1),[P,ee]=o.useState(["GET","POST","PUT","DELETE"]),[I,z]=o.useState(""),[K,$]=o.useState(""),[m,F]=o.useState({columnKey:f,order:"descend"}),[S,C]=o.useState({current:1,pageSize:10}),[te,_]=o.useState({open:!1,method:"",uri:"",type:"slow"}),O=o.useCallback((e,t)=>{_({open:!0,method:e.method,uri:e.uri,type:t})},[]),Y=o.useCallback(e=>{Z(t=>t.includes(e)?t.filter(b=>b!==e):[...t,e]),C(t=>({...t,current:1}))},[]);o.useEffect(()=>{h&&(F({columnKey:f==="count"?"count":f,order:"descend"}),C(e=>({...e,current:1})),z(""),$(""),x(null))},[h,f]),o.useEffect(()=>{const e=U.current;if(U.current=h,h&&!e&&n==="today"&&g?.[0]&&L([g[0],c()]),h&&d){const t=v(n);(async()=>{try{const b=(await B.apiTimeRange(t.start,t.end,t.apiUnit,["count2xx","count4xx","count5xx"])).map(M=>({at:Number(M.at)*1e3,counts:{"2xx":M.value.count2xx||0,"4xx":M.value.count4xx||0,"5xx":M.value.count5xx||0}}));p(b)}catch{}})(),x(null)}},[h,d,n,g,L,v]);const G=o.useCallback(async()=>{if(!h||!d)return;const e=u?.[0]&&u?.[1]?{start:Math.floor(u[0].valueOf()/1e3),end:Math.floor(u[1].valueOf()/1e3),apiUnit:(()=>{const a=(u[1].valueOf()-u[0].valueOf())/36e5;return a<=1?"minute":a<=6?"5m":a<=48?"hour":"day"})()}:v(n),t={count:"count",status2xx:"2xx",status4xx:"4xx",status5xx:"5xx",avgLatency:"avg",maxLatency:"max",successRate:"success"};try{const a=await B.apiTop({start:e.start,end:e.end,page:S.current,size:S.pageSize,statuses:T,methods:P,uriLike:I.trim(),sortBy:t[m.columnKey]||"avg",asc:m.order==="ascend"});R(a.items),k(a.total)}catch{}},[h,d,n,S.current,S.pageSize,m,T,P,I,v,u]);o.useEffect(()=>{G()},[G]);const ae=o.useMemo(()=>i.length?E.map(e=>{const t=T.includes(e);return{name:e,data:i.map(a=>({x:a.at,y:t?a.counts[e]:null}))}}):[],[i,T]),W=o.useMemo(()=>[r.colors.palette.success.dark,r.colors.palette.warning.dark,r.colors.palette.error.dark],[]),X=o.useMemo(()=>({GET:r.colors.palette.primary.dark,POST:r.colors.palette.success.dark,PUT:r.colors.palette.warning.dark,DELETE:r.colors.palette.error.dark}),[]),se=o.useCallback((e,t)=>{if(!t?.xaxis)return;const{min:a,max:l}=t.xaxis;if(a&&l&&a!==l){const b=c(a),M=c(l);x([b,M]),e?.zoomX&&setTimeout(()=>{e.zoomX(void 0,void 0)},100)}},[]),re=ce({colors:W,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:N}},yaxis:{labels:{formatter:e=>`${e}`},min:0},tooltip:{x:{formatter:e=>{switch(n){case"today":case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e} req`}},chart:{toolbar:{show:!1},zoom:{enabled:!0,type:"x",autoScaleYaxis:!1},selection:{enabled:!0,type:"x",fill:{color:r.colors.palette.primary.default,opacity:.2},stroke:{width:2,dashArray:0,color:r.colors.palette.primary.default,opacity:.8}},events:{legendClick:(e,t)=>(t!==void 0&&Y(E[t]),!1),selection:(e,t)=>{t?.xaxis&&se(e,t)},zoomed:(e,{xaxis:t})=>{if(t?.min&&t?.max){const a=c(t.min),l=c(t.max);x([a,l]),e?.zoomX&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.zoomX(void 0,void 0)})})}}}},stroke:{width:2,curve:"smooth"},annotations:{xaxis:u?.[0]&&u?.[1]?(()=>{const e=u[0],t=u[1],l=!e.isSame(t,"day")?`${e.format("MM-DD HH:mm")} ~ ${t.format("MM-DD HH:mm")}`:`${e.format("HH:mm")} ~ ${t.format("HH:mm")}`,b=(e.valueOf()+t.valueOf())/2;return[{x:e.valueOf(),x2:t.valueOf(),fillColor:r.colors.palette.primary.default,opacity:.1,borderColor:r.colors.palette.primary.default,strokeDashArray:0,borderWidth:1},{x:b,label:{text:l,orientation:"horizontal",position:"top",offsetY:-15,style:{fontSize:"11px",fontWeight:500,color:r.colors.palette.primary.default,background:r.colors.background.paper,padding:{left:8,right:8,top:4,bottom:4}},borderColor:r.colors.palette.primary.default,borderWidth:1}}]})():[]}}),oe=o.useMemo(()=>[{title:y("sys.workbench.apiColMethod","Method"),dataIndex:"method",key:"method",width:80,render:e=>s.jsx(ie,{color:X[e]||r.colors.palette.primary.default,children:e})},{title:"URL",dataIndex:"uri",key:"uri",ellipsis:!0},{title:y("sys.workbench.apiColTotal","Total"),dataIndex:"count",key:"count",sorter:!0,sortOrder:m.columnKey==="count"?m.order:void 0,width:90,align:"right"},{title:"2xx",dataIndex:"count2xx",key:"status2xx",sorter:!0,sortOrder:m.columnKey==="status2xx"?m.order:void 0,width:70,align:"right",render:(e,t)=>s.jsx(w.Link,{disabled:e===0,onClick:a=>{a.stopPropagation(),e>0&&O(t,"2xx")},style:{color:e>0?r.colors.palette.success.dark:r.colors.text.secondary},children:e})},{title:y("sys.workbench.apiColSuccessRate","Success"),key:"successRate",width:90,align:"right",render:(e,t)=>{const a=t.successRate*100,l=a>=99?"success":a>=95?"warning":"error";return s.jsxs(w.Text,{strong:!0,style:{color:r.colors.palette[l].dark},children:[a.toFixed(1),"%"]})},sorter:!0,sortOrder:m.columnKey==="successRate"?m.order:void 0},{title:"4xx",dataIndex:"count4xx",key:"status4xx",sorter:!0,sortOrder:m.columnKey==="status4xx"?m.order:void 0,width:70,align:"right",render:(e,t)=>s.jsx(w.Link,{disabled:e===0,onClick:a=>{a.stopPropagation(),e>0&&O(t,"4xx")},style:{color:e>0?r.colors.palette.warning.dark:r.colors.text.secondary},children:e})},{title:"5xx",dataIndex:"count5xx",key:"status5xx",sorter:!0,sortOrder:m.columnKey==="status5xx"?m.order:void 0,width:70,align:"right",render:(e,t)=>s.jsx(w.Link,{strong:e>0,disabled:e===0,onClick:a=>{a.stopPropagation(),e>0&&O(t,"5xx")},style:{color:e>0?r.colors.palette.error.dark:r.colors.text.secondary},children:e})},{title:y("sys.workbench.apiColAvg","Avg"),dataIndex:"avgLatency",key:"avgLatency",sorter:!0,sortOrder:m.columnKey==="avgLatency"?m.order:void 0,width:90,render:e=>{const t=Math.round(e),a=t>500?r.colors.palette.error.dark:t>200?r.colors.palette.warning.dark:void 0;return s.jsx(w.Text,{style:{color:a},children:V(t)})}},{title:y("sys.workbench.apiColMax","Max"),dataIndex:"maxLatency",key:"maxLatency",sorter:!0,sortOrder:m.columnKey==="maxLatency"?m.order:void 0,width:90,render:(e,t)=>{const a=Math.round(e),l=a>500?r.colors.palette.error.dark:a>200?r.colors.palette.warning.dark:void 0;return s.jsx(w.Link,{style:{color:l},onClick:b=>{b.stopPropagation(),O(t,"slow")},children:V(a)})}}],[y,m,X,O]),q=o.useMemo(()=>{if(!i.length)return{total:0,ok:0,err4:0,err5:0};let e=0,t=0,a=0;for(const l of i)e+=l.counts["2xx"],t+=l.counts["4xx"],a+=l.counts["5xx"];return{total:e+t+a,ok:e,err4:t,err5:a}},[i]);return s.jsxs(ue,{title:y("sys.workbench.apiTrendTitle","API Response Trend"),open:h&&d,onCancel:H,width:960,footer:null,style:{top:"6%"},styles:{body:{padding:0}},maskClosable:!0,destroyOnClose:!0,children:[s.jsxs(ne,{className:"flex-col !shadow-none",children:[s.jsxs("header",{className:"flex w-full justify-between items-center gap-4",children:[s.jsxs("div",{className:"flex gap-4 items-center flex-wrap",children:[s.jsx("div",{className:"flex gap-2 items-center",children:E.map((e,t)=>{const a=T.includes(e),l=W[t];return s.jsxs("div",{onClick:()=>Y(e),className:"flex items-center h-7 px-2.5 rounded-full border transition-all cursor-pointer hover:opacity-80 active:scale-95 select-none",style:{borderColor:a?l:r.colors.common.border,background:a?`${l}15`:r.colors.background.neutral,boxShadow:a?`0 2px 4px ${l}20`:"none"},children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full mr-2",style:{background:l,boxShadow:`0 0 4px ${l}`}}),s.jsx("span",{className:"text-xs font-medium mr-1.5",style:{color:r.colors.text.secondary},children:e}),s.jsx("span",{className:"text-sm font-bold",style:{color:a?l:r.colors.text.primary},children:q[e==="2xx"?"ok":e==="4xx"?"err4":"err5"]})]},e)})}),s.jsxs("div",{className:"flex items-center h-7 px-3 rounded-md bg-neutral-100 dark:bg-neutral-800 border border-transparent",style:{background:r.colors.background.neutral},children:[s.jsx(w.Text,{type:"secondary",style:{fontSize:"12px"},children:y("sys.workbench.apiTotalCount","Total")}),s.jsx("span",{className:"mx-1.5 h-3 w-[1px] bg-neutral-300 dark:bg-neutral-700"}),s.jsx("span",{className:"text-sm font-bold",style:{color:r.colors.text.primary},children:q.total})]})]}),A(()=>{x(null)})]}),s.jsxs("main",{className:"w-full flex flex-col gap-4 mt-4",children:[s.jsxs("div",{className:"w-full",children:[s.jsx("div",{className:"mb-2 text-xs",style:{color:r.colors.text.secondary},children:y("sys.workbench.chartHint","ðŸ’¡ Drag to select")}),s.jsx(le,{type:"area",series:ae,options:re,height:360})]}),s.jsxs("div",{className:"w-full",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2 px-1",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-base font-medium",style:{color:r.colors.text.primary},children:y("sys.workbench.apiRankingTitle","Endpoint latency ranking")}),s.jsx("span",{className:"text-xs",style:{color:r.colors.text.secondary},children:y("sys.workbench.apiRankingDesc","Sortable by status counts and latency columns.")})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(Q,{mode:"multiple",placeholder:"Method",value:P,onChange:e=>{ee(e),C(t=>({...t,current:1}))},style:{width:220},maxTagCount:"responsive",size:"small",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"PUT",value:"PUT"},{label:"DELETE",value:"DELETE"},{label:"PATCH",value:"PATCH"},{label:"OPTIONS",value:"OPTIONS"},{label:"HEAD",value:"HEAD"}]}),s.jsx(de,{placeholder:"Search URL...",size:"small",allowClear:!0,prefix:s.jsx(me,{style:{color:r.colors.text.disabled}}),value:K,onChange:e=>{const t=e.target.value;$(t),t===""&&(z(""),C(a=>({...a,current:1})))},onPressEnter:()=>{z(K),C(e=>({...e,current:1}))},style:{width:180}})]})]}),s.jsx(xe,{rowKey:e=>`${e.method}-${e.uri}`,dataSource:D,size:"small",onRow:e=>({onClick:()=>O(e,"latest"),className:"cursor-pointer"}),pagination:{current:S.current,pageSize:S.pageSize,total:j,showSizeChanger:!1,onChange:e=>C(t=>({...t,current:e}))},columns:oe,onChange:(e,t,a)=>{!Array.isArray(a)&&a.columnKey&&F({columnKey:a.columnKey,order:a.order||"descend"})}})]})]})]}),s.jsx(he,{...te,onClose:()=>_(e=>({...e,open:!1}))})]})}export{pe as TIME_OPTIONS,je as default,fe as useTimeRange};

import{u as ae,F as ne,G as ie,j as l,I as G,b as U,E as z}from"./index-Cm_8XUJi.js";import{a as oe}from"./vendor-utils-DG9TG-F2.js";import{r as u}from"./vendor-core-Cler3e7Q.js";import{T as S,H as q,af as ce,C as de,ag as K,G as le,M as ue,I as fe,s as me,i as Q}from"./vendor-ui-Bdifwvp0.js";const ye="https://ssl-checker.zoel-du.workers.dev/?host=";async function W(r){const g=`${ye}${r}`,{data:x}=await oe.get(g,{timeout:1e4});return x.result}const _="certificateCache",{Text:he}=me,X=r=>{const g=Number(r);return Number.isFinite(g)?g:void 0};function pe(r){try{return new URL(r).hostname}catch{return null}}function p(r){return Array.isArray(r)?r:[]}function Fe(){const{t:r}=ae(),g=ne(),x=ie(e=>e.setStats),[m,N]=u.useState([]),[E,F]=u.useState([]),[Y,V]=u.useState(!1),[$,C]=u.useState(null),D=u.useRef(r("sys.certificate.fetchFailed")),a=u.useRef(null),[b,ee]=u.useState(!1),M=u.useRef(!1),[j,A]=u.useState(!1),[H,O]=u.useState(""),Z=u.useRef(null),I=u.useCallback(e=>{let t=0,d=0;return e.forEach(s=>{if(s.valid===!1){t+=1;return}s.valid===!0&&typeof s.daysLeft=="number"&&(s.daysLeft<0?t+=1:s.daysLeft<=7&&(d+=1))}),{expired:t,expiring:d}},[]);u.useEffect(()=>{D.current=r("sys.certificate.fetchFailed")},[r]),u.useEffect(()=>{try{const e=localStorage.getItem(_);if(e){const t=JSON.parse(e);if(a.current=t,t.domains&&N(p(t.domains)),t.results){const s=[...p(t.results)].sort((c,i)=>{const h=typeof c.daysLeft=="number"?c.daysLeft:Number.POSITIVE_INFINITY,o=typeof i.daysLeft=="number"?i.daysLeft:Number.POSITIVE_INFINITY;return h-o});F(s);const y=I(s);x({expiring:y.expiring,expired:y.expired,lastChecked:t.lastFetched?new Date(t.lastFetched).getTime():Date.now()})}t.lastFetched&&C(new Date(t.lastFetched))}}catch{}finally{ee(!0)}},[]),u.useEffect(()=>{if(M.current||!b||p(a.current?.domains).length>0||a.current?.seededFromServers||m.length>0)return;const e=g.map(s=>pe(s.addr)).filter(Boolean);if(e.length===0)return;const d=Array.from(new Set(e)).map(s=>({host:s,source:"server",createdAt:Date.now()}));N(d),a.current={domains:d,seededFromServers:!0},localStorage.setItem(_,JSON.stringify({domains:d,lastFetched:a.current?.lastFetched,results:a.current?.results,seededFromServers:!0})),M.current=!0},[g,m.length,b]);const w=u.useCallback(e=>p(e).map(t=>({key:`${t.host}-${t.source}`,name:t.host,addr:t.host,host:t.host})),[]),k=u.useMemo(()=>w(m),[m,w]),L=u.useCallback(e=>{const t={domains:p(m),lastFetched:e.lastFetched??a.current?.lastFetched,results:e.results??p(a.current?.results),seededFromServers:e.seededFromServers??a.current?.seededFromServers??!1};a.current=t,localStorage.setItem(_,JSON.stringify(t))},[m]),T=u.useCallback(async e=>{const t=p(e??(m.length?m:a.current?.domains)),d=w(t);if(d.length===0){L({results:[],lastFetched:void 0});return}V(!0);try{const s=[],y=new Date().toLocaleString();for(const o of d)try{const n=await W(o.host),f=typeof n.cert_valid=="boolean"?n.cert_valid:n.cert_exp===!1?!0:void 0;s.push({key:o.key,name:o.name,addr:o.addr,host:o.host,ip:n.resolved_ip,valid:f,daysLeft:X(n.days_left??n.valid_days_to_expire??n.validity_days),validFrom:n.valid_from,validTill:n.valid_till,vendor:n.issuer_o||n.issuer_cn,updatedAt:y})}catch(n){const f=typeof n=="string"?n:n?.message||D.current;s.push({key:o.key,name:o.name,addr:o.addr,host:o.host,error:f,daysLeft:void 0,updatedAt:y})}const c=[...s].sort((o,n)=>{const f=typeof o.daysLeft=="number"?o.daysLeft:Number.POSITIVE_INFINITY,v=typeof n.daysLeft=="number"?n.daysLeft:Number.POSITIVE_INFINITY;return f-v});F(c);const i=new Date;C(i);const h=I(s);x({expiring:h.expiring,expired:h.expired,lastChecked:i.getTime()}),L({results:s,lastFetched:i.toISOString()})}finally{V(!1)}},[m,w,L,I,x]);u.useEffect(()=>{if(!b)return;const e=a.current?.lastFetched?new Date(a.current.lastFetched).getTime():0,t=Date.now(),d=24*60*60*1e3;(m.length>0||p(a.current?.domains).length>0)&&(!e||t-e>d)&&T()},[b,m.length,T]),u.useEffect(()=>{if(k.length===0)return;const e=a.current,t=c=>{if(!c)return!1;const i=new Date;return c.getFullYear()===i.getFullYear()&&c.getMonth()===i.getMonth()&&c.getDate()===i.getDate()},d=(e?.domains||[]).map(c=>c.host).sort().join(","),s=m.map(c=>c.host).sort().join(","),y=d===s;if(e?.results&&e.lastFetched&&t(new Date(e.lastFetched))&&y){const c=[...e.results].sort((h,o)=>{const n=typeof h.daysLeft=="number"?h.daysLeft:Number.POSITIVE_INFINITY,f=typeof o.daysLeft=="number"?o.daysLeft:Number.POSITIVE_INFINITY;return n-f});F(c),C(new Date(e.lastFetched));const i=I(e.results);x({expiring:i.expiring,expired:i.expired,lastChecked:new Date(e.lastFetched).getTime()});return}T()},[k.length,m,T]);const B=async(e,t="server")=>{const d=new Date().toLocaleString();try{const s=await W(e),y=typeof s.cert_valid=="boolean"?s.cert_valid:s.cert_exp===!1?!0:void 0,c={key:`${e}-${t}`,name:e,addr:e,host:e,ip:s.resolved_ip,valid:y,daysLeft:X(s.days_left??s.valid_days_to_expire??s.validity_days),validFrom:s.valid_from,validTill:s.valid_till,vendor:s.issuer_o||s.issuer_cn,updatedAt:d};F(i=>{const o=[...i.filter(f=>f.host!==e),c],n=I(o);return x({expiring:n.expiring,expired:n.expired,lastChecked:Date.now()}),[...o].sort((f,v)=>{const P=typeof f.daysLeft=="number"?f.daysLeft:Number.POSITIVE_INFINITY,R=typeof v.daysLeft=="number"?v.daysLeft:Number.POSITIVE_INFINITY;return P-R})}),L({results:[...a.current?.results?p(a.current?.results).filter(i=>i.host!==e):[],c],lastFetched:a.current?.lastFetched})}catch(s){const y=typeof s=="string"?s:s?.message||D.current,c={key:`${e}-${t}`,name:e,addr:e,host:e,error:y,daysLeft:void 0,updatedAt:d};F(i=>{const o=[...i.filter(f=>f.host!==e),c],n=I(o);return x({expiring:n.expiring,expired:n.expired,lastChecked:Date.now()}),[...o].sort((f,v)=>{const P=typeof f.daysLeft=="number"?f.daysLeft:Number.POSITIVE_INFINITY,R=typeof v.daysLeft=="number"?v.daysLeft:Number.POSITIVE_INFINITY;return P-R})}),L({results:[...a.current?.results?p(a.current?.results).filter(i=>i.host!==e):[],c],lastFetched:a.current?.lastFetched})}};u.useEffect(()=>{const e=I(E);x({expiring:e.expiring,expired:e.expired,lastChecked:Date.now()})},[E,I,x]);const te=()=>{A(!0),O("")};u.useEffect(()=>{j&&setTimeout(()=>Z.current?.focus(),50)},[j]);const J=()=>{const e=H.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!e){z.error(r("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(e)){z.error(r("sys.certificate.domainInvalid"));return}if(m.some(y=>y.host.toLowerCase()===e.toLowerCase())){z.warning(r("sys.certificate.domainExists"));return}const s=[...m,{host:e,source:"custom",createdAt:Date.now()}];N(s),a.current={...a.current,domains:s,seededFromServers:a.current?.seededFromServers??!0},localStorage.setItem(_,JSON.stringify({domains:s,lastFetched:a.current?.lastFetched,results:a.current?.results,seededFromServers:a.current?.seededFromServers??!0})),A(!1),O(""),B(e,"custom")},se=e=>{const t=m.filter(s=>s.host!==e);N(t);const d={domains:p(t),lastFetched:a.current?.lastFetched,results:p(a.current?.results).filter(s=>s.host!==e),seededFromServers:a.current?.seededFromServers??!0};a.current=d,localStorage.setItem(_,JSON.stringify(d)),F(s=>{const y=s.filter(i=>i.host!==e),c=I(y);return x({expiring:c.expiring,expired:c.expired,lastChecked:Date.now()}),[...y].sort((i,h)=>{const o=typeof i.daysLeft=="number"?i.daysLeft:Number.POSITIVE_INFINITY,n=typeof h.daysLeft=="number"?h.daysLeft:Number.POSITIVE_INFINITY;return o-n})})},re=[{title:r("sys.certificate.api"),dataIndex:"addr",key:"addr",render:(e,t)=>l.jsx("div",{className:"max-w-[220px] truncate md:max-w-none md:whitespace-nowrap",children:t.addr})},{title:r("sys.certificate.ip"),dataIndex:"ip",key:"ip",render:(e,t)=>t.error?"-":t.ip||"-"},{title:r("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",render:(e,t)=>t.error?"-":t.vendor||"-"},{title:r("sys.certificate.daysLeft"),dataIndex:"daysLeft",key:"daysLeft",render:(e,t)=>{if(t.error||typeof t.daysLeft!="number")return"-";const d=t.daysLeft<=7?"error":"default";return l.jsx(S,{color:d,className:"!px-3 !py-1 text-base leading-6",children:l.jsx("span",{className:"text-lg font-medium",children:t.daysLeft})})}},{title:r("sys.certificate.valid"),dataIndex:"valid",key:"valid",render:(e,t)=>t.error?l.jsx(S,{color:"default",children:r("sys.certificate.unknown")}):t.valid===void 0?l.jsx(S,{color:"default",children:r("sys.certificate.unknown")}):t.valid===!1?l.jsx(S,{color:"error",children:r("sys.certificate.invalidTag")}):typeof t.daysLeft=="number"&&t.daysLeft<=7?l.jsx(S,{color:"gold",children:r("sys.certificate.expiring")}):l.jsx(S,{color:"success",children:r("sys.certificate.validTag")})},{title:r("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",render:(e,t)=>t.error?"-":t.validFrom||"-"},{title:r("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",render:(e,t)=>t.error?"-":t.validTill||"-"},{title:r("sys.certificate.remark"),dataIndex:"error",key:"error",render:(e,t)=>t.updatedAt||"-"},{title:r("sys.certificate.operation"),key:"operation",render:(e,t)=>l.jsxs(q,{size:"small",className:"text-gray-500",children:[l.jsx(G,{size:"small",onClick:()=>void B(t.host),children:l.jsx(U,{icon:"solar:refresh-bold-duotone",size:16})}),l.jsx(ce,{title:r("sys.certificate.deleteConfirm"),onConfirm:()=>se(t.host),children:l.jsx(G,{size:"small",children:l.jsx(U,{icon:"solar:trash-bin-trash-bold-duotone",size:16})})})]})}];return l.jsxs(de,{title:r("sys.certificate.title"),extra:l.jsxs(q,{size:"middle",children:[$&&l.jsx(he,{type:"secondary",className:"text-xs",children:r("sys.certificate.updatedAt",{time:$.toLocaleString()})}),l.jsx(Q,{onClick:te,children:r("sys.certificate.addDomain")}),l.jsx(Q,{onClick:()=>{T()},loading:Y,disabled:k.length===0,children:r("sys.certificate.refresh")})]}),children:[k.length===0?l.jsx(K,{image:K.PRESENTED_IMAGE_SIMPLE,description:r("sys.certificate.noServer")}):l.jsx(le,{rowKey:"key",loading:Y,columns:re,dataSource:E,pagination:!1,scroll:{x:!0},size:"middle"}),l.jsx(ue,{title:r("sys.certificate.addDomain"),open:j,onOk:J,onCancel:()=>A(!1),okText:r("sys.certificate.confirm"),cancelText:r("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},children:l.jsx(fe,{addonBefore:"https://",placeholder:r("sys.certificate.domainPlaceholder"),value:H,onChange:e=>O(e.target.value),onPressEnter:J,allowClear:!0,ref:Z})})]})}export{Fe as default};

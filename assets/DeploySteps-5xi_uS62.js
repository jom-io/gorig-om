import{u as ee,a as Ie,j as s}from"./index-P1Zoe_e-.js";import{d as m}from"./deployService-DWHm9zEB.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import{A as we,J,s as Ne,K as R,N as W,i as j,O as ke,I as z,t as se,P as Ke,h as Te,Q as Be,l as Le}from"./vendor-ui-B8JNe9Dz.js";import"./vendor-utils-9ATX-dPw.js";const{Text:x,Paragraph:Oe}=Ne,te=o.memo(({repo:y,index:u,onChange:t,onRemove:c})=>{const{t:f}=ee(),[l,w]=o.useState(!1),v=async d=>{if(d.endsWith(".git"))try{w(!0);const p=await m.getBranches(d);t(u,"branches",JSON.stringify(p||[])),p&&p.length>0&&t(u,"branch",p[0])}catch{t(u,"branches","[]")}finally{w(!1)}},S=o.useMemo(()=>{try{return typeof y.branches=="string"?JSON.parse(y.branches):y.branches||[]}catch{return[]}},[y.branches]);return s.jsx("div",{className:"flex items-start mb-4 p-4 border rounded",children:s.jsxs("div",{className:"flex-1 flex items-center space-x-2",children:[s.jsx(z,{placeholder:f("deploy.repo.dirPlaceholder"),value:y.dir,onChange:d=>{const p=d.target.value;t(u,"dir",p)},style:{width:160}}),s.jsx(z,{placeholder:f("deploy.repo.inputPlaceholder"),value:y.repo,onChange:d=>{const p=d.target.value;t(u,"repo",p),p.endsWith(".git")&&v(p)},style:{width:280}}),s.jsx(se,{showSearch:!0,style:{width:160},placeholder:f(l?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),value:y.branch,onChange:d=>t(u,"branch",d),options:S.map(d=>({label:d,value:d})),loading:l,disabled:l,filterOption:(d,p)=>p?String(p.value).toLowerCase().includes(d.toLowerCase()):!1}),s.jsx(j,{type:"text",danger:!0,icon:s.jsx(Le,{}),onClick:()=>c(u)})]})})},(y,u)=>{const t=y.repo.branches||[],c=u.repo.branches||[];return y.repo.dir===u.repo.dir&&y.repo.repo===u.repo.repo&&y.repo.branch===u.repo.branch&&JSON.stringify(t)===JSON.stringify(c)&&y.index===u.index});te.displayName="OtherRepoItem";const Je=({onComplete:y,initialStep:u})=>{const{t}=ee(),{message:c}=we.useApp(),f=Ie(),[l,w]=o.useState(u),[v,S]=o.useState(!1),[d,p]=o.useState(!1),[N,q]=o.useState(!1),[re,M]=o.useState(!1),[I,Q]=o.useState(null),[C,Z]=o.useState(null),[k,_]=o.useState(null),[$,L]=o.useState([]),[n,a]=o.useState({gitInit:!1,goInit:!1,sshKeyCopy:!1,repo:"",branch:"",autoTrigger:!1}),[ne,X]=o.useState(!1),[ae]=o.useState(!1),[K,O]=o.useState(!1),H=o.useRef(null),D=o.useRef(!1),oe=o.useRef([]),ie=o.useCallback((e,r,b)=>{a(h=>{const i=[...h.otherRepos||[]];return i[e]||(i[e]={dir:"",repo:"",branch:"",branches:[]}),i[e]={...i[e],[r]:b},{...h,otherRepos:i}})},[]),ce=o.useCallback(()=>{a(e=>({...e,otherRepos:[...e.otherRepos||[],{dir:"",repo:"",branch:"",branches:[]}]}))},[]),le=o.useCallback(e=>{a(r=>{const b=[...r.otherRepos||[]];return b.splice(e,1),{...r,otherRepos:b}})},[]);o.useEffect(()=>{n.otherRepos&&(oe.current=n.otherRepos)},[n.otherRepos]);const T=o.useCallback(async()=>{try{const e=await m.checkInstallStatus();return Q(e),e?.installed?a(r=>({...r,gitInit:!0})):a(r=>({...r,gitInit:!1})),e}catch{return a(r=>({...r,gitInit:!1})),null}},[]),B=o.useCallback(async()=>{try{const e=await m.checkGo();return Z(e),e?.installed?a(r=>({...r,goInit:!0})):a(r=>({...r,goInit:!1})),e}catch{return a(r=>({...r,goInit:!1})),null}},[]),Y=o.useCallback(async()=>{try{const e=await m.getSshKey();return _(e),a(r=>({...r,sshKeyCopy:!!e?.publicKey})),e}catch{return null}},[]),G=o.useCallback(async()=>{if(f&&!D.current)try{D.current=!0,S(!0);const e=await m.getTaskCfg(),r=await T(),b=await B(),h={gitInit:e.gitInit||!!r?.installed,goInit:e.goInit||!!b?.installed,sshKeyCopy:e.sshKeyCopy,repo:e.repo,branch:e.branch,autoTrigger:e.autoTrigger,otherRepos:e.otherRepos||[]};let i=0;if(h.gitInit&&h.goInit&&(i=1,h.sshKeyCopy&&(i=2,h.repo&&h.branch&&(i=3))),a(h),w(i),e.repo){O(!0);try{const g=await m.getBranches(e.repo);L(g)}catch{L([])}}if(e.otherRepos&&e.otherRepos.length>0){for(const g of e.otherRepos)if(g.repo?.endsWith(".git"))try{const P=await m.getBranches(g.repo);a(U=>{const E=[...U.otherRepos||[]],V=E.findIndex(Re=>Re.repo===g.repo);return V!==-1&&(E[V]={...E[V],branches:P}),{...U,otherRepos:E}})}catch{}}H.current=f.addr}catch{}finally{D.current=!1,S(!1)}},[f,T,B]);o.useEffect(()=>{f&&G()},[G,f]),o.useEffect(()=>{f&&H.current!==f.addr&&(H.current=null,G())},[f,G]),o.useEffect(()=>{D.current||v||(l===0?(I||T().then(e=>{e?.installed&&a(r=>({...r,gitInit:!0}))}),C||B().then(e=>{e?.installed&&a(r=>({...r,goInit:!0}))})):l===1&&Y().then(e=>{e?.publicKey&&a(r=>({...r,sshKeyCopy:!0}))}))},[l,T,B,Y,v,I,C]);const pe=async(e,r)=>{if(e.endsWith(".git"))try{q(!0);const b=await m.getBranches(e);a(h=>{const i=[...h.otherRepos||[]];return i[r]&&(i[r]={...i[r],branches:b}),{...h,otherRepos:i}})}catch{a(h=>{const i=[...h.otherRepos||[]];return i[r]&&(i[r]={...i[r],branches:[]}),{...h,otherRepos:i}})}finally{q(!1)}},he=e=>{a(r=>({...r,branch:e}))},de=async()=>{try{S(!0);const e=await m.installGit();if(e.error){c.error(e.error),a(r=>({...r,gitInit:!1}));return}Q(e),a(r=>({...r,gitInit:!0})),c.success("Git 安装成功")}catch{a(r=>({...r,gitInit:!1}))}finally{S(!1)}},ye=async()=>{try{S(!0);const e=await m.installGo();if(e.error){c.error(e.error),a(r=>({...r,goInit:!1}));return}Z(e),a(r=>({...r,goInit:!0})),c.success("Go 安装成功")}catch{a(r=>({...r,goInit:!1}))}finally{S(!1)}},ue=async()=>{try{S(!0);const e=await m.generateSshKey();_(e),a(r=>({...r,sshKeyCopy:!!e?.publicKey})),c.success("SSH Key 生成成功")}catch{}finally{S(!1)}},ge=async()=>{if(!n.repo.startsWith("git@")){c.error(t("deploy.repo.invalidFormat"));return}try{M(!0);const e=await m.getBranches(n.repo);L(e),!n.branch&&e.length>0&&a(r=>({...r,branch:e[0]})),O(!0),c.success(t("deploy.repo.checkSuccess"))}catch{L([]),a(r=>({...r,branch:""})),O(!1)}finally{M(!1)}},fe=async()=>{if(!k?.publicKey){c.error(t("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(k.publicKey),c.success(t("deploy.ssh.copySuccess"))}catch{c.error(t("deploy.ssh.copyFailed"))}},xe=e=>{if(A(e))w(e);else{const r=[];n.gitInit||r.push(t("deploy.steps.gitCheck")),n.sshKeyCopy||r.push(t("deploy.steps.sshConfig")),n.repo||r.push(t("deploy.steps.repoConfig")),n.branch||r.push(t("deploy.steps.branchSelect")),c.warning(t("deploy.navigation.missingSteps",{steps:r.join("、")}))}},me=$.map(e=>({label:e,value:e})),je=async e=>{try{X(!0),a(r=>({...r,autoTrigger:e}))}catch{a(b=>({...b,autoTrigger:!e}))}finally{X(!1)}},A=e=>{switch(e){case 0:return!0;case 1:return n.gitInit&&n.goInit;case 2:return n.gitInit&&n.goInit&&n.sshKeyCopy;case 3:return n.gitInit&&n.goInit&&n.sshKeyCopy&&n.repo&&n.branch;default:return!1}},F=[{title:t("deploy.steps.envCheck"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:t("deploy.git.title")}),v&&!I&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:t("deploy.git.checking")})]}),I?.error&&s.jsx(R,{message:t("deploy.git.installFailed"),description:I.error,type:"error",showIcon:!0,className:"mb-4"}),I?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(x,{children:t("deploy.git.installed")}),s.jsxs(x,{type:"secondary",children:["(",I.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{type:"primary",onClick:de,loading:v,children:t("deploy.git.install")}),s.jsx(j,{onClick:T,children:t("deploy.git.recheck")})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:t("deploy.go.title")}),v&&!C&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:t("deploy.go.checking")})]}),C?.error&&s.jsx(R,{message:C.version?t("deploy.go.versionMismatch"):t("deploy.go.installFailed"),description:C.error,type:"error",showIcon:!0,className:"mb-4"}),C?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(x,{children:t("deploy.go.installed")}),s.jsxs(x,{type:"secondary",children:["(",C.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{type:"primary",onClick:ye,loading:v,children:C?.version?t("deploy.go.reinstall"):t("deploy.go.install")}),s.jsx(j,{onClick:B,children:t("deploy.go.recheck")})]})]}),C?.installed&&I?.installed?null:s.jsx(R,{message:"提示",description:t("deploy.installFailedTip"),type:"info",showIcon:!0})]})},{title:t("deploy.steps.sshConfig"),content:s.jsxs("div",{className:"py-4",children:[v&&!k&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:t("deploy.ssh.checking")})]}),k?.publicKey?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(x,{children:t("deploy.ssh.configured")})]}),s.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(x,{strong:!0,children:t("deploy.ssh.publicKey")}),s.jsx(j,{type:"link",icon:s.jsx(ke,{}),onClick:fe,children:t("deploy.ssh.copy")})]}),s.jsx(Oe,{className:"mb-0 break-all",children:s.jsx(x,{code:!0,children:k.publicKey})})]}),s.jsx(R,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(j,{type:"primary",onClick:ue,loading:v,children:t("deploy.ssh.generate")}),s.jsx(R,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:t("deploy.steps.repoConfig"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(z,{placeholder:t("deploy.repo.inputPlaceholder"),value:n.repo,onChange:e=>{a(r=>({...r,repo:e.target.value})),O(!1)},style:{width:400}}),s.jsx(j,{onClick:ge,loading:re,type:K?"default":"primary",icon:K?s.jsx(W,{}):null,children:t(K?"deploy.repo.recheck":"deploy.repo.check")})]}),!K&&s.jsx(R,{message:t("deploy.repo.nextStep"),description:t("deploy.repo.tip"),type:"info",showIcon:!0}),K&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(se,{showSearch:!0,style:{width:400},placeholder:t(N?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:me,value:n.branch,onChange:he,loading:N,disabled:N,filterOption:(e,r)=>(r?.label??"").toLowerCase().includes(e.toLowerCase())}),s.jsx(j,{icon:s.jsx(Ke,{spin:N}),onClick:()=>pe(n.repo,0),disabled:!n.repo,loading:N,children:t("deploy.branch.refresh")})]}),!$.length&&!N&&!n.branch&&s.jsx(R,{message:t("deploy.branch.noBranches"),description:t("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),($.length>0||n.branch)&&s.jsx(R,{message:t("deploy.branch.nextStep"),description:n.branch?t("deploy.branch.currentBranch",{branch:n.branch}):t("deploy.branch.selectTip"),type:n.branch?"success":"info",showIcon:!0}),s.jsxs("div",{className:"mt-6 border-t pt-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("div",{className:"font-medium",children:t("deploy.repo.dependencies")}),s.jsx(j,{type:"default",onClick:ce,children:t("deploy.repo.addDependency")})]}),n.otherRepos?.map((e,r)=>s.jsx(te,{repo:e,index:r,onChange:ie,onRemove:le},e.dir)),n.otherRepos&&n.otherRepos.length>0&&s.jsx(R,{message:t("deploy.repo.dependencyTip"),description:s.jsx("div",{style:{lineHeight:1.6},children:t("deploy.repo.dependencyDesc").split(`
`).map((e,r)=>s.jsx("div",{style:{marginBottom:2},children:e},r))}),type:"info",showIcon:!0,className:"mt-4"})]})]})]})},{title:t("deploy.steps.autoTrigger"),content:s.jsx("div",{className:"py-4 space-y-4",children:ae?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(J,{}),s.jsx(x,{children:t("deploy.autoTrigger.loading")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(Te,{checked:n.autoTrigger,onChange:je,loading:ne}),s.jsx(x,{children:t("deploy.autoTrigger.enable")})]}),s.jsx(x,{type:"secondary",children:t("deploy.autoTrigger.tip")})]})})}],be=()=>{if(l===2){if(!n.repo||!n.branch){c.warning(t("deploy.navigation.missingSteps",{steps:t("deploy.steps.repoConfig")}));return}if(n.otherRepos&&n.otherRepos.length>0){if(n.otherRepos.filter(g=>!g.dir||!g.repo||!g.branch).length>0){c.warning(t("deploy.repo.incompleteDependency"));return}const r=n.otherRepos.map(g=>g.dir);if(new Set(r).size!==r.length){c.error(t("deploy.repo.duplicateDir"));return}const h=/^[a-zA-Z0-9_-]+$/;if(r.filter(g=>!h.test(g)).length>0){c.error(t("deploy.repo.invalidDir"));return}}}A(l+1)&&w(l+1)},ve=()=>{l>0&&w(l-1)},Se=F.map((e,r)=>({key:e.title,title:e.title,disabled:!A(r)})),Ce=async()=>{try{p(!0),await m.saveTaskCfg(n),y(n),c.success(t("sys.cicd.saveSuccess"))}catch{}finally{p(!1)}};return s.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[s.jsx(Be,{current:l,items:Se,className:"px-6",onChange:xe}),s.jsx("div",{className:"flex-1 mt-4 px-6",children:F[l]?.content}),s.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[l>0&&s.jsx(j,{style:{margin:"0 8px"},onClick:ve,children:t("deploy.navigation.prev")}),l<F.length-1&&s.jsx(j,{type:"primary",onClick:be,disabled:!A(l+1),children:t("deploy.navigation.next")}),l===F.length-1&&s.jsx(j,{type:"primary",onClick:Ce,loading:d,children:t("sys.cicd.save")})]})]})};export{Je as DeploySteps,Je as default};

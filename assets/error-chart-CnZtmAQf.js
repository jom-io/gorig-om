import{u as G,t as n,j as r}from"./index-AHjT66P3.js";import{s as D}from"./statService-CxUvAms7.js";import{C as K}from"./index-Bc1co6Wu.js";import{C as V}from"./chart-DWnyXj9S.js";import{u as J}from"./useChart-CgyA-rHf.js";import{z as d,M as Q,G as Z,s as L,T as ee}from"./vendor-ui-B8JNe9Dz.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import te from"./anomaly-sample-modal-DfDNxKJg.js";import{useTimeRange as ae}from"./api-latency-chart-BEhE8p-9.js";import"./vendor-utils-9ATX-dPw.js";import"./vendor-charts-C0vSEv4L.js";import"./api-sample-modal-DLs4z4SQ.js";const g=["error","panic"];function he({open:c,onClose:N,enabled:y=!0}){const{t:l}=G(),{timeUnit:f,timeRange:w,setTimeRange:k,getRange:h,dateLabelFormat:O,renderTimePicker:R}=ae("today",[d().startOf("day"),d()]),[i,x]=o.useState(null),[H,z]=o.useState([]),[A,v]=o.useState([]),[E,T]=o.useState(!1),[F,$]=o.useState(g),C=o.useRef(!1),[I,j]=o.useState({open:!1,data:null}),U=o.useMemo(()=>[n.colors.palette.error.dark,n.colors.palette.error.default],[]),u=F,X=e=>{j({open:!0,data:e})},q=o.useCallback(e=>{const t=g[e];$(a=>a.includes(t)?a.filter(m=>m!==t):[...a,t])},[]),W=o.useCallback((e,t)=>{if(!t?.xaxis)return;const{min:a,max:s}=t.xaxis;if(a&&s&&a!==s){const m=d(a),b=d(s);x([m,b]),e?.zoomX&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.zoomX(void 0,void 0)})})}},[]),S=o.useCallback(async e=>{try{const t=h(e),a=await D.errorTimeRange(t.start,t.end,t.apiUnit,g);z(a)}catch{}},[h]),M=o.useCallback(async e=>{if(u.length===0){v([]);return}try{T(!0);const t=i?.[0]&&i?.[1]?{start:Math.floor(i[0].valueOf()/1e3),end:Math.floor(i[1].valueOf()/1e3),apiUnit:(()=>{const s=(i[1].valueOf()-i[0].valueOf())/36e5;return s<=1?"minute":s<=6?"5m":s<=48?"hour":"day"})()}:h(e),a=await D.errorTop(t.start,t.end,10,u);v(a)}catch{}finally{T(!1)}},[h,u,i]);o.useEffect(()=>{const e=C.current;C.current=c,c&&!e&&f==="today"&&w?.[0]&&k([w[0],d()]),c&&y&&(S(f),x(null))},[c,y,f,w,k,S]),o.useEffect(()=>{c&&y&&M(f)},[c,y,f,M]);const p=H,B=A,P=o.useMemo(()=>{if(!p.length)return[];const e=t=>{switch(t){case"error":return l("sys.workbench.anomalyError");case"panic":return l("sys.workbench.anomalyPanic");default:return t}};return g.map(t=>{const a=p.map(m=>{const b=m.value[t]||0;return{x:Number(m.at)*1e3,y:b}}),s=u.includes(t);return{name:e(t),data:s?a:a.map(m=>({...m,y:null}))}})},[p,u,l]),Y=o.useMemo(()=>{if(p.length)return p.reduce((e,t)=>{const a=t.value,s=(a.error||0)+(a.panic||0);return Math.max(e,s)},0)+1},[p]),_=J({colors:U,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:O}},tooltip:{x:{formatter:e=>{switch(f){case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e}`}},yaxis:{labels:{formatter:e=>`${e}`},min:0,max:Y},chart:{toolbar:{show:!1},zoom:{enabled:!0,type:"x",autoScaleYaxis:!1},selection:{enabled:!0,type:"x",fill:{color:n.colors.palette.primary.default,opacity:.2},stroke:{width:2,dashArray:0,color:n.colors.palette.primary.default,opacity:.8}},events:{legendClick:(e,t)=>(q(t??0),!1),selection:(e,t)=>{t?.xaxis&&W(e,t)},zoomed:(e,{xaxis:t})=>{if(t?.min&&t?.max){const a=d(t.min),s=d(t.max);x([a,s]),e?.zoomX&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.zoomX(void 0,void 0)})})}}}},stroke:{curve:"smooth",width:2},annotations:{xaxis:i?.[0]&&i?.[1]?(()=>{const e=i[0],t=i[1],s=!e.isSame(t,"day")?`${e.format("MM-DD HH:mm")} ~ ${t.format("MM-DD HH:mm")}`:`${e.format("HH:mm")} ~ ${t.format("HH:mm")}`,m=(e.valueOf()+t.valueOf())/2;return[{x:e.valueOf(),x2:t.valueOf(),fillColor:n.colors.palette.primary.default,opacity:.1,borderColor:n.colors.palette.primary.default,strokeDashArray:0,borderWidth:1},{x:m,label:{text:s,orientation:"horizontal",position:"top",offsetY:-15,style:{fontSize:"11px",fontWeight:500,color:n.colors.palette.primary.default,background:n.colors.background.paper,padding:{left:8,right:8,top:4,bottom:4}},borderColor:n.colors.palette.primary.default,borderWidth:1}}]})():[]}});return r.jsxs(Q,{title:l("sys.workbench.anomalyTrend"),open:c&&y,onCancel:N,width:850,footer:null,style:{top:"10%"},styles:{body:{padding:"0px"}},maskClosable:!0,destroyOnClose:!0,children:[r.jsxs(K,{className:"flex-col !shadow-none",children:[r.jsxs("header",{className:"flex w-full justify-between items-center mb-4",children:[r.jsx("div",{}),R(()=>{x(null)})]}),r.jsxs("main",{className:"w-full flex flex-col gap-4",children:[r.jsxs("div",{className:"w-full",children:[r.jsx("div",{className:"mb-2 text-xs",style:{color:n.colors.text.secondary},children:l("sys.workbench.chartHint","ðŸ’¡ æ‹–æ‹½é€‰æ‹©")}),r.jsx(V,{type:"area",series:P,options:_,height:360})]}),r.jsxs("div",{className:"w-full",children:[r.jsx("div",{className:"flex items-center justify-between mb-2 px-1",children:r.jsxs("div",{className:"flex flex-col",children:[r.jsx("span",{className:"text-base font-medium",style:{color:n.colors.text.primary},children:l("sys.workbench.anomalyTopTitle")}),r.jsx("span",{className:"text-xs",style:{color:n.colors.text.secondary},children:l("sys.workbench.anomalyTopDesc")})]})}),r.jsx(Z,{rowKey:e=>e.sigHash,dataSource:B,loading:E,size:"small",pagination:!1,locale:{emptyText:l("sys.workbench.anomalyTopEmpty")},onRow:e=>({onClick:()=>X(e),className:"cursor-pointer"}),columns:[{title:l("sys.workbench.anomalySignature"),dataIndex:"signature",key:"signature",render:(e,t)=>r.jsx(L.Text,{ellipsis:{tooltip:t.signature||t.sampleMsg||t.sampleError},style:{maxWidth:320},children:t.signature||t.sampleMsg||l("sys.workbench.anomalySampleEmpty")})},{title:l("sys.workbench.anomalyCount"),dataIndex:"count",key:"count",align:"right",width:80,render:e=>r.jsx(L.Text,{strong:!0,style:{color:n.colors.palette.error.dark},children:e})},{title:l("sys.workbench.anomalyLevel"),dataIndex:"level",key:"level",width:90,render:e=>{const t=e||(u.length===1?u[0]:"-");return r.jsx(ee,{color:n.colors.palette.error.light,children:t?.toUpperCase()})}},{title:l("sys.workbench.anomalyLastSeen"),dataIndex:"lastAt",key:"lastAt",width:180,className:"whitespace-nowrap",render:e=>re(e)}]})]})]})]}),r.jsx(te,{...I,onClose:()=>j(e=>({...e,open:!1}))})]})}const re=c=>c?new Date(Number(c)*1e3).toLocaleString():"--";export{he as default};

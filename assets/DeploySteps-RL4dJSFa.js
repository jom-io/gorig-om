import{u as ee,a as Ie,j as s}from"./index-Bp6b3peI.js";import{d as g}from"./deployService-C7FmMmXd.js";import{r as o}from"./vendor-core-Cler3e7Q.js";import{A as we,J as F,s as ke,K as S,N as W,i as j,O as Ne,I as z,t as se,P as Ke,h as Te,Q as Be,l as Le}from"./vendor-ui-BgnAtmuh.js";import"./vendor-utils-Dg5_7-NF.js";const{Text:m,Paragraph:Ae}=ke,te=o.memo(({repo:f,index:d,onChange:r,onRemove:l})=>{const{t:x}=ee(),[p,R]=o.useState(!1),v=async i=>{if(i.endsWith(".git"))try{R(!0);const y=await g.getBranches(i);r(d,"branches",JSON.stringify(y)),y.length>0&&r(d,"branch",y[0])}catch{r(d,"branches","[]")}finally{R(!1)}};return s.jsx("div",{className:"flex items-start mb-4 p-4 border rounded",children:s.jsxs("div",{className:"flex-1 flex items-center space-x-2",children:[s.jsx(z,{placeholder:x("deploy.repo.dirPlaceholder"),value:f.dir,onChange:i=>{const y=i.target.value;r(d,"dir",y)},style:{width:160}}),s.jsx(z,{placeholder:x("deploy.repo.inputPlaceholder"),value:f.repo,onChange:i=>{const y=i.target.value;r(d,"repo",y),y.endsWith(".git")&&v(y)},style:{width:280}}),s.jsx(se,{showSearch:!0,style:{width:160},placeholder:x(p?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),value:f.branch,onChange:i=>r(d,"branch",i),options:Array.isArray(f.branches)?f.branches.map(i=>({label:i,value:i})):[],loading:p,disabled:p,filterOption:(i,y)=>y?String(y.value).toLowerCase().includes(i.toLowerCase()):!1}),s.jsx(j,{type:"text",danger:!0,icon:s.jsx(Le,{}),onClick:()=>l(d)})]})})},(f,d)=>f.repo.dir===d.repo.dir&&f.repo.repo===d.repo.repo&&f.repo.branch===d.repo.branch&&f.repo.branches?.join(",")===d.repo.branches?.join(",")&&f.index===d.index);te.displayName="OtherRepoItem";const $e=({onComplete:f,initialStep:d})=>{const{t:r}=ee(),{message:l}=we.useApp(),x=Ie(),[p,R]=o.useState(d),[v,i]=o.useState(!1),[y,q]=o.useState(!1),[w,J]=o.useState(!1),[re,M]=o.useState(!1),[I,Q]=o.useState(null),[C,Z]=o.useState(null),[k,_]=o.useState(null),[$,B]=o.useState([]),[n,a]=o.useState({gitInit:!1,goInit:!1,sshKeyCopy:!1,repo:"",branch:"",autoTrigger:!1}),[ne,X]=o.useState(!1),[ae,De]=o.useState(!1),[N,L]=o.useState(!1),H=o.useRef(null),A=o.useRef(!1),oe=o.useRef([]),ie=o.useCallback((e,t,b)=>{a(h=>{const c=[...h.otherRepos||[]];return c[e]||(c[e]={dir:"",repo:"",branch:"",branches:[]}),c[e]={...c[e],[t]:b},{...h,otherRepos:c}})},[]),ce=o.useCallback(()=>{a(e=>({...e,otherRepos:[...e.otherRepos||[],{dir:"",repo:"",branch:"",branches:[]}]}))},[]),le=o.useCallback(e=>{a(t=>{const b=[...t.otherRepos||[]];return b.splice(e,1),{...t,otherRepos:b}})},[]);o.useEffect(()=>{n.otherRepos&&(oe.current=n.otherRepos)},[n.otherRepos]);const K=o.useCallback(async()=>{try{const e=await g.checkInstallStatus();return Q(e),e?.installed?a(t=>({...t,gitInit:!0})):a(t=>({...t,gitInit:!1})),e}catch{return a(t=>({...t,gitInit:!1})),null}},[]),T=o.useCallback(async()=>{try{const e=await g.checkGo();return Z(e),e?.installed?a(t=>({...t,goInit:!0})):a(t=>({...t,goInit:!1})),e}catch{return a(t=>({...t,goInit:!1})),null}},[]),Y=o.useCallback(async()=>{try{const e=await g.getSshKey();return _(e),a(t=>({...t,sshKeyCopy:!!e?.publicKey})),e}catch{return null}},[]);o.useCallback(async()=>{try{return await g.getTaskCfg()}catch{return null}},[]);const D=o.useCallback(async()=>{if(x&&!A.current)try{A.current=!0,i(!0);const e=await g.getTaskCfg(),t=await K(),b=await T(),h={gitInit:e.gitInit||!!t?.installed,goInit:e.goInit||!!b?.installed,sshKeyCopy:e.sshKeyCopy,repo:e.repo,branch:e.branch,autoTrigger:e.autoTrigger,otherRepos:e.otherRepos||[]};let c=0;if(h.gitInit&&h.goInit&&(c=1,h.sshKeyCopy&&(c=2,h.repo&&h.branch&&(c=3))),a(h),R(c),e.repo){L(!0);try{const u=await g.getBranches(e.repo);B(u)}catch{B([])}}if(e.otherRepos&&e.otherRepos.length>0){for(const u of e.otherRepos)if(u.repo&&u.repo.endsWith(".git"))try{const P=await g.getBranches(u.repo);a(U=>{const E=[...U.otherRepos||[]],V=E.findIndex(Re=>Re.repo===u.repo);return V!==-1&&(E[V]={...E[V],branches:P}),{...U,otherRepos:E}})}catch{}}H.current=x.addr}catch{}finally{A.current=!1,i(!1)}},[x,K,T]);o.useEffect(()=>{x&&D()},[D,x]),o.useEffect(()=>{x&&H.current!==x.addr&&(H.current=null,D())},[x,D]),o.useEffect(()=>{A.current||v||(p===0?(I||K().then(e=>{e?.installed&&a(t=>({...t,gitInit:!0}))}),C||T().then(e=>{e?.installed&&a(t=>({...t,goInit:!0}))})):p===1&&Y().then(e=>{e?.publicKey&&a(t=>({...t,sshKeyCopy:!0}))}))},[p,K,T,Y,v,I,C]);const pe=async(e,t)=>{if(e.endsWith(".git"))try{J(!0);const b=await g.getBranches(e);a(h=>{const c=[...h.otherRepos||[]];return c[t]&&(c[t]={...c[t],branches:b}),{...h,otherRepos:c}})}catch{a(h=>{const c=[...h.otherRepos||[]];return c[t]&&(c[t]={...c[t],branches:[]}),{...h,otherRepos:c}})}finally{J(!1)}},he=e=>{a(t=>({...t,branch:e}))},de=async()=>{try{i(!0);const e=await g.installGit();if(e.error){l.error(e.error),a(t=>({...t,gitInit:!1}));return}Q(e),a(t=>({...t,gitInit:!0})),l.success("Git 安装成功")}catch{a(t=>({...t,gitInit:!1}))}finally{i(!1)}},ye=async()=>{try{i(!0);const e=await g.installGo();if(e.error){l.error(e.error),a(t=>({...t,goInit:!1}));return}Z(e),a(t=>({...t,goInit:!0})),l.success("Go 安装成功")}catch{a(t=>({...t,goInit:!1}))}finally{i(!1)}},ue=async()=>{try{i(!0);const e=await g.generateSshKey();_(e),a(t=>({...t,sshKeyCopy:!!e?.publicKey})),l.success("SSH Key 生成成功")}catch{}finally{i(!1)}},ge=async()=>{if(!n.repo.startsWith("git@")){l.error(r("deploy.repo.invalidFormat"));return}try{M(!0);const e=await g.getBranches(n.repo);B(e),!n.branch&&e.length>0&&a(t=>({...t,branch:e[0]})),L(!0),l.success(r("deploy.repo.checkSuccess"))}catch{B([]),a(t=>({...t,branch:""})),L(!1)}finally{M(!1)}},fe=async()=>{if(!k?.publicKey){l.error(r("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(k.publicKey),l.success(r("deploy.ssh.copySuccess"))}catch{l.error(r("deploy.ssh.copyFailed"))}},xe=e=>{if(G(e))R(e);else{const t=[];n.gitInit||t.push(r("deploy.steps.gitCheck")),n.sshKeyCopy||t.push(r("deploy.steps.sshConfig")),n.repo||t.push(r("deploy.steps.repoConfig")),n.branch||t.push(r("deploy.steps.branchSelect")),l.warning(r("deploy.navigation.missingSteps",{steps:t.join("、")}))}},me=$.map(e=>({label:e,value:e})),je=async e=>{try{X(!0),a(t=>({...t,autoTrigger:e}))}catch{a(b=>({...b,autoTrigger:!e}))}finally{X(!1)}},G=e=>{switch(e){case 0:return!0;case 1:return n.gitInit&&n.goInit;case 2:return n.gitInit&&n.goInit&&n.sshKeyCopy;case 3:return n.gitInit&&n.goInit&&n.sshKeyCopy&&n.repo&&n.branch;default:return!1}},O=[{title:r("deploy.steps.envCheck"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:r("deploy.git.title")}),v&&!I&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(F,{}),s.jsx(m,{children:r("deploy.git.checking")})]}),I?.error&&s.jsx(S,{message:r("deploy.git.installFailed"),description:I.error,type:"error",showIcon:!0,className:"mb-4"}),I?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(m,{children:r("deploy.git.installed")}),s.jsxs(m,{type:"secondary",children:["(",I.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{type:"primary",onClick:de,loading:v,children:r("deploy.git.install")}),s.jsx(j,{onClick:K,children:r("deploy.git.recheck")})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"font-medium",children:r("deploy.go.title")}),v&&!C&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(F,{}),s.jsx(m,{children:r("deploy.go.checking")})]}),C?.error&&s.jsx(S,{message:C.version?r("deploy.go.versionMismatch"):r("deploy.go.installFailed"),description:C.error,type:"error",showIcon:!0,className:"mb-4"}),C?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(m,{children:r("deploy.go.installed")}),s.jsxs(m,{type:"secondary",children:["(",C.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(j,{type:"primary",onClick:ye,loading:v,children:C?.version?r("deploy.go.reinstall"):r("deploy.go.install")}),s.jsx(j,{onClick:T,children:r("deploy.go.recheck")})]})]})]})},{title:r("deploy.steps.sshConfig"),content:s.jsxs("div",{className:"py-4",children:[v&&!k&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(F,{}),s.jsx(m,{children:r("deploy.ssh.checking")})]}),k?.publicKey?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{className:"text-success"}),s.jsx(m,{children:r("deploy.ssh.configured")})]}),s.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(m,{strong:!0,children:r("deploy.ssh.publicKey")}),s.jsx(j,{type:"link",icon:s.jsx(Ne,{}),onClick:fe,children:r("deploy.ssh.copy")})]}),s.jsx(Ae,{className:"mb-0 break-all",children:s.jsx(m,{code:!0,children:k.publicKey})})]}),s.jsx(S,{message:r("deploy.ssh.nextStep"),description:r("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(j,{type:"primary",onClick:ue,loading:v,children:r("deploy.ssh.generate")}),s.jsx(S,{message:r("deploy.ssh.nextStep"),description:r("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:r("deploy.steps.repoConfig"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(z,{placeholder:r("deploy.repo.inputPlaceholder"),value:n.repo,onChange:e=>{a(t=>({...t,repo:e.target.value})),L(!1)},style:{width:400}}),s.jsx(j,{onClick:ge,loading:re,type:N?"default":"primary",icon:N?s.jsx(W,{}):null,children:r(N?"deploy.repo.recheck":"deploy.repo.check")})]}),!N&&s.jsx(S,{message:r("deploy.repo.nextStep"),description:r("deploy.repo.tip"),type:"info",showIcon:!0}),N&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(se,{showSearch:!0,style:{width:400},placeholder:r(w?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:me,value:n.branch,onChange:he,loading:w,disabled:w,filterOption:(e,t)=>(t?.label??"").toLowerCase().includes(e.toLowerCase())}),s.jsx(j,{icon:s.jsx(Ke,{spin:w}),onClick:()=>pe(n.repo,0),disabled:!n.repo,loading:w,children:r("deploy.branch.refresh")})]}),!$.length&&!w&&!n.branch&&s.jsx(S,{message:r("deploy.branch.noBranches"),description:r("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),($.length>0||n.branch)&&s.jsx(S,{message:r("deploy.branch.nextStep"),description:n.branch?r("deploy.branch.currentBranch",{branch:n.branch}):r("deploy.branch.selectTip"),type:n.branch?"success":"info",showIcon:!0}),s.jsxs("div",{className:"mt-6 border-t pt-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("div",{className:"font-medium",children:r("deploy.repo.dependencies")}),s.jsx(j,{type:"default",onClick:ce,children:r("deploy.repo.addDependency")})]}),n.otherRepos?.map((e,t)=>s.jsx(te,{repo:e,index:t,onChange:ie,onRemove:le},t)),n.otherRepos&&n.otherRepos.length>0&&s.jsx(S,{message:r("deploy.repo.dependencyTip"),description:s.jsx("div",{style:{lineHeight:1.6},children:r("deploy.repo.dependencyDesc").split(`
`).map((e,t)=>s.jsx("div",{style:{marginBottom:2},children:e},t))}),type:"info",showIcon:!0,className:"mt-4"})]})]})]})},{title:r("deploy.steps.autoTrigger"),content:s.jsx("div",{className:"py-4 space-y-4",children:ae?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(F,{}),s.jsx(m,{children:r("deploy.autoTrigger.loading")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(Te,{checked:n.autoTrigger,onChange:je,loading:ne}),s.jsx(m,{children:r("deploy.autoTrigger.enable")})]}),s.jsx(m,{type:"secondary",children:r("deploy.autoTrigger.tip")})]})})}],be=()=>{if(p===2){if(!n.repo||!n.branch){l.warning(r("deploy.navigation.missingSteps",{steps:r("deploy.steps.repoConfig")}));return}if(n.otherRepos&&n.otherRepos.length>0){if(n.otherRepos.filter(u=>!u.dir||!u.repo||!u.branch).length>0){l.warning(r("deploy.repo.incompleteDependency"));return}const t=n.otherRepos.map(u=>u.dir);if(new Set(t).size!==t.length){l.error(r("deploy.repo.duplicateDir"));return}const h=/^[a-zA-Z0-9_-]+$/;if(t.filter(u=>!h.test(u)).length>0){l.error(r("deploy.repo.invalidDir"));return}}}G(p+1)&&R(p+1)},ve=()=>{p>0&&R(p-1)},Ce=O.map((e,t)=>({key:e.title,title:e.title,disabled:!G(t)})),Se=async()=>{try{q(!0),await g.saveTaskCfg(n),f(n),l.success(r("sys.cicd.saveSuccess"))}catch{}finally{q(!1)}};return s.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[s.jsx(Be,{current:p,items:Ce,className:"px-6",onChange:xe}),s.jsx("div",{className:"flex-1 mt-4 px-6",children:O[p]?.content}),s.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[p>0&&s.jsx(j,{style:{margin:"0 8px"},onClick:ve,children:r("deploy.navigation.prev")}),p<O.length-1&&s.jsx(j,{type:"primary",onClick:be,disabled:!G(p+1),children:r("deploy.navigation.next")}),p===O.length-1&&s.jsx(j,{type:"primary",onClick:Se,loading:y,children:r("sys.cicd.save")})]})]})};export{$e as DeploySteps,$e as default};

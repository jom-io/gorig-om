import{G as B,H as ne,J as le,c as L,K as ce,a as de,u as ge,j as s}from"./index-Bqsuz-xJ.js";import{Q as ue,u as me}from"./useBaseQuery-U7anTN7x.js";import{A as _,F as y,z as c,H as Y,C as G,U as he,V as j,t as S,T as fe,I as M,ac as ye,i as k,M as J,ad as pe,n as xe}from"./vendor-ui-BgnAtmuh.js";import{r as u}from"./vendor-core-Cler3e7Q.js";import{LogList as X}from"./log-list-BkRlLX0b.js";import"./vendor-utils-Dg5_7-NF.js";var Pe=class extends ue{constructor(r,m){super(r,m)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(r,m){super.setOptions({...r,behavior:B()},m)}getOptimisticResult(r){return r.behavior=B(),super.getOptimisticResult(r)}fetchNextPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"backward"}}})}createResult(r,m){const{state:v}=r,o=super.createResult(r,m),{isFetching:h,isRefetching:C,isError:p,isRefetchError:x}=o,g=v.fetchMeta?.fetchMore?.direction,P=p&&g==="forward",F=h&&g==="forward",T=p&&g==="backward",w=h&&g==="backward";return{...o,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:le(m,v.data),hasPreviousPage:ne(m,v.data),isFetchNextPageError:P,isFetchingNextPage:F,isFetchPreviousPageError:T,isFetchingPreviousPage:w,isRefetchError:x&&!P&&!T,isRefetching:C&&!F&&!w}}};function we(r,m){return me(r,Pe)}const je=r=>L.post({url:"/om/log/search",data:r}),ve=()=>L.get({url:"/om/log/categories"}),be=()=>L.get({url:"/om/log/levels"}),ke=r=>L.get({url:"/om/log/near",params:r}),Le=r=>L.get({url:"/om/log/download",params:{path:r},responseType:"blob"}),E={getLogList:je,getCategories:ve,getLevels:be,getNearLogs:ke,downloadLog:Le},W=1e3;function Se(){const{message:r}=_.useApp(),[m,v]=u.useState([]),[o]=y.useForm(),[h,C]=u.useState(null),[p,x]=u.useState(!1),[g,P]=u.useState(!1),[F,T]=u.useState(null),w=u.useRef(null),R=ce(),[b,D]=u.useState(!1),[Z,H]=u.useState(!1),[d,ee]=u.useState([]),N=de(),{t:i}=ge(),se=["commons","rest","console"],Q=(e,t)=>{t.stopPropagation(),J.confirm({title:i("sys.log.downloadConfirm"),content:i("sys.log.downloadConfirmContent"),onOk:async()=>{try{const n=await fetch(`${N?.addr}/om/log/download?path=${e}`,{headers:{Authorization:`Bearer ${N?.token}`}});if(!n.ok)throw new Error("下载失败");const a=await n.blob(),l=window.URL.createObjectURL(a),f=document.createElement("a");f.href=l,f.download=e.split("/").pop()||"logfile",document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(l)}catch{r.error(i("sys.log.downloadFailed"))}}})},I=async(e,t,n)=>{if(n.stopPropagation(),!(t<=0))try{const a=await E.getNearLogs({path:e,line:t,range:10});a.forEach(l=>{l.line===t&&(l.highlight=!0)}),ee(a),H(!0)}catch{r.error(i("sys.log.contextLogFailed"))}};u.useEffect(()=>{o.setFieldsValue({startTime:c().startOf("day"),timeRange:[c().startOf("day"),c()],categories:["commons"]}),(async()=>{const t=await E.getLevels();v(t)})()},[o]);const{data:te,fetchNextPage:q,hasNextPage:K,isFetchingNextPage:U}=we({queryKey:["logs",h],queryFn:async({pageParam:e={lastPath:void 0,lastLine:void 0}})=>{try{if(p)return[];x(!0);const t=h,n={...t,startTime:t?.startTime?c(t.startTime).format("YYYY-MM-DD HH:mm:ss"):void 0,endTime:t?.endTime?c(t.endTime).format("YYYY-MM-DD HH:mm:ss"):void 0},a=await E.getLogList({...n,lastPath:e.lastPath,lastLine:e.lastLine,size:50});return await new Promise(l=>setTimeout(l,200)),!a||a.length===0?[]:a}catch{return[]}finally{x(!1)}},getNextPageParam:e=>{if(!e||e.length===0)return;const t=e[e.length-1];return{lastPath:t.path,lastLine:t.line}},initialPageParam:void 0,enabled:h!==null&&!g,retry:1,retryDelay:1e3}),re=te?.pages.flat()??[];u.useEffect(()=>{const e=new IntersectionObserver(t=>{if(t[0]?.isIntersecting&&K&&!U){if(g)return;q()}},{threshold:.5});return w.current&&e.observe(w.current),()=>{e.disconnect()}},[K,U,q,g]);const ae=async()=>{if(g)F?.close(),P(!1),D(!1),r.success(i("sys.log.monitorStopped"));else{R.setQueryData(["logs",h],{pages:[],pageParams:[]});const e={categories:o.getFieldValue("categories"),level:o.getFieldValue("level"),keyword:o.getFieldValue("keyword"),traceID:o.getFieldValue("traceID"),token:N?.token},t=Object.entries(e).filter(([a,l])=>l!==void 0).reduce((a,[l,f])=>(a[l]=f,a),{}),n=new EventSource(`${N?.addr}/om/log/monitor?${new URLSearchParams(t).toString()}`);n.onmessage=a=>{if(a.data==="monitoring started")r.success(i("sys.log.monitorStarted"));else if(a.data==="monitoring stopped")r.success(i("sys.log.monitorStopped")),n.close();else{const l=JSON.parse(a.data);R.setQueryData(["logs",h],f=>{const ie=f?.pages||[],V=[l,...ie.flat()];return V.length>W&&V.splice(W),{pages:[V],pageParams:[]}})}},n.onerror=()=>{n.close(),P(!1),r.error(i("sys.log.monitorFailed")),D(!1)},T(n),P(!0),x(!1),D(!0)}},$=(e,t)=>{t.stopPropagation();const n=o.getFieldValue("timeRange");o.setFieldsValue({categories:[],level:"",keyword:"",traceID:e,timeRange:n}),C(a=>a?{...a,categories:[],level:"",keyword:"",traceID:e}:null),O()},oe=()=>{o.resetFields(),o.setFieldsValue({startTime:c().startOf("day"),timeRange:[c().startOf("day"),c()]})},O=async()=>{if(!g&&!p)try{const{timeRange:e,...t}=o.getFieldsValue();await R.resetQueries({queryKey:["logs",t]}),C(t)}catch{x(!1)}},z=e=>{e.key==="Enter"&&O()},A=(e,t)=>{t.stopPropagation();const n=c(e).format("YYYY-MM-DD HH:mm:ss"),a=o.getFieldValue("startTime"),l=o.getFieldValue("endTime");a?l?o.setFieldsValue({timeRange:[c(a),c(n)],endTime:n}):o.setFieldsValue({timeRange:[c(a),c(n)],endTime:n}):o.setFieldsValue({timeRange:[c(n),l?c(l):null],startTime:n})};return s.jsxs(_,{children:[s.jsxs(Y,{direction:"vertical",size:"small",className:"w-full",children:[s.jsx(G,{children:s.jsxs(y,{form:o,onFinish:O,children:[s.jsxs(he,{gutter:[16,16],style:{fontSize:"12px",lineHeight:"16px"},children:[s.jsx(j,{span:24,lg:6,children:s.jsx(y.Item,{label:i("sys.log.category"),name:"categories",className:"!mb-0",children:s.jsx(S,{mode:"multiple",allowClear:!0,disabled:b,children:se.map(e=>s.jsx(S.Option,{value:e,children:e},e))})})}),s.jsx(j,{span:24,lg:6,children:s.jsx(y.Item,{label:i("sys.log.level"),name:"level",className:"!mb-0",children:s.jsx(S,{allowClear:!0,disabled:b,children:m.map(e=>s.jsx(S.Option,{value:e,children:s.jsx(fe,{color:e==="error"||e==="fatal"||e==="dpanic"?"error":e==="warn"?"warning":"success",children:e})},e))})})}),s.jsx(j,{span:24,lg:6,children:s.jsx(y.Item,{label:i("sys.log.keyword"),name:"keyword",className:"!mb-0",children:s.jsx(M,{placeholder:i("sys.log.keywordPlaceholder"),allowClear:!0,onKeyPress:z,disabled:b})})}),s.jsx(j,{span:24,lg:6,children:s.jsx(y.Item,{label:i("sys.log.traceID"),name:"traceID",className:"!mb-0",children:s.jsx(M,{placeholder:i("sys.log.traceIDPlaceholder"),allowClear:!0,onKeyPress:z,disabled:b})})}),s.jsx(j,{span:24,lg:12,children:s.jsx(y.Item,{label:i("sys.log.timeRange"),name:"timeRange",className:"!mb-0",children:s.jsx(ye.RangePicker,{showTime:!0,style:{width:"100%"},disabled:b,disabledDate:e=>e&&e>c().endOf("day"),onChange:e=>{e?o.setFieldsValue({startTime:e[0]?.format("YYYY-MM-DD HH:mm:ss"),endTime:e[1]?.format("YYYY-MM-DD HH:mm:ss")}):o.setFieldsValue({startTime:void 0,endTime:void 0})}})})}),s.jsx(j,{span:24,children:s.jsxs("div",{className:"flex justify-end",children:[s.jsx(k,{onClick:oe,children:i("sys.log.reset")}),s.jsx(k,{type:"primary",className:"ml-4",htmlType:"submit",loading:p,disabled:g,children:i("sys.log.search")}),s.jsx(k,{type:"primary",className:"ml-4",onClick:ae,children:i(g?"sys.log.stopMonitor":"sys.log.startMonitor")})]})})]}),s.jsx(y.Item,{name:"startTime",hidden:!0,children:s.jsx(M,{})}),s.jsx(y.Item,{name:"endTime",hidden:!0,children:s.jsx(M,{})})]})}),s.jsxs(G,{children:[s.jsx(X,{dataSource:re,keyword:h?.keyword,onTraceIDClick:$,onLineNumberClick:I,onFileClick:Q,onTimeClick:A}),s.jsx("div",{ref:w,style:{height:20}})]})]}),s.jsx(J,{title:i("sys.log.contextLog"),open:Z,onCancel:()=>H(!1),footer:s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"8px"},children:[s.jsx(k,{onClick:e=>{d&&d.length>0&&I(d[0].path,d[0].line,e)},disabled:!d||d.length===0,children:s.jsxs(Y,{children:[s.jsx(pe,{}),i("sys.log.prevPage")]})}),s.jsx(k,{onClick:e=>{if(d&&d.length>0){const t=d[d.length-1];I(t.path,t.line,e)}},disabled:!d||d.length===0,children:s.jsxs(Y,{children:[i("sys.log.nextPage"),s.jsx(xe,{})]})})]}),width:1e3,styles:{body:{height:"70vh",padding:"24px",overflow:"hidden"},content:{height:"100%"}},children:s.jsx("div",{style:{height:"100%",overflow:"auto"},children:s.jsx(X,{dataSource:d,keyword:h?.keyword,onTraceIDClick:$,onLineNumberClick:I,onFileClick:Q,onTimeClick:A})})})]})}export{Se as default};

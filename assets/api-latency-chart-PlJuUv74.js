import{u as W,t as r,j as a}from"./index-DBJ8dyql.js";import{s as Y,A as Z}from"./api-sample-modal-CfylE9qr.js";import{C as ee}from"./index-DTLun4oy.js";import{u as te,C as se}from"./useChart-D1qVDBM-.js";import{z as d,T as ae,s as S,M as re,t as q,I as oe,ac as ne,G as le,ad as ce}from"./vendor-ui-Dp3kvFmo.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import"./vendor-utils-DKy5dUqm.js";import"./vendor-charts-C0vSEv4L.js";const ie=[{value:"5m",label:"Last 5m"},{value:"10m",label:"Last 10m"},{value:"30m",label:"Last 30m"},{value:"hour",label:"Last Hour"},{value:"day",label:"Last Day"},{value:"week",label:"Last Week"},{value:"month",label:"Last Month"}];function ue(x="hour",N=null){const{t:n}=W(),[b,m]=o.useState(x),[i,k]=o.useState(N),P=o.useCallback(p=>{if(i?.[0]&&i?.[1]){const f=Math.floor(i[0].valueOf()/1e3),M=Math.floor(i[1].valueOf()/1e3),T=(M-f)/3600;let v;return T<=1?v="minute":T<=6?v="5m":T<=48?v="hour":v="day",{start:f,end:M,apiUnit:v}}const u=Math.floor(Date.now()/1e3);let h,y;switch(p){case"5m":h=u-300,y="minute";break;case"10m":h=u-600,y="minute";break;case"30m":h=u-1800,y="5m";break;case"hour":h=u-3600,y="5m";break;case"day":h=u-86400,y="hour";break;case"week":h=u-604800,y="day";break;case"month":h=u-2592e3,y="day";break;default:h=u-86400,y="hour"}return{start:h,end:u,apiUnit:y}},[i]),O=o.useMemo(()=>[...ie.map(p=>({...p,label:n(`sys.workbench.time.${p.value}`,p.label)})),...i?[{value:"custom",label:n("sys.workbench.time.custom","Custom")}]:[]],[n,i]),g=o.useMemo(()=>{switch(b){case"5m":case"10m":case"30m":case"hour":return"HH:mm";case"day":return"MM-dd HH:mm";case"week":case"month":return"yyyy-MM-dd";default:return"yyyy-MM-dd HH:mm"}},[b]);return{timeUnit:b,setTimeUnit:m,timeRange:i,setTimeRange:k,getRange:P,dateLabelFormat:g,renderTimePicker:p=>a.jsxs("div",{className:"flex items-center gap-1 bg-neutral-100 dark:bg-neutral-800 p-0.5 rounded-lg border border-neutral-200 dark:border-neutral-700",style:{background:r.colors.background.neutral},children:[a.jsx(q,{size:"small",variant:"borderless",value:i?"custom":b,onChange:u=>{u!=="custom"&&(m(u),k(null),p?.())},style:{width:110},options:O}),a.jsx("span",{className:"w-[1px] h-4 bg-neutral-300 dark:bg-neutral-600 mx-1"}),a.jsx(ce.RangePicker,{size:"small",variant:"borderless",value:i,onChange:u=>{k(u),p?.()},showTime:{format:"HH:mm"},format:"YYYY-MM-DD HH:mm",allowClear:!0,placeholder:[n("sys.workbench.startTime","Start"),n("sys.workbench.endTime","End")],style:{width:280},presets:[{label:n("sys.workbench.time.5m","Last 5m"),value:[d().subtract(5,"minute"),d()]},{label:n("sys.workbench.time.10m","Last 10m"),value:[d().subtract(10,"minute"),d()]},{label:n("sys.workbench.time.30m","Last 30m"),value:[d().subtract(30,"minute"),d()]},{label:n("sys.workbench.time.hour","Last Hour"),value:[d().subtract(1,"hour"),d()]},{label:n("sys.workbench.time.day","Last Day"),value:[d().subtract(1,"day"),d()]},{label:n("sys.workbench.time.week","Last Week"),value:[d().subtract(1,"week"),d()]},{label:n("sys.workbench.time.month","Last Month"),value:[d().subtract(1,"month"),d()]}]})]})}}const E=["2xx","4xx","5xx"],V=x=>`${x} ms`;function ge({open:x,onClose:N,enabled:n=!0,defaultSort:b="count"}){const{t:m}=W(),{timeUnit:i,getRange:k,dateLabelFormat:P,renderTimePicker:O}=ue("hour",[d().startOf("day"),d()]),[g,D]=o.useState([]),[p,u]=o.useState([]),[h,y]=o.useState(0),[f,M]=o.useState(E),[T,v]=o.useState(["GET","POST","PUT","DELETE"]),[H,R]=o.useState(""),[I,U]=o.useState(""),[l,A]=o.useState({columnKey:b,order:"descend"}),[C,j]=o.useState({current:1,pageSize:10}),[B,z]=o.useState({open:!1,method:"",uri:"",type:"slow"}),L=o.useCallback((e,t)=>{z({open:!0,method:e.method,uri:e.uri,type:t})},[]),K=o.useCallback(e=>{M(t=>t.includes(e)?t.filter(w=>w!==e):[...t,e]),j(t=>({...t,current:1}))},[]);o.useEffect(()=>{x&&(A({columnKey:b==="count"?"count":b,order:"descend"}),j(e=>({...e,current:1})),R(""),U(""))},[x,b]),o.useEffect(()=>{if(x&&n){const e=k(i);(async()=>{try{const c=(await Y.apiTimeRange(e.start,e.end,e.apiUnit,["count2xx","count4xx","count5xx"])).map(w=>({at:Number(w.at)*1e3,counts:{"2xx":w.value.count2xx||0,"4xx":w.value.count4xx||0,"5xx":w.value.count5xx||0}}));D(c)}catch{}})()}},[x,n,i,k]);const $=o.useCallback(async()=>{if(!x||!n)return;const e=k(i),t={count:"count",status2xx:"2xx",status4xx:"4xx",status5xx:"5xx",avgLatency:"avg",maxLatency:"max",successRate:"success"};try{const s=await Y.apiTop({start:e.start,end:e.end,page:C.current,size:C.pageSize,statuses:f,methods:T,uriLike:H.trim(),sortBy:t[l.columnKey]||"avg",asc:l.order==="ascend"});u(s.items),y(s.total)}catch{}},[x,n,i,C.current,C.pageSize,l,f,T,H,k]);o.useEffect(()=>{$()},[$]);const J=o.useMemo(()=>g.length?E.map(e=>{const t=f.includes(e);return{name:e,data:g.map(s=>({x:s.at,y:t?s.counts[e]:null}))}}):[],[g,f]),F=o.useMemo(()=>[r.colors.palette.success.dark,r.colors.palette.warning.dark,r.colors.palette.error.dark],[]),_=o.useMemo(()=>({GET:r.colors.palette.primary.dark,POST:r.colors.palette.success.dark,PUT:r.colors.palette.warning.dark,DELETE:r.colors.palette.error.dark}),[]),Q=te({colors:F,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:P}},yaxis:{labels:{formatter:e=>`${e}`},min:0},tooltip:{x:{formatter:e=>{switch(i){case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e} req`}},chart:{toolbar:{show:!1},events:{legendClick:(e,t)=>(t!==void 0&&K(E[t]),!1)}},stroke:{width:2,curve:"smooth"}}),X=o.useMemo(()=>[{title:m("sys.workbench.apiColMethod","Method"),dataIndex:"method",key:"method",width:80,render:e=>a.jsx(ae,{color:_[e]||r.colors.palette.primary.default,children:e})},{title:"URL",dataIndex:"uri",key:"uri",ellipsis:!0},{title:m("sys.workbench.apiColTotal","Total"),dataIndex:"count",key:"count",sorter:!0,sortOrder:l.columnKey==="count"?l.order:void 0,width:90,align:"right"},{title:"2xx",dataIndex:"count2xx",key:"status2xx",sorter:!0,sortOrder:l.columnKey==="status2xx"?l.order:void 0,width:70,align:"right",render:(e,t)=>a.jsx(S.Link,{disabled:e===0,onClick:s=>{s.stopPropagation(),e>0&&L(t,"2xx")},style:{color:e>0?r.colors.palette.success.dark:r.colors.text.secondary},children:e})},{title:m("sys.workbench.apiColSuccessRate","Success"),key:"successRate",width:90,align:"right",render:(e,t)=>{const s=t.successRate*100,c=s>=99?"success":s>=95?"warning":"error";return a.jsxs(S.Text,{strong:!0,style:{color:r.colors.palette[c].dark},children:[s.toFixed(1),"%"]})},sorter:!0,sortOrder:l.columnKey==="successRate"?l.order:void 0},{title:"4xx",dataIndex:"count4xx",key:"status4xx",sorter:!0,sortOrder:l.columnKey==="status4xx"?l.order:void 0,width:70,align:"right",render:(e,t)=>a.jsx(S.Link,{disabled:e===0,onClick:s=>{s.stopPropagation(),e>0&&L(t,"4xx")},style:{color:e>0?r.colors.palette.warning.dark:r.colors.text.secondary},children:e})},{title:"5xx",dataIndex:"count5xx",key:"status5xx",sorter:!0,sortOrder:l.columnKey==="status5xx"?l.order:void 0,width:70,align:"right",render:(e,t)=>a.jsx(S.Link,{strong:e>0,disabled:e===0,onClick:s=>{s.stopPropagation(),e>0&&L(t,"5xx")},style:{color:e>0?r.colors.palette.error.dark:r.colors.text.secondary},children:e})},{title:m("sys.workbench.apiColAvg","Avg"),dataIndex:"avgLatency",key:"avgLatency",sorter:!0,sortOrder:l.columnKey==="avgLatency"?l.order:void 0,width:90,render:e=>{const t=Math.round(e),s=t>500?r.colors.palette.error.dark:t>200?r.colors.palette.warning.dark:void 0;return a.jsx(S.Text,{style:{color:s},children:V(t)})}},{title:m("sys.workbench.apiColMax","Max"),dataIndex:"maxLatency",key:"maxLatency",sorter:!0,sortOrder:l.columnKey==="maxLatency"?l.order:void 0,width:90,render:(e,t)=>{const s=Math.round(e),c=s>500?r.colors.palette.error.dark:s>200?r.colors.palette.warning.dark:void 0;return a.jsx(S.Link,{style:{color:c},onClick:w=>{w.stopPropagation(),L(t,"slow")},children:V(s)})}}],[m,l,_,L]),G=o.useMemo(()=>{if(!g.length)return{total:0,ok:0,err4:0,err5:0};let e=0,t=0,s=0;for(const c of g)e+=c.counts["2xx"],t+=c.counts["4xx"],s+=c.counts["5xx"];return{total:e+t+s,ok:e,err4:t,err5:s}},[g]);return a.jsxs(re,{title:m("sys.workbench.apiTrendTitle","API Response Trend"),open:x&&n,onCancel:N,width:960,footer:null,style:{top:"6%"},styles:{body:{padding:0}},maskClosable:!0,destroyOnClose:!0,children:[a.jsxs(ee,{className:"flex-col !shadow-none",children:[a.jsxs("header",{className:"flex w-full justify-between items-center gap-4",children:[a.jsxs("div",{className:"flex gap-4 items-center flex-wrap",children:[a.jsx("div",{className:"flex gap-2 items-center",children:E.map((e,t)=>{const s=f.includes(e),c=F[t];return a.jsxs("div",{onClick:()=>K(e),className:"flex items-center h-7 px-2.5 rounded-full border transition-all cursor-pointer hover:opacity-80 active:scale-95 select-none",style:{borderColor:s?c:r.colors.common.border,background:s?`${c}15`:r.colors.background.neutral,boxShadow:s?`0 2px 4px ${c}20`:"none"},children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full mr-2",style:{background:c,boxShadow:`0 0 4px ${c}`}}),a.jsx("span",{className:"text-xs font-medium mr-1.5",style:{color:r.colors.text.secondary},children:e}),a.jsx("span",{className:"text-sm font-bold",style:{color:s?c:r.colors.text.primary},children:G[e==="2xx"?"ok":e==="4xx"?"err4":"err5"]})]},e)})}),a.jsxs("div",{className:"flex items-center h-7 px-3 rounded-md bg-neutral-100 dark:bg-neutral-800 border border-transparent",style:{background:r.colors.background.neutral},children:[a.jsx(S.Text,{type:"secondary",style:{fontSize:"12px"},children:m("sys.workbench.apiTotalCount","Total")}),a.jsx("span",{className:"mx-1.5 h-3 w-[1px] bg-neutral-300 dark:bg-neutral-700"}),a.jsx("span",{className:"text-sm font-bold",style:{color:r.colors.text.primary},children:G.total})]})]}),O()]}),a.jsxs("main",{className:"w-full flex flex-col gap-4 mt-4",children:[a.jsx("div",{className:"w-full",children:a.jsx(se,{type:"area",series:J,options:Q,height:360})}),a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2 px-1",children:[a.jsxs("div",{className:"flex flex-col",children:[a.jsx("span",{className:"text-base font-medium",style:{color:r.colors.text.primary},children:m("sys.workbench.apiRankingTitle","Endpoint latency ranking")}),a.jsx("span",{className:"text-xs",style:{color:r.colors.text.secondary},children:m("sys.workbench.apiRankingDesc","Sortable by status counts and latency columns.")})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx(q,{mode:"multiple",placeholder:"Method",value:T,onChange:e=>{v(e),j(t=>({...t,current:1}))},style:{width:220},maxTagCount:"responsive",size:"small",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"PUT",value:"PUT"},{label:"DELETE",value:"DELETE"},{label:"PATCH",value:"PATCH"},{label:"OPTIONS",value:"OPTIONS"},{label:"HEAD",value:"HEAD"}]}),a.jsx(oe,{placeholder:"Search URL...",size:"small",allowClear:!0,prefix:a.jsx(ne,{style:{color:r.colors.text.disabled}}),value:I,onChange:e=>{const t=e.target.value;U(t),t===""&&(R(""),j(s=>({...s,current:1})))},onPressEnter:()=>{R(I),j(e=>({...e,current:1}))},style:{width:180}})]})]}),a.jsx(le,{rowKey:e=>`${e.method}-${e.uri}`,dataSource:p,size:"small",onRow:e=>({onClick:()=>L(e,"latest"),className:"cursor-pointer"}),pagination:{current:C.current,pageSize:C.pageSize,total:h,showSizeChanger:!1,onChange:e=>j(t=>({...t,current:e}))},columns:X,onChange:(e,t,s)=>{!Array.isArray(s)&&s.columnKey&&A({columnKey:s.columnKey,order:s.order||"descend"})}})]})]})]}),a.jsx(Z,{...B,onClose:()=>z(e=>({...e,open:!1}))})]})}export{ie as TIME_OPTIONS,ge as default,ue as useTimeRange};

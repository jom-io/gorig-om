import{u as le,F as ue,G as fe,j as f,I as X,b as ee}from"./index-__veNQ-R.js";import{a as me}from"./vendor-utils-DG9TG-F2.js";import{r as c}from"./vendor-core-Cler3e7Q.js";import{T as _,H as te,af as he,C as ye,ag as se,G as pe,M as ge,I as xe,i as re,E as C,s as Ie}from"./vendor-ui-Bdifwvp0.js";const ve="https://ssl-checker.zoel-du.workers.dev/?host=";async function ae(s){const v=`${ve}${s}`,{data:I}=await me.get(v,{timeout:1e4}),l=I?.result??{};if(I?.status!=="ok"||l?.response==="failed"||l?.status==="error"){const F=l?.reason||l?.message||"Certificate fetch failed";throw new Error(F)}return l}const w="certificateCache",{Text:we}=Ie,ne=s=>{const v=Number(s);return Number.isFinite(v)?v:void 0};function Se(s){try{return new URL(s).hostname}catch{return null}}function x(s){return Array.isArray(s)?s:[]}function be(){const{t:s}=le(),v=ue(),I=fe(e=>e.setStats),[l,L]=c.useState([]),[F,T]=c.useState([]),[H,J]=c.useState(!1),[Fe,z]=c.useState(null),[Z,D]=c.useState({current:1,pageSize:10}),P=c.useRef(s("sys.certificate.fetchFailed")),r=c.useRef(null),[j,ie]=c.useState(!1),B=c.useRef(!1),[R,M]=c.useState(!1),[G,Y]=c.useState(""),[U,q]=c.useState(!1),K=c.useRef(null),S=c.useCallback(e=>{let t=0,d=0;return e.forEach(n=>{if(n.valid===!1){t+=1;return}n.valid===!0&&typeof n.daysLeft=="number"&&(n.daysLeft<0?t+=1:n.daysLeft<=7&&(d+=1))}),{expired:t,expiring:d}},[]);c.useEffect(()=>{P.current=s("sys.certificate.fetchFailed")},[s]),c.useEffect(()=>{try{const e=localStorage.getItem(w);if(e){const t=JSON.parse(e);if(r.current=t,t.domains&&L(x(t.domains)),t.results){const n=[...x(t.results)].sort((a,u)=>{const y=typeof a.daysLeft=="number"?a.daysLeft:Number.POSITIVE_INFINITY,i=typeof u.daysLeft=="number"?u.daysLeft:Number.POSITIVE_INFINITY;return y-i});T(n);const h=S(n);I({expiring:h.expiring,expired:h.expired,lastChecked:t.lastFetched?new Date(t.lastFetched).getTime():Date.now()})}t.lastFetched&&z(new Date(t.lastFetched))}}catch{}finally{ie(!0)}},[]),c.useEffect(()=>{if(B.current||!j||x(r.current?.domains).length>0||r.current?.seededFromServers||l.length>0)return;const e=v.map(n=>Se(n.addr)).filter(Boolean);if(e.length===0)return;const d=Array.from(new Set(e)).map(n=>({host:n,source:"server",createdAt:Date.now()}));L(d),r.current={domains:d,seededFromServers:!0},localStorage.setItem(w,JSON.stringify({domains:d,lastFetched:r.current?.lastFetched,results:r.current?.results,seededFromServers:!0})),B.current=!0},[v,l.length,j]);const A=c.useCallback(e=>x(e).map(t=>({key:`${t.host}-${t.source}`,name:t.host,addr:t.host,host:t.host})),[]),O=c.useMemo(()=>A(l),[l,A]),b=c.useCallback(e=>{const t={domains:x(l),lastFetched:e.lastFetched??r.current?.lastFetched,results:e.results??x(r.current?.results),seededFromServers:e.seededFromServers??r.current?.seededFromServers??!1};r.current=t,localStorage.setItem(w,JSON.stringify(t))},[l]),k=c.useCallback(async e=>{const t=x(e??(l.length?l:r.current?.domains)),d=A(t);if(d.length===0){b({results:[],lastFetched:void 0});return}J(!0);try{const n=[],h=new Date().toLocaleString();for(const i of d)try{const o=await ae(i.host),m=typeof o.cert_valid=="boolean"?o.cert_valid:o.cert_exp===!1?!0:void 0;n.push({key:i.key,name:i.name,addr:i.addr,host:i.host,ip:o.resolved_ip,valid:m,daysLeft:ne(o.days_left??o.valid_days_to_expire??o.validity_days),validFrom:o.valid_from,validTill:o.valid_till,vendor:o.issuer_o||o.issuer_cn,updatedAt:h})}catch(o){const m=typeof o=="string"?o:o?.message||P.current;n.push({key:i.key,name:i.name,addr:i.addr,host:i.host,error:m,daysLeft:void 0,updatedAt:h})}const a=[...n].sort((i,o)=>{const m=typeof i.daysLeft=="number"?i.daysLeft:Number.POSITIVE_INFINITY,N=typeof o.daysLeft=="number"?o.daysLeft:Number.POSITIVE_INFINITY;return m-N});T(a);const u=new Date;z(u);const y=S(n);I({expiring:y.expiring,expired:y.expired,lastChecked:u.getTime()}),b({results:n,lastFetched:u.toISOString()})}finally{J(!1)}},[l,A,b,S,I]);c.useEffect(()=>{if(!j)return;const e=r.current?.lastFetched?new Date(r.current.lastFetched).getTime():0,t=Date.now(),d=24*60*60*1e3;(l.length>0||x(r.current?.domains).length>0)&&(!e||t-e>d)&&k()},[j,l.length,k]),c.useEffect(()=>{if(O.length===0)return;const e=r.current,t=a=>{if(!a)return!1;const u=new Date;return a.getFullYear()===u.getFullYear()&&a.getMonth()===u.getMonth()&&a.getDate()===u.getDate()},d=(e?.domains||[]).map(a=>a.host).sort().join(","),n=l.map(a=>a.host).sort().join(","),h=d===n;if(e?.results&&e.lastFetched&&t(new Date(e.lastFetched))&&h){const a=[...e.results].sort((y,i)=>{const o=typeof y.daysLeft=="number"?y.daysLeft:Number.POSITIVE_INFINITY,m=typeof i.daysLeft=="number"?i.daysLeft:Number.POSITIVE_INFINITY;return o-m});T(a),z(new Date(e.lastFetched));const u=S(e.results);I({expiring:u.expiring,expired:u.expired,lastChecked:new Date(e.lastFetched).getTime()});return}k()},[O.length,l,k]);const Q=async(e,t="server",d=!1,n=!1)=>{const h=new Date().toLocaleString();try{const a=await ae(e),u=typeof a.cert_valid=="boolean"?a.cert_valid:a.cert_exp===!1?!0:void 0,y={key:`${e}-${t}`,name:e,addr:e,host:e,ip:a.resolved_ip,valid:u,daysLeft:ne(a.days_left??a.valid_days_to_expire??a.validity_days),validFrom:a.valid_from,validTill:a.valid_till,vendor:a.issuer_o||a.issuer_cn,updatedAt:h};return T(i=>{const m=[...i.filter(p=>p.host!==e),y],N=S(m);I({expiring:N.expiring,expired:N.expired,lastChecked:Date.now()});const E=[...m].sort((p,g)=>{const V=typeof p.daysLeft=="number"?p.daysLeft:Number.POSITIVE_INFINITY,$=typeof g.daysLeft=="number"?g.daysLeft:Number.POSITIVE_INFINITY;return V-$});if(d){const p=E.findIndex(g=>g.host===e);p>=0&&D(g=>({...g,current:Math.floor(p/g.pageSize)+1}))}return E}),b({results:[...r.current?.results?x(r.current?.results).filter(i=>i.host!==e):[],y],lastFetched:r.current?.lastFetched}),!0}catch(a){const u=typeof a=="string"?a:a?.message||P.current;if(C.error(u),n){const i=l.filter(m=>m.host!==e);L(i);const o={domains:x(i),lastFetched:r.current?.lastFetched,results:x(r.current?.results).filter(m=>m.host!==e),seededFromServers:r.current?.seededFromServers??!0};return r.current=o,localStorage.setItem(w,JSON.stringify(o)),!1}const y={key:`${e}-${t}`,name:e,addr:e,host:e,error:u,daysLeft:void 0,updatedAt:h};return T(i=>{const m=[...i.filter(p=>p.host!==e),y],N=S(m);I({expiring:N.expiring,expired:N.expired,lastChecked:Date.now()});const E=[...m].sort((p,g)=>{const V=typeof p.daysLeft=="number"?p.daysLeft:Number.POSITIVE_INFINITY,$=typeof g.daysLeft=="number"?g.daysLeft:Number.POSITIVE_INFINITY;return V-$});if(d){const p=E.findIndex(g=>g.host===e);p>=0&&D(g=>({...g,current:Math.floor(p/g.pageSize)+1}))}return E}),b({results:[...r.current?.results?x(r.current?.results).filter(i=>i.host!==e):[],y],lastFetched:r.current?.lastFetched}),!1}};c.useEffect(()=>{const e=S(F);I({expiring:e.expiring,expired:e.expired,lastChecked:Date.now()})},[F,S,I]),c.useEffect(()=>{D(e=>{const t=Math.max(1,Math.ceil(F.length/e.pageSize)),d=Math.min(e.current,t);return{...e,current:d}})},[F.length]);const oe=()=>{M(!0),Y("")};c.useEffect(()=>{R&&setTimeout(()=>K.current?.focus(),50)},[R]);const W=async()=>{const e=G.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!e){C.error(s("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(e)){C.error(s("sys.certificate.domainInvalid"));return}if(l.some(h=>h.host.toLowerCase()===e.toLowerCase())){C.warning(s("sys.certificate.domainExists"));return}const n=[...l,{host:e,source:"custom",createdAt:Date.now()}];L(n),r.current={...r.current,domains:n,seededFromServers:r.current?.seededFromServers??!0},localStorage.setItem(w,JSON.stringify({domains:n,lastFetched:r.current?.lastFetched,results:r.current?.results,seededFromServers:r.current?.seededFromServers??!0})),q(!0);try{await Q(e,"custom",!0,!0)&&(C.success(s("sys.api.operationSuccess")),M(!1),Y(""))}finally{q(!1)}},ce=e=>{const t=l.filter(n=>n.host!==e);L(t);const d={domains:x(t),lastFetched:r.current?.lastFetched,results:x(r.current?.results).filter(n=>n.host!==e),seededFromServers:r.current?.seededFromServers??!0};r.current=d,localStorage.setItem(w,JSON.stringify(d)),T(n=>{const h=n.filter(u=>u.host!==e),a=S(h);return I({expiring:a.expiring,expired:a.expired,lastChecked:Date.now()}),[...h].sort((u,y)=>{const i=typeof u.daysLeft=="number"?u.daysLeft:Number.POSITIVE_INFINITY,o=typeof y.daysLeft=="number"?y.daysLeft:Number.POSITIVE_INFINITY;return i-o})})},de=[{title:f.jsx("div",{className:"pl-4 text-left",children:s("sys.certificate.api")}),dataIndex:"addr",key:"addr",align:"left",render:(e,t)=>f.jsx("div",{className:"max-w-[220px] truncate pl-4 md:max-w-none md:whitespace-nowrap",children:t.addr})},{title:s("sys.certificate.ip"),dataIndex:"ip",key:"ip",align:"center",render:(e,t)=>t.error?"-":t.ip||"-"},{title:s("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",align:"center",render:(e,t)=>t.error?"-":t.vendor||"-"},{title:s("sys.certificate.daysLeft"),dataIndex:"daysLeft",key:"daysLeft",width:110,align:"center",render:(e,t)=>{if(t.error||typeof t.daysLeft!="number")return"-";const d=t.daysLeft<=7?"error":"default";return f.jsx(_,{color:d,className:"!px-3 !py-1 text-base leading-6",children:f.jsx("span",{className:"text-lg font-medium",children:t.daysLeft})})}},{title:s("sys.certificate.valid"),dataIndex:"valid",key:"valid",width:110,align:"center",className:"!whitespace-nowrap",render:(e,t)=>t.error?f.jsx(_,{color:"default",children:s("sys.certificate.unknown")}):t.valid===void 0?f.jsx(_,{color:"default",children:s("sys.certificate.unknown")}):t.valid===!1?f.jsx(_,{color:"error",children:s("sys.certificate.invalidTag")}):typeof t.daysLeft=="number"&&t.daysLeft<=7?f.jsx(_,{color:"gold",children:s("sys.certificate.expiring")}):f.jsx(_,{color:"success",children:s("sys.certificate.validTag")})},{title:s("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",align:"center",render:(e,t)=>t.error?"-":t.validFrom||"-"},{title:s("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",align:"center",render:(e,t)=>t.error?"-":t.validTill||"-"},{title:s("sys.certificate.remark"),dataIndex:"error",key:"error",align:"center",render:(e,t)=>t.updatedAt||"-"},{title:s("sys.certificate.operation"),key:"operation",align:"center",render:(e,t)=>f.jsxs(te,{size:"small",className:"text-gray-500",children:[f.jsx(X,{size:"small",onClick:()=>void Q(t.host),children:f.jsx(ee,{icon:"solar:refresh-bold-duotone",size:16})}),f.jsx(he,{title:s("sys.certificate.deleteConfirm"),onConfirm:()=>ce(t.host),children:f.jsx(X,{size:"small",children:f.jsx(ee,{icon:"solar:trash-bin-trash-bold-duotone",size:16})})})]})}];return f.jsxs(ye,{title:s("sys.certificate.title"),styles:{body:{padding:0}},extra:f.jsxs(te,{size:"middle",children:[f.jsx(re,{type:"primary",onClick:oe,children:s("sys.certificate.addDomain")}),f.jsx(re,{onClick:()=>void k(),loading:H,disabled:O.length===0,children:s("sys.certificate.refreshAll")})]}),children:[O.length===0?f.jsx(se,{image:se.PRESENTED_IMAGE_SIMPLE,description:s("sys.certificate.noServer")}):f.jsx(pe,{rowKey:"key",loading:H,columns:de,dataSource:F,pagination:{current:Z.current,pageSize:Z.pageSize,total:F.length,showSizeChanger:!1,onChange:e=>D(t=>({...t,current:e}))},scroll:{x:"max-content"},size:"small",className:"w-full"}),f.jsx(ge,{title:s("sys.certificate.addDomain"),open:R,onOk:W,onCancel:()=>M(!1),okText:s("sys.certificate.confirm"),cancelText:s("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},confirmLoading:U,children:f.jsx(xe,{addonBefore:"https://",placeholder:s("sys.certificate.domainPlaceholder"),value:G,onChange:e=>Y(e.target.value),onPressEnter:W,allowClear:!0,ref:K,disabled:U})})]})}export{be as default};

import{c as i,d as R,u as oe,a as le,j as s}from"./index-D8jLLxGe.js";import{r as a}from"./vendor-core-Cler3e7Q.js";import{J as G,s as ie,K as m,N as L,i as y,O as pe,I as de,t as he,P as ye,h as ue,Q as ge,E as p}from"./vendor-ui-BgnAtmuh.js";const fe=()=>i.get({url:"/om/deploy/git/check"}),xe=()=>i.post({url:"/om/deploy/git/install"}),me=()=>i.post({url:"/om/deploy/ssh/key"}),be=()=>i.get({url:"/om/deploy/ssh/key"}),je=o=>i.get({url:"/om/deploy/branches",params:{repoUrl:o}}),Se=o=>i.post({url:"/om/deploy/task/config",data:o}),ke=()=>i.get({url:"/om/deploy/task/config"}),Ce=()=>i.post({url:"/om/deploy/task/start"}),ve=(o,K)=>i.get({url:"/om/deploy/task/page",params:{page:o,size:K}}),Te=o=>i.get({url:"/om/deploy/task/get",params:{id:o}}),we=o=>i.post({url:"/om/deploy/task/rollback",params:{id:o}}),Ke=R(fe,200),Ne=R(be,200),Ie=R(ke,200),d={checkGitStatus:Ke,installGit:xe,generateSshKey:me,getSshKey:Ne,getBranches:je,saveTaskCfg:Se,getTaskCfg:Ie,startTask:Ce,pageTask:ve,getTask:Te,rollbackTask:we},{Text:h,Paragraph:Be}=ie,D=({onComplete:o,initialStep:K})=>{const{t}=oe(),u=le(),[c,S]=a.useState(K),[k,g]=a.useState(!1),[H,E]=a.useState(!1),[f,C]=a.useState(!1),[z,A]=a.useState(!1),[b,O]=a.useState(null),[j,P]=a.useState(null),[N,x]=a.useState([]),[r,l]=a.useState({gitInit:!1,sshKeyCopy:!1,repo:"",branch:"",autoTrigger:!1}),[M,F]=a.useState(!1),[J,Ge]=a.useState(!1),I=a.useRef(null),_=a.useRef(!1),B=a.useCallback(async()=>{try{const e=await d.checkGitStatus();return O(e),e}catch{return null}},[]),$=a.useCallback(async()=>{try{const e=await d.getSshKey();return P(e),e}catch{return null}},[]);a.useCallback(async()=>{try{return await d.getTaskCfg()}catch{return null}},[]),a.useEffect(()=>{c===0?B():c===1?$():c===3&&r.repo&&Q()},[c,r.repo,B,$]);const v=a.useCallback(async()=>{if(u)try{_.current=!0,g(!0);const e=await d.getTaskCfg();l({gitInit:e.gitInit,sshKeyCopy:e.sshKeyCopy,repo:e.repo,branch:e.branch,autoTrigger:e.autoTrigger});let n=0;e.gitInit&&(n=1,e.sshKeyCopy&&(n=2,e.repo&&(n=3,e.branch&&(n=4)))),S(n),I.current=u.addr}catch{}finally{_.current=!1,g(!1)}},[u]);a.useEffect(()=>{v()},[v]),a.useEffect(()=>{u&&I.current!==u.addr&&(I.current=null,v())},[u,v]);const Q=async()=>{if(r.repo)try{C(!0);const e=await d.getBranches(r.repo);x(e),!r.branch&&e.length>0&&l(n=>({...n,branch:e[0]}))}catch{x([])}finally{C(!1)}},W=async()=>{if(r.repo)try{C(!0);const e=await d.getBranches(r.repo);x(e),!r.branch&&e.length>0&&l(n=>({...n,branch:e[0]}))}catch{x([])}finally{C(!1)}},q=async e=>{l(n=>({...n,branch:e}))},U=async()=>{try{g(!0);const e=await d.installGit();if(e.error){p.error(e.error);return}O(e),l(n=>({...n,gitInit:!0})),p.success("Git 安装成功")}catch{}finally{g(!1)}},V=async()=>{try{g(!0);const e=await d.generateSshKey();P(e),l(n=>({...n,sshKeyCopy:!!e?.publicKey})),p.success("SSH Key 生成成功")}catch{}finally{g(!1)}},X=async()=>{if(!r.repo.startsWith("git@")){p.error(t("deploy.repo.invalidFormat"));return}try{A(!0);const e=await d.getBranches(r.repo);x(e),!r.branch&&e.length>0&&l(n=>({...n,branch:e[0]})),p.success(t("deploy.repo.checkSuccess"))}catch{x([]),l(n=>({...n,branch:""}))}finally{A(!1)}},Y=async()=>{if(!j?.publicKey){p.error(t("deploy.ssh.noKey"));return}try{await navigator.clipboard.writeText(j.publicKey),p.success(t("deploy.ssh.copySuccess"))}catch{p.error(t("deploy.ssh.copyFailed"))}},Z=e=>{if(T(e))S(e);else{const n=[];r.gitInit||n.push(t("deploy.steps.gitCheck")),r.sshKeyCopy||n.push(t("deploy.steps.sshConfig")),r.repo||n.push(t("deploy.steps.repoConfig")),r.branch||n.push(t("deploy.steps.branchSelect")),p.warning(t("deploy.navigation.missingSteps",{steps:n.join("、")}))}},ee=N.map(e=>({label:e,value:e})),se=async e=>{try{F(!0),l(n=>({...n,autoTrigger:e}))}catch{l(ce=>({...ce,autoTrigger:!e}))}finally{F(!1)}},T=e=>{switch(e){case 0:return!0;case 1:return r.gitInit;case 2:return r.gitInit&&r.sshKeyCopy;case 3:return r.gitInit&&r.sshKeyCopy&&r.repo;case 4:return r.gitInit&&r.sshKeyCopy&&r.repo&&r.branch;default:return!1}},w=[{title:t("deploy.steps.gitCheck"),content:s.jsxs("div",{className:"py-4",children:[k&&!b&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(G,{}),s.jsx(h,{children:t("deploy.git.checking")})]}),b?.error&&s.jsx(m,{message:t("deploy.git.installFailed"),description:b.error,type:"error",showIcon:!0,className:"mb-4"}),b?.installed?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{className:"text-success"}),s.jsx(h,{children:t("deploy.git.installed")}),s.jsxs(h,{type:"secondary",children:["(",b.version,")"]})]}):s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(y,{type:"primary",onClick:U,loading:k,children:t("deploy.git.install")}),s.jsx(y,{onClick:B,children:t("deploy.git.recheck")})]})]})},{title:t("deploy.steps.sshConfig"),content:s.jsxs("div",{className:"py-4",children:[k&&!j&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(G,{}),s.jsx(h,{children:t("deploy.ssh.checking")})]}),j?.publicKey?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{className:"text-success"}),s.jsx(h,{children:t("deploy.ssh.configured")})]}),s.jsxs("div",{className:"flex flex-col space-y-2 bg-gray-50 p-4 rounded",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(h,{strong:!0,children:t("deploy.ssh.publicKey")}),s.jsx(y,{type:"link",icon:s.jsx(pe,{}),onClick:Y,children:t("deploy.ssh.copy")})]}),s.jsx(Be,{className:"mb-0 break-all",children:s.jsx(h,{code:!0,children:j.publicKey})})]}),s.jsx(m,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.deployKeyTip"),type:"info",showIcon:!0})]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(y,{type:"primary",onClick:V,loading:k,children:t("deploy.ssh.generate")}),s.jsx(m,{message:t("deploy.ssh.nextStep"),description:t("deploy.ssh.generateTip"),type:"info",showIcon:!0})]})]})},{title:t("deploy.steps.repoConfig"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(de,{placeholder:t("deploy.repo.inputPlaceholder"),value:r.repo,onChange:e=>{l(n=>({...n,repo:e.target.value}))},style:{width:400}}),s.jsx(y,{onClick:X,loading:z,type:r.repo?"default":"primary",icon:r.repo?s.jsx(L,{}):null,children:r.repo?t("deploy.repo.recheck"):t("deploy.repo.check")})]}),s.jsx(m,{message:r.repo?t("deploy.repo.success"):t("deploy.repo.nextStep"),description:r.repo?t("deploy.repo.successTip"):t("deploy.repo.tip"),type:r.repo?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.branchSelect"),content:s.jsxs("div",{className:"py-4 space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(he,{showSearch:!0,style:{width:400},placeholder:t(f?"deploy.branch.loading":"deploy.branch.selectPlaceholder"),options:ee,value:r.branch,onChange:q,loading:f,disabled:f,filterOption:(e,n)=>(n?.label??"").toLowerCase().includes(e.toLowerCase())}),s.jsx(y,{icon:s.jsx(ye,{spin:f}),onClick:W,disabled:!r.repo,loading:f,children:t("deploy.branch.refresh")})]}),!N.length&&!f&&!r.branch&&s.jsx(m,{message:t("deploy.branch.noBranches"),description:t("deploy.branch.noBranchesTip"),type:"warning",showIcon:!0}),(N.length>0||r.branch)&&s.jsx(m,{message:t("deploy.branch.nextStep"),description:r.branch?t("deploy.branch.currentBranch",{branch:r.branch}):t("deploy.branch.selectTip"),type:r.branch?"success":"info",showIcon:!0})]})},{title:t("deploy.steps.autoTrigger"),content:s.jsx("div",{className:"py-4 space-y-4",children:J?s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(G,{}),s.jsx(h,{children:t("deploy.autoTrigger.loading")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(ue,{checked:r.autoTrigger,onChange:se,loading:M}),s.jsx(h,{children:t("deploy.autoTrigger.enable")})]}),s.jsx(h,{type:"secondary",children:t("deploy.autoTrigger.tip")})]})})}],te=()=>{T(c+1)&&S(c+1)},re=()=>{c>0&&S(c-1)},ne=w.map((e,n)=>({key:e.title,title:e.title,disabled:!T(n)})),ae=async()=>{try{E(!0),await d.saveTaskCfg(r),o(r),p.success(t("sys.cicd.saveSuccess"))}catch{}finally{E(!1)}};return s.jsxs("div",{className:"min-h-[260px] flex flex-col",children:[s.jsx(ge,{current:c,items:ne,className:"px-6",onChange:Z}),s.jsx("div",{className:"flex-1 mt-4 px-6",children:w[c].content}),s.jsxs("div",{className:"flex justify-end mt-4 pt-4 px-6 border-t",children:[c>0&&s.jsx(y,{style:{margin:"0 8px"},onClick:re,children:t("deploy.navigation.prev")}),c<w.length-1&&s.jsx(y,{type:"primary",onClick:te,disabled:!T(c+1),children:t("deploy.navigation.next")}),c===w.length-1&&s.jsx(y,{type:"primary",onClick:ae,loading:H,children:t("sys.cicd.save")})]})]})},Ae=Object.freeze(Object.defineProperty({__proto__:null,DeploySteps:D,default:D},Symbol.toStringTag,{value:"Module"}));export{D,Ae as a,d};

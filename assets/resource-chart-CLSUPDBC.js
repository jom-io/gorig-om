import{d as D,c as v,u as L,j as h}from"./index-Cr9X0c_l.js";import{C as R}from"./index-Cs5ZFJds.js";import{u as $,C as E}from"./useChart-DiyEozAU.js";import{r as p}from"./vendor-core-Cler3e7Q.js";import{M as N,q as P,t as z}from"./vendor-ui-Bdifwvp0.js";const S=(r,l)=>v.get({url:"/om/host/usage",params:{page:r,size:l}}),A=(r,l,c,a)=>v.get({url:"/om/host/usage/time",params:{start:r,end:l,unit:c,filter:a},paramsSerializer:{serialize:u=>{const y=new URLSearchParams;for(const[d,f]of Object.entries(u))if(Array.isArray(f))for(const o of f)y.append(d,o);else y.append(d,String(f));return y.toString()}}}),O=D(S,200),_=D(A,200);let k=null,g=null,C=0;const F=200;function K(r,l){const c=Date.now();return k&&c-C<F?Promise.resolve(k):g||(g=S(r,l).then(a=>(k=a,C=Date.now(),g=null,a)),g)}const I={usage:O,getCachedUsage:K,usageTimeRange:_};function q({open:r,onClose:l,resourceType:c}){const{t:a}=L(),[u,y]=p.useState("hour"),[d,f]=p.useState([]),[o,w]=p.useState(c);p.useEffect(()=>{w(c)},[c]);const b=p.useCallback(async e=>{try{const n=Math.floor(Date.now()/1e3);let s;const x=n;let t;switch(e){case"hour":s=n-3600,t="minute";break;case"day":s=n-86400,t="hour";break;case"week":s=n-604800,t="day";break;case"month":s=n-2592e3,t="day";break;default:s=n-86400,t="hour"}const i=(()=>{switch(o){case"cpu":return["cpu","appCpu"];case"memory":return["mem","appMem","totalMem"];case"disk":return["disk","appDisk","totalDisk"];default:return[]}})(),m=await I.usageTimeRange(s,x,t,i);f(m)}catch{}finally{}},[o]);p.useEffect(()=>{r&&w(c)},[r,c]),p.useEffect(()=>{r&&b(u)},[r,u,b]);const M=e=>{y(e)},T=e=>{w(e)},U=()=>{if(!d.length)return[];const e=(t,i,m)=>{switch(m){case"cpu":return Math.min(t,100);case"memory":case"disk":return Math.min(t/i*100,100);default:return 0}},s=(t=>{switch(t){case"cpu":return{host:"cpu",app:"appCpu"};case"memory":return{host:"mem",app:"appMem",total:"totalMem"};case"disk":return{host:"disk",app:"appDisk",total:"totalDisk"};default:return{host:"cpu",app:"appCpu"}}})(o);return[{name:a(`sys.workbench.${o}AppUsage`),data:d.map(t=>{const i=t.value[s.app]||0,m=s.total&&t.value[s.total]||1;return{x:Number(t.at)*1e3,y:e(i,m,o)}})},{name:a(`sys.workbench.${o}HostUsage`),data:d.map(t=>{const i=t.value[s.host]||0,m=s.total&&t.value[s.total]||1;return{x:Number(t.at)*1e3,y:e(i,m,o)}})}]},j=$({xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:(()=>{switch(u){case"hour":return"HH:mm";case"day":return"MM-dd HH:mm";case"week":case"month":return"yyyy-MM-dd";default:return"yyyy-MM-dd HH:mm"}})()}},tooltip:{x:{formatter:(()=>{switch(u){case"hour":return e=>new Date(e).toLocaleString();case"day":return e=>new Date(e).toLocaleString();case"week":return e=>{const n=new Date(e);return`${n.toLocaleDateString()} (${n.toLocaleDateString("en-US",{weekday:"short"})})`};case"month":return e=>new Date(e).toLocaleDateString();default:return e=>new Date(e).toLocaleString()}})()},y:{formatter:e=>`${e.toFixed(2)}%`}},yaxis:{labels:{formatter:e=>`${e.toFixed(2)}%`},max:100},chart:{toolbar:{show:!1}},fill:{type:"gradient",gradient:{shadeIntensity:1,opacityFrom:.45,opacityTo:.05,stops:[0,100]}},stroke:{curve:"smooth",width:2}}),H=[{key:"cpu",label:a("sys.workbench.cpu")},{key:"memory",label:a("sys.workbench.memory")},{key:"disk",label:a("sys.workbench.disk")}];return h.jsx(N,{title:a(`sys.workbench.${o}UsageHistory`),open:r,onCancel:l,width:800,footer:null,style:{top:"15%"},styles:{body:{padding:"0px"}},children:h.jsxs(R,{className:"flex-col !shadow-none",children:[h.jsxs("header",{className:"flex w-full justify-between items-start self-start",children:[h.jsx(P,{activeKey:o,onChange:T,items:H,size:"small"}),h.jsx(z,{size:"small",value:u,onChange:M,style:{width:110,marginTop:10},options:[{value:"hour",label:a("sys.workbench.lastHour")},{value:"day",label:a("sys.workbench.lastDay")},{value:"week",label:a("sys.workbench.lastWeek")},{value:"month",label:a("sys.workbench.lastMonth")}]})]}),h.jsx("main",{className:"w-full",children:h.jsx(E,{type:"area",series:U(),options:j,height:350,style:{marginLeft:"-15px"}})})]})})}const V=Object.freeze(Object.defineProperty({__proto__:null,default:q},Symbol.toStringTag,{value:"Module"}));export{q as R,I as h,V as r};

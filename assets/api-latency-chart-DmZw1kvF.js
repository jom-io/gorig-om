import{u as B,t as r,j as s}from"./index-B8gF60y7.js";import{s as X}from"./statService-CguRoBzC.js";import{C as oe}from"./index-ZYOVP4Kc.js";import{C as ne}from"./chart-HN1HX2Pq.js";import{u as le}from"./useChart-1uMmjKdd.js";import{z as i,T as ce,s as k,M as ie,t as V,I as ue,ab as de,G as me,ac as xe}from"./vendor-ui-B8JNe9Dz.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import ye from"./api-sample-modal-0eadmLw8.js";import"./vendor-utils-9ATX-dPw.js";import"./vendor-charts-C0vSEv4L.js";const he=[{value:"today",label:"Today"},{value:"5m",label:"Last 5m"},{value:"10m",label:"Last 10m"},{value:"30m",label:"Last 30m"},{value:"hour",label:"Last Hour"},{value:"day",label:"Last Day"},{value:"week",label:"Last Week"},{value:"month",label:"Last Month"}];function pe(f="hour",R=null){const{t:d}=B(),[b,y]=o.useState(f),[n,M]=o.useState(R),P=o.useCallback(u=>{if(n?.[0]&&n?.[1]){const O=Math.floor(n[0].valueOf()/1e3),L=Math.floor(n[1].valueOf()/1e3),j=(L-O)/3600;let g;return n[0]?.startOf("day").valueOf()===n[0]?.valueOf()&&n[1]?.valueOf()<=Date.now()&&Math.abs(n[1].valueOf()-Date.now())<6e4?g="5m":j<=1?g="minute":j<=6?g="5m":j<=48?g="hour":g="day",{start:O,end:L,apiUnit:g}}const x=Math.floor(Date.now()/1e3);let c,h;switch(u){case"today":c=Math.floor(i().startOf("day").valueOf()/1e3),h="5m";break;case"5m":c=x-300,h="minute";break;case"10m":c=x-600,h="minute";break;case"30m":c=x-1800,h="5m";break;case"hour":c=x-3600,h="5m";break;case"day":c=x-86400,h="hour";break;case"week":c=x-604800,h="day";break;case"month":c=x-2592e3,h="day";break;default:c=x-86400,h="hour"}return{start:c,end:x,apiUnit:h}},[n]),w=o.useMemo(()=>[...he.map(u=>({...u,label:d(`sys.workbench.time.${u.value}`,u.label)})),...n?[{value:"custom",label:d("sys.workbench.time.custom","Custom")}]:[]],[d,n]),E=o.useMemo(()=>{switch(b){case"today":case"5m":case"10m":case"30m":case"hour":return"HH:mm";case"day":return"MM-dd HH:mm";case"week":case"month":return"yyyy-MM-dd";default:return"yyyy-MM-dd HH:mm"}},[b]);return{timeUnit:b,setTimeUnit:y,timeRange:n,setTimeRange:M,getRange:P,dateLabelFormat:E,renderTimePicker:u=>{const x=n?.[0]&&n?.[1]&&n[0].startOf("day").valueOf()===n[0].valueOf()&&n[1].valueOf()<=Date.now()&&Math.abs(n[1].valueOf()-Date.now())<6e4;return s.jsxs("div",{className:"flex items-center gap-1 bg-neutral-100 dark:bg-neutral-800 p-0.5 rounded-lg border border-neutral-200 dark:border-neutral-700",style:{background:r.colors.background.neutral},children:[s.jsx(V,{size:"small",variant:"borderless",value:x?"today":n?"custom":b,onChange:c=>{c!=="custom"&&(c==="today"?(M([i().startOf("day"),i()]),y("today")):(y(c),M(null)),u?.())},style:{width:110},options:w}),s.jsx("span",{className:"w-[1px] h-4 bg-neutral-300 dark:bg-neutral-600 mx-1"}),s.jsx(xe.RangePicker,{size:"small",variant:"borderless",value:n,onChange:c=>{M(c),u?.()},showTime:{format:"HH:mm"},format:"YYYY-MM-DD HH:mm",allowClear:!0,placeholder:[d("sys.workbench.startTime","Start"),d("sys.workbench.endTime","End")],style:{width:280},presets:[{label:d("sys.workbench.time.5m","Last 5m"),value:[i().subtract(5,"minute"),i()]},{label:d("sys.workbench.time.10m","Last 10m"),value:[i().subtract(10,"minute"),i()]},{label:d("sys.workbench.time.30m","Last 30m"),value:[i().subtract(30,"minute"),i()]},{label:d("sys.workbench.time.hour","Last Hour"),value:[i().subtract(1,"hour"),i()]},{label:d("sys.workbench.time.day","Last Day"),value:[i().subtract(1,"day"),i()]},{label:d("sys.workbench.time.week","Last Week"),value:[i().subtract(1,"week"),i()]},{label:d("sys.workbench.time.month","Last Month"),value:[i().subtract(1,"month"),i()]}]})]})}}}const D=["2xx","4xx","5xx"],q=f=>`${f} ms`;function je({open:f,onClose:R,enabled:d=!0,defaultSort:b="count"}){const{t:y}=B(),{timeUnit:n,setTimeUnit:M,setTimeRange:P,getRange:w,dateLabelFormat:E,renderTimePicker:z}=pe("today",[i().startOf("day"),i()]),[u,x]=o.useState(null),[c,h]=o.useState([]),[O,L]=o.useState([]),[j,g]=o.useState(0),[v,J]=o.useState(D),[H,Q]=o.useState(["GET","POST","PUT","DELETE"]),[U,N]=o.useState(""),[A,I]=o.useState(""),[m,K]=o.useState({columnKey:b,order:"descend"}),[T,S]=o.useState({current:1,pageSize:10}),[Z,$]=o.useState({open:!1,method:"",uri:"",type:"slow"}),C=o.useCallback((e,t)=>{$({open:!0,method:e.method,uri:e.uri,type:t})},[]),F=o.useCallback(e=>{J(t=>t.includes(e)?t.filter(p=>p!==e):[...t,e]),S(t=>({...t,current:1}))},[]);o.useEffect(()=>{f&&(K({columnKey:b==="count"?"count":b,order:"descend"}),S(e=>({...e,current:1})),N(""),I(""),x(null))},[f,b]),o.useEffect(()=>{if(f&&d){const e=w(n);(async()=>{try{const l=(await X.apiTimeRange(e.start,e.end,e.apiUnit,["count2xx","count4xx","count5xx"])).map(p=>({at:Number(p.at)*1e3,counts:{"2xx":p.value.count2xx||0,"4xx":p.value.count4xx||0,"5xx":p.value.count5xx||0}}));h(l)}catch{}})(),x(null)}},[f,d,n,w]);const _=o.useCallback(async()=>{if(!f||!d)return;const e=u?.[0]&&u?.[1]?{start:Math.floor(u[0].valueOf()/1e3),end:Math.floor(u[1].valueOf()/1e3),apiUnit:(()=>{const a=(u[1].valueOf()-u[0].valueOf())/36e5;return a<=1?"minute":a<=6?"5m":a<=48?"hour":"day"})()}:w(n),t={count:"count",status2xx:"2xx",status4xx:"4xx",status5xx:"5xx",avgLatency:"avg",maxLatency:"max",successRate:"success"};try{const a=await X.apiTop({start:e.start,end:e.end,page:T.current,size:T.pageSize,statuses:v,methods:H,uriLike:U.trim(),sortBy:t[m.columnKey]||"avg",asc:m.order==="ascend"});L(a.items),g(a.total)}catch{}},[f,d,n,T.current,T.pageSize,m,v,H,U,w,u]);o.useEffect(()=>{_()},[_]);const ee=o.useMemo(()=>c.length?D.map(e=>{const t=v.includes(e);return{name:e,data:c.map(a=>({x:a.at,y:t?a.counts[e]:null}))}}):[],[c,v]),Y=o.useMemo(()=>[r.colors.palette.success.dark,r.colors.palette.warning.dark,r.colors.palette.error.dark],[]),G=o.useMemo(()=>({GET:r.colors.palette.primary.dark,POST:r.colors.palette.success.dark,PUT:r.colors.palette.warning.dark,DELETE:r.colors.palette.error.dark}),[]),te=o.useCallback((e,t)=>{if(!t?.xaxis)return;const{min:a,max:l}=t.xaxis;if(a&&l&&a!==l){const p=i(a),re=i(l);x([p,re]),e?.zoomX&&setTimeout(()=>{e.zoomX(void 0,void 0)},100)}},[]),ae=le({colors:Y,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:E}},yaxis:{labels:{formatter:e=>`${e}`},min:0},tooltip:{x:{formatter:e=>{switch(n){case"today":case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e} req`}},chart:{toolbar:{show:!1},zoom:{enabled:!0,type:"x",autoScaleYaxis:!1},selection:{enabled:!0,type:"x",fill:{color:r.colors.palette.primary.default,opacity:.2},stroke:{width:2,dashArray:0,color:r.colors.palette.primary.default,opacity:.8}},events:{legendClick:(e,t)=>(t!==void 0&&F(D[t]),!1),selection:(e,t)=>{t?.xaxis&&te(e,t)},zoomed:(e,{xaxis:t})=>{if(t?.min&&t?.max){const a=i(t.min),l=i(t.max);x([a,l]),e?.zoomX&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.zoomX(void 0,void 0)})})}}}},stroke:{width:2,curve:"smooth"},annotations:{xaxis:u?.[0]&&u?.[1]?(()=>{const e=u[0],t=u[1],l=!e.isSame(t,"day")?`${e.format("MM-DD HH:mm")} ~ ${t.format("MM-DD HH:mm")}`:`${e.format("HH:mm")} ~ ${t.format("HH:mm")}`,p=(e.valueOf()+t.valueOf())/2;return[{x:e.valueOf(),x2:t.valueOf(),fillColor:r.colors.palette.primary.default,opacity:.1,borderColor:r.colors.palette.primary.default,strokeDashArray:0,borderWidth:1},{x:p,label:{text:l,orientation:"horizontal",position:"top",offsetY:-15,style:{fontSize:"11px",fontWeight:500,color:r.colors.palette.primary.default,background:r.colors.background.paper,padding:{left:8,right:8,top:4,bottom:4}},borderColor:r.colors.palette.primary.default,borderWidth:1}}]})():[]}}),se=o.useMemo(()=>[{title:y("sys.workbench.apiColMethod","Method"),dataIndex:"method",key:"method",width:80,render:e=>s.jsx(ce,{color:G[e]||r.colors.palette.primary.default,children:e})},{title:"URL",dataIndex:"uri",key:"uri",ellipsis:!0},{title:y("sys.workbench.apiColTotal","Total"),dataIndex:"count",key:"count",sorter:!0,sortOrder:m.columnKey==="count"?m.order:void 0,width:90,align:"right"},{title:"2xx",dataIndex:"count2xx",key:"status2xx",sorter:!0,sortOrder:m.columnKey==="status2xx"?m.order:void 0,width:70,align:"right",render:(e,t)=>s.jsx(k.Link,{disabled:e===0,onClick:a=>{a.stopPropagation(),e>0&&C(t,"2xx")},style:{color:e>0?r.colors.palette.success.dark:r.colors.text.secondary},children:e})},{title:y("sys.workbench.apiColSuccessRate","Success"),key:"successRate",width:90,align:"right",render:(e,t)=>{const a=t.successRate*100,l=a>=99?"success":a>=95?"warning":"error";return s.jsxs(k.Text,{strong:!0,style:{color:r.colors.palette[l].dark},children:[a.toFixed(1),"%"]})},sorter:!0,sortOrder:m.columnKey==="successRate"?m.order:void 0},{title:"4xx",dataIndex:"count4xx",key:"status4xx",sorter:!0,sortOrder:m.columnKey==="status4xx"?m.order:void 0,width:70,align:"right",render:(e,t)=>s.jsx(k.Link,{disabled:e===0,onClick:a=>{a.stopPropagation(),e>0&&C(t,"4xx")},style:{color:e>0?r.colors.palette.warning.dark:r.colors.text.secondary},children:e})},{title:"5xx",dataIndex:"count5xx",key:"status5xx",sorter:!0,sortOrder:m.columnKey==="status5xx"?m.order:void 0,width:70,align:"right",render:(e,t)=>s.jsx(k.Link,{strong:e>0,disabled:e===0,onClick:a=>{a.stopPropagation(),e>0&&C(t,"5xx")},style:{color:e>0?r.colors.palette.error.dark:r.colors.text.secondary},children:e})},{title:y("sys.workbench.apiColAvg","Avg"),dataIndex:"avgLatency",key:"avgLatency",sorter:!0,sortOrder:m.columnKey==="avgLatency"?m.order:void 0,width:90,render:e=>{const t=Math.round(e),a=t>500?r.colors.palette.error.dark:t>200?r.colors.palette.warning.dark:void 0;return s.jsx(k.Text,{style:{color:a},children:q(t)})}},{title:y("sys.workbench.apiColMax","Max"),dataIndex:"maxLatency",key:"maxLatency",sorter:!0,sortOrder:m.columnKey==="maxLatency"?m.order:void 0,width:90,render:(e,t)=>{const a=Math.round(e),l=a>500?r.colors.palette.error.dark:a>200?r.colors.palette.warning.dark:void 0;return s.jsx(k.Link,{style:{color:l},onClick:p=>{p.stopPropagation(),C(t,"slow")},children:q(a)})}}],[y,m,G,C]),W=o.useMemo(()=>{if(!c.length)return{total:0,ok:0,err4:0,err5:0};let e=0,t=0,a=0;for(const l of c)e+=l.counts["2xx"],t+=l.counts["4xx"],a+=l.counts["5xx"];return{total:e+t+a,ok:e,err4:t,err5:a}},[c]);return s.jsxs(ie,{title:y("sys.workbench.apiTrendTitle","API Response Trend"),open:f&&d,onCancel:R,width:960,footer:null,style:{top:"6%"},styles:{body:{padding:0}},maskClosable:!0,destroyOnClose:!0,children:[s.jsxs(oe,{className:"flex-col !shadow-none",children:[s.jsxs("header",{className:"flex w-full justify-between items-center gap-4",children:[s.jsxs("div",{className:"flex gap-4 items-center flex-wrap",children:[s.jsx("div",{className:"flex gap-2 items-center",children:D.map((e,t)=>{const a=v.includes(e),l=Y[t];return s.jsxs("div",{onClick:()=>F(e),className:"flex items-center h-7 px-2.5 rounded-full border transition-all cursor-pointer hover:opacity-80 active:scale-95 select-none",style:{borderColor:a?l:r.colors.common.border,background:a?`${l}15`:r.colors.background.neutral,boxShadow:a?`0 2px 4px ${l}20`:"none"},children:[s.jsx("span",{className:"w-1.5 h-1.5 rounded-full mr-2",style:{background:l,boxShadow:`0 0 4px ${l}`}}),s.jsx("span",{className:"text-xs font-medium mr-1.5",style:{color:r.colors.text.secondary},children:e}),s.jsx("span",{className:"text-sm font-bold",style:{color:a?l:r.colors.text.primary},children:W[e==="2xx"?"ok":e==="4xx"?"err4":"err5"]})]},e)})}),s.jsxs("div",{className:"flex items-center h-7 px-3 rounded-md bg-neutral-100 dark:bg-neutral-800 border border-transparent",style:{background:r.colors.background.neutral},children:[s.jsx(k.Text,{type:"secondary",style:{fontSize:"12px"},children:y("sys.workbench.apiTotalCount","Total")}),s.jsx("span",{className:"mx-1.5 h-3 w-[1px] bg-neutral-300 dark:bg-neutral-700"}),s.jsx("span",{className:"text-sm font-bold",style:{color:r.colors.text.primary},children:W.total})]})]}),z(()=>{x(null)})]}),s.jsxs("main",{className:"w-full flex flex-col gap-4 mt-4",children:[s.jsxs("div",{className:"w-full",children:[s.jsx("div",{className:"mb-2 text-xs",style:{color:r.colors.text.secondary},children:y("sys.workbench.chartHint","ðŸ’¡ Drag to select")}),s.jsx(ne,{type:"area",series:ee,options:ae,height:360})]}),s.jsxs("div",{className:"w-full",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2 px-1",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-base font-medium",style:{color:r.colors.text.primary},children:y("sys.workbench.apiRankingTitle","Endpoint latency ranking")}),s.jsx("span",{className:"text-xs",style:{color:r.colors.text.secondary},children:y("sys.workbench.apiRankingDesc","Sortable by status counts and latency columns.")})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(V,{mode:"multiple",placeholder:"Method",value:H,onChange:e=>{Q(e),S(t=>({...t,current:1}))},style:{width:220},maxTagCount:"responsive",size:"small",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"PUT",value:"PUT"},{label:"DELETE",value:"DELETE"},{label:"PATCH",value:"PATCH"},{label:"OPTIONS",value:"OPTIONS"},{label:"HEAD",value:"HEAD"}]}),s.jsx(ue,{placeholder:"Search URL...",size:"small",allowClear:!0,prefix:s.jsx(de,{style:{color:r.colors.text.disabled}}),value:A,onChange:e=>{const t=e.target.value;I(t),t===""&&(N(""),S(a=>({...a,current:1})))},onPressEnter:()=>{N(A),S(e=>({...e,current:1}))},style:{width:180}})]})]}),s.jsx(me,{rowKey:e=>`${e.method}-${e.uri}`,dataSource:O,size:"small",onRow:e=>({onClick:()=>C(e,"latest"),className:"cursor-pointer"}),pagination:{current:T.current,pageSize:T.pageSize,total:j,showSizeChanger:!1,onChange:e=>S(t=>({...t,current:e}))},columns:se,onChange:(e,t,a)=>{!Array.isArray(a)&&a.columnKey&&K({columnKey:a.columnKey,order:a.order||"descend"})}})]})]})]}),s.jsx(ye,{...Z,onClose:()=>$(e=>({...e,open:!1}))})]})}export{he as TIME_OPTIONS,je as default,pe as useTimeRange};

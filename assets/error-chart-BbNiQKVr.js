import{u as B,t as l,j as r}from"./index-B8gF60y7.js";import{s as j}from"./statService-CguRoBzC.js";import{C as P}from"./index-ZYOVP4Kc.js";import{C as Y}from"./chart-HN1HX2Pq.js";import{u as G}from"./useChart-1uMmjKdd.js";import{z as f,M as K,G as V,s as S,T as J}from"./vendor-ui-B8JNe9Dz.js";import{r as s}from"./vendor-core-D3G3Pc5t.js";import Q from"./anomaly-sample-modal-DmL11wPQ.js";import{useTimeRange as Z}from"./api-latency-chart-DmZw1kvF.js";import"./vendor-utils-9ATX-dPw.js";import"./vendor-charts-C0vSEv4L.js";import"./api-sample-modal-0eadmLw8.js";const g=["error","panic"];function pe({open:m,onClose:M,enabled:p=!0}){const{t:n}=B(),{timeUnit:y,setTimeRange:te,getRange:h,dateLabelFormat:D,renderTimePicker:L}=Z("today",[f().startOf("day"),f()]),[i,x]=s.useState(null),[N,H]=s.useState([]),[O,b]=s.useState([]),[R,k]=s.useState(!1),[z,A]=s.useState(g),[E,T]=s.useState({open:!1,data:null}),F=s.useMemo(()=>[l.colors.palette.error.dark,l.colors.palette.error.default],[]),u=z,$=t=>{T({open:!0,data:t})},I=s.useCallback(t=>{const e=g[t];A(a=>a.includes(e)?a.filter(c=>c!==e):[...a,e])},[]),U=s.useCallback((t,e)=>{if(!e?.xaxis)return;const{min:a,max:o}=e.xaxis;if(a&&o&&a!==o){const c=f(a),w=f(o);x([c,w]),t?.zoomX&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{t.zoomX(void 0,void 0)})})}},[]),v=s.useCallback(async t=>{try{const e=h(t),a=await j.errorTimeRange(e.start,e.end,e.apiUnit,g);H(a)}catch{}},[h]),C=s.useCallback(async t=>{if(u.length===0){b([]);return}try{k(!0);const e=i?.[0]&&i?.[1]?{start:Math.floor(i[0].valueOf()/1e3),end:Math.floor(i[1].valueOf()/1e3),apiUnit:(()=>{const o=(i[1].valueOf()-i[0].valueOf())/36e5;return o<=1?"minute":o<=6?"5m":o<=48?"hour":"day"})()}:h(t),a=await j.errorTop(e.start,e.end,10,u);b(a)}catch{}finally{k(!1)}},[h,u,i]);s.useEffect(()=>{m&&p&&(v(y),x(null))},[m,p,y,v]),s.useEffect(()=>{m&&p&&C(y)},[m,p,y,C]);const d=N,X=O,q=s.useMemo(()=>{if(!d.length)return[];const t=e=>{switch(e){case"error":return n("sys.workbench.anomalyError");case"panic":return n("sys.workbench.anomalyPanic");default:return e}};return g.map(e=>{const a=d.map(c=>{const w=c.value[e]||0;return{x:Number(c.at)*1e3,y:w}}),o=u.includes(e);return{name:t(e),data:o?a:a.map(c=>({...c,y:null}))}})},[d,u,n]),W=s.useMemo(()=>{if(d.length)return d.reduce((t,e)=>{const a=e.value,o=(a.error||0)+(a.panic||0);return Math.max(t,o)},0)+1},[d]),_=G({colors:F,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:D}},tooltip:{x:{formatter:t=>{switch(y){case"5m":case"10m":case"30m":case"hour":case"day":return new Date(t).toLocaleString();case"week":case"month":return new Date(t).toLocaleDateString();default:return new Date(t).toLocaleString()}}},y:{formatter:t=>`${t}`}},yaxis:{labels:{formatter:t=>`${t}`},min:0,max:W},chart:{toolbar:{show:!1},zoom:{enabled:!0,type:"x",autoScaleYaxis:!1},selection:{enabled:!0,type:"x",fill:{color:l.colors.palette.primary.default,opacity:.2},stroke:{width:2,dashArray:0,color:l.colors.palette.primary.default,opacity:.8}},events:{legendClick:(t,e)=>(I(e??0),!1),selection:(t,e)=>{e?.xaxis&&U(t,e)},zoomed:(t,{xaxis:e})=>{if(e?.min&&e?.max){const a=f(e.min),o=f(e.max);x([a,o]),t?.zoomX&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{t.zoomX(void 0,void 0)})})}}}},stroke:{curve:"smooth",width:2},annotations:{xaxis:i?.[0]&&i?.[1]?(()=>{const t=i[0],e=i[1],o=!t.isSame(e,"day")?`${t.format("MM-DD HH:mm")} ~ ${e.format("MM-DD HH:mm")}`:`${t.format("HH:mm")} ~ ${e.format("HH:mm")}`,c=(t.valueOf()+e.valueOf())/2;return[{x:t.valueOf(),x2:e.valueOf(),fillColor:l.colors.palette.primary.default,opacity:.1,borderColor:l.colors.palette.primary.default,strokeDashArray:0,borderWidth:1},{x:c,label:{text:o,orientation:"horizontal",position:"top",offsetY:-15,style:{fontSize:"11px",fontWeight:500,color:l.colors.palette.primary.default,background:l.colors.background.paper,padding:{left:8,right:8,top:4,bottom:4}},borderColor:l.colors.palette.primary.default,borderWidth:1}}]})():[]}});return r.jsxs(K,{title:n("sys.workbench.anomalyTrend"),open:m&&p,onCancel:M,width:850,footer:null,style:{top:"10%"},styles:{body:{padding:"0px"}},maskClosable:!0,destroyOnClose:!0,children:[r.jsxs(P,{className:"flex-col !shadow-none",children:[r.jsxs("header",{className:"flex w-full justify-between items-center mb-4",children:[r.jsx("div",{}),L(()=>{x(null)})]}),r.jsxs("main",{className:"w-full flex flex-col gap-4",children:[r.jsxs("div",{className:"w-full",children:[r.jsx("div",{className:"mb-2 text-xs",style:{color:l.colors.text.secondary},children:n("sys.workbench.chartHint","ðŸ’¡ æ‹–æ‹½é€‰æ‹©")}),r.jsx(Y,{type:"area",series:q,options:_,height:360})]}),r.jsxs("div",{className:"w-full",children:[r.jsx("div",{className:"flex items-center justify-between mb-2 px-1",children:r.jsxs("div",{className:"flex flex-col",children:[r.jsx("span",{className:"text-base font-medium",style:{color:l.colors.text.primary},children:n("sys.workbench.anomalyTopTitle")}),r.jsx("span",{className:"text-xs",style:{color:l.colors.text.secondary},children:n("sys.workbench.anomalyTopDesc")})]})}),r.jsx(V,{rowKey:t=>t.sigHash,dataSource:X,loading:R,size:"small",pagination:!1,locale:{emptyText:n("sys.workbench.anomalyTopEmpty")},onRow:t=>({onClick:()=>$(t),className:"cursor-pointer"}),columns:[{title:n("sys.workbench.anomalySignature"),dataIndex:"signature",key:"signature",render:(t,e)=>r.jsx(S.Text,{ellipsis:{tooltip:e.signature||e.sampleMsg||e.sampleError},style:{maxWidth:320},children:e.signature||e.sampleMsg||n("sys.workbench.anomalySampleEmpty")})},{title:n("sys.workbench.anomalyCount"),dataIndex:"count",key:"count",align:"right",width:80,render:t=>r.jsx(S.Text,{strong:!0,style:{color:l.colors.palette.error.dark},children:t})},{title:n("sys.workbench.anomalyLevel"),dataIndex:"level",key:"level",width:90,render:t=>{const e=t||(u.length===1?u[0]:"-");return r.jsx(J,{color:l.colors.palette.error.light,children:e?.toUpperCase()})}},{title:n("sys.workbench.anomalyLastSeen"),dataIndex:"lastAt",key:"lastAt",width:180,className:"whitespace-nowrap",render:t=>ee(t)}]})]})]})]}),r.jsx(Q,{...E,onClose:()=>T(t=>({...t,open:!1}))})]})}const ee=m=>m?new Date(Number(m)*1e3).toLocaleString():"--";export{pe as default};

import{u as F,a as K,j as e,t as s}from"./index-B8gF60y7.js";import{s as C}from"./statService-CguRoBzC.js";import{C as R}from"./index-ZYOVP4Kc.js";import{z as h,S as z,M as A,ak as M,G as U,t as G}from"./vendor-ui-B8JNe9Dz.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import W from"./RefreshIcon-CFY6dIpq.js";import{useTimeRange as V}from"./api-latency-chart-DmZw1kvF.js";import"./vendor-utils-9ATX-dPw.js";import"./chart-HN1HX2Pq.js";import"./vendor-charts-C0vSEv4L.js";import"./useChart-1uMmjKdd.js";import"./api-sample-modal-0eadmLw8.js";const{Panel:q}=M,f=l=>{if(l===0)return"0 B";const r=1024,b=["B","KB","MB","GB"],m=Math.floor(Math.log(Math.abs(l))/Math.log(r));return`${(l/r**m).toFixed(2)} ${b[m]}`};function ce(){const{t:l}=F(),r=K(),[b,m]=o.useState(!1),[k,D]=o.useState(0),[j,$]=o.useState(""),[i,N]=o.useState(!1),[u,L]=o.useState([]),[a,x]=o.useState({current:1,pageSize:10,total:0}),[I,w]=o.useState(!1),[B,y]=o.useState([]),{timeUnit:S,getRange:v,renderTimePicker:E}=V("today",[h().startOf("day"),h()]),p=o.useCallback(async()=>{if(r)try{m(!0);const t=h(),c=t.startOf("day").unix(),n=t.unix(),d=await C.memLeakCount(c,n);D(d),$(t.format("HH:mm"))}catch{}finally{m(!1)}},[r]),g=o.useCallback(async()=>{if(r)try{w(!0);const{start:t,end:c}=v(S),n=await C.memLeakPage({start:t,end:c,page:a.current,size:a.pageSize}),d=n.items||[];L(d),d.length>0?y([`${d[0].at}-0`]):y([]),x(T=>({...T,total:n.total||0,current:n.page||1,pageSize:n.size||10}))}catch{}finally{w(!1)}},[r,S,v,a.current,a.pageSize]);o.useEffect(()=>{if(r){p();const t=setInterval(p,3e4);return()=>clearInterval(t)}},[r,p]),o.useEffect(()=>{i&&r&&x(t=>({...t,current:1}))},[i,r]),o.useEffect(()=>{i&&r&&g()},[i,r,g]);const H=()=>{N(!0),y([])},Y=o.useCallback(t=>{t.stopPropagation(),p(),i&&r&&g()},[p,i,r,g]),O=[{title:l("sys.workbench.leakFunc"),dataIndex:"func",key:"func",render:(t,c)=>e.jsxs("div",{className:"flex flex-col py-0.5",style:{wordBreak:"break-all",whiteSpace:"normal"},children:[e.jsx("span",{style:{fontSize:"13px",fontFamily:"monospace",fontWeight:600,color:s.colors.text.primary,wordBreak:"break-all",whiteSpace:"normal",lineHeight:"1.4"},children:t}),e.jsxs("span",{className:"mt-0.5",style:{fontSize:"11px",color:s.colors.text.secondary,wordBreak:"break-all",whiteSpace:"normal",lineHeight:"1.4"},children:[c.file,":",c.line]})]})},{title:l("sys.workbench.leakDeltaSpace"),dataIndex:"deltaSpace",key:"deltaSpace",width:110,align:"right",render:t=>e.jsxs("span",{style:{fontSize:"13px",fontWeight:700,color:s.colors.palette.error.dark},children:["+",f(t)]})},{title:l("sys.workbench.leakDeltaObjects"),dataIndex:"deltaObjects",key:"deltaObjects",width:90,align:"right",render:t=>e.jsxs("span",{style:{fontSize:"13px",color:s.colors.text.primary},children:["+",t.toLocaleString()]})}],P=`linear-gradient(135deg, rgba(${s.colors.palette.error.lightChannel}, 0.14), rgba(${s.colors.palette.warning.lightChannel}, 0.12)) ${s.colors.background.paper}`;return e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"!p-0 overflow-hidden cursor-pointer hover:shadow-lg transition-shadow",onClick:H,style:{background:P,padding:0,boxShadow:s.shadows.card,height:133,width:"100%",display:"flex",flexDirection:"column",flexShrink:0},children:e.jsx(z,{spinning:b,style:{height:"100%"},wrapperClassName:"flex-1 flex flex-col",children:e.jsx("div",{className:"flex h-full flex-col justify-center p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"text-lg font-medium",style:{color:s.colors.text.primary},children:l("sys.workbench.memoryLeak")}),e.jsx("div",{className:"text-xs",style:{color:s.colors.text.secondary},children:k>0?l("sys.workbench.leakSummary"):l("sys.workbench.leakNoEvent")}),e.jsxs("div",{className:"flex items-baseline gap-2 mt-6",children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:k>0?s.colors.palette.error.dark:s.colors.text.primary},children:k}),e.jsx("div",{className:"text-xs",style:{color:s.colors.text.secondary},children:l("sys.workbench.leakUnit")})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 justify-center",children:[e.jsx(W,{background:`rgba(${s.colors.palette.error.defaultChannel}, 0.16)`,color:s.colors.palette.error.dark,icon:"mdi:leak",onClick:Y}),j&&e.jsx("span",{className:"mt-4 text-xs whitespace-nowrap",style:{color:s.colors.text.secondary},children:l("sys.workbench.leakUpdatedAt",{time:j})})]})]})})})}),e.jsxs(A,{title:e.jsx("span",{className:"text-lg font-bold",children:l("sys.workbench.memoryLeak")}),open:i,onCancel:()=>N(!1),footer:null,width:900,centered:!0,styles:{body:{paddingTop:"12px",maxHeight:"calc(100vh - 200px)",overflowY:"auto"}},children:[e.jsx("div",{className:"mb-4 flex items-center justify-end gap-2",children:E(()=>{x(t=>({...t,current:1}))})}),e.jsxs(z,{spinning:I,children:[u&&u.length>0?e.jsx(M,{activeKey:B,onChange:y,style:{background:"transparent"},children:u.map((t,c)=>e.jsx(q,{header:e.jsx("div",{className:"flex items-center justify-between w-full pr-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-semibold",style:{color:s.colors.text.primary},children:h.unix(t.at).format("YYYY-MM-DD HH:mm:ss")}),e.jsxs("span",{className:"text-sm font-bold text-red-500",style:{color:s.colors.palette.error.dark},children:["+",f(t.allocDelta)]}),e.jsxs("span",{className:"text-sm font-bold text-red-500",style:{color:s.colors.palette.error.dark},children:["+",t.objectDelta.toLocaleString()]})]})}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl",style:{background:s.colors.background.neutral},children:[e.jsxs("div",{className:"flex flex-col gap-1.5",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:s.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakTime",{time:""})}),e.jsx("div",{className:"text-sm font-bold",style:{color:s.colors.text.primary},children:h.unix(t.at).format("YYYY-MM-DD HH:mm:ss")})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:s.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakBaseInuseSpace")}),e.jsx("div",{className:"text-base font-bold",style:{color:s.colors.text.primary},children:f(t.baseInuseSpace)})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:s.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakLeakInuseSpace")}),e.jsx("div",{className:"text-base font-bold",style:{color:s.colors.text.primary},children:f(t.leakInuseSpace)})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:s.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakAllocDelta")}),e.jsxs("div",{className:"text-lg font-black text-red-500",children:["+",f(t.allocDelta)]})]}),e.jsxs("div",{className:"flex flex-col gap-1.5 items-end",children:[e.jsx("div",{className:"text-sm font-semibold",style:{color:s.colors.text.secondary,opacity:.85},children:l("sys.workbench.leakObjectDelta")}),e.jsxs("div",{className:"text-lg font-black text-red-500",children:["+",t.objectDelta.toLocaleString()]})]})]})]}),t.points&&t.points.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"mb-3 text-sm font-bold tracking-tight",style:{color:s.colors.text.primary},children:l("sys.workbench.leakPoints")}),e.jsx(U,{dataSource:t.points,columns:O,pagination:!1,size:"small",rowKey:(n,d)=>`${n.func}-${n.file}-${n.line}-${d}`})]})]})},`${t.at}-${c}`))}):e.jsx("div",{className:"py-20 text-center",children:e.jsx("div",{className:"mb-2 text-lg font-medium",style:{color:s.colors.text.disabled},children:l("sys.workbench.leakNoEvent")})}),u.length>0&&e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",style:{color:s.colors.text.secondary},children:["共 ",a.total," 条"]}),e.jsx(G,{value:a.pageSize,onChange:t=>{x(c=>({...c,pageSize:t,current:1}))},style:{width:100},options:[{value:10,label:"10 条/页"},{value:20,label:"20 条/页"},{value:50,label:"50 条/页"}]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>{a.current>1&&x(t=>({...t,current:t.current-1}))},disabled:a.current===1,className:"px-2 py-1 text-sm rounded border",style:{background:a.current===1?s.colors.background.neutral:"transparent",cursor:a.current===1?"not-allowed":"pointer"},children:"上一页"}),e.jsxs("span",{className:"px-2 text-sm",style:{color:s.colors.text.primary},children:[a.current," / ",Math.ceil(a.total/a.pageSize)]}),e.jsx("button",{type:"button",onClick:()=>{const t=Math.ceil(a.total/a.pageSize);a.current<t&&x(c=>({...c,current:c.current+1}))},disabled:a.current>=Math.ceil(a.total/a.pageSize),className:"px-2 py-1 text-sm rounded border",style:{background:a.current>=Math.ceil(a.total/a.pageSize)?s.colors.background.neutral:"transparent",cursor:a.current>=Math.ceil(a.total/a.pageSize)?"not-allowed":"pointer"},children:"下一页"})]})]})})]})]})]})}export{ce as default};

import{u as le,F as ue,G as fe,j as l,I as X,b as ee}from"./index-Cnre7JAL.js";import{a as me}from"./vendor-utils-DKy5dUqm.js";import{r as d}from"./vendor-core-D3G3Pc5t.js";import{T as w,H as te,ak as ye,C as he,aa as se,G as pe,M as ge,I as xe,i as re,E as j,s as Ie}from"./vendor-ui-Dp3kvFmo.js";const Se="https://ssl-checker.zoel-du.workers.dev/?host=";async function ae(s){const F=`${Se}${s}`,{data:I}=await me.get(F,{timeout:1e4}),u=I?.result??{};if(I?.status!=="ok"||u?.response==="failed"||u?.status==="error"){const N=u?.reason||u?.message||"Certificate fetch failed";throw new Error(N)}return u}const b="certificateCache",{Text:we}=Ie,ne=s=>{const F=Number(s);return Number.isFinite(F)?F:void 0};function ve(s){try{return new URL(s).hostname}catch{return null}}function S(s){return Array.isArray(s)?s:[]}function be(){const{t:s}=le(),F=ue(),I=fe(e=>e.setStats),[u,T]=d.useState([]),[N,_]=d.useState([]),[H,J]=d.useState(!1),[Fe,P]=d.useState(null),[Z,D]=d.useState({current:1,pageSize:10}),R=d.useRef(s("sys.certificate.fetchFailed")),r=d.useRef(null),[A,ie]=d.useState(!1),B=d.useRef(!1),[M,Y]=d.useState(!1),[G,V]=d.useState(""),[U,q]=d.useState(!1),K=d.useRef(null),v=d.useCallback(e=>{let t=0,i=0;for(const a of e){if(a.valid===!1){t+=1;continue}a.valid===!0&&typeof a.daysLeft=="number"&&(a.daysLeft<0?t+=1:a.daysLeft<=7&&(i+=1))}return{expired:t,expiring:i}},[]);d.useEffect(()=>{R.current=s("sys.certificate.fetchFailed")},[s]),d.useEffect(()=>{try{const e=localStorage.getItem(b);if(e){const t=JSON.parse(e);if(r.current=t,t.domains&&T(S(t.domains)),t.results){const a=[...S(t.results)].sort((c,f)=>{const x=typeof c.daysLeft=="number"?c.daysLeft:Number.POSITIVE_INFINITY,n=typeof f.daysLeft=="number"?f.daysLeft:Number.POSITIVE_INFINITY;return x-n});_(a);const p=v(a);I({expiring:p.expiring,expired:p.expired,lastChecked:t.lastFetched?new Date(t.lastFetched).getTime():Date.now()})}t.lastFetched&&P(new Date(t.lastFetched))}}catch{}finally{ie(!0)}},[v,I]),d.useEffect(()=>{if(B.current||!A||S(r.current?.domains).length>0||r.current?.seededFromServers||u.length>0)return;const e=F.map(a=>ve(a.addr)).filter(Boolean);if(e.length===0)return;const i=Array.from(new Set(e)).map(a=>({host:a,source:"server",createdAt:Date.now()}));T(i),r.current={domains:i,seededFromServers:!0},localStorage.setItem(b,JSON.stringify({domains:i,lastFetched:r.current?.lastFetched,results:r.current?.results,seededFromServers:!0})),B.current=!0},[F,u.length,A]);const O=d.useCallback(e=>S(e).map(t=>({key:`${t.host}-${t.source}`,name:t.host,addr:t.host,host:t.host})),[]),z=d.useMemo(()=>O(u),[u,O]),k=d.useCallback(e=>{const t={domains:S(u),lastFetched:e.lastFetched??r.current?.lastFetched,results:e.results??S(r.current?.results),seededFromServers:e.seededFromServers??r.current?.seededFromServers??!1};r.current=t,localStorage.setItem(b,JSON.stringify(t))},[u]),$=d.useCallback(async e=>{const t=S(e??(u.length?u:r.current?.domains)),i=O(t);if(i.length===0){k({results:[],lastFetched:void 0});return}J(!0);try{const a=[],p=new Date().toLocaleString();for(const n of i)try{const o=await ae(n.host),g=typeof o.cert_valid=="boolean"?o.cert_valid:o.cert_exp===!1?!0:void 0;a.push({key:n.key,name:n.name,addr:n.addr,host:n.host,ip:o.resolved_ip,valid:g,daysLeft:ne(o.days_left??o.valid_days_to_expire??o.validity_days),validFrom:o.valid_from,validTill:o.valid_till,vendor:o.issuer_o||o.issuer_cn,updatedAt:p})}catch(o){const g=typeof o=="string"?o:o?.message||R.current;a.push({key:n.key,name:n.name,addr:n.addr,host:n.host,error:g,daysLeft:void 0,updatedAt:p})}const c=[...a].sort((n,o)=>{const g=typeof n.daysLeft=="number"?n.daysLeft:Number.POSITIVE_INFINITY,m=typeof o.daysLeft=="number"?o.daysLeft:Number.POSITIVE_INFINITY;return g-m});_(c);const f=new Date;P(f);const x=v(a);I({expiring:x.expiring,expired:x.expired,lastChecked:f.getTime()}),k({results:a,lastFetched:f.toISOString()})}finally{J(!1)}},[u,O,k,v,I]);d.useEffect(()=>{if(!A||z.length===0)return;const e=r.current,t=e?.lastFetched?new Date(e.lastFetched):null,i=new Date,a=m=>m?m.getFullYear()===i.getFullYear()&&m.getMonth()===i.getMonth()&&m.getDate()===i.getDate():!1,p=(e?.domains||[]).map(m=>m.host).sort().join(","),c=u.map(m=>m.host).sort().join(","),f=p===c,x=24*60*60*1e3,n=!t||i.getTime()-t.getTime()>x,o=!a(t);if(!(!f||o||n)&&e?.results){const m=[...e.results].sort((y,h)=>{const E=typeof y.daysLeft=="number"?y.daysLeft:Number.POSITIVE_INFINITY,C=typeof h.daysLeft=="number"?h.daysLeft:Number.POSITIVE_INFINITY;return E-C});_(m),t&&P(t);const L=v(e.results);I({expiring:L.expiring,expired:L.expired,lastChecked:t?.getTime()||i.getTime()});return}$()},[A,z.length,u,$,v,I]);const Q=async(e,t="server",i=!1,a=!1)=>{const p=new Date().toLocaleString();try{const c=await ae(e),f=typeof c.cert_valid=="boolean"?c.cert_valid:c.cert_exp===!1?!0:void 0,x={key:`${e}-${t}`,name:e,addr:e,host:e,ip:c.resolved_ip,valid:f,daysLeft:ne(c.days_left??c.valid_days_to_expire??c.validity_days),validFrom:c.valid_from,validTill:c.valid_till,vendor:c.issuer_o||c.issuer_cn,updatedAt:p};return _(n=>{const g=[...n.filter(y=>y.host!==e),x],m=v(g);I({expiring:m.expiring,expired:m.expired,lastChecked:Date.now()});const L=[...g].sort((y,h)=>{const E=typeof y.daysLeft=="number"?y.daysLeft:Number.POSITIVE_INFINITY,C=typeof h.daysLeft=="number"?h.daysLeft:Number.POSITIVE_INFINITY;return E-C});if(i){const y=L.findIndex(h=>h.host===e);y>=0&&D(h=>({...h,current:Math.floor(y/h.pageSize)+1}))}return L}),k({results:[...r.current?.results?S(r.current?.results).filter(n=>n.host!==e):[],x],lastFetched:r.current?.lastFetched}),!0}catch(c){const f=typeof c=="string"?c:c?.message||R.current;if(j.error(f),a){const n=u.filter(g=>g.host!==e);T(n);const o={domains:S(n),lastFetched:r.current?.lastFetched,results:S(r.current?.results).filter(g=>g.host!==e),seededFromServers:r.current?.seededFromServers??!0};return r.current=o,localStorage.setItem(b,JSON.stringify(o)),!1}const x={key:`${e}-${t}`,name:e,addr:e,host:e,error:f,daysLeft:void 0,updatedAt:p};return _(n=>{const g=[...n.filter(y=>y.host!==e),x],m=v(g);I({expiring:m.expiring,expired:m.expired,lastChecked:Date.now()});const L=[...g].sort((y,h)=>{const E=typeof y.daysLeft=="number"?y.daysLeft:Number.POSITIVE_INFINITY,C=typeof h.daysLeft=="number"?h.daysLeft:Number.POSITIVE_INFINITY;return E-C});if(i){const y=L.findIndex(h=>h.host===e);y>=0&&D(h=>({...h,current:Math.floor(y/h.pageSize)+1}))}return L}),k({results:[...r.current?.results?S(r.current?.results).filter(n=>n.host!==e):[],x],lastFetched:r.current?.lastFetched}),!1}};d.useEffect(()=>{const e=v(N);I({expiring:e.expiring,expired:e.expired})},[N,v,I]),d.useEffect(()=>{D(e=>{const t=Math.max(1,Math.ceil(N.length/e.pageSize)),i=Math.min(e.current,t);return{...e,current:i}})},[N.length]);const oe=()=>{Y(!0),V("")};d.useEffect(()=>{M&&setTimeout(()=>K.current?.focus(),50)},[M]);const W=async()=>{const e=G.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!e){j.error(s("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(e)){j.error(s("sys.certificate.domainInvalid"));return}if(u.some(p=>p.host.toLowerCase()===e.toLowerCase())){j.warning(s("sys.certificate.domainExists"));return}const a=[...u,{host:e,source:"custom",createdAt:Date.now()}];T(a),r.current={...r.current,domains:a,seededFromServers:r.current?.seededFromServers??!0},localStorage.setItem(b,JSON.stringify({domains:a,lastFetched:r.current?.lastFetched,results:r.current?.results,seededFromServers:r.current?.seededFromServers??!0})),q(!0);try{await Q(e,"custom",!0,!0)&&(j.success(s("sys.api.operationSuccess")),Y(!1),V(""))}finally{q(!1)}},ce=e=>{const t=u.filter(a=>a.host!==e);T(t);const i={domains:S(t),lastFetched:r.current?.lastFetched,results:S(r.current?.results).filter(a=>a.host!==e),seededFromServers:r.current?.seededFromServers??!0};r.current=i,localStorage.setItem(b,JSON.stringify(i)),_(a=>{const p=a.filter(f=>f.host!==e),c=v(p);return I({expiring:c.expiring,expired:c.expired,lastChecked:Date.now()}),[...p].sort((f,x)=>{const n=typeof f.daysLeft=="number"?f.daysLeft:Number.POSITIVE_INFINITY,o=typeof x.daysLeft=="number"?x.daysLeft:Number.POSITIVE_INFINITY;return n-o})})},de=[{title:l.jsx("div",{className:"pl-4 text-left",children:s("sys.certificate.api")}),dataIndex:"addr",key:"addr",align:"left",render:(e,t)=>l.jsx("div",{className:"max-w-[220px] truncate pl-4 md:max-w-none md:whitespace-nowrap",children:t.addr})},{title:s("sys.certificate.ip"),dataIndex:"ip",key:"ip",align:"center",render:(e,t)=>t.error?"-":t.ip||"-"},{title:s("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",align:"center",render:(e,t)=>t.error?"-":t.vendor||"-"},{title:s("sys.certificate.daysLeft"),dataIndex:"daysLeft",key:"daysLeft",width:110,align:"center",render:(e,t)=>{if(t.error||typeof t.daysLeft!="number")return"-";const i=t.daysLeft<=7?"error":"default";return l.jsx(w,{color:i,className:"!px-3 !py-1 text-base leading-6",children:l.jsx("span",{className:"text-lg font-medium",children:t.daysLeft})})}},{title:s("sys.certificate.valid"),dataIndex:"valid",key:"valid",width:110,align:"center",className:"!whitespace-nowrap",render:(e,t)=>t.error?l.jsx(w,{color:"default",children:s("sys.certificate.unknown")}):t.valid===void 0?l.jsx(w,{color:"default",children:s("sys.certificate.unknown")}):t.valid===!1?l.jsx(w,{color:"error",children:s("sys.certificate.invalidTag")}):typeof t.daysLeft=="number"&&t.daysLeft<=7?l.jsx(w,{color:"gold",children:s("sys.certificate.expiring")}):l.jsx(w,{color:"success",children:s("sys.certificate.validTag")})},{title:s("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",align:"center",render:(e,t)=>t.error?"-":t.validFrom||"-"},{title:s("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",align:"center",render:(e,t)=>t.error?"-":t.validTill||"-"},{title:s("sys.certificate.remark"),dataIndex:"error",key:"error",align:"center",render:(e,t)=>t.updatedAt||"-"},{title:s("sys.certificate.operation"),key:"operation",align:"center",render:(e,t)=>l.jsxs(te,{size:"small",className:"text-gray-500",children:[l.jsx(X,{size:"small",onClick:()=>void Q(t.host),children:l.jsx(ee,{icon:"solar:refresh-bold-duotone",size:16})}),l.jsx(ye,{title:s("sys.certificate.deleteConfirm"),onConfirm:()=>ce(t.host),children:l.jsx(X,{size:"small",children:l.jsx(ee,{icon:"solar:trash-bin-trash-bold-duotone",size:16})})})]})}];return l.jsxs(he,{title:s("sys.certificate.title"),styles:{body:{padding:0}},extra:l.jsxs(te,{size:"middle",children:[l.jsx(re,{type:"primary",onClick:oe,children:s("sys.certificate.addDomain")}),l.jsx(re,{onClick:()=>void $(),loading:H,disabled:z.length===0,children:s("sys.certificate.refreshAll")})]}),children:[z.length===0?l.jsx(se,{image:se.PRESENTED_IMAGE_SIMPLE,description:s("sys.certificate.noServer")}):l.jsx(pe,{rowKey:"key",loading:H,columns:de,dataSource:N,pagination:{current:Z.current,pageSize:Z.pageSize,total:N.length,showSizeChanger:!1,onChange:e=>D(t=>({...t,current:e}))},scroll:{x:"max-content"},size:"small",className:"w-full"}),l.jsx(ge,{title:s("sys.certificate.addDomain"),open:M,onOk:W,onCancel:()=>Y(!1),okText:s("sys.certificate.confirm"),cancelText:s("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},confirmLoading:U,children:l.jsx(xe,{addonBefore:"https://",placeholder:s("sys.certificate.domainPlaceholder"),value:G,onChange:e=>V(e.target.value),onPressEnter:W,allowClear:!0,ref:K,disabled:U})})]})}export{be as default};

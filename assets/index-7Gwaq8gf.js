import{u as K,F as Q,j as i,E as _}from"./index-C1yQrvnY.js";import{a as V}from"./vendor-utils-DG9TG-F2.js";import{r as a}from"./vendor-core-Cler3e7Q.js";import{s as W,T as F,af as X,i as D,C as ee,ag as $,G as te,M as re,I as se,H as ae}from"./vendor-ui-Bdifwvp0.js";const ne="https://ssl-checker.io/api/v1/check";async function ie(r){const h=`${ne}/${r}`,{data:o}=await V.get(h,{timeout:1e4});return o.result}const p="certificateCache",{Text:I}=W;function oe(r){try{return new URL(r).hostname}catch{return null}}function fe(){const{t:r}=K(),h=Q(),[o,v]=a.useState([]),[b,y]=a.useState([]),[A,R]=a.useState(!1),[O,k]=a.useState(null),L=a.useRef(r("sys.certificate.fetchFailed")),s=a.useRef(null),[z,Z]=a.useState(!1),M=a.useRef(!1),[w,E]=a.useState(!1),[N,C]=a.useState(""),P=a.useRef(null);a.useEffect(()=>{L.current=r("sys.certificate.fetchFailed")},[r]),a.useEffect(()=>{try{const t=localStorage.getItem(p);if(t){const e=JSON.parse(t);s.current=e,e.domains&&v(e.domains),e.results&&y(e.results),e.lastFetched&&k(new Date(e.lastFetched))}}catch{}finally{Z(!0)}},[]),a.useEffect(()=>{if(M.current||!z||s.current?.domains?.length||s.current?.seededFromServers||o.length>0)return;const t=h.map(n=>oe(n.addr)).filter(Boolean);if(t.length===0)return;const c=Array.from(new Set(t)).map(n=>({host:n,source:"server",createdAt:Date.now()}));v(c),s.current={domains:c,seededFromServers:!0},localStorage.setItem(p,JSON.stringify({domains:c,lastFetched:s.current?.lastFetched,results:s.current?.results,seededFromServers:!0})),M.current=!0},[h,o.length,z]);const g=a.useCallback(t=>t.map(e=>({key:`${e.host}-${e.source}`,name:e.host,addr:e.host,host:e.host})),[]),x=a.useMemo(()=>g(o),[o,g]),j=a.useCallback(t=>{const e={domains:o,lastFetched:t.lastFetched??s.current?.lastFetched,results:t.results??s.current?.results,seededFromServers:t.seededFromServers??s.current?.seededFromServers??!1};s.current=e,localStorage.setItem(p,JSON.stringify(e))},[o]),S=a.useCallback(async t=>{const c=g(t??o);if(c.length===0){y([]),j({results:[],lastFetched:void 0});return}y([]),R(!0);try{const u=(await Promise.allSettled(c.map(d=>ie(d.host)))).map((d,q)=>{const f=c[q];if(d.status==="fulfilled"){const m=d.value,Y=typeof m.cert_valid=="boolean"?m.cert_valid:m.cert_exp===!1?!0:void 0;return{key:f.key,name:f.name,addr:f.addr,host:f.host,ip:m.resolved_ip,valid:Y,validFrom:m.valid_from,validTill:m.valid_till,vendor:m.issuer_o||m.issuer_cn}}const T=d.reason,G=typeof T=="string"?T:T?.message||L.current;return{key:f.key,name:f.name,addr:f.addr,host:f.host,error:G}});y(u);const l=new Date;k(l),j({results:u,lastFetched:l.toISOString()})}finally{R(!1)}},[o,g,j]);a.useEffect(()=>{if(x.length===0)return;const t=s.current,e=l=>{if(!l)return!1;const d=new Date;return l.getFullYear()===d.getFullYear()&&l.getMonth()===d.getMonth()&&l.getDate()===d.getDate()},c=(t?.domains||[]).map(l=>l.host).sort().join(","),n=o.map(l=>l.host).sort().join(","),u=c===n;if(t?.results&&t.lastFetched&&e(new Date(t.lastFetched))&&u){y(t.results),k(new Date(t.lastFetched));return}S()},[x.length,o,S]);const J=()=>{E(!0),C("")};a.useEffect(()=>{w&&setTimeout(()=>P.current?.focus(),50)},[w]);const H=()=>{const t=N.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!t){_.error(r("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(t)){_.error(r("sys.certificate.domainInvalid"));return}if(o.some(u=>u.host.toLowerCase()===t.toLowerCase())){_.warning(r("sys.certificate.domainExists"));return}const n=[...o,{host:t,source:"custom",createdAt:Date.now()}];v(n),s.current={...s.current,domains:n,seededFromServers:s.current?.seededFromServers??!0},localStorage.setItem(p,JSON.stringify({domains:n,lastFetched:s.current?.lastFetched,results:s.current?.results,seededFromServers:s.current?.seededFromServers??!0})),E(!1),C(""),S(n)},B=t=>{const e=o.filter(n=>n.host!==t);v(e);const c={domains:e,lastFetched:s.current?.lastFetched,results:(s.current?.results||[]).filter(n=>n.host!==t),seededFromServers:s.current?.seededFromServers??!0};s.current=c,localStorage.setItem(p,JSON.stringify(c)),y(n=>n.filter(u=>u.host!==t))},U=[{title:r("sys.certificate.api"),dataIndex:"addr",key:"addr",render:(t,e)=>i.jsx(I,{className:"font-medium",children:e.addr})},{title:r("sys.certificate.ip"),dataIndex:"ip",key:"ip",render:(t,e)=>e.error?"-":e.ip||"-"},{title:r("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",render:(t,e)=>e.error?"-":e.vendor||"-"},{title:r("sys.certificate.valid"),dataIndex:"valid",key:"valid",render:(t,e)=>e.error?i.jsx(F,{color:"default",children:r("sys.certificate.unknown")}):e.valid===void 0?i.jsx(F,{color:"default",children:r("sys.certificate.unknown")}):e.valid?i.jsx(F,{color:"success",children:r("sys.certificate.validTag")}):i.jsx(F,{color:"error",children:r("sys.certificate.invalidTag")})},{title:r("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",render:(t,e)=>e.error?"-":e.validFrom||"-"},{title:r("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",render:(t,e)=>e.error?"-":e.validTill||"-"},{title:r("sys.certificate.remark"),dataIndex:"error",key:"error",render:(t,e)=>e.error?i.jsx(I,{type:"danger",children:e.error}):"-"},{title:r("sys.certificate.operation"),key:"operation",render:(t,e)=>i.jsx(X,{title:r("sys.certificate.deleteConfirm"),onConfirm:()=>B(e.host),children:i.jsx(D,{type:"link",danger:!0,children:r("sys.certificate.delete")})})}];return i.jsxs(ee,{title:r("sys.certificate.title"),extra:i.jsxs(ae,{size:"middle",children:[O&&i.jsx(I,{type:"secondary",className:"text-xs",children:r("sys.certificate.updatedAt",{time:O.toLocaleString()})}),i.jsx(D,{onClick:J,children:r("sys.certificate.addDomain")}),i.jsx(D,{onClick:S,loading:A,disabled:x.length===0,children:r("sys.certificate.refresh")})]}),children:[x.length===0?i.jsx($,{image:$.PRESENTED_IMAGE_SIMPLE,description:r("sys.certificate.noServer")}):i.jsx(te,{rowKey:"key",loading:A,columns:U,dataSource:b,pagination:!1,scroll:{x:!0},size:"middle"}),i.jsx(re,{title:r("sys.certificate.addDomain"),open:w,onOk:H,onCancel:()=>E(!1),okText:r("sys.certificate.confirm"),cancelText:r("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},children:i.jsx(se,{addonBefore:"https://",placeholder:r("sys.certificate.domainPlaceholder"),value:N,onChange:t=>C(t.target.value),onPressEnter:H,allowClear:!0,ref:P})})]})}export{fe as default};

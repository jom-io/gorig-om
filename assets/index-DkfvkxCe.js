import{u as K,F as Q,j as n,E as _}from"./index-Cr9X0c_l.js";import{a as V}from"./vendor-utils-DG9TG-F2.js";import{r}from"./vendor-core-Cler3e7Q.js";import{s as W,T as F,af as X,i as D,C as ee,ag as H,G as te,M as se,I as re,H as ae}from"./vendor-ui-Bdifwvp0.js";const ne="https://ssl-checker.io/api/v1/check";async function ie(s){const m=`${ne}/${s}`,{data:o}=await V.get(m,{timeout:1e4});return o.result}const p="certificateCache",{Text:I}=W;function oe(s){try{return new URL(s).hostname}catch{return null}}function fe(){const{t:s}=K(),m=Q(),[o,g]=r.useState([]),[$,y]=r.useState([]),[A,R]=r.useState(!1),[O,k]=r.useState(null),L=r.useRef(s("sys.certificate.fetchFailed")),i=r.useRef(null),[b,Z]=r.useState(!1),z=r.useRef(!1),[w,E]=r.useState(!1),[M,C]=r.useState(""),N=r.useRef(null);r.useEffect(()=>{L.current=s("sys.certificate.fetchFailed")},[s]),r.useEffect(()=>{try{const t=localStorage.getItem(p);if(!t)return;const e=JSON.parse(t);i.current=e,e.domains&&g(e.domains),e.results&&y(e.results),e.lastFetched&&k(new Date(e.lastFetched))}catch{}finally{Z(!0)}},[]),r.useEffect(()=>{if(z.current||!b||i.current?.domains?.length||o.length>0)return;const t=m.map(a=>oe(a.addr)).filter(Boolean);if(t.length===0)return;const c=Array.from(new Set(t)).map(a=>({host:a,source:"server",createdAt:Date.now()}));g(c),i.current={domains:c},localStorage.setItem(p,JSON.stringify({domains:c,lastFetched:i.current?.lastFetched,results:i.current?.results})),z.current=!0},[m,o.length]);const x=r.useCallback(t=>t.map(e=>({key:`${e.host}-${e.source}`,name:e.host,addr:e.host,host:e.host})),[]),v=r.useMemo(()=>x(o),[o,x]),j=r.useCallback(t=>{const e={domains:o,lastFetched:t.lastFetched??i.current?.lastFetched,results:t.results??i.current?.results};i.current=e,localStorage.setItem(p,JSON.stringify(e))},[o]),S=r.useCallback(async t=>{const c=x(t??o);if(c.length===0){y([]),j({results:[],lastFetched:void 0});return}y([]),R(!0);try{const u=(await Promise.allSettled(c.map(d=>ie(d.host)))).map((d,q)=>{const f=c[q];if(d.status==="fulfilled"){const h=d.value,Y=typeof h.cert_valid=="boolean"?h.cert_valid:h.cert_exp===!1?!0:void 0;return{key:f.key,name:f.name,addr:f.addr,host:f.host,ip:h.resolved_ip,valid:Y,validFrom:h.valid_from,validTill:h.valid_till,vendor:h.issuer_o||h.issuer_cn}}const T=d.reason,G=typeof T=="string"?T:T?.message||L.current;return{key:f.key,name:f.name,addr:f.addr,host:f.host,error:G}});y(u);const l=new Date;k(l),j({results:u,lastFetched:l.toISOString()})}finally{R(!1)}},[o,x,j]);r.useEffect(()=>{if(v.length===0)return;const t=i.current,e=l=>{if(!l)return!1;const d=new Date;return l.getFullYear()===d.getFullYear()&&l.getMonth()===d.getMonth()&&l.getDate()===d.getDate()},c=(t?.domains||[]).map(l=>l.host).sort().join(","),a=o.map(l=>l.host).sort().join(","),u=c===a;if(t?.results&&t.lastFetched&&e(new Date(t.lastFetched))&&u){y(t.results),k(new Date(t.lastFetched));return}S()},[v.length,o,S]);const J=()=>{E(!0),C("")};r.useEffect(()=>{w&&setTimeout(()=>N.current?.focus(),50)},[w]);const P=()=>{const t=M.trim().replace(/^https?:\/\//i,"").replace(/\/+$/,"");if(!t){_.error(s("sys.certificate.domainRequired"));return}if(!/^(?=.{1,253}$)([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(:\d{1,5})?$/.test(t)){_.error(s("sys.certificate.domainInvalid"));return}if(o.some(u=>u.host.toLowerCase()===t.toLowerCase())){_.warning(s("sys.certificate.domainExists"));return}const a=[...o,{host:t,source:"custom",createdAt:Date.now()}];g(a),i.current={...i.current,domains:a},localStorage.setItem(p,JSON.stringify({domains:a,lastFetched:i.current?.lastFetched,results:i.current?.results})),E(!1),C(""),S(a)},B=t=>{const e=o.filter(a=>a.host!==t);g(e);const c={domains:e,lastFetched:i.current?.lastFetched,results:(i.current?.results||[]).filter(a=>a.host!==t)};i.current=c,localStorage.setItem(p,JSON.stringify(c)),y(a=>a.filter(u=>u.host!==t))},U=[{title:s("sys.certificate.api"),dataIndex:"addr",key:"addr",render:(t,e)=>n.jsx(I,{className:"font-medium",children:e.addr})},{title:s("sys.certificate.ip"),dataIndex:"ip",key:"ip",render:(t,e)=>e.error?"-":e.ip||"-"},{title:s("sys.certificate.vendor"),dataIndex:"vendor",key:"vendor",render:(t,e)=>e.error?"-":e.vendor||"-"},{title:s("sys.certificate.valid"),dataIndex:"valid",key:"valid",render:(t,e)=>e.error?n.jsx(F,{color:"default",children:s("sys.certificate.unknown")}):e.valid===void 0?n.jsx(F,{color:"default",children:s("sys.certificate.unknown")}):e.valid?n.jsx(F,{color:"success",children:s("sys.certificate.validTag")}):n.jsx(F,{color:"error",children:s("sys.certificate.invalidTag")})},{title:s("sys.certificate.validFrom"),dataIndex:"validFrom",key:"validFrom",render:(t,e)=>e.error?"-":e.validFrom||"-"},{title:s("sys.certificate.expireAt"),dataIndex:"validTill",key:"validTill",render:(t,e)=>e.error?"-":e.validTill||"-"},{title:s("sys.certificate.remark"),dataIndex:"error",key:"error",render:(t,e)=>e.error?n.jsx(I,{type:"danger",children:e.error}):"-"},{title:s("sys.certificate.operation"),key:"operation",render:(t,e)=>n.jsx(X,{title:s("sys.certificate.deleteConfirm"),onConfirm:()=>B(e.host),children:n.jsx(D,{type:"link",danger:!0,children:s("sys.certificate.delete")})})}];return n.jsxs(ee,{title:s("sys.certificate.title"),extra:n.jsxs(ae,{size:"middle",children:[O&&n.jsx(I,{type:"secondary",className:"text-xs",children:s("sys.certificate.updatedAt",{time:O.toLocaleString()})}),n.jsx(D,{onClick:J,children:s("sys.certificate.addDomain")}),n.jsx(D,{onClick:S,loading:A,disabled:v.length===0,children:s("sys.certificate.refresh")})]}),children:[v.length===0?n.jsx(H,{image:H.PRESENTED_IMAGE_SIMPLE,description:s("sys.certificate.noServer")}):n.jsx(te,{rowKey:"key",loading:A,columns:U,dataSource:$,pagination:!1,scroll:{x:!0},size:"middle"}),n.jsx(se,{title:s("sys.certificate.addDomain"),open:w,onOk:P,onCancel:()=>E(!1),okText:s("sys.certificate.confirm"),cancelText:s("sys.certificate.cancel"),destroyOnClose:!0,style:{top:"20vh"},children:n.jsx(re,{addonBefore:"https://",placeholder:s("sys.certificate.domainPlaceholder"),value:M,onChange:t=>C(t.target.value),onPressEnter:P,allowClear:!0,ref:N})})]})}export{fe as default};

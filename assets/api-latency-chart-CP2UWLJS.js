import{u as F,t as r,j as a}from"./index-BERtlmQb.js";import{s as I,A as V}from"./api-sample-modal-DF60HdJW.js";import{C as J}from"./index-DCpAUovq.js";import{u as Q,C as X}from"./useChart-BUFOfR3x.js";import{T as Z,s as v,M as ee,t as _,G as te,ac as se,z as d}from"./vendor-ui-DHYkxuVK.js";import{r as o}from"./vendor-core-D3G3Pc5t.js";import"./vendor-utils-CsjJZ8C9.js";import"./vendor-charts-C0vSEv4L.js";const ae=[{value:"5m",label:"Last 5m"},{value:"10m",label:"Last 10m"},{value:"30m",label:"Last 30m"},{value:"hour",label:"Last Hour"},{value:"day",label:"Last Day"},{value:"week",label:"Last Week"},{value:"month",label:"Last Month"}];function re(m="hour"){const{t:u}=F(),[y,w]=o.useState(m),[n,b]=o.useState(null),C=o.useCallback(p=>{if(n?.[0]&&n?.[1]){const M=Math.floor(n[0].valueOf()/1e3),g=Math.floor(n[1].valueOf()/1e3),L=(g-M)/3600;let k;return L<=1?k="minute":L<=6?k="5m":L<=48?k="hour":k="day",{start:M,end:g,apiUnit:k}}const i=Math.floor(Date.now()/1e3);let x,h;switch(p){case"5m":x=i-300,h="minute";break;case"10m":x=i-600,h="minute";break;case"30m":x=i-1800,h="5m";break;case"hour":x=i-3600,h="5m";break;case"day":x=i-86400,h="hour";break;case"week":x=i-604800,h="day";break;case"month":x=i-2592e3,h="day";break;default:x=i-86400,h="hour"}return{start:x,end:i,apiUnit:h}},[n]),P=o.useMemo(()=>[...ae.map(p=>({...p,label:u(`sys.workbench.time.${p.value}`,p.label)})),...n?[{value:"custom",label:u("sys.workbench.time.custom","Custom")}]:[]],[u,n]),O=o.useMemo(()=>{switch(y){case"5m":case"10m":case"30m":case"hour":return"HH:mm";case"day":return"MM-dd HH:mm";case"week":case"month":return"yyyy-MM-dd";default:return"yyyy-MM-dd HH:mm"}},[y]);return{timeUnit:y,setTimeUnit:w,timeRange:n,setTimeRange:b,getRange:C,dateLabelFormat:O,renderTimePicker:p=>a.jsxs("div",{className:"flex items-center gap-1 bg-neutral-100 dark:bg-neutral-800 p-0.5 rounded-lg border border-neutral-200 dark:border-neutral-700",style:{background:r.colors.background.neutral},children:[a.jsx(_,{size:"small",variant:"borderless",value:n?"custom":y,onChange:i=>{i!=="custom"&&(w(i),b(null),p?.())},style:{width:110},options:P}),a.jsx("span",{className:"w-[1px] h-4 bg-neutral-300 dark:bg-neutral-600 mx-1"}),a.jsx(se.RangePicker,{size:"small",variant:"borderless",value:n,onChange:i=>{b(i),p?.()},showTime:{format:"HH:mm"},format:"YYYY-MM-DD HH:mm",allowClear:!0,placeholder:[u("sys.workbench.startTime","Start"),u("sys.workbench.endTime","End")],style:{width:280},presets:[{label:u("sys.workbench.time.5m","Last 5m"),value:[d().subtract(5,"minute"),d()]},{label:u("sys.workbench.time.10m","Last 10m"),value:[d().subtract(10,"minute"),d()]},{label:u("sys.workbench.time.30m","Last 30m"),value:[d().subtract(30,"minute"),d()]},{label:u("sys.workbench.time.hour","Last Hour"),value:[d().subtract(1,"hour"),d()]},{label:u("sys.workbench.time.day","Last Day"),value:[d().subtract(1,"day"),d()]},{label:u("sys.workbench.time.week","Last Week"),value:[d().subtract(1,"week"),d()]},{label:u("sys.workbench.time.month","Last Month"),value:[d().subtract(1,"month"),d()]}]})]})}}const N=["2xx","4xx","5xx"],$=m=>`${m} ms`;function xe({open:m,onClose:u,enabled:y=!0,defaultSort:w="count"}){const{t:n}=F(),{timeUnit:b,getRange:C,dateLabelFormat:P,renderTimePicker:O}=re("hour"),[T,p]=o.useState([]),[i,x]=o.useState([]),[h,M]=o.useState(0),[g,L]=o.useState(N),[k,G]=o.useState(["GET","POST","PUT","DELETE"]),[l,R]=o.useState({columnKey:w,order:"descend"}),[S,E]=o.useState({current:1,pageSize:10}),[Y,D]=o.useState({open:!1,method:"",uri:"",type:"slow"}),j=o.useCallback((e,t)=>{D({open:!0,method:e.method,uri:e.uri,type:t})},[]),H=o.useCallback(e=>{L(t=>t.includes(e)?t.filter(f=>f!==e):[...t,e]),E(t=>({...t,current:1}))},[]);o.useEffect(()=>{m&&(R({columnKey:w==="count"?"count":w,order:"descend"}),E(e=>({...e,current:1})))},[m,w]),o.useEffect(()=>{if(m&&y){const e=C(b);(async()=>{try{const c=(await I.apiTimeRange(e.start,e.end,e.apiUnit,["count2xx","count4xx","count5xx"])).map(f=>({at:Number(f.at)*1e3,counts:{"2xx":f.value.count2xx||0,"4xx":f.value.count4xx||0,"5xx":f.value.count5xx||0}}));p(c)}catch{}})()}},[m,y,b,C]);const A=o.useCallback(async()=>{if(!m||!y)return;const e=C(b),t={count:"count",status2xx:"2xx",status4xx:"4xx",status5xx:"5xx",avgLatency:"avg",maxLatency:"max",successRate:"success"};try{const s=await I.apiTop({start:e.start,end:e.end,page:S.current,size:S.pageSize,statuses:g,methods:k,sortBy:t[l.columnKey]||"avg",asc:l.order==="ascend"});x(s.items),M(s.total)}catch{}},[m,y,b,S.current,S.pageSize,l,g,k,C]);o.useEffect(()=>{A()},[A]);const W=o.useMemo(()=>T.length?N.map(e=>{const t=g.includes(e);return{name:e,data:T.map(s=>({x:s.at,y:t?s.counts[e]:null}))}}):[],[T,g]),K=o.useMemo(()=>[r.colors.palette.success.dark,r.colors.palette.warning.dark,r.colors.palette.error.dark],[]),U=o.useMemo(()=>({GET:r.colors.palette.primary.dark,POST:r.colors.palette.success.dark,PUT:r.colors.palette.warning.dark,DELETE:r.colors.palette.error.dark}),[]),q=Q({colors:K,xaxis:{type:"datetime",labels:{datetimeUTC:!1,format:P}},yaxis:{labels:{formatter:e=>`${e}`},min:0},tooltip:{x:{formatter:e=>{switch(b){case"5m":case"10m":case"30m":case"hour":case"day":return new Date(e).toLocaleString();case"week":case"month":return new Date(e).toLocaleDateString();default:return new Date(e).toLocaleString()}}},y:{formatter:e=>`${e} req`}},chart:{toolbar:{show:!1},events:{legendClick:(e,t)=>(t!==void 0&&H(N[t]),!1)}},stroke:{width:2,curve:"smooth"}}),B=o.useMemo(()=>[{title:n("sys.workbench.apiColMethod","Method"),dataIndex:"method",key:"method",width:80,render:e=>a.jsx(Z,{color:U[e]||r.colors.palette.primary.default,children:e})},{title:"URL",dataIndex:"uri",key:"uri",ellipsis:!0},{title:n("sys.workbench.apiColTotal","Total"),dataIndex:"count",key:"count",sorter:!0,sortOrder:l.columnKey==="count"?l.order:void 0,width:90,align:"right"},{title:"2xx",dataIndex:"count2xx",key:"status2xx",sorter:!0,sortOrder:l.columnKey==="status2xx"?l.order:void 0,width:70,align:"right",render:(e,t)=>a.jsx(v.Link,{disabled:e===0,onClick:s=>{s.stopPropagation(),e>0&&j(t,"2xx")},style:{color:e>0?r.colors.palette.success.dark:r.colors.text.secondary},children:e})},{title:n("sys.workbench.apiColSuccessRate","Success"),key:"successRate",width:90,align:"right",render:(e,t)=>{const s=t.successRate*100,c=s>=99?"success":s>=95?"warning":"error";return a.jsxs(v.Text,{strong:!0,style:{color:r.colors.palette[c].dark},children:[s.toFixed(1),"%"]})},sorter:!0,sortOrder:l.columnKey==="successRate"?l.order:void 0},{title:"4xx",dataIndex:"count4xx",key:"status4xx",sorter:!0,sortOrder:l.columnKey==="status4xx"?l.order:void 0,width:70,align:"right",render:(e,t)=>a.jsx(v.Link,{disabled:e===0,onClick:s=>{s.stopPropagation(),e>0&&j(t,"4xx")},style:{color:e>0?r.colors.palette.warning.dark:r.colors.text.secondary},children:e})},{title:"5xx",dataIndex:"count5xx",key:"status5xx",sorter:!0,sortOrder:l.columnKey==="status5xx"?l.order:void 0,width:70,align:"right",render:(e,t)=>a.jsx(v.Link,{strong:e>0,disabled:e===0,onClick:s=>{s.stopPropagation(),e>0&&j(t,"5xx")},style:{color:e>0?r.colors.palette.error.dark:r.colors.text.secondary},children:e})},{title:n("sys.workbench.apiColAvg","Avg"),dataIndex:"avgLatency",key:"avgLatency",sorter:!0,sortOrder:l.columnKey==="avgLatency"?l.order:void 0,width:90,render:e=>{const t=Math.round(e),s=t>500?r.colors.palette.error.dark:t>200?r.colors.palette.warning.dark:void 0;return a.jsx(v.Text,{style:{color:s},children:$(t)})}},{title:n("sys.workbench.apiColMax","Max"),dataIndex:"maxLatency",key:"maxLatency",sorter:!0,sortOrder:l.columnKey==="maxLatency"?l.order:void 0,width:90,render:(e,t)=>{const s=Math.round(e),c=s>500?r.colors.palette.error.dark:s>200?r.colors.palette.warning.dark:void 0;return a.jsx(v.Link,{style:{color:c},onClick:f=>{f.stopPropagation(),j(t,"slow")},children:$(s)})}}],[n,l,U,j]),z=o.useMemo(()=>{if(!T.length)return{total:0,ok:0,err4:0,err5:0};let e=0,t=0,s=0;for(const c of T)e+=c.counts["2xx"],t+=c.counts["4xx"],s+=c.counts["5xx"];return{total:e+t+s,ok:e,err4:t,err5:s}},[T]);return a.jsxs(ee,{title:n("sys.workbench.apiTrendTitle","API Response Trend"),open:m&&y,onCancel:u,width:960,footer:null,style:{top:"6%"},styles:{body:{padding:0}},maskClosable:!0,destroyOnClose:!0,children:[a.jsxs(J,{className:"flex-col !shadow-none",children:[a.jsxs("header",{className:"flex w-full justify-between items-center gap-4",children:[a.jsxs("div",{className:"flex gap-4 items-center flex-wrap",children:[a.jsx("div",{className:"flex gap-2 items-center",children:N.map((e,t)=>{const s=g.includes(e),c=K[t];return a.jsxs("div",{onClick:()=>H(e),className:"flex items-center h-7 px-2.5 rounded-full border transition-all cursor-pointer hover:opacity-80 active:scale-95 select-none",style:{borderColor:s?c:r.colors.common.border,background:s?`${c}15`:r.colors.background.neutral,boxShadow:s?`0 2px 4px ${c}20`:"none"},children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full mr-2",style:{background:c,boxShadow:`0 0 4px ${c}`}}),a.jsx("span",{className:"text-xs font-medium mr-1.5",style:{color:r.colors.text.secondary},children:e}),a.jsx("span",{className:"text-sm font-bold",style:{color:s?c:r.colors.text.primary},children:z[e==="2xx"?"ok":e==="4xx"?"err4":"err5"]})]},e)})}),a.jsxs("div",{className:"flex items-center h-7 px-3 rounded-md bg-neutral-100 dark:bg-neutral-800 border border-transparent",style:{background:r.colors.background.neutral},children:[a.jsx(v.Text,{type:"secondary",style:{fontSize:"12px"},children:n("sys.workbench.apiTotalCount","Total")}),a.jsx("span",{className:"mx-1.5 h-3 w-[1px] bg-neutral-300 dark:bg-neutral-700"}),a.jsx("span",{className:"text-sm font-bold",style:{color:r.colors.text.primary},children:z.total})]})]}),O()]}),a.jsxs("main",{className:"w-full flex flex-col gap-4 mt-4",children:[a.jsx("div",{className:"w-full",children:a.jsx(X,{type:"area",series:W,options:q,height:360})}),a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2 px-1",children:[a.jsxs("div",{className:"flex flex-col",children:[a.jsx("span",{className:"text-base font-medium",style:{color:r.colors.text.primary},children:n("sys.workbench.apiRankingTitle","Endpoint latency ranking")}),a.jsx("span",{className:"text-xs",style:{color:r.colors.text.secondary},children:n("sys.workbench.apiRankingDesc","Sortable by status counts and latency columns.")})]}),a.jsx(_,{mode:"multiple",placeholder:"Method",value:k,onChange:e=>{G(e),E(t=>({...t,current:1}))},style:{width:220},maxTagCount:"responsive",size:"small",options:[{label:"GET",value:"GET"},{label:"POST",value:"POST"},{label:"PUT",value:"PUT"},{label:"DELETE",value:"DELETE"},{label:"PATCH",value:"PATCH"},{label:"OPTIONS",value:"OPTIONS"},{label:"HEAD",value:"HEAD"}]})]}),a.jsx(te,{rowKey:e=>`${e.method}-${e.uri}`,dataSource:i,size:"small",onRow:e=>({onClick:()=>j(e,"latest"),className:"cursor-pointer"}),pagination:{current:S.current,pageSize:S.pageSize,total:h,showSizeChanger:!1,onChange:e=>E(t=>({...t,current:e}))},columns:B,onChange:(e,t,s)=>{!Array.isArray(s)&&s.columnKey&&R({columnKey:s.columnKey,order:s.order||"descend"})}})]})]})]}),a.jsx(V,{...Y,onClose:()=>D(e=>({...e,open:!1}))})]})}export{ae as TIME_OPTIONS,xe as default,re as useTimeRange};

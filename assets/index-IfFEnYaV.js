import{H as K,J as ne,K as ce,c as C,N as de,a as ge,u as ue,j as s}from"./index-BfkEEPVp.js";import{Q as he,u as me}from"./useBaseQuery-DbSuHkGO.js";import{A as _,F as y,z as g,H as E,C as J,U as fe,V as b,t as I,T as pe,I as G,ah as X,i as k,M as W,a9 as ye,n as xe}from"./vendor-ui-Bdifwvp0.js";import{r as d}from"./vendor-core-Cler3e7Q.js";import{LogList as Z}from"./log-list-C0xx1YvO.js";import"./vendor-utils-DG9TG-F2.js";var be=class extends he{constructor(r,u){super(r,u)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(r,u){super.setOptions({...r,behavior:K()},u)}getOptimisticResult(r){return r.behavior=K(),super.getOptimisticResult(r)}fetchNextPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(r){return this.fetch({...r,meta:{fetchMore:{direction:"backward"}}})}createResult(r,u){const{state:v}=r,L=super.createResult(r,u),{isFetching:T,isRefetching:i,isError:h,isRefetchError:F}=L,p=v.fetchMeta?.fetchMore?.direction,x=h&&p==="forward",m=T&&p==="forward",w=h&&p==="backward",N=T&&p==="backward";return{...L,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:ce(u,v.data),hasPreviousPage:ne(u,v.data),isFetchNextPageError:x,isFetchingNextPage:m,isFetchPreviousPageError:w,isFetchingPreviousPage:N,isRefetchError:F&&!x&&!w,isRefetching:i&&!m&&!N}}};function we(r,u){return me(r,be)}const Pe=r=>C.post({url:"/om/log/search",data:r}),je=()=>C.get({url:"/om/log/categories"}),ve=()=>C.get({url:"/om/log/levels"}),ke=r=>C.get({url:"/om/log/near",params:r}),Ce=r=>C.get({url:"/om/log/download",params:{path:r},responseType:"blob"}),R={getLogList:Pe,getCategories:je,getLevels:ve,getNearLogs:ke,downloadLog:Ce},ee=1e3;function Re(){const{message:r}=_.useApp(),[u,v]=d.useState([]),[L,T]=d.useState([]),[i]=y.useForm(),[h,F]=d.useState(null),[p,x]=d.useState(!1),[m,w]=d.useState(!1),[N,Y]=d.useState(null),D=d.useRef(null),M=de(),[P,O]=d.useState(!1),[se,Q]=d.useState(!1),[c,te]=d.useState([]),j=ge(),{t:a}=ue();d.useEffect(()=>{i.setFieldsValue({startTime:g().subtract(1,"hour")})},[i]),d.useEffect(()=>{j&&(async()=>{try{const[t,o]=await Promise.all([R.getCategories(),R.getLevels()]);T(t),v(o),t&&t.length>0&&i.setFieldsValue({categories:[t[0]]})}catch{r.error(a("sys.log.fetchDataFailed"))}})()},[j,i,r,a]);const H=(e,t)=>{t.stopPropagation(),W.confirm({title:a("sys.log.downloadConfirm"),content:a("sys.log.downloadConfirmContent"),onOk:async()=>{try{const o=await fetch(`${j?.addr}/om/log/download?path=${e}`,{headers:{Authorization:`Bearer ${j?.token}`}});if(!o.ok)throw new Error("下载失败");const l=await o.blob(),n=window.URL.createObjectURL(l),f=document.createElement("a");f.href=n,f.download=e.split("/").pop()||"logfile",document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(n)}catch{r.error(a("sys.log.downloadFailed"))}}})},S=async(e,t,o)=>{if(o.stopPropagation(),!(t<=0))try{const l=await R.getNearLogs({path:e,line:t,range:10});l.forEach(n=>{n.line===t&&(n.highlight=!0)}),te(l),Q(!0)}catch{r.error(a("sys.log.contextLogFailed"))}},{data:re,fetchNextPage:q,hasNextPage:U,isFetchingNextPage:$}=we({queryKey:["logs",h],queryFn:async({pageParam:e={lastPath:void 0,lastLine:void 0}})=>{try{if(p)return[];x(!0);const t=h,o={...t,startTime:t?.startTime?g(t.startTime).format("YYYY-MM-DD HH:mm:ss"):void 0,endTime:t?.endTime?g(t.endTime).format("YYYY-MM-DD HH:mm:ss"):void 0},l=await R.getLogList({...o,lastPath:e.lastPath,lastLine:e.lastLine,size:50});return await new Promise(n=>setTimeout(n,200)),!l||l.length===0?[]:l}catch{return[]}finally{x(!1)}},getNextPageParam:e=>{if(!e||e.length===0)return;const t=e[e.length-1];return{lastPath:t.path,lastLine:t.line}},initialPageParam:void 0,enabled:h!==null&&!m,retry:1,retryDelay:1e3}),ae=re?.pages.flat()??[];d.useEffect(()=>{const e=new IntersectionObserver(t=>{if(t[0]?.isIntersecting&&U&&!$){if(m)return;q()}},{threshold:.5});return D.current&&e.observe(D.current),()=>{e.disconnect()}},[U,$,q,m]);const oe=async()=>{if(m)N?.close(),w(!1),O(!1),r.success(a("sys.log.monitorStopped"));else{M.setQueryData(["logs",h],{pages:[],pageParams:[]});const e={categories:i.getFieldValue("categories"),level:i.getFieldValue("level"),keyword:i.getFieldValue("keyword"),traceID:i.getFieldValue("traceID"),token:j?.token},t=Object.entries(e).filter(([l,n])=>n!==void 0).reduce((l,[n,f])=>(l[n]=f,l),{}),o=new EventSource(`${j?.addr}/om/log/monitor?${new URLSearchParams(t).toString()}`);o.onmessage=l=>{if(l.data==="monitoring started")r.success(a("sys.log.monitorStarted"));else if(l.data==="monitoring stopped")r.success(a("sys.log.monitorStopped")),o.close();else{const n=JSON.parse(l.data);M.setQueryData(["logs",h],f=>{const le=f?.pages||[],V=[n,...le.flat()];return V.length>ee&&V.splice(ee),{pages:[V],pageParams:[]}})}},o.onerror=()=>{o.close(),w(!1),r.error(a("sys.log.monitorFailed")),O(!1)},Y(o),w(!0),x(!1),O(!0)}},z=(e,t)=>{t.stopPropagation(),i.setFieldsValue({categories:[],level:"",keyword:"",traceID:e}),F(o=>o?{...o,categories:[],level:"",keyword:"",traceID:e}:null),A()},ie=()=>{i.resetFields(),i.setFieldsValue({startTime:g().subtract(1,"hour"),endTime:g()})},A=async()=>{if(!m&&!p)try{const e=i.getFieldsValue();await M.resetQueries({queryKey:["logs",e]}),F(e)}catch{x(!1)}},B=(e,t)=>{t.stopPropagation();const o=g(e).format("YYYY-MM-DD HH:mm:ss"),l=i.getFieldValue("startTime"),n=i.getFieldValue("endTime");l?n?i.setFieldsValue({endTime:g(o)}):i.setFieldsValue({endTime:g(o)}):i.setFieldsValue({startTime:g(o)})};return s.jsxs(_,{children:[s.jsxs(E,{direction:"vertical",size:"small",className:"w-full",children:[s.jsx(J,{children:s.jsx(y,{form:i,onFinish:A,children:s.jsxs(fe,{gutter:[16,16],style:{fontSize:"12px",lineHeight:"16px"},children:[s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.category"),name:"categories",className:"!mb-0",children:s.jsx(I,{mode:"multiple",allowClear:!0,disabled:P,children:L.map(e=>s.jsx(I.Option,{value:e,children:e},e))})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.level"),name:"level",className:"!mb-0",children:s.jsx(I,{allowClear:!0,disabled:P,children:u.map(e=>s.jsx(I.Option,{value:e,children:s.jsx(pe,{color:e==="error"||e==="fatal"||e==="dpanic"?"error":e==="warn"?"warning":"success",children:e})},e))})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.keyword"),name:"keyword",className:"!mb-0",children:s.jsx(G,{placeholder:a("sys.log.keywordPlaceholder"),allowClear:!0,disabled:P})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.traceID"),name:"traceID",className:"!mb-0",children:s.jsx(G,{placeholder:a("sys.log.traceIDPlaceholder"),allowClear:!0,disabled:P})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.startTime"),name:"startTime",className:"!mb-0",children:s.jsx(X,{showTime:!0,style:{width:"100%"},disabled:P,disabledDate:e=>e&&e>g().endOf("day"),placeholder:a("sys.log.startTimePlaceholder")})})}),s.jsx(b,{span:24,lg:6,children:s.jsx(y.Item,{label:a("sys.log.endTime"),name:"endTime",className:"!mb-0",children:s.jsx(X,{showTime:!0,style:{width:"100%"},disabled:P,disabledDate:e=>e&&e>g().endOf("day"),placeholder:a("sys.log.endTimePlaceholder")})})}),s.jsx(b,{span:24,children:s.jsxs("div",{className:"flex justify-end",children:[s.jsx(k,{onClick:ie,children:a("sys.log.reset")}),s.jsx(k,{type:"primary",className:"ml-4",htmlType:"submit",loading:p,disabled:m,children:a("sys.log.search")}),s.jsx(k,{type:"primary",className:"ml-4",onClick:oe,children:a(m?"sys.log.stopMonitor":"sys.log.startMonitor")})]})})]})})}),s.jsxs(J,{children:[s.jsx(Z,{dataSource:ae,keyword:h?.keyword,onTraceIDClick:z,onLineNumberClick:S,onFileClick:H,onTimeClick:B}),s.jsx("div",{ref:D,style:{height:20}})]})]}),s.jsx(W,{title:a("sys.log.contextLog"),open:se,onCancel:()=>Q(!1),footer:s.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"8px"},children:[s.jsx(k,{onClick:e=>{c&&c.length>0&&S(c[0].path,c[0].line,e)},disabled:!c||c.length===0,children:s.jsxs(E,{children:[s.jsx(ye,{}),a("sys.log.prevPage")]})}),s.jsx(k,{onClick:e=>{if(c&&c.length>0){const t=c[c.length-1];S(t.path,t.line,e)}},disabled:!c||c.length===0,children:s.jsxs(E,{children:[a("sys.log.nextPage"),s.jsx(xe,{})]})})]}),width:1e3,styles:{body:{height:"70vh",padding:"24px",overflow:"hidden"},content:{height:"100%"}},children:s.jsx("div",{style:{height:"100%",overflow:"auto"},children:s.jsx(Z,{dataSource:c,keyword:h?.keyword,onTraceIDClick:z,onLineNumberClick:S,onFileClick:H,onTimeClick:B})})})]})}export{Re as default};
